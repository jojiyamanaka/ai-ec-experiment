# syntax=docker/dockerfile:1.7

# 開発用 Dockerfile
FROM node:20-bookworm

WORKDIR /app

# workspace の package.json をコピー
COPY package.json package-lock.json ./
COPY bff/shared/package.json ./bff/shared/package.json
COPY frontend/package.json ./frontend/package.json
COPY scripts/ensure-frontend-native-deps.mjs ./scripts/ensure-frontend-native-deps.mjs

# frontend と共有パッケージの依存関係をインストール
RUN --mount=type=cache,target=/root/.npm \
    npm ci --workspace=bff/shared --workspace=frontend --include-workspace-root=false --no-audit \
    && node ./scripts/ensure-frontend-native-deps.mjs

# ソースコードをコピー
COPY bff/shared ./bff/shared
COPY frontend ./frontend

WORKDIR /app/frontend

# Viteの開発サーバーをホストからアクセス可能にする
EXPOSE 5173
EXPOSE 5174

# 開発サーバー起動（docker-compose.yml の command で上書き可能）
CMD ["npm", "run", "dev", "--", "--host"]
