version: '3.8'

services:
  postgres:
    image: postgres:16
    container_name: ec-postgres
    environment:
      POSTGRES_USER: ec_user
      POSTGRES_PASSWORD: ec_password
      POSTGRES_DB: ec_db
    ports:
      - "${POSTGRES_HOST_PORT:-5432}:5432"  # 開発環境のみ公開（無効化: POSTGRES_HOST_PORT=0）
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./backend/src/main/resources/db/init:/docker-entrypoint-initdb.d
    networks:
      - internal
      - public  # ホストからのポート公開に必要

  backend:
    build: ./backend
    container_name: ec-backend
    ports:
      - "8000:8000"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/ec_db
      - SPRING_DATASOURCE_USERNAME=ec_user
      - SPRING_DATASOURCE_PASSWORD=ec_password
      - SPRING_PROFILES_ACTIVE=production-internal
      - JOBRUNR_WORKER_ENABLED=true
      - APP_JOBS_ENABLED_CREATE_SHIPMENT=${APP_JOBS_ENABLED_CREATE_SHIPMENT:-true}
      - APP_JOBS_ENABLED_CREATESHIPMENT=${APP_JOBS_ENABLED_CREATESHIPMENT:-true}
      - APP_JOBS_ENABLED_SFTP_PUT=${APP_JOBS_ENABLED_SFTP_PUT:-true}
      - MAIL_HOST=mailpit
      - MAIL_PORT=1025
      - MANAGEMENT_OTLP_TRACING_ENDPOINT=http://otel-collector:4317
      - MANAGEMENT_OTLP_TRACING_TRANSPORT=grpc
    depends_on:
      - postgres
      - mailpit
      - otel-collector
    networks:
      - internal
      - public
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  customer-bff:
    build:
      context: .
      dockerfile: bff/customer-bff/Dockerfile
    container_name: ec-customer-bff
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - CORE_API_URL=http://backend:8080
      - CORE_API_TIMEOUT=5000
      - CORE_API_RETRY=2
      - LOG_LEVEL=info
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_TIMEOUT=5000
      - OTEL_EXPORTER_OTLP_GRPC_ENDPOINT=http://otel-collector:4317
      - OTEL_SERVICE_NAME=customer-bff
    depends_on:
      - backend
      - redis
      - otel-collector
    networks:
      - public    # 外部公開
      - internal  # Core API接続
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  backoffice-bff:
    build:
      context: .
      dockerfile: bff/backoffice-bff/Dockerfile
    container_name: ec-backoffice-bff
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - PORT=3002
      - CORE_API_URL=http://backend:8080
      - CORE_API_TIMEOUT=5000
      - CORE_API_RETRY=2
      - LOG_LEVEL=info
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_TIMEOUT=5000
      - OTEL_EXPORTER_OTLP_GRPC_ENDPOINT=http://otel-collector:4317
      - OTEL_SERVICE_NAME=backoffice-bff
    depends_on:
      - backend
      - redis
      - otel-collector
    networks:
      - public
      - internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend-customer:
    build:
      context: .
      dockerfile: frontend/Dockerfile.dev
    container_name: ec-frontend-customer
    ports:
      - "5173:5173"
    environment:
      - VITE_APP_MODE=customer
      - VITE_API_URL=http://localhost:3001
      - VITE_OTEL_ENDPOINT=http://localhost:4318
    command: npm run dev:customer
    depends_on:
      - customer-bff
    networks:
      - public

  frontend-admin:
    build:
      context: .
      dockerfile: frontend/Dockerfile.dev
    container_name: ec-frontend-admin
    ports:
      - "5174:5174"
    environment:
      - VITE_APP_MODE=admin
      - VITE_API_URL=http://localhost:3002
      - VITE_OTEL_ENDPOINT=http://localhost:4318
    command: npm run dev:admin
    depends_on:
      - backoffice-bff
    networks:
      - public

  redis:
    image: redis:7.2-alpine
    container_name: ec-redis
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - internal

  mailpit:
    image: axllent/mailpit:latest
    container_name: ec-mailpit
    ports:
      - "8025:8025"
      - "1025:1025"
    networks:
      - public
      - internal

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.116.1
    container_name: ec-otel-collector
    command: ["--config=/etc/otel/config.yaml"]
    volumes:
      - ./otel/otel-collector-config.yaml:/etc/otel/config.yaml
    ports:
      - "4317:4317"
      - "4318:4318"
    networks:
      - public
      - internal

  jaeger:
    image: jaegertracing/all-in-one:1.63.0
    container_name: ec-jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "16686:16686"
    networks:
      - internal
      - public

  prometheus:
    image: prom/prometheus:v3.1.0
    container_name: ec-prometheus
    volumes:
      - ./otel/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - internal
      - public

  grafana:
    image: grafana/grafana:11.4.0
    container_name: ec-grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./otel/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
      - jaeger
    networks:
      - internal
      - public

networks:
  public:
    driver: bridge
  internal:
    driver: bridge
    internal: true  # 外部からのアクセスを遮断

volumes:
  postgres-data:
  redis-data:
  grafana-data:
