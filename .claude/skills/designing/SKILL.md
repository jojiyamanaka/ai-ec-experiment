---
name: designing
description: 要件定義書から技術設計書を作成する。CHG番号指定で関連ドキュメントとコードを調査し設計書を生成する。
argument-hint: "[CHG番号 例: CHG-011]"
---

# 技術設計書の作成

CHG番号: $ARGUMENTS

## 手順

### 1. 要件定義書の読み込み

`docs/01_requirements/` から $ARGUMENTS に一致するファイルを検索して読み込む。
見つからない場合はユーザーに報告して終了する。

### 2. 関連ドキュメントの調査

要件定義書の内容を分析し、`docs/SPEC.md` のタスク別参照ガイドに従って関連ドキュメントを読み込む。
常に参照: `docs/SPEC.md`, `docs/requirements.md`

### 3. 既存コードパターンの調査

要件に関連する既存の実装を確認し、一貫性のある設計にする。
調査は要件が触れる層に応じて **専用サブエージェント** に委譲する:

| 要件が触れる層 | 使用するサブエージェント | 調査対象の例 |
|---|---|---|
| `backend/` | **backend** エージェント | エンティティ、Port/UseCase、コントローラ、DTO |
| `bff/` | **bff** エージェント | コントローラ、サービス、CoreApiService 連携 |
| `frontend/` | **frontend** エージェント | ページ、entities/model/api.ts、FSD 境界 |
| アーキテクチャ制約 | **arch** エージェント | ArchUnit テスト、モジュール境界ルール、スキーマと仕様書の乖離 |

複数の層にまたがる場合は該当する全エージェントを **並列** で呼び出す。
arch エージェントは新規モジュール・クラスを追加する場合は常に含める。

各エージェントへのプロンプト例:
```
$ARGUMENTS の設計に必要な既存パターンを調査してください。
要件概要: <要件定義書の主要機能を1〜3行で>
調査ポイント: <エンティティ名・API パス・機能名など>
```

arch エージェントへのプロンプト例:
```
$ARGUMENTS の設計で触れるモジュール・テーブルに関するアーキテクチャ制約を調査してください。
確認ポイント:
- backend/src/test 配下の ArchUnit テストルール（モジュール間依存制約）
- 設計書・data-model.md と実際のエンティティ/DDL の乖離
- 既存 Flyway マイグレーションの最新バージョン番号
```

### 3.5. 設計草稿の生成（Plan エージェント）

Step 3 の調査結果が揃ったら **Plan エージェント** に設計草稿を委譲する。

**対象**: 以下の条件を1つでも満たす場合は必須
- 触れる層が2つ以上（backend + bff + frontend など）
- 新規モジュール・テーブル・Enum 値の追加を伴う
- ステータス遷移・トランザクション境界の設計が必要

Plan エージェントへのプロンプト:
```
$ARGUMENTS の技術設計書の草稿を作成してください。

## 要件概要
<要件定義書の主要機能を箇条書き>

## 調査結果（Step 1-3 の成果物をそのまま渡す）
### 関連ドキュメント
<order.md / data-model.md 等の抜粋>

### バックエンド調査結果
<backend エージェントの報告>

### BFF 調査結果
<bff エージェントの報告>

### フロントエンド調査結果
<frontend エージェントの報告>

### アーキテクチャ制約
<arch エージェントの報告>

## 設計制約
- template.md の構成に従うこと
- 「構造の決定（契約）」のみ記述し、実装詳細は書かないこと
- 設計判断が複数考えられる箇所は選択肢とトレードオフを明示すること

出力: 設計書の全セクション草稿（markdown）
```

Plan エージェントの草稿を受け取ったら:
1. 草稿をレビューし、要件との整合性・既存パターンとの一貫性を確認する
2. 設計判断が必要な箇所を抽出して Step 4（ユーザー確認）へ進む

### 4. 設計判断が必要な場合はユーザーに質問する

以下のケースでは AskUserQuestion ツールで確認する:

- 複数の実装アプローチが考えられる場合
- 既存パターンから逸脱する必要がある場合
- 要件定義書に曖昧な点や不足情報がある場合
- 影響範囲が大きく方針確認が必要な場合
- API設計で複数の選択肢がある場合

質問は具体的な選択肢を提示し、トレードオフを説明すること。

### 5. 設計書の作成

`docs/02_designs/` にファイルを作成する。
ファイル名は要件定義書と同じ命名規則 (`CHG-XXX_<機能名>.md`) に従う。

構成テンプレートは [template.md](template.md) を参照。
過去の設計書の例は `docs/archive/02_designs/` を参照。

セクションは機能の規模に応じて取捨選択する。小規模な変更で不要なセクションは省略してよい。

**設計書に残すもの（構造の決定＝契約）**:
- API契約（エンドポイント・リクエスト/レスポンス構造・固定するもの）
- モジュール境界・レイヤ依存方向
- トランザクション境界・非同期方式・リトライ/冪等性方針
- 主要クラス/IFのシグネチャ（"契約"として。最小限）

**設計書から削るもの（実装詳細 = Codex の担当）**:
- 「このクラスのこのメソッドに追記」のような作業指示
- 行番号・挿入位置・差分手順
- コピペ用コード断片（IF定義の例示はOKだが最小限に）
- import 文の列挙や細かい命名規約

**混ざりやすい箇所の注意点**:

- **影響範囲**: 「何を触るか（クラス名・変更概要）」までにとどめる。「どう触るか（編集手順・差分）」は書かない
- **処理フロー**: 「箱と矢印」で登場コンポーネントと責務の流れを示す。if/for・例外の投げ方・メソッド呼び順の逐次記述は書かない

### 6. ユーザーへの報告

作成した設計書の概要を報告する:
- 設計方針の要約
- 主要な変更対象ファイル
- 設計上の判断事項や制約
