# CHG-011: 商品一覧ページネーション - 実装タスク

要件: `docs/01_requirements/CHG-011_商品一覧ページネーション.md`
設計: `docs/02_designs/CHG-011_商品一覧ページネーション.md`
作成日: 2026-02-17

検証コマンド:
- フロントエンド: `docker compose exec frontend npm run build`
- コンテナ未起動の場合: `docker compose up -d` を先に実行

---

## タスク一覧

### フロントエンド

- [ ] **T-1**: Pagination コンポーネントの新規作成

  パス: `frontend/src/components/Pagination.tsx`（新規作成）

  ```tsx
  interface PaginationProps {
    currentPage: number
    totalPages: number
    onPageChange: (page: number) => void
  }

  export default function Pagination({
    currentPage,
    totalPages,
    onPageChange,
  }: PaginationProps) {
    // 表示するページ番号を生成（現在ページの前後を含む）
    const getPageNumbers = (): (number | '...')[] => {
      const pages: (number | '...')[] = []

      if (totalPages <= 7) {
        // 7ページ以下: 全ページ表示
        for (let i = 1; i <= totalPages; i++) pages.push(i)
      } else {
        // 8ページ以上: 先頭・末尾・現在ページ周辺を表示
        pages.push(1)
        if (currentPage > 3) pages.push('...')

        const start = Math.max(2, currentPage - 1)
        const end = Math.min(totalPages - 1, currentPage + 1)
        for (let i = start; i <= end; i++) pages.push(i)

        if (currentPage < totalPages - 2) pages.push('...')
        pages.push(totalPages)
      }

      return pages
    }

    return (
      <nav className="mt-16 flex items-center justify-center gap-1" aria-label="ページネーション">
        {/* 前へ */}
        <button
          onClick={() => onPageChange(currentPage - 1)}
          disabled={currentPage <= 1}
          className="px-3 py-2 text-xs uppercase tracking-[0.2em] text-zinc-500 transition-colors hover:text-zinc-900 disabled:text-stone-300 disabled:cursor-not-allowed"
        >
          Prev
        </button>

        {/* ページ番号 */}
        {getPageNumbers().map((page, index) =>
          page === '...' ? (
            <span key={`ellipsis-${index}`} className="px-2 py-2 text-xs text-zinc-400">
              ...
            </span>
          ) : (
            <button
              key={page}
              onClick={() => onPageChange(page)}
              className={`min-w-[2.5rem] px-2 py-2 text-xs transition-colors ${
                page === currentPage
                  ? 'bg-zinc-900 text-white'
                  : 'text-zinc-500 hover:text-zinc-900'
              }`}
            >
              {page}
            </button>
          )
        )}

        {/* 次へ */}
        <button
          onClick={() => onPageChange(currentPage + 1)}
          disabled={currentPage >= totalPages}
          className="px-3 py-2 text-xs uppercase tracking-[0.2em] text-zinc-500 transition-colors hover:text-zinc-900 disabled:text-stone-300 disabled:cursor-not-allowed"
        >
          Next
        </button>
      </nav>
    )
  }
  ```

---

- [ ] **T-2**: ItemListPage をページネーション対応に書き換え

  パス: `frontend/src/pages/ItemListPage.tsx`

  **変更前（1-18行目、ファイル全体）:**

  ```tsx
  import ProductCard from '../components/ProductCard'
  import { useProducts } from '../contexts/ProductContext'

  export default function ItemListPage() {
    const { getPublishedProducts } = useProducts()
    const publishedProducts = getPublishedProducts()

    return (
      <div className="mx-auto max-w-7xl px-6 py-24">
        <h1 className="mb-12 font-serif text-3xl text-zinc-900">すべての商品</h1>
        <div className="grid gap-x-6 gap-y-12 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
          {publishedProducts.map((product) => (
            <ProductCard key={product.id} product={product} />
          ))}
        </div>
      </div>
    )
  }
  ```

  **変更後:**

  ```tsx
  import { useState, useEffect } from 'react'
  import { useSearchParams } from 'react-router'
  import ProductCard from '../components/ProductCard'
  import Pagination from '../components/Pagination'
  import * as api from '../lib/api'
  import type { Product } from '../types/api'

  const ITEMS_PER_PAGE = 12

  export default function ItemListPage() {
    const [searchParams, setSearchParams] = useSearchParams()
    const [products, setProducts] = useState<Product[]>([])
    const [total, setTotal] = useState(0)
    const [loading, setLoading] = useState(true)
    const [error, setError] = useState<string | null>(null)

    // URLからページ番号を取得（不正値は1にフォールバック）
    const currentPage = Math.max(1, parseInt(searchParams.get('page') || '1') || 1)

    const totalPages = Math.ceil(total / ITEMS_PER_PAGE)

    useEffect(() => {
      const fetchProducts = async () => {
        setLoading(true)
        setError(null)
        try {
          const response = await api.getItems(currentPage, ITEMS_PER_PAGE)
          if (response.success && response.data) {
            setProducts(response.data.items)
            setTotal(response.data.total)
          } else {
            setError('商品の取得に失敗しました')
          }
        } catch {
          setError('商品の取得中にエラーが発生しました')
        } finally {
          setLoading(false)
        }
      }
      fetchProducts()
    }, [currentPage])

    const handlePageChange = (page: number) => {
      if (page === 1) {
        setSearchParams({})
      } else {
        setSearchParams({ page: String(page) })
      }
      window.scrollTo({ top: 0, behavior: 'smooth' })
    }

    if (loading) {
      return (
        <div className="mx-auto max-w-7xl px-6 py-24">
          <h1 className="mb-12 font-serif text-3xl text-zinc-900">すべての商品</h1>
          <p className="text-sm text-zinc-500">読み込み中...</p>
        </div>
      )
    }

    if (error) {
      return (
        <div className="mx-auto max-w-7xl px-6 py-24">
          <h1 className="mb-12 font-serif text-3xl text-zinc-900">すべての商品</h1>
          <p className="text-sm text-zinc-500">{error}</p>
        </div>
      )
    }

    return (
      <div className="mx-auto max-w-7xl px-6 py-24">
        <h1 className="mb-12 font-serif text-3xl text-zinc-900">すべての商品</h1>
        <div className="grid gap-x-6 gap-y-12 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
          {products.map((product) => (
            <ProductCard key={product.id} product={product} />
          ))}
        </div>
        {totalPages > 1 && (
          <Pagination
            currentPage={currentPage}
            totalPages={totalPages}
            onPageChange={handlePageChange}
          />
        )}
      </div>
    )
  }
  ```

  **変更点まとめ:**
  - `ProductContext` 依存を削除し、コンポーネント内で直接 `api.getItems()` を呼び出す方式に変更
  - `useSearchParams` でURLクエリパラメータ `?page=N` と連動
  - ローディング状態・エラー状態をローカルstateで管理
  - `totalPages > 1` の場合のみ `Pagination` コンポーネントを表示
  - ページ1の場合は `?page=1` を付けずクリーンなURLを維持

---

## 実装順序

```
T-1（Pagination コンポーネント新規作成）
  → T-2（ItemListPage 書き換え — T-1で作成したコンポーネントをimport）
```

---

## テスト手順

実装後に以下を手動確認:

1. `http://localhost:5173/item` にアクセス → 商品一覧が表示される
2. 商品が12件を超える場合、ページネーションUIが表示される
3. 商品が12件以下の場合、ページネーションUIが表示されない
4. 「Next」クリック → 2ページ目の商品が表示され、URLが `/item?page=2` になる
5. 「Prev」クリック → 1ページ目に戻り、URLが `/item` になる（`?page=1` は付かない）
6. 1ページ目で「Prev」ボタンが無効化されている
7. 最終ページで「Next」ボタンが無効化されている
8. `/item?page=2` に直接アクセス → 2ページ目が表示される
9. `/item?page=0`, `/item?page=abc`, `/item?page=999` → 1ページ目が表示される
10. ブラウザの戻る/進むボタンでページ遷移が正しく動作する
11. ページ切り替え時に「読み込み中...」が表示される
12. ページ切り替え後にスクロールがトップに戻る
13. 商品カードクリック → 商品詳細画面への遷移が正常に動作する


## Review Packet
### 変更サマリ（10行以内）
- `frontend/src/components/Pagination.tsx` を新規作成し、ページ番号生成（省略記号含む）と Prev/Next の有効・無効制御を実装
- `frontend/src/pages/ItemListPage.tsx` を `ProductContext` 依存から `api.getItems(page, limit)` 直接取得へ変更
- `useSearchParams` で `?page=` と同期し、1ページ目は `/item`（`?page=1` なし）を維持
- ローディング表示（`読み込み中...`）とエラー表示をローカル state で追加
- `totalPages > 1` の場合のみ `Pagination` を表示する条件分岐を追加

### 変更ファイル一覧
- `frontend/src/components/Pagination.tsx`
- `frontend/src/pages/ItemListPage.tsx`
- `docs/03_tasks/CHG-011_商品一覧ページネーション.md`

### リスクと未解決
- `docker compose` の実サービス名は `frontend` ではなく `frontend-customer` / `frontend-admin` のため、task.md 冒頭の build コマンドはそのままだと失敗する
- `api.getItems()` が返す `data.total` が「全件数」ではなく「そのページの件数」の挙動だと、商品総数が12件超でも `totalPages` が1になりページネーション UI が表示されない

### テスト結果
- ✅ PASS `docker compose up -d`
- ❌ FAIL `docker compose exec frontend npm run build`
  - 核心ログ: `service "frontend" is not running`
- ✅ PASS `docker compose exec frontend-customer npm run build`
- ✅ PASS `docker compose exec frontend-admin npm run build`
- ✅ PASS `docker compose exec frontend-customer sh -lc 'cd /app/frontend && node tmp/chg011_pagination_check.mjs'`
  - 結果概要: `SUMMARY total=13 pass=13 fail=0 totalProducts=5 totalPages=1`
  - 補足: データ件数5件のため、手動シナリオ 2/4/5/6/7/8/10/11/12 は前提未充足（N/A）
