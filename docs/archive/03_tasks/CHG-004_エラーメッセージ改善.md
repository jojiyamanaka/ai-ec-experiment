# CHG-004: エラーメッセージ改善 - 実装タスク

## 検証コマンド

```bash
# フロントエンド開発サーバー起動
cd frontend
npm run dev

# 型チェック
npm run build

# Lint
npm run lint
```

## 検証シナリオ

1. **在庫不足エラー**: カートで数量を在庫以上に増やす → 「在庫が不足しています。数量を減らしてお試しください。」
2. **非公開商品エラー**: 非公開商品をカートに追加 → 「この商品は現在購入できません。カートから削除してください。」
3. **カート情報エラー**: セッションをクリアしてカート操作 → 「カート情報が見つかりませんでした。ページを更新してください。」
4. **ネットワークエラー**: バックエンド停止状態でカート操作 → 「ネットワークエラーが発生しました。接続を確認してもう一度お試しください。」

---

## タスク1: エラーメッセージマッピングモジュールの作成

### ファイル: `src/lib/errorMessages.ts`（新規作成）

全体を新規作成する。

```typescript
/**
 * エラーメッセージマッピング
 * バックエンドのエラーコードをユーザーフレンドリーなメッセージに変換する
 */

interface ErrorMessageConfig {
  message: string
  action?: string
}

const ERROR_MESSAGES: Record<string, ErrorMessageConfig> = {
  // ネットワーク・システムエラー
  NETWORK_ERROR: {
    message: 'ネットワークエラーが発生しました',
    action: '接続を確認してもう一度お試しください',
  },
  INTERNAL_ERROR: {
    message: '一時的なエラーが発生しました',
    action: 'しばらくしてからもう一度お試しください',
  },
  INVALID_REQUEST: {
    message: '無効なリクエストです',
    action: '入力内容を確認してください',
  },

  // カート関連
  CART_NOT_FOUND: {
    message: 'カート情報が見つかりませんでした',
    action: 'ページを更新してください',
  },
  CART_EMPTY: {
    message: 'カートに商品がありません',
    action: '商品を追加してください',
  },
  RESERVATION_NOT_FOUND: {
    message: 'カート情報が見つかりませんでした',
    action: 'ページを更新してください',
  },
  NO_RESERVATIONS: {
    message: 'カート情報が見つかりませんでした',
    action: 'ページを更新してください',
  },

  // 商品関連
  ITEM_NOT_FOUND: {
    message: '商品が見つかりませんでした',
  },
  ITEM_NOT_AVAILABLE: {
    message: 'この商品は現在購入できません',
    action: 'カートから削除してください',
  },

  // 在庫関連
  OUT_OF_STOCK: {
    message: '在庫が不足している商品があります',
    action: '数量を調整してください',
  },
  INSUFFICIENT_STOCK: {
    message: '在庫が不足しています',
    action: '数量を減らしてお試しください',
  },
  INVALID_QUANTITY: {
    message: '数量が無効です',
    action: '1〜9の範囲で指定してください',
  },

  // 注文関連
  ORDER_NOT_FOUND: {
    message: '注文が見つかりませんでした',
  },
  ORDER_NOT_CANCELLABLE: {
    message: 'この注文はキャンセルできません',
  },
  ALREADY_CANCELLED: {
    message: 'この注文は既にキャンセルされています',
  },
  INVALID_STATUS_TRANSITION: {
    message: '操作を実行できませんでした',
  },
}

/**
 * エラーコードからユーザーフレンドリーなメッセージを取得
 * @param errorCode - バックエンドから返されたエラーコード
 * @returns ユーザー向けエラーメッセージ
 */
export function getUserFriendlyMessage(errorCode: string): string {
  const config = ERROR_MESSAGES[errorCode]

  if (!config) {
    return '操作に失敗しました。もう一度お試しください。'
  }

  // アクションガイダンスがある場合は結合
  if (config.action) {
    return `${config.message}。${config.action}。`
  }

  return config.message
}

/**
 * エラーコードとアクションを個別に取得
 * UI側でメッセージとアクションを別々に表示したい場合に使用
 * @param errorCode - バックエンドから返されたエラーコード
 * @returns メッセージとアクションを含むオブジェクト
 */
export function getErrorMessageWithAction(errorCode: string): {
  message: string
  action?: string
} {
  const config = ERROR_MESSAGES[errorCode]

  if (!config) {
    return {
      message: '操作に失敗しました',
      action: 'もう一度お試しください',
    }
  }

  return {
    message: config.message,
    action: config.action,
  }
}
```

### 検証

- ファイルが作成されていることを確認
- 型エラーがないことを確認（`npm run build`）

---

## タスク2: CartContext の変更

### ファイル: `src/contexts/CartContext.tsx`

#### 変更1: import の追加

**挿入位置**: ファイル冒頭の import セクション（`import * as api from '../lib/api'` の次の行）

**追加コード**:
```typescript
import { getUserFriendlyMessage } from '../lib/errorMessages'
```

#### 変更2: `refreshCart` 関数のエラーハンドリング

**対象箇所**: `refreshCart` 関数内、`setError` を呼び出している行

**変更前** (42行目付近):
```typescript
      } else {
        setError(response.error?.message || 'カートの取得に失敗しました')
      }
```

**変更後**:
```typescript
      } else {
        const message = response.error?.code
          ? getUserFriendlyMessage(response.error.code)
          : 'カートの取得に失敗しました'
        setError(message)
      }
```

#### 変更3: `addToCart` 関数のエラーハンドリング

**対象箇所**: `addToCart` 関数内、`throw new Error` を呼び出している行

**変更前** (71行目付近):
```typescript
      } else {
        throw new Error(response.error?.message || 'カートへの追加に失敗しました')
      }
```

**変更後**:
```typescript
      } else {
        const message = response.error?.code
          ? getUserFriendlyMessage(response.error.code)
          : 'カートへの追加に失敗しました'
        throw new Error(message)
      }
```

#### 変更4: `removeFromCart` 関数のエラーハンドリング

**対象箇所**: `removeFromCart` 関数内、`throw new Error` を呼び出している行

**変更前** (93行目付近):
```typescript
      } else {
        throw new Error(response.error?.message || 'カートからの削除に失敗しました')
      }
```

**変更後**:
```typescript
      } else {
        const message = response.error?.code
          ? getUserFriendlyMessage(response.error.code)
          : 'カートからの削除に失敗しました'
        throw new Error(message)
      }
```

#### 変更5: `updateQuantity` 関数のエラーハンドリング

**対象箇所**: `updateQuantity` 関数内、`throw new Error` を呼び出している行

**変更前** (123行目付近):
```typescript
      } else {
        throw new Error(response.error?.message || '数量の変更に失敗しました')
      }
```

**変更後**:
```typescript
      } else {
        const message = response.error?.code
          ? getUserFriendlyMessage(response.error.code)
          : '数量の変更に失敗しました'
        throw new Error(message)
      }
```

### 検証

- 型エラーがないことを確認
- カート操作で技術用語（「仮引当」など）が表示されないことを確認

---

## タスク3: OrderConfirmPage の変更

### ファイル: `src/pages/OrderConfirmPage.tsx`

#### 変更1: import の追加

**挿入位置**: ファイル冒頭の import セクション（`import type { ApiError, ... } from '../types/api'` の次の行）

**追加コード**:
```typescript
import { getUserFriendlyMessage } from '../lib/errorMessages'
```

#### 変更2: エラーメッセージ表示部分

**対象箇所**: エラー表示の `<h3>` タグ（176行目付近）

**変更前**:
```typescript
              <h3 className="font-medium text-red-800">{error.message}</h3>
```

**変更後**:
```typescript
              <h3 className="font-medium text-red-800">
                {getUserFriendlyMessage(error.code)}
              </h3>
```

### 検証

- 型エラーがないことを確認
- 注文確定時のエラーメッセージが改善されていることを確認
- `details` フィールドの表示は維持されていることを確認

---

## タスク4: ProductContext の変更

### ファイル: `src/contexts/ProductContext.tsx`

#### 変更1: import の追加

**挿入位置**: ファイル冒頭の import セクション（`import * as api from '../lib/api'` の次の行）

**追加コード**:
```typescript
import { getUserFriendlyMessage } from '../lib/errorMessages'
```

#### 変更2: `refreshProducts` 関数のエラーハンドリング

**対象箇所**: `refreshProducts` 関数内、`setError` を呼び出している行

**変更前** (31行目付近):
```typescript
      } else {
        setError(response.error?.message || '商品の取得に失敗しました')
      }
```

**変更後**:
```typescript
      } else {
        const message = response.error?.code
          ? getUserFriendlyMessage(response.error.code)
          : '商品の取得に失敗しました'
        setError(message)
      }
```

#### 変更3: `updateProduct` 関数のエラーハンドリング

**対象箇所**: `updateProduct` 関数内、`throw new Error` を呼び出している行

**変更前** (63行目付近):
```typescript
      } else {
        throw new Error(response.error?.message || '商品の更新に失敗しました')
      }
```

**変更後**:
```typescript
      } else {
        const message = response.error?.code
          ? getUserFriendlyMessage(response.error.code)
          : '商品の更新に失敗しました'
        throw new Error(message)
      }
```

### 検証

- 型エラーがないことを確認
- 商品取得・更新時のエラーメッセージが改善されていることを確認

---

## タスク5: 動作検証

### 検証項目

#### 1. 在庫不足エラー（INSUFFICIENT_STOCK）

**操作**:
1. カートに商品を追加
2. 数量を在庫数以上に変更

**期待結果**:
- エラーメッセージ: 「在庫が不足しています。数量を減らしてお試しください。」
- 「仮引当」などの技術用語が表示されない

#### 2. カート情報エラー（RESERVATION_NOT_FOUND / NO_RESERVATIONS）

**操作**:
1. ブラウザの開発者ツールで localStorage をクリア
2. カート操作を実行

**期待結果**:
- エラーメッセージ: 「カート情報が見つかりませんでした。ページを更新してください。」
- 「仮引当が存在しません」が表示されない

#### 3. 非公開商品エラー（ITEM_NOT_AVAILABLE）

**操作**:
1. 管理画面で商品を非公開に設定
2. カートに残っている非公開商品で注文を試みる

**期待結果**:
- エラーメッセージ: 「この商品は現在購入できません。カートから削除してください。」
- 詳細情報（商品名リスト）が表示される

#### 4. ネットワークエラー（NETWORK_ERROR）

**操作**:
1. バックエンドを停止
2. カート操作を実行

**期待結果**:
- エラーメッセージ: 「ネットワークエラーが発生しました。接続を確認してもう一度お試しください。」

#### 5. 一貫性確認

**操作**:
- 同じエラーコードを異なる画面（CartPage, OrderConfirmPage）で発生させる

**期待結果**:
- どの画面でも同じメッセージが表示される

### 検証完了条件

- [ ] すべてのエラーコードで技術用語が排除されている
- [ ] アクションガイダンスが適切に表示されている
- [ ] 型チェック・Lintがパスする
- [ ] 詳細情報（details）が正しく表示される
- [ ] 同じエラーコードは一貫したメッセージを表示する

---

## 参考情報

### 既存実装

- **OrderConfirmPage の詳細情報表示**: `src/pages/OrderConfirmPage.tsx` 177-209行目
- **API エラーレスポンス型**: `src/types/api.ts` 54-66行目
- **エラーコード一覧**: `docs/ui/api-spec.md` 800-822行目

### 挿入位置のランドマーク

- **CartContext**: 各関数名（`refreshCart`, `addToCart`, `removeFromCart`, `updateQuantity`）
- **OrderConfirmPage**: エラー表示の `<h3>` タグ

### フォールバック処理

エラーコードが `undefined` または未定義の場合、以下のフォールバックメッセージを使用:
- `getUserFriendlyMessage()`: 「操作に失敗しました。もう一度お試しください。」
- Context 層の各関数: 関数ごとの固有メッセージ（「カートへの追加に失敗しました」など）
