# BUG-01: 顧客画面/管理画面のドメイン分離（localhost:5173 / localhost:5174） - 実装タスク

## 前提条件

- 技術設計: `docs/02_designs/BUG-01_ドメイン分離_5173_5174.md` が確定済み
- 本タスクは最小スコープ（画面公開面の分離）に限定する
- BFF 導入（CHG-010）は本タスクの対象外

---

## 検証コマンド

```bash
# frontend（顧客）
cd frontend
npm run dev:customer

# frontend（管理）
cd frontend
npm run dev:admin

# backend
cd backend
./mvnw spring-boot:run

# CORS確認（Origin 5173）
curl -i http://localhost:8080/api/item \
  -H "Origin: http://localhost:5173"

# CORS確認（Origin 5174）
curl -i http://localhost:8080/api/bo-auth/me \
  -H "Origin: http://localhost:5174"
```

---

## タスク一覧

### T-1: フロントエンド起動モードを分離する（customer/admin）

**目的**: 単一ソースのまま 2 つの開発サーバー（5173 / 5174）を起動可能にする。

**実装内容**:

1. `frontend/package.json` に以下の scripts を追加
   - `dev:customer`
   - `dev:admin`
2. `frontend/vite.config.ts` で `mode` に応じて port を切り替える
   - customer: `5173`
   - admin: `5174`
3. 必要に応じて `.env.customer` / `.env.admin` を追加し、`VITE_APP_MODE` を定義

**完了条件**:

- `npm run dev:customer` で `http://localhost:5173` が起動する
- `npm run dev:admin` で `http://localhost:5174` が起動する

---

### T-2: 画面ルーティングをモード別に分離する

**目的**: 顧客画面ビルドから管理画面ルートを除外し、管理画面ビルドから顧客画面ルートを除外する。

**実装内容**:

1. `frontend/src/App.tsx` で `VITE_APP_MODE` を参照し、ルート定義を分岐
2. customer モードでは管理画面ルート（`/bo/*`）を定義しない
3. admin モードでは顧客画面ルートを定義しない（必要最小限: ログイン + 管理画面）
4. customer モードの `Layout` から管理画面リンクを削除する

**完了条件**:

- `http://localhost:5173/bo/item` が表示されない（404/Not Found になる）
- `http://localhost:5174` で管理画面導線のみ利用できる

---

### T-3: APIクライアントの認証文脈を URL 依存からモード依存へ変更する

**目的**: `window.location.pathname.startsWith('/bo')` 依存を廃止し、ドメイン分離後も正しくトークンを送信する。

**実装内容**:

1. `frontend/src/lib/api.ts` の認証ヘッダー付与ロジックを整理
2. `VITE_APP_MODE` を基準に customer/bo の送信トークンを決定
3. 管理機能 API（商品更新、注文管理、在庫管理、会員管理）は bo トークンを必ず使用する
4. 顧客機能 API は authToken を使用する

**完了条件**:

- 管理画面（5174）からの管理 API 呼び出しが 401 にならない
- 顧客画面（5173）から管理 API へ誤って bo トークンが付与されない

---

### T-4: バックエンド CORS を 2 オリジン対応にする

**目的**: `http://localhost:5173` と `http://localhost:5174` の双方から API アクセス可能にする。

**実装内容**:

1. `backend/src/main/resources/application.yml` の `app.cors.allowed-origins` に `http://localhost:5174` を追加
2. `backend/src/main/java/com/example/aiec/config/WebConfig.java` の CORS 設定が上記 2 オリジンを許可することを確認
3. 既存の `/api/bo/**` no-store ヘッダー付与は維持する

**完了条件**:

- 5173/5174 いずれの Origin でも CORS エラーが発生しない

---

### T-5: Docker Compose のフロントエンドサービスを 2 系統化する

**目的**: ローカル開発で顧客画面/管理画面を同時起動できるようにする。

**実装内容**:

1. `docker-compose.yml` の `frontend` サービスを以下へ分割
   - `frontend-customer`（5173）
   - `frontend-admin`（5174）
2. 両サービスで起動コマンドを分ける
   - customer: `npm run dev:customer`
   - admin: `npm run dev:admin`
3. 必要な環境変数（`VITE_APP_MODE` 等）をサービスごとに設定

**完了条件**:

- `docker compose up` 後に 5173/5174 の両方へアクセスできる

---

## テスト内容

1. 顧客画面（5173）
   - 商品一覧、商品詳細、カート、注文作成、注文履歴
2. 管理画面（5174）
   - Boログイン、商品更新、注文管理、在庫管理、会員管理
3. 誤アクセス
   - 5173 側で管理画面 URL を開けないこと
   - 顧客トークンで `/api/bo/**` を叩くと 401/403 になること
4. CORS
   - 5173/5174 の両方で API 通信が成功すること

---

## 想定工数

- 実装: 1.5 〜 3.0 人日
- 検証: 0.5 〜 1.0 人日
- 合計: 2 〜 4 人日

