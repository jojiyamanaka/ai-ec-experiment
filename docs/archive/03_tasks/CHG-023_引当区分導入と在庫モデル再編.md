# CHG-023: å¼•å½“åŒºåˆ†å°å…¥ã¨åœ¨åº«ãƒ¢ãƒ‡ãƒ«å†ç·¨ - å®Ÿè£…ã‚¿ã‚¹ã‚¯

è¦ä»¶: `docs/01_requirements/CHG-023_å¼•å½“åŒºåˆ†å°å…¥ã¨åœ¨åº«ãƒ¢ãƒ‡ãƒ«å†ç·¨.md`
è¨­è¨ˆ: `docs/02_designs/CHG-023_å¼•å½“åŒºåˆ†å°å…¥ã¨åœ¨åº«ãƒ¢ãƒ‡ãƒ«å†ç·¨.md`
ä½œæˆæ—¥: 2026-02-20

---

## ã‚¿ã‚¹ã‚¯ä¸€è¦§

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

- [x] **T-1** `[CONTRACT]`: Flyway V11 ã‚’è¿½åŠ ã—ã€`allocation_type`ãƒ»`location_stocks`ãƒ»`sales_limits`ãƒ»`order_items.allocated_qty` ã‚’å°å…¥ã™ã‚‹

  è§¦ã‚‹ç¯„å›²: `backend/src/main/resources/db/flyway / V11__introduce_allocation_type_and_stock_models.sql`

  Done: `docker compose up -d backend && docker compose logs backend | rg "V11__introduce_allocation_type_and_stock_models|Successfully applied"` ã§ Flyway V11 ã®é©ç”¨ã‚’ç¢ºèªã§ãã‚‹ã“ã¨

  > ğŸ“ ã‚²ãƒ¼ãƒˆé«˜ã€‚Codex ã¯ review-noteï¼ˆDDLåˆ¶ç´„ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ åˆ¤æ–­ï¼‰ã‚’ `docs/archive/04_review-note/CHG-023.md` ã® `## T-1` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½è¨˜ã—ã€è¿½åŠ æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã€‚

---

- [x] **T-2** `[CONTRACT]`: Product/Inventory ã® API å¥‘ç´„ã‚’æ›´æ–°ã—ã€`stock` éä¾å­˜åŒ–ã¨åœ¨åº«ã‚¿ãƒ– APIï¼ˆ`/api/bo/admin/items/{id}/inventory`ï¼‰ã‚’å®Ÿè£…ã™ã‚‹

  è§¦ã‚‹ç¯„å›²: `backend/src/main/java/com/example/aiec/modules/product / domain/entity, application/port, adapter/rest`ã€`backend/src/main/java/com/example/aiec/modules/inventory / adapter/rest, application/usecase`

  Done: `cd backend && ./mvnw test -Dtest=ProductControllerContractTest,BoAdminProductControllerContractTest,InventoryUseCaseTest` ãŒé€šã‚‹ã“ã¨

  âš ï¸ å½±éŸ¿: Productç³»ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¥‘ç´„ã‹ã‚‰ `stock` ã‚’å‰Šé™¤ã™ã‚‹ãŸã‚ã€BFF ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã® DTO/å‹æ›´æ–°ã‚’åŒä¸€ãƒªãƒªãƒ¼ã‚¹ã§å®Ÿæ–½ã™ã‚‹ã“ã¨ã€‚

  > ğŸ“ ã‚²ãƒ¼ãƒˆé«˜ã€‚Codex ã¯ review-noteï¼ˆå¥‘ç´„å·®åˆ†ã€`effectiveStock` ç®—å‡ºè²¬å‹™ã€`stock` å»ƒæ­¢äº’æ›ã®æ‰±ã„ï¼‰ã‚’ `docs/archive/04_review-note/CHG-023.md` ã® `## T-2` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½è¨˜ã—ã€è¿½åŠ æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã€‚

---

- [x] **T-3** `[ARCH]`: æ åœ¨åº«å•†å“ã®éåŒæœŸæœ¬å¼•å½“ï¼ˆ`ORDER_PLACED` / `STOCK_AVAILABILITY_INCREASED`ï¼‰ã‚’å®Ÿè£…ã—ã€FIFOãƒ»éƒ¨åˆ†å¼•å½“ãƒ»å†ªç­‰æ›´æ–°ã‚’æˆç«‹ã•ã›ã‚‹

  è§¦ã‚‹ç¯„å›²: `backend/src/main/java/com/example/aiec/modules/inventory / application/service/FrameAllocationService.java, application/usecase/InventoryUseCase.java`ã€`backend/src/main/java/com/example/aiec/modules/shared/outbox/handler / FrameAllocationOutboxHandler.java`

  Done: `cd backend && ./mvnw test -Dtest=FrameAllocationServiceTest,OrderUseCaseOutboxTest,OutboxProcessorTest` ãŒé€šã‚‹ã“ã¨

  > ğŸ“ ã‚²ãƒ¼ãƒˆé«˜ã€‚Codex ã¯ review-noteï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã€`SELECT ... FOR UPDATE`ã€é‡è¤‡ã‚¤ãƒ™ãƒ³ãƒˆæ™‚ã®å˜èª¿å¢—åŠ åˆ¶å¾¡ï¼‰ã‚’ `docs/archive/04_review-note/CHG-023.md` ã® `## T-3` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½è¨˜ã—ã€è¿½åŠ æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã€‚

---

- [x] **T-4** `[ARCH]`: æ³¨æ–‡ç³»ã‚’ `allocated_qty` ãƒ™ãƒ¼ã‚¹ã¸å†ç·¨ã—ã€å‡ºè·çµ±åˆ¶ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«è§£æ”¾ãƒ»æ‰‹å‹•å†è©¦è¡Œ API ã‚’å®Ÿè£…ã™ã‚‹

  è§¦ã‚‹ç¯„å›²: `backend/src/main/java/com/example/aiec/modules/purchase / application/usecase/OrderUseCase.java, application/job/CreateShipmentJob.java, adapter/rest/OrderController.java, order/entity/OrderItem.java`

  Done: `cd backend && ./mvnw test -Dtest=OrderUseCaseStateTransitionTest,CreateShipmentJobTest,OrderControllerContractTest` ãŒé€šã‚‹ã“ã¨

  > ğŸ“ ã‚²ãƒ¼ãƒˆé«˜ã€‚Codex ã¯ review-noteï¼ˆ`SHIPPED` é·ç§»åˆ¶ç´„ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®å‰¯ä½œç”¨å¢ƒç•Œã€`allocation/retry` ã® no-op å¥‘ç´„ï¼‰ã‚’ `docs/archive/04_review-note/CHG-023.md` ã® `## T-4` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½è¨˜ã—ã€è¿½åŠ æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã€‚

---

- [x] **T-5** `[SAFE]`: `products.stock` æ¥­å‹™å‚ç…§ç¦æ­¢ã®é™çš„æ¤œæŸ»ã¨å¼•å½“æ•´åˆæ€§æ¤œè¨¼ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ã™ã‚‹

  è§¦ã‚‹ç¯„å›²: `backend/src/test/java/com/example/aiec/architecture / ProductStockAccessArchUnitTest.java`ã€`backend/src/main/java/com/example/aiec/modules/inventory/application/job / AllocationConsistencyCheckJob.java`

  Done: `cd backend && ./mvnw test -Dtest=ProductStockAccessArchUnitTest,AllocationConsistencyCheckJobTest` ãŒé€šã‚‹ã“ã¨

---

### BFF

- [x] **T-6** `[CONTRACT]`: Customer BFF ã§ `allocationType` / `effectiveStock` ã¨æ³¨æ–‡é€²æ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ Core API ã‹ã‚‰é€éã—ã€åœ¨åº«çŠ¶æ…‹åˆ¤å®šã‚’ `effectiveStock` åŸºæº–ã¸çµ±ä¸€ã™ã‚‹

  è§¦ã‚‹ç¯„å›²: `bff/customer-bff/src/products / products.service.ts`ã€`bff/customer-bff/src/orders / orders.service.ts`

  Done: `cd bff/customer-bff && npm run build` ãŒé€šã‚‹ã“ã¨

  > ğŸ“ ã‚²ãƒ¼ãƒˆé«˜ã€‚Codex ã¯ review-noteï¼ˆCoreå¥‘ç´„ã®é€éç¯„å›²ã€åœ¨åº«çŠ¶æ…‹è¨ˆç®—ã®è²¬å‹™å¢ƒç•Œï¼‰ã‚’ `docs/archive/04_review-note/CHG-023.md` ã® `## T-6` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½è¨˜ã—ã€è¿½åŠ æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã€‚

---

- [x] **T-7** `[CONTRACT]`: BackOffice BFF ã«åœ¨åº«ã‚¿ãƒ– API ã¨æœ¬å¼•å½“å†è©¦è¡Œ API ã‚’è¿½åŠ ã—ã€æ³¨æ–‡é€²æ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é€éã™ã‚‹

  è§¦ã‚‹ç¯„å›²: `bff/backoffice-bff/src/products / products.controller.ts, products.service.ts`ã€`bff/backoffice-bff/src/orders / orders.controller.ts, orders.service.ts`

  Done: `cd bff/backoffice-bff && npm run build` ãŒé€šã‚‹ã“ã¨

  > ğŸ“ ã‚²ãƒ¼ãƒˆé«˜ã€‚Codex ã¯ review-noteï¼ˆç®¡ç†å‘ã‘ API å¥‘ç´„å·®åˆ†ã€æ—¢å­˜ `/api/inventory*` äº’æ›ç¶­æŒæ–¹é‡ï¼‰ã‚’ `docs/archive/04_review-note/CHG-023.md` ã® `## T-7` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½è¨˜ã—ã€è¿½åŠ æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã€‚

---

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

- [x] **T-8** `[CONTRACT]`: FSD ã® product/order ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‹ã¨ API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æ›´æ–°ã—ã€`stock` ä¾å­˜ã‚’é™¤å»ã—ã¦ `allocationType` / `effectiveStock` / é€²æ—é …ç›®ã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹

  è§¦ã‚‹ç¯„å›²: `frontend/src/entities/product/model / types.ts, api.ts, ProductContext.tsx`ã€`frontend/src/entities/order/model / types.ts, api.ts`

  Done: `npm run build --prefix frontend` ãŒé€šã‚‹ã“ã¨

  > ğŸ“ ã‚²ãƒ¼ãƒˆé«˜ã€‚Codex ã¯ review-noteï¼ˆå‹å¥‘ç´„å¤‰æ›´ã€æ—¢å­˜ UI ã¸ã®ä¼æ’­ç¯„å›²ï¼‰ã‚’ `docs/archive/04_review-note/CHG-023.md` ã® `## T-8` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½è¨˜ã—ã€è¿½åŠ æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã€‚

---

- [x] **T-9** `[CONTRACT]`: ç®¡ç†ç”»é¢ã®å•†å“è©³ç´°ã‚’ 3 ã‚¿ãƒ–ï¼ˆå•†å“/åœ¨åº«/è²©å£²ï¼‰ã¸å†ç·¨ã—ã€`/bo/inventory` ã®ãƒ«ãƒ¼ã‚¿ãƒ¼ãƒ»ã‚µã‚¤ãƒ‰ãƒãƒ¼å°ç·šã‚’å‰Šé™¤ã™ã‚‹

  è§¦ã‚‹ç¯„å›²: `frontend/src/pages/admin/AdminItemPage / index.tsx`ã€`frontend/src/app/router / admin.tsx`ã€`frontend/src/widgets/AdminSidebar / AdminSidebar.tsx`

  Done: `npm run build --prefix frontend && cd frontend && bash ./e2e/admin-smoke.sh` ãŒé€šã‚‹ã“ã¨

  âš ï¸ å½±éŸ¿: `/bo/inventory` å°ç·šå‰Šé™¤ã«ã‚ˆã‚Šã€ç®¡ç†ç”»é¢ã®é·ç§»å°ç·šãƒ»E2Eã‚·ãƒŠãƒªã‚ªãƒ»é‹ç”¨æ‰‹é †ã®æ›´æ–°ã‚’åŒæ™‚å®Ÿæ–½ã™ã‚‹ã“ã¨ã€‚

  > ğŸ“ ã‚²ãƒ¼ãƒˆé«˜ã€‚Codex ã¯ review-noteï¼ˆå°ç·šå‰Šé™¤ã®å½±éŸ¿ç¯„å›²ã€åœ¨åº«æ›´æ–°è²¬å‹™ã®é›†ç´„åˆ¤æ–­ï¼‰ã‚’ `docs/archive/04_review-note/CHG-023.md` ã® `## T-9` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½è¨˜ã—ã€è¿½åŠ æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã€‚

---

- [x] **T-10** `[SAFE]`: æ³¨æ–‡ä¸€è¦§/è©³ç´°ã«å¼•å½“é€²æ—ï¼ˆ`allocatedQuantity / orderedQuantity`ï¼‰ã‚’è¡¨ç¤ºã—ã€é¡§å®¢ãƒ»ç®¡ç†ã®åŒæ–¹ã§æ•´åˆã•ã›ã‚‹

  è§¦ã‚‹ç¯„å›²: `frontend/src/pages/admin/AdminOrderPage / index.tsx`ã€`frontend/src/pages/customer/OrderHistoryPage / index.tsx`ã€`frontend/src/pages/customer/OrderDetailPage / index.tsx`

  Done: `npm run build --prefix frontend && cd frontend && bash ./e2e/customer-smoke.sh && bash ./e2e/admin-smoke.sh` ãŒé€šã‚‹ã“ã¨

---

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [x] **T-11** `[CONTRACT]`: ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ãƒ»ä»•æ§˜æ›¸ãƒ»OpenAPI ã‚’ CHG-023 å¥‘ç´„ã¸æ›´æ–°ã—ã€åœ¨åº«æºæ³‰åˆ†é›¢ãƒ»é€²æ—é …ç›®ãƒ»å†è©¦è¡Œ API ã‚’åæ˜ ã™ã‚‹

  è§¦ã‚‹ç¯„å›²: `docs/data-model.md`ã€`docs/specs/inventory.md`ã€`docs/specs/order.md`ã€`docs/specs/product.md`ã€`docs/ui/admin-ui.md`ã€`docs/api/openapi.json`ã€`docs/api/customer-bff-openapi.json`ã€`docs/api/backoffice-bff-openapi.json`

  Done: `rg -n "allocationType|effectiveStock|location_stocks|sales_limits|allocatedQuantity|orderedQuantity|allocation/retry|products\\.stock" docs/data-model.md docs/specs/inventory.md docs/specs/order.md docs/specs/product.md docs/ui/admin-ui.md docs/api/openapi.json docs/api/customer-bff-openapi.json docs/api/backoffice-bff-openapi.json` ã§åæ˜ ç®‡æ‰€ã‚’ç¢ºèªã§ãã‚‹ã“ã¨

  > ğŸ“ ã‚²ãƒ¼ãƒˆé«˜ã€‚Codex ã¯ review-noteï¼ˆå¥‘ç´„æ–‡è¨€çµ±ä¸€ã€æ—§ `stock` è¡¨è¨˜ã®æ‰±ã„ï¼‰ã‚’ `docs/archive/04_review-note/CHG-023.md` ã® `## T-11` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½è¨˜ã—ã€è¿½åŠ æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã€‚

---

## å®Ÿè£…é †åº

```
T-1 â†’ T-2 â†’ T-3 â†’ T-4 â†’ T-5 â†’ T-6 â†’ T-7 â†’ T-8 â†’ T-9 â†’ T-10 â†’ T-11
```

---

## æ¤œè¨¼

### Per-task æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰

```bash
# Backend
docker compose up -d backend && docker compose logs backend | rg "V11__introduce_allocation_type_and_stock_models|Successfully applied"
cd backend && ./mvnw test -Dtest=ProductControllerContractTest,BoAdminProductControllerContractTest,InventoryUseCaseTest
cd backend && ./mvnw test -Dtest=FrameAllocationServiceTest,OrderUseCaseOutboxTest,OutboxProcessorTest
cd backend && ./mvnw test -Dtest=OrderUseCaseStateTransitionTest,CreateShipmentJobTest,OrderControllerContractTest
cd backend && ./mvnw test -Dtest=ProductStockAccessArchUnitTest,AllocationConsistencyCheckJobTest

# BFF
cd bff/customer-bff && npm run build
cd bff/backoffice-bff && npm run build

# Frontend
npm run build --prefix frontend
npm run build --prefix frontend && cd frontend && bash ./e2e/admin-smoke.sh
npm run build --prefix frontend && cd frontend && bash ./e2e/customer-smoke.sh && bash ./e2e/admin-smoke.sh

# Docs
rg -n "allocationType|effectiveStock|location_stocks|sales_limits|allocatedQuantity|orderedQuantity|allocation/retry|products\\.stock" \
  docs/data-model.md \
  docs/specs/inventory.md \
  docs/specs/order.md \
  docs/specs/product.md \
  docs/ui/admin-ui.md \
  docs/api/openapi.json \
  docs/api/customer-bff-openapi.json \
  docs/api/backoffice-bff-openapi.json
```

### Final Gateï¼ˆå…¨ã‚¿ã‚¹ã‚¯å®Œäº†å¾Œã«å¿…ãšå®Ÿè¡Œã—ã€çµæœã‚’ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«è²¼ã‚Šä»˜ã‘ã‚‹ã“ã¨ï¼‰

```bash
# å¤‰æ›´å¯¾è±¡ã‚³ãƒ³ãƒ†ãƒŠã®å†ãƒ“ãƒ«ãƒ‰ï¼ˆå¿…é ˆï¼‰
docker compose build backend customer-bff backoffice-bff frontend-admin frontend-customer

# ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
docker compose up -d

# Backend
cd backend && ./mvnw compile
cd backend && ./mvnw test

# BFF
cd bff/customer-bff && npm run build
cd bff/backoffice-bff && npm run build

# Frontend
npm run build --prefix frontend
cd frontend && bash ./e2e/customer-smoke.sh
cd frontend && bash ./e2e/admin-smoke.sh

# Health
curl -sS -o /dev/null -w "customer-bff=%{http_code}\n" http://localhost:3001/health
curl -sS -o /dev/null -w "backoffice-bff=%{http_code}\n" http://localhost:3002/health
curl -sS -o /dev/null -w "frontend-customer=%{http_code}\n" http://localhost:5173
curl -sS -o /dev/null -w "frontend-admin=%{http_code}\n" http://localhost:5174
```

**Final Gate çµæœ:**

- å®Ÿæ–½æ—¥: 2026-02-20
- `docker compose build backend customer-bff backoffice-bff frontend-admin frontend-customer`: PASS
- `docker compose up -d`: PASS
- `cd backend && ./mvnw compile`: PASS
- `cd backend && ./mvnw test`: PASSï¼ˆTests run: 100, Failures: 0, Errors: 0ï¼‰
- `cd bff/customer-bff && npm run build`: PASS
- `cd bff/backoffice-bff && npm run build`: PASS
- `npm run build --prefix frontend`: PASS
- `cd frontend && bash ./e2e/customer-smoke.sh`: PASS
- `cd frontend && bash ./e2e/admin-smoke.sh`: PASS
- Health:
  - `customer-bff=200`
  - `backoffice-bff=200`
  - `frontend-customer=200`
  - `frontend-admin=200`

---

## ãƒ†ã‚¹ãƒˆæ‰‹é †

1. å®Ÿåœ¨åº«å•†å“ã§ã‚«ãƒ¼ãƒˆè¿½åŠ ã‹ã‚‰æ³¨æ–‡ç¢ºå®šã¾ã§å®Ÿè¡Œã—ã€`allocatedQuantity == orderedQuantity` ã§å‡ºè·å¯èƒ½ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
2. æ åœ¨åº«å•†å“ã§æ³¨æ–‡ç¢ºå®šå¾Œã« `allocatedQuantity < orderedQuantity` ã®çŠ¶æ…‹ã‚’ä½œã‚Šã€`SHIPPED` é·ç§»ãŒæ‹’å¦ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
3. æ åœ¨åº«å•†å“ã®åœ¨åº«ã‚’å¢—åŠ ã•ã›ã€éåŒæœŸå†è©¦è¡Œã§éƒ¨åˆ†å¼•å½“ãŒå‰é€²ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
4. ã™ã§ã«å…¨é‡å¼•å½“æ¸ˆã¿æ³¨æ–‡ã¸ `/allocation/retry` ã‚’å®Ÿè¡Œã—ã€no-op æˆåŠŸã¨ãªã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
5. æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã« `allocated_qty` ãŒè§£æ”¾ã•ã‚Œã€åœ¨åº«ãŒå¢—åŠ ã—ãŸå•†å“ã®å†è©¦è¡Œã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
6. ç®¡ç†ç”»é¢ã®å•†å“è©³ç´°ã§ 3 ã‚¿ãƒ–ï¼ˆå•†å“/åœ¨åº«/è²©å£²ï¼‰ã®ä¿å­˜ã¨å†è¡¨ç¤ºãŒä¸€è²«ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
7. `/bo/inventory` ã¸ã® UI å°ç·šãŒå­˜åœ¨ã—ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
8. æ³¨æ–‡ä¸€è¦§/è©³ç´°ï¼ˆç®¡ç†ãƒ»é¡§å®¢ï¼‰ã§ `å¼•å½“æ¸ˆç‚¹æ•° / æ³¨æ–‡ç‚¹æ•°` ãŒä»•æ§˜ã©ãŠã‚Šè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

## Review Packet

### å¤‰æ›´ã‚µãƒãƒªï¼ˆ10è¡Œä»¥å†…ï¼‰

- Flyway V11 ã§ `allocation_type`ãƒ»`location_stocks`ãƒ»`sales_limits`ãƒ»`order_items.allocated_qty` ã‚’å°å…¥ã—ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ CHG-023 ãƒ¢ãƒ‡ãƒ«ã¸ç§»è¡Œã€‚
- Core API ã® Product å¥‘ç´„ã‚’ `stock` éä¾å­˜åŒ–ã—ã€`allocationType` / `effectiveStock` ã‚’è¿”å´ã€‚
- Inventory/Purchase ã‚’ `allocated_qty` ä¸­å¿ƒã¸å†ç·¨ã—ã€æ åœ¨åº«ã®éåŒæœŸæœ¬å¼•å½“ï¼ˆOutbox: `ORDER_PLACED` / `STOCK_AVAILABILITY_INCREASED`ï¼‰ã‚’è¿½åŠ ã€‚
- å‡ºè·åˆ¤å®šã‚’ã€Œå…¨é‡å¼•å½“æ¸ˆã¿ã€ã«çµ±ä¸€ã—ã€`POST /api/order/{id}/allocation/retry` ã‚’è¿½åŠ ã€‚
- BFFï¼ˆcustomer/backofficeï¼‰ã§é€²æ—é …ç›®ã¨åœ¨åº«ã‚¿ãƒ– API ã‚’é€éã€‚
- Frontend ã§ `stock` ä¾å­˜ã‚’é™¤å»ã—ã€ç®¡ç†å•†å“è©³ç´°ã‚’ 3 ã‚¿ãƒ–åŒ–ã€`/bo/inventory` UI å°ç·šã‚’å‰Šé™¤ã€‚
- ç®¡ç†/é¡§å®¢ã®æ³¨æ–‡ä¸€è¦§ãƒ»è©³ç´°ã« `allocatedQuantity / orderedQuantity` è¡¨ç¤ºã‚’å®Ÿè£…ã€‚
- ä»•æ§˜æ›¸ãƒ»OpenAPIãƒ»review-note ã‚’ CHG-023 å¥‘ç´„ã«åˆã‚ã›ã¦æ›´æ–°ã€‚

### å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

- Backend: `backend/src/main/resources/db/flyway/V11__introduce_allocation_type_and_stock_models.sql`ã€`backend/src/main/java/com/example/aiec/modules/product/**`ã€`backend/src/main/java/com/example/aiec/modules/inventory/**`ã€`backend/src/main/java/com/example/aiec/modules/purchase/**`ã€`backend/src/main/java/com/example/aiec/modules/shared/outbox/handler/**`
- Backend tests: `backend/src/test/java/com/example/aiec/architecture/ProductStockAccessArchUnitTest.java`ã€`backend/src/test/java/com/example/aiec/modules/inventory/**`ã€`backend/src/test/java/com/example/aiec/modules/purchase/**`ã€`backend/src/test/resources/mockito-extensions/org.mockito.plugins.MockMaker`
- BFF: `bff/customer-bff/src/products/products.service.ts`ã€`bff/customer-bff/src/orders/orders.service.ts`ã€`bff/backoffice-bff/src/products/{products.controller.ts,products.service.ts}`ã€`bff/backoffice-bff/src/orders/{orders.controller.ts,orders.service.ts}`ã€`bff/shared/src/dto/{product.dto.ts,order.dto.ts}`
- Frontend: `frontend/src/entities/product/**`ã€`frontend/src/entities/order/**`ã€`frontend/src/pages/admin/{AdminItemPage,AdminOrderPage}/index.tsx`ã€`frontend/src/pages/customer/{ItemDetailPage,OrderHistoryPage,OrderDetailPage}/index.tsx`ã€`frontend/src/app/router/admin.tsx`ã€`frontend/src/widgets/AdminSidebar/AdminSidebar.tsx`
- Docs: `docs/data-model.md`ã€`docs/specs/{inventory.md,order.md,product.md}`ã€`docs/ui/admin-ui.md`ã€`docs/api/{openapi.json,customer-bff-openapi.json,backoffice-bff-openapi.json}`ã€`docs/archive/04_review-note/CHG-023.md`

### ãƒªã‚¹ã‚¯ã¨æœªè§£æ±º

- `docker compose` å®Ÿè¡Œæ™‚ã« `docker-compose.yml` ã® `version` å±æ€§ãŒ obsolete ã¨ã„ã†è­¦å‘ŠãŒç¶™ç¶šï¼ˆå‹•ä½œå½±éŸ¿ãªã—ï¼‰ã€‚
- CHG-023 ã®å®Ÿè£…ãƒ»æ¤œè¨¼ã¨ã—ã¦ã¯æœªè§£æ±ºäº‹é …ãªã—ã€‚

### UIç¢ºèªåª’ä½“ï¼ˆMCP/Dockerï¼‰

- MCP Playwright ã§ç¢ºèª:
  - `http://localhost:5174/bo/item` ã‚µã‚¤ãƒ‰ãƒãƒ¼ã« `/bo/inventory` å°ç·šãŒå­˜åœ¨ã—ãªã„ã“ã¨ï¼ˆ`å•†å“/æ³¨æ–‡/ä¼šå“¡` ã®ã¿ï¼‰ã€‚
  - `http://localhost:5174/bo/inventory` ç›´ã‚¢ã‚¯ã‚»ã‚¹ã§ `No routes matched location "/bo/inventory"` ã‚’ç¢ºèªã€‚
  - ç®¡ç†å•†å“è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ 3 ã‚¿ãƒ–ï¼ˆ`å•†å“` / `åœ¨åº«` / `è²©å£²`ï¼‰è¡¨ç¤ºã‚’ç¢ºèªã€‚
  - ç®¡ç†æ³¨æ–‡ä¸€è¦§/è©³ç´°ã§ `å¼•å½“é€²æ—`ï¼ˆ`allocated / ordered`ï¼‰è¡¨ç¤ºã‚’ç¢ºèªã€‚
  - é¡§å®¢æ³¨æ–‡å±¥æ­´/è©³ç´°ï¼ˆ`/order/history`, `/order/3`ï¼‰ã§ `å¼•å½“é€²æ—` è¡¨ç¤ºã‚’ç¢ºèªã€‚

### ãƒ†ã‚¹ãƒˆçµæœï¼ˆPASS/FAILã€å¤±æ•—æ™‚ã¯30è¡Œä»¥å†…ï¼‰

- PASS: `cd backend && ./mvnw -q -DskipTests compile`
- PASS: `cd backend && ./mvnw -q test -Dtest=ProductControllerContractTest,BoAdminProductControllerContractTest,InventoryUseCaseTest`
- PASS: `cd backend && ./mvnw -q test -Dtest=FrameAllocationServiceTest,OrderUseCaseOutboxTest,OutboxProcessorTest`
- PASS: `cd backend && ./mvnw -q test -Dtest=OrderUseCaseStateTransitionTest,CreateShipmentJobTest,OrderControllerContractTest`
- PASS: `cd backend && ./mvnw -q test -Dtest=ProductStockAccessArchUnitTest,AllocationConsistencyCheckJobTest`
- PASS: `cd bff/customer-bff && npm run build`
- PASS: `cd bff/backoffice-bff && npm run build`
- PASS: `npm run build --prefix frontend`
- PASS: `cd frontend && bash ./e2e/customer-smoke.sh`
- PASS: `cd frontend && bash ./e2e/admin-smoke.sh`
- PASS: Final Gateä¸€å¼ï¼ˆbackend full test / bff build / frontend build / health checkï¼‰
