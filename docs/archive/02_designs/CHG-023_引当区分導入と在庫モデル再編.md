# CHG-023: 引当区分導入と在庫モデル再編 - 技術設計

要件: `docs/01_requirements/CHG-023_引当区分導入と在庫モデル再編.md`  
作成日: 2026-02-20

**SSOT（唯一の真実）**:
- API契約: このドキュメントの「API契約」セクション
- DBスキーマ: `backend/src/main/resources/db/flyway/V11__introduce_allocation_type_and_stock_models.sql`（Flywayが正）
- モジュール境界: `backend/AGENTS.md` のモジュール依存ルール
- 状態遷移: `backend/src/main/java/com/example/aiec/modules/purchase/order/entity/Order.java`

---

## 1. 設計方針

### 1.1 在庫源泉の分離

- 商品は `allocationType` を必須保持し、`REAL` / `FRAME` の2値固定で運用する。
- 在庫源泉は以下の2系統に分離する。
  - 実在庫: `location_stocks`（単一拠点 `location_id=1` 固定）
  - 枠在庫: `sales_limits`（累計販売限度数）
- `products.stock` はアプリケーション参照を廃止し、互換カラムとして `0` 初期化・非依存化する（物理削除は別CHG）。
- `products.stock` 非依存化は規約だけでなく検査で強制する。ArchUnit ルールを追加し、`Product#getStock` / `setStock` の業務ロジック利用を禁止する。

### 1.2 有効在庫（要件16の確定）

- 顧客向け在庫表示・カート追加可否は `effectiveStock` で統一する。
- 実在庫商品の有効在庫:
  - `max(0, locationStock.remainingQty - activeTentativeQty(real))`
  - `remainingQty = allocatableQty - allocatedQty`（算出値）
- 枠在庫商品の有効在庫:
  - `max(0, salesLimitTotal - orderedFrameQty(non-cancelled) - activeTentativeQty(frame))`
- 在庫状態表示（在庫あり/残りわずか/売り切れ）は従来閾値（6以上/1〜5/0）を `effectiveStock` に適用する。

### 1.3 引当進捗（要件16の確定）

- 永続保持は `order_items.allocated_qty` を追加し、本引当済数量の正を保持する。
- 注文単位の進捗は集計値として返却する。
  - `orderedQuantity = SUM(order_items.quantity)`
  - `allocatedQuantity = SUM(order_items.allocated_qty)`
- 注文明細単位の進捗:
  - `orderedQuantity = quantity`
  - `allocatedQuantity = allocated_qty`

### 1.4 非同期本引当（要件16の確定）

- 枠在庫商品の本引当は同期必須にしない。
- 起点イベントは以下で確定する。
  - `ORDER_PLACED`（注文作成完了時）
  - `STOCK_AVAILABILITY_INCREASED`（`remainingQty` が増える更新時）
- 冪等性は「単調増加更新」で担保する。
  - `allocated_qty` は `quantity` を上限に増加のみ
  - `location_stocks.allocated_qty` は減算/加算を同一トランザクションで整合
  - 重複イベントは差分0更新となり副作用なし

### 1.5 管理画面再編

- `/bo/inventory` は UI導線（ルーター・サイドバー）から削除する。
- 商品詳細は `商品タブ / 在庫タブ / 販売タブ` の3タブへ再編する。
- 在庫更新は商品詳細の在庫タブ経由に集約し、在庫専用画面遷移は提供しない。

---

## 2. API契約

### 2.1 Product系契約（Core API）

対象:
- `GET /api/item`
- `GET /api/item/{id}`
- `GET /api/bo/admin/items`
- `GET /api/bo/admin/items/{id}`
- `POST /api/bo/admin/items`
- `PUT /api/bo/admin/items/{id}`

`ProductDto` 契約変更:
- 追加: `allocationType: "REAL" | "FRAME"`
- 追加: `effectiveStock: number`
- 廃止: `stock`（レスポンス契約から除外）

`CreateProductRequest` / `UpdateProductRequest` 契約:
- 廃止: `stock`
- 追加: `allocationType`（省略時は `REAL`）

### 2.2 BO在庫タブ契約（Core API 新設）

| エンドポイント | メソッド | 認証 | 用途 |
|---|---|---|---|
| `/api/bo/admin/items/{id}/inventory` | GET | BoUser | 在庫タブ初期表示 |
| `/api/bo/admin/items/{id}/inventory` | PUT | BoUser(ADMIN以上) | 在庫タブ保存 |

`GET /api/bo/admin/items/{id}/inventory` レスポンス:
- `productId`
- `allocationType`
- `locationStock`: `locationId`, `allocatableQty`, `allocatedQty`, `remainingQty`
- `salesLimit`: `salesLimitTotal`, `consumedQty`, `remainingQty`

`salesLimit` の算出契約:
- `consumedQty` は永続値ではなく算出値（`orders.status != CANCELLED` の FRAME 明細数量合計）
- `remainingQty = max(0, salesLimitTotal - consumedQty)`（算出値）

`PUT /api/bo/admin/items/{id}/inventory` リクエスト:
- `allocationType`
- `locationStock.allocatableQty`
- `salesLimit.salesLimitTotal`

制約:
- `allocationType=REAL` でも `salesLimitTotal` は保持可能（将来切替時に利用）
- `allocationType=FRAME` でも `locationStock` は本引当源として更新可能

### 2.3 注文系契約（Core API）

対象:
- `GET /api/order`
- `GET /api/order/{id}`
- `GET /api/order/history`

`OrderDto` 追加:
- `orderedQuantity`
- `allocatedQuantity`

`OrderItemDto` 追加:
- `orderedQuantity`
- `allocatedQuantity`

振る舞い:
- 実在庫商品: 注文作成時に同期本引当（従来維持）
- 枠在庫商品: 注文作成時は枠消費のみ確定し、本引当は非同期進行

### 2.4 出荷統制契約

対象:
- `POST /api/order/{id}/mark-shipped`（Core）
- BFF経由の `POST /api/admin/orders/{id}/ship`

追加条件:
- `allocatedQuantity == orderedQuantity` を満たさない注文は `SHIPPED` 遷移不可
- 不成立時は既存 `INVALID_STATUS_TRANSITION` 契約で拒否する

### 2.5 引当再試行契約（Core API 新設）

| エンドポイント | メソッド | 認証 | 用途 |
|---|---|---|---|
| `/api/order/{id}/allocation/retry` | POST | BoUser(ADMIN以上) | 本引当の手動再試行 |

契約:
- 未引当が残る注文に対して非同期本引当を即時再実行する。
- 既に `allocatedQuantity == orderedQuantity` の注文は no-op 成功で返す（冪等）。
- `CANCELLED` / `SHIPPED` / `DELIVERED` は再試行対象外とする。

### 2.6 BFF契約

Customer BFF:
- `/api/products`, `/api/products/{id}`, `/api/products/{id}/full` に `allocationType`, `effectiveStock` を透過
- 在庫状態計算は `effectiveStock` 基準に変更

BackOffice BFF:
- `/api/admin/items/{id}/inventory`（GET/PUT）を追加
- `/api/admin/orders*` は `orderedQuantity`, `allocatedQuantity` を透過
- `/api/admin/orders/{id}/allocation/retry` を追加
- `/api/inventory*` は互換維持（UI導線なし）

---

## 3. データモデル契約

### 3.1 products

- 追加: `allocation_type VARCHAR(20) NOT NULL`（`REAL` / `FRAME`）
- 既存 `stock` は `0` 初期化し、業務ロジック参照を禁止

### 3.2 location_stocks（新設）

主要カラム:
- `product_id`（FK）
- `location_id`（単一拠点固定値 `1`）
- `allocatable_qty`（引当可能実在庫）
- `allocated_qty`（本引当済）
- 監査カラム

制約:
- `UNIQUE(product_id, location_id)`
- `allocatable_qty >= 0`
- `allocated_qty >= 0`

### 3.3 sales_limits（新設）

主要カラム:
- `product_id`（FK, UNIQUE）
- `sales_limit_total`（累計販売限度数）
- 監査カラム

制約:
- `sales_limit_total >= 0`

算出項目（永続しない）:
- `consumedQty = SUM(order_items.quantity)`（FRAME商品、かつ `orders.status != CANCELLED`）
- `remainingQty = max(0, sales_limit_total - consumedQty)`

注記:
- 現時点では算出値で実装し、永続集計カラムは導入しない。
- 性能要件が顕在化した場合は materialized view または集計カラムへの移行を許容する。

### 3.4 order_items（拡張）

- 追加: `allocated_qty INTEGER NOT NULL DEFAULT 0 CHECK (allocated_qty >= 0)`
- アプリケーション制約: `allocated_qty <= quantity`

### 3.5 stock_reservations（継続利用）

- 役割を「カート起点の仮引当管理」に限定する。
- 本引当の真実は `order_items.allocated_qty` + `location_stocks.allocated_qty` とする。
- `stock_reservations` に `allocation_type` カラムは追加しない。
- `activeTentativeQty(real/frame)` は `stock_reservations.product_id -> products.allocation_type` の JOIN で区分集計する。

### 3.6 データ移行

- 既存商品は `allocation_type='REAL'` で初期化
- 既存 `products.stock` は `0` へ初期化
- `location_stocks` / `sales_limits` は全商品に `0` で初期レコード作成

---

## 4. モジュール・レイヤ構成

```
product/
  domain/entity/Product                 (allocationType追加)
  application/port/ProductDto           (effectiveStock追加)
  adapter/rest/BoAdminProductController (inventoryタブAPI追加)

inventory/
  domain/entity/LocationStock           (新規)
  domain/entity/SalesLimit              (新規)
  domain/repository/LocationStockRepository (新規)
  domain/repository/SalesLimitRepository    (新規)
  application/usecase/InventoryUseCase  (仮引当・本引当ロジック再編)
  application/service/FrameAllocationService (新規, 非同期本引当)

purchase/
  order/entity/OrderItem                (allocatedQty追加)
  application/usecase/OrderUseCase      (注文作成・出荷可否条件の再編)
  application/job/CreateShipmentJob      (全量引当済のみ出荷作成)

shared/outbox/
  handler/FrameAllocationOutboxHandler  (新規イベントハンドラ)
```

---

## 5. 主要クラス/IFの責務

| クラス/IF | 責務 | レイヤ |
|---|---|---|
| `Product` | 引当区分を持つ商品マスタ | product/domain |
| `LocationStock` | 実在庫の引当可能/引当済管理 | inventory/domain |
| `SalesLimit` | 枠在庫の累計販売上限管理 | inventory/domain |
| `InventoryUseCase` | 仮引当、在庫タブ更新、有効在庫計算 | inventory/application |
| `FrameAllocationService` | 枠在庫商品の非同期本引当実行 | inventory/application |
| `OrderUseCase` | 注文作成時の区分別引当、進捗反映、出荷統制 | purchase/application |
| `FrameAllocationOutboxHandler` | `ORDER_PLACED` / `STOCK_AVAILABILITY_INCREASED` 処理 | shared/outbox |
| `BoAdminProductController` | 商品詳細3タブのAPI境界（在庫タブ含む） | product/adapter |
| `ProductsService` (backoffice-bff) | 在庫タブAPIと商品APIのCore中継 | bff/backoffice |
| `AdminItemPage` | 商品/在庫/販売タブUIと保存操作 | frontend/pages |
| `AdminOrderPage` | 注文一覧/詳細の引当進捗表示 | frontend/pages |

---

## 6. トランザクション・非同期方針

- 注文作成は単一トランザクションで実施:
  - カート妥当性確認
  - 区分別引当処理
  - `order_items.allocated_qty` 更新
  - 仮引当解放
  - `ORDER_PLACED` outbox書き込み
- 在庫タブ保存は単一トランザクション:
  - `products.allocation_type`
  - `location_stocks`
  - `sales_limits`
  - 更新前後の `remainingQty` 差分を比較し、増加時のみ `STOCK_AVAILABILITY_INCREASED` 発行
- 注文キャンセルは単一トランザクションで実施:
  - `orders.status = CANCELLED`
  - `order_items.allocated_qty` を0へ更新
  - `allocated_qty > 0` の場合のみ `location_stocks.allocated_qty` を減算
  - 更新前後の `remainingQty` 差分が増加なら `STOCK_AVAILABILITY_INCREASED` 発行
- 非同期本引当は Outbox の再試行戦略（PENDING→最大3回）を継続利用。
- 部分引当不足はエラーにせず正常完了とし、次回イベントで再試行する。
- Outbox が `DEAD` に到達したイベントは運用アラート対象とし、BackOffice BFF の `/api/admin/orders/{id}/allocation/retry` で再試行する。
- 非同期本引当では `order_items` と `location_stocks` を同一トランザクションで更新し、`SELECT ... FOR UPDATE` で対象在庫行をロックする。
- 整合性検証ジョブで以下を検証し、差分があれば警告記録する。  
  `location_stocks(product_id).allocated_qty == SUM(order_items.allocated_qty JOIN orders ON orders.id = order_items.order_id WHERE order_items.product_id = product_id AND orders.status != 'CANCELLED')`

---

## 7. 処理フロー

### 7.1 カート追加（区分別）

```
CartService
  → InventoryUseCase.createReservation
    → Product.allocationType 判定
      REAL  : location_stocks + tentative で有効在庫判定
      FRAME : sales_limits + orderedFrame + tentative で有効在庫判定
    → stock_reservations(TENTATIVE) 更新
```

### 7.2 注文作成

```
OrderUseCase.createOrder
  → 注文明細生成
  → 区分別引当
      REAL  : 同期本引当（allocated_qty=quantity）
      FRAME : 枠消費確定（allocated_qtyは0開始）
  → 仮引当解放
  → ORDER_PLACED(outbox)
  → レスポンス（進捗付き）
```

### 7.3 非同期本引当（FRAME）

```
OutboxProcessor
  → FrameAllocationOutboxHandler
    → FrameAllocationService.allocatePending()
      → location_stocks 行ロック
      → 未引当 order_items を FIFO（orders.created_at ASC, orders.id ASC, order_items.id ASC）で部分引当
      → order_items.allocated_qty / location_stocks.allocated_qty 更新
```

実装補足:
- FIFO 処理のため、V11 で未引当探索クエリ用インデックス（`orders(created_at, id)`, `order_items(order_id, id)`）を追加対象とする。

### 7.4 出荷統制

```
CreateShipmentJob / markShipped
  → orderedQuantity と allocatedQuantity を評価
  → 全量引当済のみ SHIPPED 遷移を許可
```

### 7.5 注文キャンセル

```
OrderUseCase.cancelOrder
  → 注文ステータスを CANCELLED へ更新
  → 注文明細ごとに released = allocated_qty を確定
  → order_items.allocated_qty を 0 に更新
  → released > 0 の合計分だけ location_stocks.allocated_qty を減算
  → remainingQty が増加した場合のみ STOCK_AVAILABILITY_INCREASED(outbox)
```

補足:
- REAL/FRAME ともに `order_items.allocated_qty` を正として解放する。
- 枠消費は `orders.status != CANCELLED` 集計から自動的に除外されるため、`sales_limits` への直接更新は行わない。

### 7.6 非同期失敗時の運用

```
OutboxEvent(ORDER_PLACED or STOCK_AVAILABILITY_INCREASED) が DEAD
  → 監視アラート
  → 原因解消後、管理者が /api/admin/orders/{id}/allocation/retry 実行
  → FULL引当済注文は no-op 成功
```

---

## 8. 影響範囲

| 区分 | 対象（クラス/ファイル） | 変更概要 |
|---|---|---|
| 新規作成 | `backend/src/main/resources/db/flyway/V11__introduce_allocation_type_and_stock_models.sql` | 引当区分・在庫再編スキーマ |
| 既存変更 | `backend/src/main/java/com/example/aiec/modules/product/domain/entity/Product.java` | `allocationType` 追加、`stock` 非依存化 |
| 新規作成 | `backend/src/main/java/com/example/aiec/modules/inventory/domain/entity/LocationStock.java` | 実在庫モデル |
| 新規作成 | `backend/src/main/java/com/example/aiec/modules/inventory/domain/entity/SalesLimit.java` | 枠在庫モデル |
| 既存変更 | `backend/src/main/java/com/example/aiec/modules/inventory/application/usecase/InventoryUseCase.java` | 仮引当・有効在庫ロジック再編 |
| 新規作成 | `backend/src/main/java/com/example/aiec/modules/inventory/application/service/FrameAllocationService.java` | 非同期本引当 |
| 既存変更 | `backend/src/main/java/com/example/aiec/modules/purchase/order/entity/OrderItem.java` | `allocatedQty` 追加 |
| 既存変更 | `backend/src/main/java/com/example/aiec/modules/purchase/application/usecase/OrderUseCase.java` | 区分別引当、進捗集計、出荷制御 |
| 既存変更 | `backend/src/main/java/com/example/aiec/modules/purchase/adapter/rest/OrderController.java` | `allocation/retry` 契約追加 |
| 既存変更 | `backend/src/main/java/com/example/aiec/modules/purchase/application/job/CreateShipmentJob.java` | 全量引当済条件の追加 |
| 新規作成 | `backend/src/main/java/com/example/aiec/modules/shared/outbox/handler/FrameAllocationOutboxHandler.java` | 非同期イベント処理 |
| 新規作成 | `backend/src/main/java/com/example/aiec/modules/inventory/application/job/AllocationConsistencyCheckJob.java` | 引当整合性検証 |
| 新規作成 | `backend/src/test/java/com/example/aiec/architecture/ProductStockAccessArchUnitTest.java` | `products.stock` 非依存化の静的検査 |
| 既存変更 | `backend/src/main/java/com/example/aiec/modules/product/adapter/rest/BoAdminProductController.java` | 在庫タブAPI追加 |
| 既存変更 | `bff/customer-bff/src/products/products.service.ts` | `effectiveStock` 対応 |
| 既存変更 | `bff/customer-bff/src/orders/orders.service.ts` | 進捗フィールド透過 |
| 既存変更 | `bff/backoffice-bff/src/products/products.controller.ts` | `/items/:id/inventory` 追加 |
| 既存変更 | `bff/backoffice-bff/src/products/products.service.ts` | 在庫タブAPI中継 |
| 既存変更 | `bff/backoffice-bff/src/orders/orders.service.ts` | 進捗フィールド透過 |
| 既存変更 | `bff/backoffice-bff/src/orders/orders.controller.ts` | `allocation/retry` エンドポイント追加 |
| 既存変更 | `frontend/src/app/router/admin.tsx` | `/bo/inventory` ルート削除 |
| 既存変更 | `frontend/src/widgets/AdminSidebar/AdminSidebar.tsx` | 在庫メニュー導線削除 |
| 既存変更 | `frontend/src/pages/admin/AdminItemPage/index.tsx` | 3タブ化、在庫タブ導入 |
| 既存変更 | `frontend/src/pages/admin/AdminOrderPage/index.tsx` | 進捗表示列追加 |
| 既存変更 | `frontend/src/pages/customer/OrderHistoryPage/index.tsx` | 注文進捗表示追加 |
| 既存変更 | `frontend/src/pages/customer/OrderDetailPage/index.tsx` | 明細進捗表示追加 |
| 既存変更 | `frontend/src/entities/product/model/types.ts` | `stock` 廃止、`allocationType/effectiveStock` 追加 |
| 既存変更 | `frontend/src/entities/order/model/types.ts` | `orderedQuantity/allocatedQuantity` 追加 |
| 既存変更 | `docs/data-model.md` | 新在庫モデル反映 |
| 既存変更 | `docs/specs/inventory.md` | 実在庫/枠在庫ルール更新 |
| 既存変更 | `docs/specs/order.md` | 出荷統制・進捗反映 |
| 既存変更 | `docs/specs/product.md` | Product IF更新 |
| 既存変更 | `docs/ui/admin-ui.md` | 商品詳細3タブ化・導線廃止反映 |
| 既存変更 | `docs/api/openapi.json` | Core API契約更新 |
| 既存変更 | `docs/api/customer-bff-openapi.json` | Customer BFF契約更新 |
| 既存変更 | `docs/api/backoffice-bff-openapi.json` | BackOffice BFF契約更新 |

---

## 9. テスト観点

- 正常系:
  - 商品ごとに `allocationType` を設定/更新できる。
  - 実在庫商品は同期本引当で従来どおり注文作成できる。
  - 枠在庫商品は注文作成後に部分本引当が非同期進行する。
  - 在庫増加時に未引当分が再試行される。
  - 管理画面商品詳細が3タブで保存・再表示一貫する。
  - `/bo/inventory` へのUI導線が存在しない。
  - 注文一覧/詳細で `allocatedQuantity/orderedQuantity` が表示される。
  - 手動再試行APIが未引当注文に対して本引当を再実行できる。
  - 手動再試行APIが FULL引当済注文に対して no-op 成功を返す。

- 異常系:
  - 有効在庫不足時にカート追加/数量変更が拒否される。
  - 枠在庫上限超過時に注文作成が拒否される。
  - 未引当残のある注文は `SHIPPED` 遷移が拒否される。
  - 重複イベント処理でも引当数量が過剰加算されない。
  - Outbox が `DEAD` 到達時にアラート/運用再試行導線が機能する。

- 境界値:
  - 在庫状態閾値（0/1/5/6）が `effectiveStock` 基準で正しい。
  - 部分引当（例: 5点中2点）の進捗値が注文単位/明細単位で整合する。
  - 注文キャンセル時、枠消費集計の除外と本引当解放が正しく反映される。
  - `allocationType` 切替時に既存在庫データの整合が崩れない。
  - 整合性検証ジョブで差分0は正常、差分ありは警告記録される。
