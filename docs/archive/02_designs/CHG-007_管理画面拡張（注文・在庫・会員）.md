# CHG-007: 管理画面拡張（注文・在庫・会員）— 技術設計

要件: `docs/01_requirements/CHG-007_管理画面拡張（注文・在庫・会員）.md`
作成日: 2026-02-13
ステータス: 設計中

---

## 1. 概要

本設計は、管理画面に左サイドバーを追加し、商品・注文・在庫・会員の4つの管理機能を統一的に提供するための技術仕様を定義する。

### 1-1. スコープ

**実装対象**:
- 左サイドバーコンポーネントの作成
- 在庫管理画面の新規実装（一覧、調整、履歴）
- 会員管理画面の新規実装（一覧、詳細、状態/ロール変更）
- 認可強化（全管理APIへのADMINロール必須化）
- 監査ログの実装（主要更新操作の記録）

**既存機能の維持**:
- 商品管理（`/bo/item`）— 既存機能をサイドバー経由でアクセス可能に
- 注文管理（`/bo/order`）— 既存機能をサイドバー経由でアクセス可能に

---

## 2. アーキテクチャ設計

### 2-1. URL構造

| 機能 | URL | ページコンポーネント | 状態 |
|------|-----|----------------------|------|
| 商品管理 | `/bo/item` | `AdminItemPage` | ✅ 既存 |
| 注文管理 | `/bo/order` | `AdminOrderPage` | ✅ 既存 |
| 在庫管理 | `/bo/inventory` | `AdminInventoryPage` | 🆕 新規 |
| 会員管理 | `/bo/members` | `AdminMembersPage` | 🆕 新規 |

### 2-2. コンポーネント構成

```
App.tsx
├── Route element={<Layout />} — 一般ユーザー画面（ヘッダー/フッター付き）
│   ├── HomePage
│   ├── ItemListPage
│   └── ... その他ユーザー画面
└── Route path="/bo" element={<AdminLayout />} — 管理画面専用レイアウト（h-screen固定）
    ├── AdminSidebar (新規) — 左サイドバー
    │   ├── メニュー項目: 商品
    │   ├── メニュー項目: 注文
    │   ├── メニュー項目: 在庫
    │   └── メニュー項目: 会員
    └── <Outlet /> — 管理画面コンテンツエリア
        ├── AdminItemPage (既存)
        ├── AdminOrderPage (既存)
        ├── AdminInventoryPage (新規)
        └── AdminMembersPage (新規)
```

**重要**: 既存の `<Layout />` と `<AdminLayout />` は完全に分離されたレイアウトとして実装する。

### 2-3. データフロー

```
ユーザー操作
  ↓
フロントエンド (React)
  ↓ (Authorization: Bearer <token>)
バックエンド (Spring Boot)
  ↓ AuthService.verifyToken()
  ↓ 認可チェック (requireAdmin)
  ↓ ビジネスロジック実行
  ↓ OperationHistoryService.logAdminAction()
  ↓ レスポンス返却
```

---

## 3. フロントエンド設計

### 3-1. デザインシステム（ETHEREAL Admin）

**デザインコンセプト**:
- エディトリアルでモダンな管理画面
- ダークサイドバー（zinc-900）+ 明るいコンテンツエリア
- 数値は tabular-nums で綺麗に整列
- 状態に応じた色分け（emerald=成功、rose=警告、blue=進行中）

**共通デザインルール**:
1. **統計カードは使用しない** — 画面をシンプルに保ち、テーブルに集中
2. **検索・フィルタと一覧を一体化** — ページ遷移なしで絞り込み
3. **IDをクリック → モーダルで詳細** — すべての画面で統一
4. **モーダルサイズ**: `max-w-4xl` で大きめに表示

### 3-2. 左サイドバーコンポーネント

**ファイル**: `frontend/src/components/AdminSidebar.tsx` (新規)

**機能**:
- 4つの管理メニューを縦並びで表示
- 現在のパスに応じてアクティブメニューをハイライト
- React Router の `NavLink` を使用

**デザイン**:
- 幅: 固定 256px (w-64)
- 背景: ダーク（`bg-zinc-900`）
- ブランディング: "ETHEREAL Admin"
- アクティブ項目: `bg-zinc-800`
- 非アクティブ: `text-zinc-400 hover:text-white hover:bg-zinc-800`

**メニュー項目**:
```tsx
[
  { label: '商品', path: '/bo/item' },
  { label: '注文', path: '/bo/order' },
  { label: '在庫', path: '/bo/inventory' },
  { label: '会員', path: '/bo/members' },
]
```

**注**: アイコン（絵文字）は使用しない。テキストのみのシンプルなデザイン。

### 3-3. 管理画面レイアウト

**ファイル**: `frontend/src/components/AdminLayout.tsx` (新規)

**構造**:
```tsx
<div className="flex h-screen overflow-hidden">
  <AdminSidebar />
  <main className="flex-1 overflow-y-auto">
    <Outlet />
  </main>
</div>
```

**ルーティング変更**:
```tsx
// App.tsx を以下のように修正
<BrowserRouter>
  <Routes>
    {/* 一般ユーザー画面 */}
    <Route element={<Layout />}>
      <Route path="/" element={<HomePage />} />
      <Route path="/item" element={<ItemListPage />} />
      {/* ... その他ユーザー画面 */}
    </Route>

    {/* 管理画面（別レイアウト） */}
    <Route path="/bo" element={<AdminLayout />}>
      <Route path="item" element={<AdminItemPage />} />
      <Route path="order" element={<AdminOrderPage />} />
      <Route path="inventory" element={<AdminInventoryPage />} />
      <Route path="members" element={<AdminMembersPage />} />
    </Route>
  </Routes>
</BrowserRouter>
```

**注意**: 現在 `/bo/item` と `/bo/order` は既存の `<Layout />` 配下にあるため、これらを `<AdminLayout />` 配下に移動する必要があります。

### 3-4. 共通UI/UXパターン

**すべての管理画面で統一**:

1. **画面構成**（統計カードなし、4段階レイアウト）:
```
┌─────────────────────────────────────┐
│ [ヘッダー]                          │
│  - ページタイトル + アクションボタン  │
├─────────────────────────────────────┤
│ [検索エリア]                        │
│  - <input> + 検索ボタン              │
├─────────────────────────────────────┤
│ [フィルタエリア]（必要な画面のみ）   │
│  - フィルタボタン群                  │
├─────────────────────────────────────┤
│ [テーブル]                          │
│  - IDカラムがクリッカブルリンク      │
│  - IDクリック → 詳細モーダル         │
└─────────────────────────────────────┘
```

**各エリアの役割**:
- **ヘッダー**: ページタイトル（例: "商品管理"）+ 主要アクション（例: "新規登録"ボタン）
- **検索エリア**: テキスト入力による絞り込み。各画面で検索対象が異なる。
- **フィルタエリア**: ボタンやドロップダウンによる条件絞り込み（必要な画面のみ表示）
- **テーブル**: データ一覧とクリッカブルなID列

**検索対象**:
- **商品管理**: 商品名で検索
- **注文管理**: 注文番号で検索
- **在庫管理**: 商品名で検索
- **会員管理**: メールアドレスで検索

2. **IDクリック → モーダル詳細表示**:
   - **クリック対象**: IDのみ（商品ID、注文番号、会員IDなど）
   - **モーダルサイズ**: `max-w-4xl`
   - **モーダル内容**: 詳細情報 + アクション（編集、ステータス変更など）
   - **操作**: モーダル内で操作完結、ページ遷移なし
   - **閉じる方法**: ESCキー、背景クリック、×ボタン

3. **テーブルデザイン**:
   - IDカラムは `font-mono text-blue-600 hover:underline cursor-pointer`
   - 数値は `tabular-nums` で整列
   - ホバー時は `hover:bg-gray-50`

### 3-5. 商品管理画面（既存の改修）

**ファイル**: `frontend/src/pages/AdminItemPage.tsx` (既存)

**画面構成**:
```
[ヘッダー] 商品管理 + 新規登録ボタン
[検索エリア] 商品名検索
[フィルタエリア] 公開状態フィルタ（すべて | 公開 | 非公開）
[商品一覧テーブル]
  - 商品ID（クリック可能） | 商品名 | 価格 | 在庫 | 公開状態
```

**主な変更点**:
- 統計カード削除
- ヘッダー・検索・フィルタ・テーブルの4段階レイアウトに統一
- 商品IDをクリッカブルリンクに変更
- 商品IDクリック → 商品詳細モーダル表示

**モーダル内容**:
- 大きな商品画像
- 詳細説明（長文）
- 在庫履歴（簡易版）
- 価格・在庫・公開状態の編集フォーム

### 3-6. 注文管理画面（既存の改修）

**ファイル**: `frontend/src/pages/AdminOrderPage.tsx` (既存)

**画面構成**:
```
[ヘッダー] 注文管理
[検索エリア] 注文番号検索
[フィルタエリア] ステータスフィルタ（すべて | 確認済 | 発送済 | 配達完了 | キャンセル）
[注文一覧テーブル]
  - 注文番号（クリック可能） | 注文日時 | 会員メール | 会員表示名 | ステータス | 合計金額
```

**主な変更点**:
- 統計カード削除
- ヘッダー・検索・フィルタ・テーブルの4段階レイアウトに統一
- 注文番号をクリッカブルリンクに変更
- 注文番号クリック → 注文詳細モーダル表示
- **会員情報の追加**: 注文一覧に会員メールアドレスと表示名を表示（要件 CHG-007:L43 対応）

**一覧テーブルのカラム**:
- 注文番号（クリッカブル）
- 注文日時
- 会員メールアドレス（新規）
- 会員表示名（新規）
- ステータス
- 合計金額

**モーダル内容**:
- 会員情報（メールアドレス、表示名）
- 注文明細（商品一覧、数量、小計）
- 配送先情報
- 決済情報
- ステータス履歴
- ステータス変更ボタン（確認、発送、配達完了、キャンセル）

### 3-7. 在庫管理画面

**ファイル**: `frontend/src/pages/AdminInventoryPage.tsx` (新規)

**画面構成**:
```
[ヘッダー] 在庫管理
[検索エリア] 商品名検索
[フィルタエリア] しきい値入力 + 不足商品表示ボタン
[在庫一覧テーブル]
  - 商品ID（クリック可能） | 商品名 | 現在庫 | 仮引当 | 本引当 | 有効在庫 | 調整ボタン
[調整履歴テーブル]
  - 調整日時 | 商品名 | 調整前 | 調整後 | 理由 | 実施者
```

**機能**:
1. **在庫一覧表示**: API `GET /api/admin/inventory`
2. **在庫不足抽出**: しきい値以下の商品をフィルタ表示
3. **商品IDクリック → 在庫詳細モーダル**:
   - 引当状況の詳細（仮引当・本引当の内訳）
   - 調整履歴（その商品のみ）
4. **在庫調整**: 「調整」ボタン → 調整モーダル → API `POST /api/admin/inventory/adjust`

**状態管理**:
```tsx
const [inventories, setInventories] = useState<InventoryItem[]>([])
const [adjustments, setAdjustments] = useState<InventoryAdjustment[]>([])
const [threshold, setThreshold] = useState<number>(10)
const [selectedProductId, setSelectedProductId] = useState<number | null>(null)
const [showDetailModal, setShowDetailModal] = useState<boolean>(false)
const [showAdjustModal, setShowAdjustModal] = useState<boolean>(false)
```

### 3-8. 会員管理画面

**ファイル**: `frontend/src/pages/AdminMembersPage.tsx` (新規)

**画面構成**:
```
[ヘッダー] 会員管理
[検索エリア] メールアドレス検索
[フィルタエリア] すべて | CUSTOMER | ADMIN
[会員一覧テーブル]
  - 会員ID（クリック可能） | メールアドレス | 表示名 | ロール | 状態 | 登録日
```

**機能**:
1. **会員一覧表示**: API `GET /api/admin/members`
   - **重要**: レスポンスに `id` フィールドを必須で含める
2. **メール検索**: フロントエンドでフィルタリング
3. **ロールフィルタ**: すべて / CUSTOMER / ADMIN
4. **会員IDクリック → 会員詳細モーダル**:
   - 基本情報（ID、メール、表示名、ロール、状態、登録日、更新日）
   - 注文履歴サマリ（総注文数、総購入額）
   - 状態変更ボタン（有効/無効切り替え）
   - ロール変更ボタン（CUSTOMER ⇔ ADMIN）

**モーダル内のアクション**:
- **状態変更**: API `PUT /api/admin/members/:id/status`
- **ロール変更**: API `PUT /api/admin/members/:id/role`
- モーダル内で操作完結、成功後に会員一覧を再取得

**状態管理**:
```tsx
const [members, setMembers] = useState<User[]>([])
const [selectedMemberId, setSelectedMemberId] = useState<number | null>(null)
const [selectedMember, setSelectedMember] = useState<User | null>(null)
const [showDetailModal, setShowDetailModal] = useState<boolean>(false)
const [searchQuery, setSearchQuery] = useState<string>('')
const [roleFilter, setRoleFilter] = useState<'ALL' | 'CUSTOMER' | 'ADMIN'>('ALL')
```

---

## 4. バックエンド設計

### 4-1. コントローラー分離（重要）

**現状の問題**:
- 既存の `InventoryController` には、カート機能で使用する引当API（認証不要）が含まれる
- 設計書で「全エンドポイントADMIN必須」とすると、カート導線を破壊する

**解決策: コントローラーを2つに分離**:

| コントローラー | 用途 | 認可 | エンドポイント例 |
|--------------|------|------|------------------|
| `InventoryController` (既存) | カート用引当API | 認証不要 | `POST /api/inventory/reservations`, `GET /api/inventory/availability/{id}` |
| `AdminInventoryController` (新規) | 管理画面用在庫管理 | ADMIN必須 | `GET /api/admin/inventory`, `POST /api/admin/inventory/adjust` |

**既存の `InventoryController` は変更せず維持**。新規の管理画面用APIは `AdminInventoryController` に実装する。

---

### 4-2. 在庫管理API（管理画面用）

#### 4-2-1. 在庫一覧取得（バッチ処理版）

**エンドポイント**: `GET /api/admin/inventory`

**認可**: ADMIN ロール必須

**レスポンス**:
```json
{
  "success": true,
  "data": [
    {
      "productId": 1,
      "productName": "プレミアムコーヒー豆",
      "physicalStock": 50,
      "tentativeReserved": 5,
      "committedReserved": 10,
      "availableStock": 35
    }
  ]
}
```

**実装**:
- `AdminInventoryController.getAllInventory()` (新規)
- `InventoryService.getAllInventoryStatus()` (新規) — **バッチ処理版**を実装
  - 既存の `getAvailableStock(Long productId)` を1000回呼ぶのではなく、JOINとGROUP BYで一括取得
  - 目標: 1000件3秒以内

**SQL例（概念）**:
```sql
SELECT
  p.id AS product_id,
  p.name AS product_name,
  p.stock AS physical_stock,
  COALESCE(SUM(CASE WHEN r.type = 'TENTATIVE' AND r.expires_at > NOW() THEN r.quantity ELSE 0 END), 0) AS tentative_reserved,
  COALESCE(SUM(CASE WHEN r.type = 'COMMITTED' THEN r.quantity ELSE 0 END), 0) AS committed_reserved,
  (p.stock
   - COALESCE(SUM(CASE WHEN r.type = 'TENTATIVE' AND r.expires_at > NOW() THEN r.quantity ELSE 0 END), 0)
   - COALESCE(SUM(CASE WHEN r.type = 'COMMITTED' THEN r.quantity ELSE 0 END), 0)
  ) AS available_stock
FROM products p
LEFT JOIN stock_reservations r ON p.id = r.product_id
GROUP BY p.id
ORDER BY p.id
```

#### 4-2-2. 在庫調整

**エンドポイント**: `POST /api/admin/inventory/adjust`

**認可**: ADMIN ロール必須

**リクエスト（差分方式）**:
```json
{
  "productId": 1,
  "quantityDelta": 10,
  "reason": "棚卸調整"
}
```

**quantityDelta の意味**:
- **正の値**: 在庫を増やす（例: `+10` → 50個から60個へ）
- **負の値**: 在庫を減らす（例: `-5` → 50個から45個へ）
- **差分方式を採用** — 調整後の絶対値ではなく、増減量を指定する

**レスポンス**:
```json
{
  "success": true,
  "data": {
    "id": 123,
    "productId": 1,
    "quantityBefore": 50,
    "quantityAfter": 60,
    "quantityDelta": 10,
    "reason": "棚卸調整",
    "adjustedBy": "admin@example.com",
    "adjustedAt": "2026-02-13T10:30:00"
  }
}
```

**実装**:
- `AdminInventoryController.adjustStock()` (新規)
- `InventoryService.adjustStock(Long productId, Integer quantityDelta, String reason, User admin)` (新規)
  - `Product.stock` を `stock + quantityDelta` で更新
  - 負の値で在庫が0未満にならないようバリデーション
  - `InventoryAdjustment` エンティティに履歴を保存
  - `OperationHistoryService.logAdminAction()` で監査ログ記録

**在庫調整後の available stock 計算**:
- 調整は `Product.stock` のみを変更
- `availableStock` の計算式は変更なし: `stock - tentativeReserved - committedReserved`
- `committedReserved` は注文確定時に `stock` から既に引かれているため、二重控除にはならない

#### 4-2-3. 在庫調整履歴取得

**エンドポイント**: `GET /api/admin/inventory/adjustments?productId=1` (productIdはオプション)

**認可**: ADMIN ロール必須

**レスポンス**:
```json
{
  "success": true,
  "data": [
    {
      "id": 123,
      "productId": 1,
      "productName": "プレミアムコーヒー豆",
      "quantityBefore": 50,
      "quantityAfter": 60,
      "reason": "棚卸調整",
      "adjustedBy": "admin@example.com",
      "adjustedAt": "2026-02-13T10:30:00"
    }
  ]
}
```

**実装**:
- `AdminInventoryController.getAdjustments()` (新規)
- `InventoryAdjustmentRepository.findAll()` または `findByProductId()`

---

### 4-3. 会員管理API

#### 4-3-1. 会員一覧取得

**エンドポイント**: `GET /api/admin/members`

**認可**: ADMIN ロール必須

**レスポンス**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "email": "user@example.com",
      "displayName": "山田太郎",
      "role": "CUSTOMER",
      "isActive": true,
      "createdAt": "2026-02-01T10:00:00"
    }
  ]
}
```

**実装**:
- `AdminController.getMembers()` (新規)
- `UserRepository.findAll()`

#### 4-3-2. 会員詳細取得

**エンドポイント**: `GET /api/admin/members/:id`

**認可**: ADMIN ロール必須

**レスポンス**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "email": "user@example.com",
    "displayName": "山田太郎",
    "role": "CUSTOMER",
    "isActive": true,
    "createdAt": "2026-02-01T10:00:00",
    "updatedAt": "2026-02-10T15:30:00",
    "orderSummary": {
      "totalOrders": 5,
      "totalAmount": 25000
    }
  }
}
```

**実装**:
- `AdminController.getMemberById()` (新規)
- `UserService.findById()`
- `OrderRepository.countByUserId()`, `OrderRepository.sumTotalPriceByUserId()`

#### 4-3-3. 会員状態変更

**エンドポイント**: `PUT /api/admin/members/:id/status`

**認可**: ADMIN ロール必須

**リクエスト**:
```json
{
  "isActive": false
}
```

**レスポンス**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "isActive": false
  }
}
```

**実装**:
- `AdminController.updateMemberStatus()` (新規)
- `UserService.updateStatus()` (新規)
  - `User.isActive` を更新
  - `OperationHistoryService.logAdminAction()` で監査ログ記録

#### 4-3-4. 会員ロール変更

**エンドポイント**: `PUT /api/admin/members/:id/role`

**認可**: ADMIN ロール必須

**リクエスト**:
```json
{
  "role": "ADMIN"
}
```

**レスポンス**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "role": "ADMIN"
  }
}
```

**実装**:
- `AdminController.updateMemberRole()` (新規)
- `UserService.updateRole()` (新規)
  - `User.role` を更新
  - `OperationHistoryService.logAdminAction()` で監査ログ記録

#### 4-3-5. 注文一覧APIの拡張（会員情報追加）

**エンドポイント**: `GET /api/admin/orders` (既存の `/api/order` を変更または別途作成)

**認可**: ADMIN ロール必須

**レスポンス**:
```json
{
  "success": true,
  "data": [
    {
      "orderId": 1,
      "orderNumber": "ORD-20260213-001",
      "userId": 3,
      "userEmail": "user@example.com",
      "userDisplayName": "山田太郎",
      "totalPrice": 5000,
      "status": "CONFIRMED",
      "createdAt": "2026-02-13T10:30:00",
      "updatedAt": "2026-02-13T11:00:00"
    }
  ]
}
```

**実装**:
- `OrderDto` に以下のフィールドを追加:
  - `userId: Long`
  - `userEmail: String`
  - `userDisplayName: String`
- `OrderDto.fromEntity()` メソッドで `order.getUser()` から取得
- `Order` エンティティに `@ManyToOne User user` があることを前提（CHG-006で実装済み）

---

## 5. データモデル設計

### 5-1. 新規エンティティ: InventoryAdjustment

**ファイル**: `backend/src/main/java/com/example/aiec/entity/InventoryAdjustment.java` (新規)

**フィールド**:
```java
@Entity
@Table(name = "inventory_adjustments")
public class InventoryAdjustment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne
    @JoinColumn(name = "product_id", nullable = false)
    private Product product;

    @Column(nullable = false)
    private Integer quantityBefore;

    @Column(nullable = false)
    private Integer quantityAfter;

    @Column(nullable = false)
    private Integer quantityDelta; // 増減量（例: +10, -5）

    @Column(nullable = false, length = 500)
    private String reason;

    @Column(nullable = false, length = 255)
    private String adjustedBy; // メールアドレス

    @Column(nullable = false)
    private LocalDateTime adjustedAt;
}
```

### 5-2. User エンティティ拡張

**ファイル**: `backend/src/main/java/com/example/aiec/entity/User.java` (既存)

**追加フィールド**:
```java
@Column(nullable = false)
private Boolean isActive = true;
```

**注意**: CHG-006で `role` フィールドは既に実装されているため、`isActive` のみ追加。

**データ移行手順**:
1. **ALTER TABLE で NULL許可カラムとして追加**:
   ```sql
   ALTER TABLE users ADD COLUMN is_active INTEGER;
   ```

2. **既存データに DEFAULT 値を設定**:
   ```sql
   UPDATE users SET is_active = 1 WHERE is_active IS NULL;
   ```

3. **Hibernate で NOT NULL 制約を有効化**:
   - `@Column(nullable = false)` を設定後、`ddl-auto: validate` に切り替え
   - または手動で `ALTER TABLE users ALTER COLUMN is_active SET NOT NULL;` を実行（SQLiteでは制限あり）

**SQLite の制約**:
- SQLiteでは `ALTER COLUMN` によるNOT NULL制約追加が直接サポートされていない
- 推奨: `nullable = false` を設定し、DEFAULT値を明示（`private Boolean isActive = true;`）
- Hibernateが新規レコード作成時にDEFAULT値を使用する

**PostgreSQL + Flyway 移行時の注意（`is_active` カラム）**:
- SQLite運用時の履歴によっては `users.is_active` に `NULL` が残る可能性がある。
- PostgreSQL移行時は Flyway マイグレーションで `NULL` 補正と制約付与を必ず実施する。
- 実施例:
  ```sql
  ALTER TABLE users ADD COLUMN IF NOT EXISTS is_active BOOLEAN;
  UPDATE users SET is_active = TRUE WHERE is_active IS NULL;
  ALTER TABLE users ALTER COLUMN is_active SET DEFAULT TRUE;
  ALTER TABLE users ALTER COLUMN is_active SET NOT NULL;
  ```

### 5-3. Role enum と OperationHistory

**注意**: CHG-006で以下は既に実装済み:
- `Role.java` enum (CUSTOMER, ADMIN)
- `OperationHistory.java` エンティティ
- `OperationHistoryService.java`
- `ForbiddenException.java`

本タスクでは、これらの既存実装を活用する。

---

## 6. 認可・監査ログ設計

### 6-1. 認可チェック

**既存管理API（CHG-006で実装済み）**:
- `ItemController.updateProduct()` — ADMIN必須
- `OrderController.confirmOrder()` — ADMIN必須
- `OrderController.shipOrder()` — ADMIN必須
- `OrderController.deliverOrder()` — ADMIN必須
- `OrderController.getAllOrders()` — ADMIN必須

**新規管理API（本タスクで実装）**:
- `AdminInventoryController` 全エンドポイント — 🆕 新規（ADMIN必須）
- `AdminController` 全エンドポイント — 🆕 新規（ADMIN必須）

**カート用API（認証不要、変更なし）**:
- `InventoryController.createReservation()` — 認証不要（既存維持）
- `InventoryController.releaseReservation()` — 認証不要（既存維持）
- `InventoryController.getAvailability()` — 認証不要（既存維持）

**実装パターン**:
```java
@PostMapping("/some-admin-action")
public ApiResponse<?> someAdminAction(
    @RequestHeader("Authorization") String authHeader,
    @RequestBody SomeRequest request) {

    // 認証・認可
    String token = extractToken(authHeader);
    User user = authService.verifyToken(token);
    requireAdmin(user, "/api/some-admin-action");

    // ビジネスロジック実行
    // ...

    // 監査ログ記録
    operationHistoryService.logAdminAction(user, "/api/some-admin-action", "操作詳細");

    return ApiResponse.success(result);
}
```

### 6-2. 監査ログ対象操作

| 操作 | エンドポイント | ログ詳細例 |
|------|----------------|------------|
| 商品編集 | `PUT /api/item/:id` | "Updated product: プレミアムコーヒー豆" |
| 注文確認 | `POST /api/order/:id/confirm` | "Confirmed order: ORD-20260213-001" |
| 注文発送 | `POST /api/order/:id/ship` | "Shipped order: ORD-20260213-001" |
| 注文配達完了 | `POST /api/order/:id/deliver` | "Delivered order: ORD-20260213-001" |
| 在庫調整 | `POST /api/admin/inventory/adjust` | "Adjusted inventory: プレミアムコーヒー豆 (50 → 60, delta: +10)" |
| 会員状態変更 | `PUT /api/admin/members/:id/status` | "Updated member status: user@example.com (active → inactive)" |
| 会員ロール変更 | `PUT /api/admin/members/:id/role` | "Updated member role: user@example.com (CUSTOMER → ADMIN)" |

---

## 7. 既存パターンとの整合性

### 7-1. API設計パターン

- **共通レスポンス形式**: `ApiResponse<T>` を使用（既存パターン）
- **エラーハンドリング**: `GlobalExceptionHandler` で集中管理（既存パターン）
- **認証ヘッダー**: `Authorization: Bearer <token>` を使用（既存パターン）
- **認可エラー**: `ForbiddenException` → HTTP 403（CHG-006パターン）

### 7-2. フロントエンド設計パターン

- **API呼び出し**: `src/lib/api.ts` 経由（既存パターン）
- **状態管理**: `useState` + `useEffect`（既存パターン）
- **スタイリング**: Tailwind CSS（既存パターン）
- **ルーティング**: React Router v7（既存パターン）

### 7-3. 参考実装

- **認可チェック**: `ItemController.updateProduct()` (CHG-006)
- **監査ログ**: `OperationHistoryService.logAdminAction()` (CHG-006)
- **管理画面UI**: `AdminOrderPage.tsx`, `AdminItemPage.tsx` (既存)
- **モーダル実装**: 既存プロジェクトのパターンを踏襲

---

## 8. 実装優先順位

### フェーズ1: 基盤整備
1. `Role` enum と `User.isActive` フィールド追加（未実装の場合）
2. `InventoryAdjustment` エンティティ作成
3. `AdminLayout` と `AdminSidebar` コンポーネント作成
4. 既存管理画面を `AdminLayout` でラップ

### フェーズ2: 在庫管理
5. `InventoryController` 作成（一覧、調整、履歴）
6. `AdminInventoryPage` 作成
7. API統合とテスト

### フェーズ3: 会員管理
8. `AdminController` 作成（会員一覧、詳細、状態/ロール変更）
9. `AdminMembersPage` 作成
10. API統合とテスト

### フェーズ4: 認可・監査強化
11. 全管理APIに認可チェック追加（未実装の場合）
12. 監査ログ記録の追加
13. 統合テスト

---

## 9. 非機能要件

### 9-1. パフォーマンス

- **在庫一覧取得**: 全商品数が1000件程度でも3秒以内にレスポンス
- **会員一覧取得**: ページネーション実装は後回し（初期は全件取得）

### 9-2. セキュリティ

- **認証**: 全管理APIでトークン検証必須
- **認可**: ADMIN ロール以外は403 Forbiddenエラー
- **監査ログ**: トランザクション分離（`REQUIRES_NEW`）で確実に記録
- **パスワード**: 会員管理画面でパスワードは表示しない（変更機能は対象外）

### 9-3. 保守性

- **コントローラー分離**: 会員管理は `AdminController` に集約
- **サービス層**: ビジネスロジックは `UserService`, `InventoryService` に実装
- **DTO使用**: エンティティを直接返さず、DTOで変換

---

## 10. テスト観点

### 10-1. フロントエンド

- [ ] サイドバーのメニュー切り替えが正常に動作する
- [ ] 各管理画面が表示される
- [ ] 在庫調整モーダルで入力・送信ができる
- [ ] 会員状態/ロール変更が反映される
- [ ] ADMIN以外でアクセスした際にエラー表示される

### 10-2. バックエンド

- [ ] ADMIN ロールで全管理APIにアクセスできる
- [ ] CUSTOMER ロールで管理APIにアクセスすると403エラー
- [ ] 在庫調整が `products.stock` と `inventory_adjustments` に正しく記録される
- [ ] 会員状態/ロール変更が `users` テーブルに反映される
- [ ] 監査ログが `operation_histories` テーブルに記録される

---

## 11. 制約事項

### 11-1. 対象外機能

- BIダッシュボード（売上分析、LTV分析など）
- CSV一括取込/一括出力
- メール配信、クーポン配布、ポイント管理
- 高度な権限分離（部署別・機能別の細粒度RBAC）

### 11-2. 既知の制限

- **在庫調整**: マイナス調整は可能だが、在庫が負になることは許可しない
- **会員削除**: 物理削除は実装しない（`isActive = false` で論理削除）
- **ロール変更**: 自分自身のロールは変更できない（実装で制御）

---

## 12. 関連ドキュメント

- **要件定義**: `docs/01_requirements/CHG-007_管理画面拡張（注文・在庫・会員）.md`
- **仕様書**:
  - `docs/specs/inventory.md` — 在庫管理仕様
  - `docs/specs/authentication.md` — 認証・認可仕様
  - `docs/ui/admin-ui.md` — 管理画面UI仕様
  - `docs/ui/api-spec.md` — API仕様
- **参考実装**:
  - CHG-006 — 会員機能追加（認証・認可基盤）
  - 既存の `AdminOrderPage.tsx`, `AdminItemPage.tsx`

---

## 13. 次のステップ

設計承認後、以下のタスクドキュメントを作成する:
- `docs/03_tasks/CHG-007_管理画面拡張（注文・在庫・会員）.md`

実装は以下の順序で進める:
1. データモデル拡張（エンティティ、リポジトリ）
2. バックエンドAPI実装（コントローラー、サービス）
3. フロントエンドコンポーネント実装（レイアウト、ページ）
4. 統合テスト
5. ドキュメント更新（`docs/ui/admin-ui.md`, `docs/ui/api-spec.md`）
