# CHG-003: カート内商品の数量上限（設計）

要件: `docs/01_requirements/CHG-003_カート数量上限.md`
作成日: 2026-02-12

---

## 1. 設計方針

既存の DTO バリデーション（`@Min`）とエラーレスポンス形式（`ApiResponse.error()`）を踏襲する。`INVALID_QUANTITY` エラーコードは api-spec.md に定義済みだが未使用のため、これを活用する。

数量上限値（9）はバックエンドの定数として一元管理し、フロントエンドにはカートレスポンスに含める形で伝達する。

---

## 2. API設計

### 2-1. カート追加時（REQ 2-1, 2-3）

**エンドポイント**: `POST /api/order/cart/items`

数量が上限を超える場合:

```json
{
  "success": false,
  "error": {
    "code": "INVALID_QUANTITY",
    "message": "1商品あたりの最大数量は9個です"
  }
}
```

- HTTPステータス: 400 Bad Request
- 例外: `BusinessException("INVALID_QUANTITY", "1商品あたりの最大数量は9個です")`
- チェック対象: リクエスト数量単体 + カート内既存数量との合計

### 2-2. 数量変更時（REQ 2-1, 2-3）

**エンドポイント**: `PUT /api/order/cart/items/{id}`

数量が上限を超える場合:

```json
{
  "success": false,
  "error": {
    "code": "INVALID_QUANTITY",
    "message": "1商品あたりの最大数量は9個です"
  }
}
```

- HTTPステータス: 400 Bad Request
- 数量変更は絶対値指定のため、単純に `quantity > 9` で判定

---

## 3. バックエンド実装

### 3-1. 変更: `AddToCartRequest.java`

`quantity` フィールドに `@Max(9)` を追加。

```java
// 現在: @Min(1) のみ
@Min(value = 1, message = "数量は1以上である必要があります")
@Max(value = 9, message = "1商品あたりの最大数量は9個です")
private Integer quantity = 1;
```

### 3-2. 変更: `UpdateQuantityRequest.java`

`quantity` フィールドに `@Max(9)` を追加。

```java
// 現在: @Min(1) のみ
@Min(value = 1, message = "数量は1以上である必要があります")
@Max(value = 9, message = "1商品あたりの最大数量は9個です")
private Integer quantity;
```

### 3-3. 変更: `CartService.java`

**定数追加**:

```java
private static final int MAX_QUANTITY_PER_ITEM = 9;
```

**`addToCart()`** — DTO バリデーション通過後、カート内既存数量との合計チェック:

```java
// 既存の isPublished チェックの後、InventoryService 呼び出しの前
CartItem existingItem = cart.getItems().stream()
    .filter(item -> item.getProduct().getId().equals(product.getId()))
    .findFirst()
    .orElse(null);

int totalQuantity = request.getQuantity() + (existingItem != null ? existingItem.getQuantity() : 0);
if (totalQuantity > MAX_QUANTITY_PER_ITEM) {
    throw new BusinessException("INVALID_QUANTITY",
        "1商品あたりの最大数量は" + MAX_QUANTITY_PER_ITEM + "個です（現在カートに"
        + (existingItem != null ? existingItem.getQuantity() : 0) + "個あります）");
}
```

**`updateCartItemQuantity()`** — DTO バリデーションで十分（絶対値指定のため追加チェック不要）。

### 3-4. バリデーション層の整理

| チェック | レイヤー | 内容 |
|----------|---------|------|
| 範囲チェック | DTO（`@Min`/`@Max`） | 1 ≤ quantity ≤ 9 |
| 合計チェック | CartService | 既存数量 + 追加数量 ≤ 9（addToCart のみ） |
| 在庫チェック | InventoryService | quantity ≤ 有効在庫（既存のまま） |

評価順: DTO → CartService（合計チェック）→ InventoryService（在庫チェック）

---

## 4. フロントエンド実装

### 4-1. 変更: `CartPage.tsx`

数量入力欄に `max` 属性を追加し、クライアントサイドバリデーションを強化。

```tsx
// 現在: <input type="number" min="0" ...>
<input
  type="number"
  min="1"
  max={9}
  value={item.quantity}
  onChange={(e) => {
    const value = parseInt(e.target.value) || 1;
    const clamped = Math.min(Math.max(value, 1), 9);
    handleQuantityChange(item.id, clamped);
  }}
  className="w-16 rounded border border-gray-300 px-3 py-1 text-center"
/>
```

### 4-2. 変更: `CartContext.tsx`

**`updateQuantity()`** — 上限チェックを追加:

```typescript
// 現在: quantity <= 0 の場合のみ removeItem
if (quantity > 9) return; // 上限超過は無視
```

**`addToCart()`** — 変更不要（バックエンドで合計チェックするため）。エラーレスポンスは既存のエラーハンドリングで表示される。

### 4-3. 変更: `ItemDetailPage.tsx`

商品詳細画面の「カートに追加」ボタンで数量選択がある場合、同様に上限を設定。現在は固定で1個追加のため、変更不要。

---

## 5. 処理フロー

### カート追加時
```
ユーザー → addToCart API
  → @Valid: quantity 1〜9 → 範囲外 → 400 (MethodArgumentNotValid)
  → CartService: 既存数量 + 追加数量 ≤ 9 → 超過 → 400 (INVALID_QUANTITY)
  → InventoryService: quantity ≤ 有効在庫 → 超過 → 409 (INSUFFICIENT_STOCK)
  → (OK) カートに追加
```

### 数量変更時
```
ユーザー → updateQuantity API
  → @Valid: quantity 1〜9 → 範囲外 → 400 (MethodArgumentNotValid)
  → InventoryService: quantity ≤ 有効在庫 → 超過 → 409 (INSUFFICIENT_STOCK)
  → (OK) 数量更新
```

---

## 6. 既存パターンとの整合性

| 観点 | 既存（在庫チェック） | CHG-003（数量上限） |
|------|---------------------|---------------------|
| バリデーション層 | InventoryService | DTO + CartService |
| HTTPステータス | 409 Conflict | 400 Bad Request |
| エラーコード | `INSUFFICIENT_STOCK` | `INVALID_QUANTITY` |
| 例外クラス | `ConflictException` | `BusinessException` |
| details 付き | あり | なし（単純なメッセージ） |

---

## 7. テスト観点

- カート追加: 数量10 → 400エラー、数量9 → 正常追加
- カート追加: カート内に5個 + 追加5個 = 合計10 → 400エラー
- カート追加: カート内に5個 + 追加4個 = 合計9 → 正常追加
- 数量変更: 数量10 → 400エラー、数量9 → 正常変更
- 数量変更: 数量0 → 400エラー（既存の @Min バリデーション）
- 在庫が3個の場合: 数量5 → 409エラー（在庫不足が先に検出）
- フロントエンド: 入力欄で10以上が入力できないこと
