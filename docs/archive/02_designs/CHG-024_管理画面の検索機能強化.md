# CHG-024: 管理画面の検索機能強化 - 技術設計

要件: `docs/01_requirements/CHG-024_管理画面の検索機能強化.md`
作成日: 2026-02-22

**SSOT（唯一の真実）**:
- API契約: このドキュメントの「API契約」セクション
- DBスキーマ: Flyway マイグレーションなし（既存カラムのみ使用）
- モジュール境界: `backend/AGENTS.md` のモジュール依存ルール

---

## 1. 設計方針

### 1.1 サーバーサイドフィルタへの移行

現状は全件取得後にフロントでクライアントサイドフィルタを行っている。
データ増加に備え、全フィルタをサーバーサイド（Core API レベル）で処理する。

- フロント → `useSearchParams` でURL同期 + APIにパラメータ転送
- BFF → クエリパラメータをそのまま Core API へ透過
- Core API → `JpaSpecificationExecutor` による動的フィルタクエリ

### 1.2 JPA Specification 採用理由

複数フィルタの任意組み合わせに対応するため、`JpaSpecificationExecutor` を採用する。
カスタム JPQL メソッドでは条件の組み合わせ爆発が起きるため不採用。

商品の「在庫閾値以下」は REAL/FRAME で有効在庫源泉が異なるため、
`effectiveStock` 相当を JOINで計算するサブクエリ Specification として実装する。

注文の「引当未完了」は集計フィルタ（`allocated_qty < quantity`）を
`EXISTS` サブクエリ Specification として実装する。

### 1.3 注文一覧へのページネーション追加

現在の注文一覧は `findAll()` 全件取得で、BFF でもページネーション情報をハードコードしている。
サーバーサイドフィルタ移行に合わせ、Core API / BFF ともにページネーションを正規化する。

### 1.4 URL同期戦略

フィルタ状態は React Router の `useSearchParams` で URL クエリパラメータと双方向同期する。
初期表示時は URL パラメータからフィルタ初期値を復元する。
フィルタ変更時は `setSearchParams` でURLを更新し、ブラウザ履歴に追記する。

---

## 2. API契約

### 2.1 Core API — 商品一覧（変更）

```
GET /api/bo/admin/items
```

追加クエリパラメータ（全て省略可能）:

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `keyword` | string | 商品名・品番の部分一致 |
| `categoryId` | number | カテゴリID完全一致 |
| `isPublished` | boolean | 公開状態フィルタ |
| `inSalePeriod` | boolean | true=現在販売期間内のみ |
| `allocationType` | `"REAL" \| "FRAME"` | 引当区分フィルタ |
| `stockThreshold` | number | `effectiveStock <= threshold` の商品のみ |
| `zeroStockOnly` | boolean | true=`effectiveStock == 0` のみ |

既存パラメータ `page`, `limit` は継続。
レスポンス構造は既存の `PagedResponse<ProductDto>` を継続。

`zeroStockOnly=true` は `stockThreshold=0` と等価。両方指定時は `zeroStockOnly` 優先。

`effectiveStock` の定義（CHG-023 既定）:
- REAL: `max(0, locationStock.allocatableQty - locationStock.allocatedQty - activeTentativeQty(real))`
- FRAME: `max(0, salesLimitTotal - orderedFrameQty(non-cancelled) - activeTentativeQty(frame))`

### 2.2 Core API — 注文一覧（変更）

```
GET /api/order
```

追加クエリパラメータ（全て省略可能）:

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| `orderNumber` | string | 注文番号部分一致 |
| `customerEmail` | string | 会員メール部分一致 |
| `statuses` | string | ステータス複数選択（カンマ区切り。例: `PENDING,CONFIRMED`） |
| `dateFrom` | string | 注文日付 FROM（ISO-8601 日付文字列）|
| `dateTo` | string | 注文日付 TO（ISO-8601 日付文字列）|
| `totalPriceMin` | number | 合計金額の下限（以上） |
| `totalPriceMax` | number | 合計金額の上限（以下） |
| `allocationIncomplete` | boolean | true=引当未完了（`allocatedQty < orderedQty`）のみ |
| `unshipped` | boolean | true=出荷未指示（PENDING/CONFIRMED/PREPARING_SHIPMENT）のみ |
| `page` | number | ページ番号（1始まり、デフォルト1） |
| `limit` | number | ページサイズ（デフォルト20） |

レスポンス変更:
- 現在: `OrderDto[]`（フラット配列）
- 変更後: `{ orders: OrderDto[], pagination: { page, pageSize, totalCount } }`

BFF の `normalizeOrder` / ハードコードpagination は廃止し、Core API の実値を透過する。

HTTPステータス:
- `200 OK`: 検索成功（0件も200）
- `400 Bad Request`: パラメータ不正（不明なステータス値等）

### 2.3 BackOffice BFF — 商品一覧（変更）

```
GET /api/admin/items
```

追加クエリパラメータ: `keyword`, `categoryId`, `isPublished`, `inSalePeriod`, `allocationType`, `stockThreshold`, `zeroStockOnly` を Core API へそのまま透過。

### 2.4 BackOffice BFF — 注文一覧（変更）

```
GET /api/admin/orders
```

追加クエリパラメータ: `orderNumber`, `customerEmail`, `statuses`, `dateFrom`, `dateTo`, `totalPriceMin`, `totalPriceMax`, `allocationIncomplete`, `unshipped`, `page`, `limit` を Core API へ透過。

---

## 3. モジュール・レイヤ構成

```
product/
  domain/repository/ProductRepository        (JpaSpecificationExecutor 追加)
  application/usecase/ProductUseCase         (フィルタ引数追加)
  application/dto/AdminProductSearchParams   (新規: 検索条件DTO)
  application/spec/ProductSpecifications     (新規: Specification ファクトリ)
  adapter/rest/BoAdminProductController      (RequestParam 追加)

purchase/
  order/repository/OrderRepository           (JpaSpecificationExecutor 追加)
  application/usecase/OrderUseCase           (フィルタ引数・ページネーション追加)
  application/dto/AdminOrderSearchParams     (新規: 検索条件DTO)
  application/spec/OrderSpecifications       (新規: Specification ファクトリ)
  adapter/rest/OrderController               (RequestParam 追加)
```

BFF:
```
bff/backoffice-bff/src/
  products/products.controller.ts   (@Query 追加)
  products/products.service.ts      (URL パラメータ組み立て追加)
  orders/orders.controller.ts       (@Query 追加)
  orders/orders.service.ts          (URL パラメータ組み立て追加、全件取得廃止)
```

フロントエンド:
```
frontend/src/
  pages/admin/AdminItemPage/index.tsx    (useSearchParams 移行、UIコンポーネント拡充)
  pages/admin/AdminOrderPage/index.tsx   (useSearchParams 移行、UIコンポーネント拡充)
  entities/product/model/api.ts          (検索パラメータ追加)
  entities/order/model/api.ts            (検索パラメータ追加)
  entities/product/model/types.ts        (AdminProductSearchParams 型追加)
  entities/order/model/types.ts          (AdminOrderSearchParams 型追加)
```

---

## 4. 主要クラス/IFの責務

| クラス/IF | 責務 | レイヤ |
|-----------|------|--------|
| `AdminProductSearchParams` | 商品検索条件を保持する値オブジェクト | product/application/dto |
| `ProductSpecifications` | Specification ファクトリ（条件→`Specification<Product>`変換） | product/application/spec |
| `ProductUseCase.getAdminProducts` | 検索条件と Pageable を受け取り PagedResponse を返す | product/application |
| `AdminOrderSearchParams` | 注文検索条件を保持する値オブジェクト | purchase/application/dto |
| `OrderSpecifications` | Specification ファクトリ（条件→`Specification<Order>`変換） | purchase/application/spec |
| `OrderUseCase.getAllOrders` | 検索条件と Pageable を受け取り PagedResponse を返す | purchase/application |
| `AdminItemPage` | `useSearchParams` でURL同期・フィルタUIレンダリング | frontend/pages |
| `AdminOrderPage` | `useSearchParams` でURL同期・フィルタUIレンダリング | frontend/pages |

---

## 5. トランザクション・非同期方針

- 全て読み取り専用（`@Transactional(readOnly = true)`）。
- 書き込みトランザクションへの変更なし。
- 在庫閾値フィルタは `location_stocks` / `sales_limits` を LEFT JOIN するため、
  N+1を避けるクエリ設計とする（Specification 内で JOIN を明示）。

---

## 6. 処理フロー

### 6.1 商品フィルタ検索

```
AdminItemPage (useSearchParams)
  → entities/product/model/api.ts (getAdminProducts with params)
  → BFF ProductsController (@Query デコレータで受取)
  → BFF ProductsService (Core API URLにパラメータ付与)
  → Core API BoAdminProductController (@RequestParam)
  → ProductUseCase.getAdminProducts(AdminProductSearchParams, Pageable)
    → ProductSpecifications.build(params) → Specification<Product>
    → ProductRepository.findAll(spec, pageable)
    → Page<ProductDto> → PagedResponse
```

### 6.2 注文フィルタ検索

```
AdminOrderPage (useSearchParams)
  → entities/order/model/api.ts (getAdminOrders with params)
  → BFF OrdersController (@Query デコレータで受取)
  → BFF OrdersService (Core API URLにパラメータ付与、全件取得廃止)
  → Core API OrderController (@RequestParam)
  → OrderUseCase.getAllOrders(AdminOrderSearchParams, Pageable)
    → OrderSpecifications.build(params) → Specification<Order>
    → OrderRepository.findAll(spec, pageable) (pageableあり)
    → Page<OrderDto> → PagedResponse
```

---

## 7. 影響範囲

| 区分 | 対象 | 変更概要 |
|------|------|---------|
| 新規作成 | `backend/.../product/application/dto/AdminProductSearchParams.java` | 商品検索条件DTO |
| 新規作成 | `backend/.../product/application/spec/ProductSpecifications.java` | 商品Specificationファクトリ |
| 既存変更 | `backend/.../product/domain/repository/ProductRepository.java` | `JpaSpecificationExecutor<Product>` 追加 |
| 既存変更 | `backend/.../product/application/usecase/ProductUseCase.java` | `getAdminProducts` シグネチャ変更 |
| 既存変更 | `backend/.../product/adapter/rest/BoAdminProductController.java` | 検索 `@RequestParam` 追加 |
| 新規作成 | `backend/.../purchase/application/dto/AdminOrderSearchParams.java` | 注文検索条件DTO |
| 新規作成 | `backend/.../purchase/application/spec/OrderSpecifications.java` | 注文Specificationファクトリ |
| 既存変更 | `backend/.../purchase/order/repository/OrderRepository.java` | `JpaSpecificationExecutor<Order>` 追加 |
| 既存変更 | `backend/.../purchase/application/usecase/OrderUseCase.java` | `getAllOrders` シグネチャ変更（Pageable追加） |
| 既存変更 | `backend/.../purchase/adapter/rest/OrderController.java` | 検索 `@RequestParam` 追加 |
| 既存変更 | `bff/backoffice-bff/src/products/products.controller.ts` | 商品検索 `@Query` 追加 |
| 既存変更 | `bff/backoffice-bff/src/products/products.service.ts` | Core API URLへのパラメータ組み立て追加 |
| 既存変更 | `bff/backoffice-bff/src/orders/orders.controller.ts` | 注文検索 `@Query` 追加 |
| 既存変更 | `bff/backoffice-bff/src/orders/orders.service.ts` | 全件取得廃止・パラメータ透過・レスポンス構造変更 |
| 既存変更 | `frontend/src/pages/admin/AdminItemPage/index.tsx` | `useSearchParams` 移行・検索UIコンポーネント追加 |
| 既存変更 | `frontend/src/pages/admin/AdminOrderPage/index.tsx` | `useSearchParams` 移行・検索UIコンポーネント追加 |
| 既存変更 | `frontend/src/entities/product/model/api.ts` | 検索パラメータ追加 |
| 既存変更 | `frontend/src/entities/order/model/api.ts` | 検索パラメータ追加 |
| 既存変更 | `frontend/src/entities/product/model/types.ts` | `AdminProductSearchParams` 型追加 |
| 既存変更 | `frontend/src/entities/order/model/types.ts` | `AdminOrderSearchParams` 型追加 |
| 既存変更 | `docs/ui/admin-ui.md` | 商品管理・注文管理の検索仕様追記 |
| 既存変更 | `docs/api/backoffice-bff-openapi.json` | 検索クエリパラメータ追加 |
| 既存変更 | `docs/specs/order.md` | 引当進捗検索の明示 |
| 既存変更 | `docs/specs/product.md` | 在庫条件検索の明示 |

---

## 8. テスト観点

- 正常系:
  - 各フィルタパラメータ単体で正しく絞り込まれる（商品: keyword, categoryId, isPublished, inSalePeriod, allocationType, stockThreshold, zeroStockOnly）
  - 各フィルタパラメータ単体で正しく絞り込まれる（注文: orderNumber, customerEmail, statuses, 日付範囲, 金額範囲, allocationIncomplete, unshipped）
  - パラメータ未指定時は従来の全件一覧と同一結果になる
  - 複数条件を AND 組み合わせで正しく絞り込まれる
  - statuses に複数値（カンマ区切り）を指定して OR 検索できる
  - 結果0件のとき空配列とtotalCount=0が返る
  - ページネーションが正しく機能する（page/limit/totalCount一致）
  - URLにフィルタパラメータを含んで直接アクセスすると同一結果が再現される

- 異常系:
  - 不明なステータス文字列指定時に 400 が返る
  - `stockThreshold` に負値を指定した場合の動作（400 or 0件）
  - `dateFrom > dateTo` のケース（400 or 0件）

- 境界値:
  - `zeroStockOnly=true` と `stockThreshold=0` が同一結果になる
  - `allocationIncomplete=true` で `allocatedQty == orderedQty` の注文が除外される
  - `unshipped=true` で PENDING/CONFIRMED/PREPARING_SHIPMENT が対象、SHIPPED/DELIVERED/CANCELLED が除外される
  - `effectiveStock` の計算が REAL/FRAME それぞれ正しく stockThreshold フィルタに反映される
