# CHG-023 impl-notes

## T-1

- `products.stock` は物理削除せず、`allocation_type` 追加と同時に全件 `0` 初期化のみ実施。
- `location_stocks` は `UNIQUE(product_id, location_id)` + `allocated_qty/allocatable_qty >= 0` 制約で管理し、単一拠点 `location_id=1` を既定化。
- `sales_limits` は集計値を永続せず `sales_limit_total` のみ保持し、消費数は注文明細集計で算出する方針とした。
- FIFO処理の探索性能を担保するため `orders(created_at, id)` と `order_items(order_id, id)`、`order_items(product_id, allocated_qty, id)` の index を追加。
- 追加検証:
  - `docker compose build backend`
  - `docker compose up -d backend`
  - `docker compose logs backend | rg "V11__introduce_allocation_type_and_stock_models|Successfully applied"`

## T-2

- Product契約は `stock` を廃止し、`allocationType` と `effectiveStock` を返す構造へ変更。
- `effectiveStock` の算出責務は `InventoryQueryPort.calculateEffectiveStock` に集約し、ProductUseCase は Port 呼び出しのみ実施。
- 管理向け在庫タブ API は `BoAdminProductController` から `InventoryCommandPort/InventoryQueryPort` を呼び出す構成で実装。
- `stock` 廃止互換は DBカラム保持 + DTO非公開で対応した。
- 追加検証:
  - `cd backend && ./mvnw -q test -Dtest=ProductControllerContractTest,BoAdminProductControllerContractTest,InventoryUseCaseTest`

## T-3

- 非同期本引当は `FrameAllocationService` に集約し、Outboxイベント（`ORDER_PLACED`, `STOCK_AVAILABILITY_INCREASED`）で起動。
- 在庫行は `LocationStockRepository.findByProductIdAndLocationIdForUpdate` で悲観ロックし、同一トランザクションで `order_items.allocated_qty` と `location_stocks.allocated_qty` を更新。
- 冪等性は `allocated_qty` を増加専用・上限 `quantity` で制御し、重複イベント時は差分0更新となる。
- FIFO は `orders.created_at ASC, orders.id ASC, order_items.id ASC` の repository query で実装。
- 追加検証:
  - `cd backend && ./mvnw -q test -Dtest=FrameAllocationServiceTest,OrderUseCaseOutboxTest,OutboxProcessorTest`

## T-4

- 出荷可否は `OrderUseCase.markShipped` で `ordered == allocated` を必須化し、未引当時は既存 `INVALID_STATUS_TRANSITION` で拒否。
- キャンセル時の副作用は `InventoryUseCase.releaseCommittedReservations` に集約し、`allocated_qty` 解放と在庫増加イベント発行を同トランザクションで実施。
- `allocation/retry` は対象外状態（`CANCELLED`/`SHIPPED`/`DELIVERED`）を拒否し、全量引当済は no-op 成功（再計算のみ）とした。
- 追加検証:
  - `cd backend && ./mvnw -q test -Dtest=OrderUseCaseStateTransitionTest,CreateShipmentJobTest,OrderControllerContractTest`

## T-6

- Customer BFF は Core API の `allocationType` / `effectiveStock` を透過し、在庫表示判定を `effectiveStock` ベースへ統一。
- 注文レスポンスは `orderedQuantity` / `allocatedQuantity` を正規化して顧客UIへ渡す責務に限定。
- 追加検証:
  - `cd bff/customer-bff && npm run build`

## T-7

- BackOffice BFF に `/api/admin/items/:id/inventory`（GET/PUT）を追加し、Core の在庫タブ API を中継。
- 注文APIは `orderedQuantity` / `allocatedQuantity` を透過し、`/api/admin/orders/:id/allocation/retry` を追加。
- 既存 `/api/inventory*` は互換維持のため残置。
- 追加検証:
  - `cd bff/backoffice-bff && npm run build`

## T-8

- Frontend の product/order 型を `stock` 非依存へ更新し、`allocationType` / `effectiveStock` / 進捗項目を追加。
- 既存UI連携への影響を避けるため BFF 側 normalize で不足フィールドにフォールバック値を補完。
- 追加検証:
  - `npm run build --prefix frontend`

## T-9

- 管理商品詳細モーダルを `商品/在庫/販売` の3タブに再編し、在庫更新責務を商品詳細内へ集約。
- `/bo/inventory` 導線は router と sidebar から削除し、互換APIのみ維持。
- 追加検証:
  - `npm run build --prefix frontend && cd frontend && bash ./e2e/admin-smoke.sh`

## T-11

- 契約語彙は `allocationType`, `effectiveStock`, `orderedQuantity`, `allocatedQuantity` へ統一。
- 旧 `products.stock` は「非業務参照」の文言で残し、API契約側は `allocation/retry` を明示。
- 追加検証:
  - `rg -n "allocationType|effectiveStock|location_stocks|sales_limits|allocatedQuantity|orderedQuantity|allocation/retry|products\\.stock" docs/data-model.md docs/specs/inventory.md docs/specs/order.md docs/specs/product.md docs/ui/admin-ui.md docs/api/openapi.json docs/api/customer-bff-openapi.json docs/api/backoffice-bff-openapi.json`
