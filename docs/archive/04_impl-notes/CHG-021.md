# CHG-021 impl-notes

## T-1
- `product_categories` は論理削除・監査カラムを既存主要テーブルと同型で作成し、`name` 一意制約は `uk_product_categories_name` で明示した。
- 既存 `products` への非NULL追加に備えて、移行内で先に「未分類」カテゴリを投入し、その後 `product_code` と `category_id` をバックフィルしてから NOT NULL 制約を付与した。
- 期間整合は DB でも担保するため、`publish_start_at/publish_end_at` と `sale_start_at/sale_end_at` の CHECK 制約、および `sale` が `publish` 範囲内である制約を追加した。

## T-2
- 顧客向け表示判定は `ProductRepository.findPublishedForCustomer/findVisibleById` に集約し、UseCase 側で分岐させない構成にして判定式の重複を避けた。
- `ITEM_NOT_FOUND` の隠蔽方針を維持するため、顧客詳細取得は「存在しない」場合と「非表示条件」該当を同じ 404（`ITEM_NOT_FOUND`）に統一した。
- 販売期間の公開期間内制約は `INVALID_SCHEDULE` として UseCase で検証し、`create` と `update` の双方で同一バリデータを利用した。

## T-3
- 管理向け商品/カテゴリ API は `BoAdminProductController` で新設し、既存画面互換のため `/api/admin/*` と `/api/bo/admin/*` を同一メソッドにマルチマッピングした。
- 権限不足は既存管理系と同じ `FORBIDDEN` を維持し、認証ヘッダ不備は `UNAUTHORIZED` としてエラー契約を既存の運用に合わせた。
- 監査イベントは既存の `OPERATION_PERFORMED` に寄せ、商品/カテゴリ操作ごとに requestPath と details を記録する方針にした。

## T-4
- カートの可用判定は `isPurchasableById`（商品公開・カテゴリ公開・公開期間・販売期間）へ切り替え、`add/update/getOrCreate` の入口で同じ判定を適用した。
- 既存エラー文言を変えないため、購入不可時の返却コード/メッセージは `ITEM_NOT_AVAILABLE` / 「この商品は現在購入できません」を維持した。
- 在庫判定との順序は既存どおり在庫サービス側に委譲し、公開判定はカートサービス側で先に短絡評価する構成にした。

## T-5
- Customer BFF は Core API の拡張項目を後方互換で吸収できるよう、`isPublished/published` と `categoryName/category` の双方を正規化する実装にした。
- 期間値は epoch seconds/epoch millis/ISO 文字列の混在を吸収するため、`toEpochMillis` で単一路線に正規化して公開判定に利用した。
- 公開判定の最終責務は Core API に残しつつ、BFF 側でも `isVisible` フィルタを適用して契約の防衛線を二重化した。

## T-6
- BackOffice BFF は controller ルートを `['api/admin', 'api/bo/admin']` の併記にし、既存クライアントと新規契約の両方を同時に満たす方針を採用した。
- Core API への中継パスは `/api/bo/admin/*` に固定し、BFF 側では外部公開ルート差異のみを吸収する薄いアダプタに留めた。
- 商品/カテゴリの作成・更新成功時は既存商品キャッシュキー（`cache:product:*`, `cache:products:list:*`）を共通で無効化した。

## T-9
- 仕様文言は DB カラム（`is_published`）と API フィールド（`isPublished`）の両表記を役割で使い分け、フラグ名称の実体を `is_published` に統一した。
- 旧 `is_active` 相当の運用記述は商品ドメインから除外し、「商品公開」「カテゴリ公開」「公開期間」「販売期間」で判定する構成へ置換した。
- Core API OpenAPI は backend `integration-test` 実行で再生成し、`jobrunr` ポート競合回避のため `ec-backend` コンテナ停止後に生成した。
