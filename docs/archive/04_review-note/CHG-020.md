# CHG-020 review-note

## T-1
- `users` 拡張は NULL 許容で追加し、既存会員データを非破壊で移行できるようにした（`member_rank` / `loyalty_points` / `newsletter_opt_in` は DEFAULT 付与）。
- `member_rank` は DB 制約で `STANDARD/SILVER/GOLD/PLATINUM` を固定し、アプリ層の enum と不整合が起きないようにした。
- `user_addresses` のデフォルト住所制約は部分一意インデックス（`user_id` + `is_default=true` + `is_deleted=false`）で実装し、論理削除済み住所を排他対象から除外した。

## T-2
- `UserProfileService` をトランザクション境界として追加し、プロフィール更新と住所更新を同一サービス内で完結させた。
- `is_default` 正規化は `clearDefaultByUserId` の更新クエリを先に実行し、その後対象住所を保存する順序に統一した（同一会員内で最大1件を維持）。
- 住所ID直指定の更新/削除は `findById` 後に所有者チェックを行い、他会員住所は `FORBIDDEN` で拒否する実装にした。

## T-3
- 顧客プロフィール更新は `UpdateMyProfileRequest` の `@JsonAnySetter` で未知フィールドを収集し、許可外項目を `INVALID_REQUEST` で拒否する方式にした。
- 住所APIの request 型は `AuthController` 内部クラスに置き、顧客向け公開契約の変更をコントローラー境界で閉じた。
- `GET /api/auth/me` は `UserProfileService` から住所を取得して `UserDto` に合成し、顧客画面での再取得一貫性を優先した。

## T-4
- BO 会員作成は `UserService#createUserByAdmin` に切り出し、重複メール判定とパスワードハッシュ化を既存責務に寄せた。
- BO FULL更新は `UpdateMemberRequest` + `ProfileUpdateCommand` + `applyAddressUpserts` で一括反映し、住所追加/更新/削除を単一APIで扱えるようにした。
- `/api/bo/admin/members/*` と `/api/admin/members/*` の互換維持は `@RequestMapping` に複数パスを登録して実現した。

## T-5
- Customer BFF は `/api/members/me` と `/api/members/me/addresses*` を Core API の `/api/auth/me*` に1対1で透過中継する実装にした。
- エラー処理は `CoreApiService` の既存ポリシー（Core 側 `success=false` を HTTP ステータスごと透過）を維持し、members サービス側で独自変換しない方針にした。

## T-6
- BackOffice BFF は既存 GET/GET:id/PUT:status を維持しつつ、POST/PUT:id を追加して会員新規登録/FULL更新を Core API に中継した。
- 互換性は controller の複数パス定義（`api/admin/members` と `api/bo/admin/members`）を維持して壊さない方針にした。
