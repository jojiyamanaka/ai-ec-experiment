## CHG-024 review-note

## T-1
- クエリ契約は `AdminProductSearchParams` を導入し、`BoAdminProductController` で `@RequestParam` を DTO へ束ねて `ProductUseCase` に渡す構成に統一した。
- `zeroStockOnly=true` は `stockThreshold` より優先し、Specification 内で閾値を強制 `0` にする実装とした（両指定時の優先ルールを固定）。
- `effectiveStock` 判定責務は `ProductSpecifications` 側に寄せ、既存 `InventoryUseCase#calculateEffectiveStock` と同じ計算式（REAL/FRAME ともに tentative を差し引いて下限0）を SQL 条件式へ写経した。
- `allocationType` 不正値と負の `stockThreshold` は `BusinessException(INVALID_REQUEST)` として 400 契約に寄せた。
- 追加検証:
  - `cd backend && ./mvnw test -Dtest=BoAdminProductControllerContractTest,ProductUseCaseTest` PASS

## T-2
- レスポンス契約を `AdminOrderListResponse { orders, pagination }` に変更し、`OrderQueryPort` から固定配列返却を廃止した。
- `allocationIncomplete` 境界は `EXISTS(order_items where committed_qty < quantity)` で判定し、部分引当のみを抽出する仕様に固定した。
- `unshipped` 境界は `PENDING/CONFIRMED/PREPARING_SHIPMENT` のみ許容する固定集合で実装した。
- `statuses` の不正値は `BusinessException(INVALID_REQUEST)` を返すよう `OrderController#parseStatuses` で明示的にバリデーションした（400契約）。
- 追加検証:
  - `cd backend && ./mvnw test -Dtest=OrderControllerContractTest,OrderUseCaseTest` PASS

## T-3
- BFF 公開契約は `/api/admin/orders` の応答を Core API 透過（`orders + pagination`）へ変更し、旧 `normalizeOrder + 固定pagination` を削除した。
- Core API 透過方針として、商品・注文とも query を `URLSearchParams` で構築し未指定条件は送信しない実装に統一した。
- 既存フロント互換については CHG-024 対象画面で同時に API クライアント/型を更新し、BFF 側の互換レイヤは持たない判断とした。
- 追加検証:
  - `cd bff/backoffice-bff && npm run build` PASS

## T-4
- フロント型契約差分として `AdminProductSearchParams` / `AdminOrderSearchParams` / `AdminOrderListResponse` を追加し、クエリ・レスポンスの型境界を API レイヤに明示した。
- ページネーション項目の互換性は `orders[]` 直返却を廃止し、管理画面が `pagination.page/pageSize/totalCount` を直接利用する形へ統一した。
- 追加検証:
  - `npm run build --prefix frontend` PASS

## T-8
- UI仕様・業務仕様・OpenAPI に同じ検索パラメータ語彙（`keyword`/`stockThreshold`/`zeroStockOnly`/`allocationIncomplete`/`unshipped`/`customerEmail`/`statuses`/`dateFrom`/`dateTo`/`totalPriceMin`/`totalPriceMax`）を反映し、用語ずれを解消した。
- 追加検証:
  - `rg -n "keyword|stockThreshold|zeroStockOnly|allocationIncomplete|unshipped|customerEmail|statuses|dateFrom|dateTo|totalPriceMin|totalPriceMax" docs/ui/admin-ui.md docs/api/backoffice-bff-openapi.json docs/specs/order.md docs/specs/product.md` PASS

## Final Gate 結果
- `docker compose build backend backoffice-bff frontend-admin frontend-customer` PASS
- `docker compose up -d` PASS
- `cd backend && ./mvnw compile` PASS
- `cd backend && ./mvnw test` FAIL
  - 既存不具合: Flyway マイグレーション重複（`V2__baseline_current_schema.sql` と `V2__insert_sample_data.sql`）で `BoAuthSecurityTest` 起動時に ApplicationContext 生成失敗
- `cd bff/backoffice-bff && npm run build` PASS
- `npm run build --prefix frontend` PASS
- `cd frontend && bash ./e2e/admin-smoke.sh` PASS
- `curl -sS -o /dev/null -w "backoffice-bff=%{http_code}\n" http://localhost:3002/health` PASS (200)
- `curl -sS -o /dev/null -w "frontend-admin=%{http_code}\n" http://localhost:5174` PASS (200)

## Review Packet
### 変更サマリ（10行以内）
- Core API 商品一覧に複合検索条件（keyword/categoryId/isPublished/inSalePeriod/allocationType/stockThreshold/zeroStockOnly）を追加。
- Core API 注文一覧を複合検索 + ページネーション + `orders/pagination` 契約に変更。
- BackOffice BFF の商品・注文 API を query 透過型へ変更し、注文の全件取得前提を廃止。
- フロントの商品/注文 entity API・型を新契約に更新。
- AdminItemPage/AdminOrderPage を `useSearchParams` 同期に移行し、複合フィルタ・クリア・0件表示を実装。
- 管理画面検索仕様を `docs/ui/admin-ui.md`・`docs/specs/order.md`・`docs/specs/product.md`・`docs/api/backoffice-bff-openapi.json` に反映。
- MCP Playwright で URL 直アクセス復元・ブラウザ戻る維持・0件表示を確認。

### 変更ファイル一覧
- backend/src/main/java/com/example/aiec/modules/product/application/port/AdminProductSearchParams.java
- backend/src/main/java/com/example/aiec/modules/product/application/spec/ProductSpecifications.java
- backend/src/main/java/com/example/aiec/modules/product/application/port/ProductQueryPort.java
- backend/src/main/java/com/example/aiec/modules/product/application/usecase/ProductUseCase.java
- backend/src/main/java/com/example/aiec/modules/product/domain/repository/ProductRepository.java
- backend/src/main/java/com/example/aiec/modules/product/adapter/rest/BoAdminProductController.java
- backend/src/main/java/com/example/aiec/modules/purchase/application/port/AdminOrderSearchParams.java
- backend/src/main/java/com/example/aiec/modules/purchase/application/port/AdminOrderListResponse.java
- backend/src/main/java/com/example/aiec/modules/purchase/application/spec/OrderSpecifications.java
- backend/src/main/java/com/example/aiec/modules/purchase/application/port/OrderQueryPort.java
- backend/src/main/java/com/example/aiec/modules/purchase/application/usecase/OrderUseCase.java
- backend/src/main/java/com/example/aiec/modules/purchase/order/repository/OrderRepository.java
- backend/src/main/java/com/example/aiec/modules/purchase/adapter/rest/OrderController.java
- backend/src/test/java/com/example/aiec/modules/product/adapter/rest/BoAdminProductControllerContractTest.java
- backend/src/test/java/com/example/aiec/modules/purchase/adapter/rest/OrderControllerContractTest.java
- backend/src/test/java/com/example/aiec/modules/purchase/application/usecase/OrderUseCaseTest.java
- bff/backoffice-bff/src/products/products.controller.ts
- bff/backoffice-bff/src/products/products.service.ts
- bff/backoffice-bff/src/orders/orders.controller.ts
- bff/backoffice-bff/src/orders/orders.service.ts
- frontend/src/entities/product/model/types.ts
- frontend/src/entities/product/model/api.ts
- frontend/src/entities/product/model/ProductContext.tsx
- frontend/src/entities/product/index.ts
- frontend/src/entities/order/model/types.ts
- frontend/src/entities/order/model/api.ts
- frontend/src/entities/order/index.ts
- frontend/src/pages/admin/AdminItemPage/index.tsx
- frontend/src/pages/admin/AdminOrderPage/index.tsx
- docs/ui/admin-ui.md
- docs/api/backoffice-bff-openapi.json
- docs/specs/order.md
- docs/specs/product.md

### リスクと未解決
- Final Gate の `cd backend && ./mvnw test` は、既存 Flyway マイグレーション重複（V2 が2本）により FAIL。今回変更外の既存不整合のため未修正。
- `ProductSpecifications` の `effectiveStock` 条件は SQL サブクエリで一致させているため、データ量増加時の実行計画は別途監視が必要。
- フロントの注文ステータス入力は `statuses` をカンマ区切り textbox で扱うため、UI上の選択補助は今後改善余地あり。

### UI確認媒体（MCP/Docker）
- MCP Playwright（http://localhost:5174）

### テスト結果（PASS/FAIL、失敗時は30行以内）
- PASS: `cd backend && ./mvnw test -Dtest=BoAdminProductControllerContractTest,ProductUseCaseTest`
- PASS: `cd backend && ./mvnw test -Dtest=OrderControllerContractTest,OrderUseCaseTest`
- PASS: `cd bff/backoffice-bff && npm run build`
- PASS: `npm run build --prefix frontend`
- PASS: `cd frontend && bash ./e2e/admin-smoke.sh`
- PASS: `rg -n "keyword|stockThreshold|zeroStockOnly|allocationIncomplete|unshipped|customerEmail|statuses|dateFrom|dateTo|totalPriceMin|totalPriceMax" docs/ui/admin-ui.md docs/api/backoffice-bff-openapi.json docs/specs/order.md docs/specs/product.md`
- FAIL: `cd backend && ./mvnw test`
  - `Found more than one migration with version 2`
  - `V2__baseline_current_schema.sql`
  - `V2__insert_sample_data.sql`

---

## Verify

### T-N × 設計書 照合

乖離なし。

- T-1: `zeroStockOnly` 優先ルール・`effectiveStock` 写経・400 バリデーションいずれも設計書 §2.1 と一致
- T-2: `AdminOrderListResponse { orders, pagination }` / `allocationIncomplete` の EXISTS 判定 / `unshipped` 固定集合いずれも設計書 §2.2 と一致
- T-3: `normalizeOrder` 廃止・URLSearchParams 透過は設計書 §1.1, §2.4 と一致
- T-4: 型定義追加（`AdminProductSearchParams` / `AdminOrderSearchParams` / `AdminOrderListResponse`）は設計書 §7 と一致
- T-8: 検索パラメータ語彙が docs 全体に反映されていることを rg で確認済み

補足: `OrderSpecifications.java` が `AdminOrderSearchParams` を `purchase/application/port` からインポートしているが、設計書では `application/dto` と記載。ArchUnit は PASS しており、`port` も同レイヤ内のため境界違反なし。

### リスクと未解決の評価

1. **Flyway V2 重複（`BoAuthSecurityTest` 起動失敗）**: CHG-024 の変更対象外（既存不整合）。今回は対応不要。別途 CHG として修正すること。
2. **`effectiveStock` サブクエリの実行計画**: データ量増加時の監視が必要。実装品質への影響なし。対応不要（モニタリングは継続的な運用対応）。
3. **`statuses` UI の選択補助**: 今後の改善余地として明示済み。対応不要。

### テスト結果の評価

- FAIL（`./mvnw test`）: Flyway V2 重複による既存不具合。CHG-024 の変更と無関係。対応不要（別途修正 CHG を起票）。
- その他テスト（個別ターゲット・BFF ビルド・フロントビルド・E2E スモーク）: 全 PASS。

### ArchUnit

PASS（28テスト / 0 Failure / 0 Error）

```
Tests run: 14, Failures: 0, Errors: 0 -- ModularMonolithArchitectureTest
Tests run: 14, Failures: 0, Errors: 0 -- ArchitectureTest
BUILD SUCCESS
```

### 判定

**PASS**
