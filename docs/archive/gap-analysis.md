# ギャップ分析レポート

生成日時: 2026-02-10

## 1. 実装にあるが仕様に書かれていないもの

### バックエンド

#### 1-1. カートエンティティの自動タイムスタンプ管理
- **場所**: `backend/src/main/java/com/example/aiec/entity/Cart.java:39-47`
- **内容**: `@PrePersist`と`@PreUpdate`アノテーションにより、作成日時・更新日時が自動的に設定される仕組みが実装されている
- **影響度**: 低 - 技術的な実装詳細だが、仕様書に記載があるとAPI開発者が理解しやすい

#### 1-2. 注文エンティティの自動タイムスタンプ管理
- **場所**: `backend/src/main/java/com/example/aiec/entity/Order.java:48-56`
- **内容**: カート同様、注文エンティティにも自動タイムスタンプ管理が実装されている
- **影響度**: 低 - 技術的な実装詳細

#### 1-3. カートアイテムIDが商品IDと同じ仕様
- **場所**: `backend/src/main/java/com/example/aiec/dto/CartItemDto.java:25`
- **内容**: カートアイテムのIDは商品IDと同一にする実装になっている（コメントに記載あり）。これはAPI仕様書に記載されているが、SPEC.mdには記載がない
- **影響度**: 中 - フロントエンドとの連携に影響する重要な仕様

#### 1-4. セッションIDとカートIDの一致チェック
- **場所**: `backend/src/main/java/com/example/aiec/service/OrderService.java:34-37`
- **内容**: 注文作成時にセッションIDとカートIDが一致するか検証している
- **影響度**: 中 - セキュリティに関わる実装だが、SPEC.mdには記載なし（api-spec.mdには記載あり）

#### 1-5. 注文番号生成時の重複チェックロジック
- **場所**: `backend/src/main/java/com/example/aiec/service/OrderService.java:97-108`
- **内容**: 注文番号生成時に同日の注文数をカウントして連番を付与する詳細なロジックが実装されている
- **影響度**: 中 - SPEC.mdには「ORD-YYYYMMDD-XXX形式で自動生成」とあるのみで、具体的な採番ロジックの説明がない

#### 1-6. カート追加時の既存アイテム数量加算ロジック
- **場所**: `backend/src/main/java/com/example/aiec/service/CartService.java:58-81`
- **内容**: 既にカートに存在する商品を追加した場合、数量を加算する仕様になっている。加算後も在庫チェックを実施
- **影響度**: 中 - api-spec.mdには「既に存在する商品の場合は数量が増加」と記載があるが、SPEC.mdには明記されていない

#### 1-7. 注文詳細取得時のセッションID検証
- **場所**: `backend/src/main/java/com/example/aiec/service/OrderService.java:86-89`
- **内容**: 注文詳細取得時に、リクエストのセッションIDと注文のセッションIDが一致するか検証している（他人の注文を見られないようにする）
- **影響度**: 高 - セキュリティに関わる重要な実装だが、SPEC.mdには記載なし

#### 1-8. バリデーションエラーメッセージの詳細フォーマット
- **場所**: `backend/src/main/java/com/example/aiec/exception/GlobalExceptionHandler.java:43-59`
- **内容**: バリデーションエラー時に複数のエラーをマップ形式で収集し、最初のエラーメッセージを返す実装
- **影響度**: 低 - 技術的な実装詳細

#### 1-9. HTTPステータスコードの使い分け
- **場所**: `backend/src/main/java/com/example/aiec/exception/GlobalExceptionHandler.java:24-70`
- **内容**: 404 (NOT_FOUND), 400 (BAD_REQUEST), 500 (INTERNAL_ERROR) の使い分け
- **影響度**: 低 - api-spec.mdにも記載がないが、REST APIの標準的な実装

#### 1-10. 初期データローダーの実装
- **場所**: `backend/src/main/java/com/example/aiec/config/DataLoader.java`
- **内容**: アプリケーション起動時に8商品の初期データを自動投入する仕組み。既にデータが存在する場合はスキップ
- **影響度**: 低 - 開発用の便利機能だが、仕様書に記載なし

#### 1-11. カートクリア機能
- **場所**: `backend/src/main/java/com/example/aiec/service/CartService.java:142-150`
- **内容**: カートをクリアするメソッドが実装されている（注文作成時に内部的に使用）。ただしAPIエンドポイントとしては公開されていない
- **影響度**: 低 - 内部実装の詳細

#### 1-12. 商品詳細取得時の公開状態チェックなし
- **場所**: `backend/src/main/java/com/example/aiec/service/ProductService.java:52-57`
- **内容**: 商品詳細取得API (`GET /api/item/:id`) では`isPublished`のチェックをしていない。つまり、非公開商品もIDが分かれば取得できる
- **影響度**: 高 - セキュリティ的な問題の可能性。SPEC.mdには「非公開の商品は表示しない」とあるが、詳細APIでは制限されていない

### フロントエンド

#### 1-13. セッションID管理の実装詳細
- **場所**: `frontend/src/lib/api.ts:15-23`
- **内容**: セッションIDを`localStorage`に保存し、`session-{timestamp}-{random}`形式で生成する実装
- **影響度**: 中 - SPEC.mdには「セッションIDはクライアント側で生成・管理」とあるのみで、具体的な生成ロジックや保存方法の記載なし

#### 1-14. カートコンテキストのローカルクリア機能
- **場所**: `frontend/src/contexts/CartContext.tsx:130-135`
- **内容**: `clearCart`メソッドがローカル状態のみをクリアし、APIを呼ばない実装になっている
- **影響度**: 低 - 実装詳細だが、挙動を理解するために仕様書に記載があると良い

#### 1-15. 商品一覧画面の全商品表示
- **場所**: `frontend/src/pages/ItemListPage.tsx` (ファイル未読込だが、ProductContextから推測可能)
- **内容**: `getPublishedProducts()`を使って公開商品のみを表示しているが、ProductContextはAPI経由で既にフィルタされた商品を取得しているため、二重フィルタリングになっている
- **影響度**: 低 - 動作には問題ないが、冗長な実装

#### 1-16. カート追加後の自動遷移
- **場所**: `frontend/src/pages/ItemDetailPage.tsx:48-49`
- **内容**: カート追加後に自動的にカート画面へ遷移する実装
- **影響度**: 中 - SPEC.mdには「カートに追加して /order/cart へ遷移」と記載があるが、UX的に重要な挙動なので明確化すべき

#### 1-17. 数量入力で0にすると削除する仕様
- **場所**: `frontend/src/contexts/CartContext.tsx:104-108`
- **内容**: 数量を0にすると自動的に削除する実装
- **影響度**: 中 - SPEC.mdには「数量を 0 にすると自動削除」と記載があるが、カート画面のUIでは数量入力欄の最小値チェック等の記載なし

#### 1-18. 注文完了画面の状態管理（React Router state）
- **場所**: `frontend/src/pages/OrderCompletePage.tsx:11-12`
- **内容**: 注文情報をReact Routerの`state`で受け渡す実装
- **影響度**: 低 - SPEC.mdに「React Router の state で受け渡し」と記載あり

#### 1-19. エラー時のアラート表示
- **場所**: `frontend/src/pages/ItemDetailPage.tsx:52`, `frontend/src/pages/CartPage.tsx:53`, `frontend/src/pages/OrderConfirmPage.tsx:59-63`
- **内容**: エラー時に`alert()`を使ってエラーメッセージを表示する実装
- **影響度**: 低 - UI/UXの実装詳細だが、仕様書に記載なし

#### 1-20. ローディング状態の管理
- **場所**: `frontend/src/contexts/CartContext.tsx:12,27`, `frontend/src/contexts/ProductContext.tsx:7,18`
- **内容**: API通信中のローディング状態を管理し、UIに反映する実装
- **影響度**: 低 - UI/UXの実装詳細

#### 1-21. API通信エラー時のデフォルトエラーレスポンス
- **場所**: `frontend/src/lib/api.ts:50-58`
- **内容**: ネットワークエラー時に`NETWORK_ERROR`コードとメッセージを返す実装
- **影響度**: 低 - エラーハンドリングの実装詳細

## 2. 仕様に書いてあるが実装されていないもの

### 2-1. 配送料・手数料の計算
- **仕様書の場所**: SPEC.md:104-105 (注文確認画面の「配送料、手数料」)
- **内容**: 仕様書には「配送料、手数料」の表示が記載されているが、現在の実装では常に0円
- **影響度**: 中 - 現状は配送料・手数料が0円固定だが、将来的に実装予定の機能か不明。仕様書に「現在は0円固定」と明記すべき

### 2-2. 注文状態遷移の管理機能
- **仕様書の場所**: SPEC.md:284-338 (注文の状態遷移)
- **内容**: 注文状態を PENDING → CONFIRMED → SHIPPED → DELIVERED と遷移させる機能が仕様に記載されているが、実装されていない。現在は PENDING で作成されるのみ
- **影響度**: 高 - 仕様書に詳細な状態遷移図とルールが記載されているが未実装。「バックエンド実装時に追加予定」と明記すべき

### 2-3. 注文のキャンセル機能
- **仕様書の場所**: SPEC.md:329-332 (PENDING/CONFIRMED → CANCELLED)
- **内容**: 注文をキャンセルする機能が仕様に記載されているが、APIエンドポイントも画面も実装されていない
- **影響度**: 中 - 将来実装予定の機能と思われるが、現在の実装範囲として除外されている旨を明記すべき

### 2-4. 在庫の引き当て処理
- **仕様書の場所**: SPEC.md:406-408 (制約事項「在庫管理の簡易実装」)
- **内容**: 仕様書の「今後の実装予定」には「注文時の在庫引き当て」とあるが、現在は実装されていない。注文作成時に在庫チェックはするが、在庫を減らす処理はない
- **影響度**: 高 - 実際のECサイトでは必須の機能だが、プロトタイプ段階では未実装。SPEC.mdの制約事項に記載があるので問題ないが、api-spec.mdにも明記すべき

### 2-5. 商品一覧のページネーション機能（フロントエンド）
- **仕様書の場所**: api-spec.md:42-46 (商品一覧APIのページングパラメータ)
- **内容**: APIはページングをサポートしているが、フロントエンドでページング機能が実装されていない（全件取得のみ）
- **影響度**: 低 - 現状は商品数が少ないため問題ないが、将来的に実装が必要

### 2-6. 在庫不足時の詳細エラーレスポンス
- **仕様書の場所**: api-spec.md:437-453 (注文作成時のOUT_OF_STOCKエラーの詳細情報)
- **内容**: API仕様書には在庫不足時に`details`配列で商品ごとの在庫状況を返す仕様が記載されているが、実装では単純なエラーメッセージのみ返している
- **影響度**: 中 - ユーザー体験に影響する機能。実装するか、仕様から削除すべき

### 2-7. おすすめ商品の選定ロジック
- **仕様書の場所**: SPEC.md:17-30 (TOP画面のおすすめ商品セクション)
- **内容**: 「AIがおすすめする商品」というコンセプトだが、実際には単に最初の3件を表示しているだけ
- **影響度**: 低 - プロトタイプ段階では許容範囲だが、「将来的にAIレコメンデーション実装予定」と明記すべき

## 3. 仕様の記述が曖昧なもの

### 3-1. カート内商品の数量上限
- **仕様書の場所**: SPEC.md:86-89 (カート画面の数量変更機能)
- **曖昧な点**: 1つの商品をカートに何個まで追加できるのか、上限が不明
- **実装の解釈**: バックエンドでは在庫数までという暗黙のルールがあるが、フロントエンドの入力欄には`max`属性がない
- **推奨**: 「カート内の数量は在庫数を超えられない」と明記し、フロントエンドでも入力制限を設けるべき

### 3-2. 在庫チェックのタイミング
- **仕様書の場所**: SPEC.md:196-201 (カート機能の仕様)
- **曖昧な点**: カート追加時、数量変更時、注文作成時のどのタイミングで在庫チェックを行うのか
- **実装の解釈**: バックエンドでは全てのタイミングでチェックしているが、仕様書には明記なし
- **推奨**: 「在庫チェックはカート追加時、数量変更時、注文作成時の3箇所で実施」と明記すべき

### 3-3. 配送料・手数料の計算ロジック
- **仕様書の場所**: SPEC.md:104 (注文確認画面のお支払い金額)
- **曖昧な点**: 配送料・手数料の計算方法が不明（金額ベース？地域ベース？）
- **実装の解釈**: 現在は0円固定
- **推奨**: 「現在は配送料・手数料ともに0円固定。将来的に実装予定」と明記すべき

### 3-4. 商品画像のURL形式
- **仕様書の場所**: SPEC.md:349 (Product の image フィールド)
- **曖昧な点**: 画像URLの形式、サイズ、保存場所などが不明
- **実装の解釈**: プレースホルダーサービス (placehold.co) を使用
- **推奨**: 「現在はプレースホルダー画像を使用。将来的には画像アップロード機能を実装予定」と明記すべき

### 3-5. 注文番号の重複時の挙動
- **仕様書の場所**: SPEC.md:224 (注文番号は ORD-YYYYMMDD-XXX 形式で自動生成)
- **曖昧な点**: 同日に999件を超える注文があった場合の挙動が不明
- **実装の解釈**: 現在の実装では1000件目以降も生成されるが、フォーマットが崩れる（4桁になる）
- **推奨**: 「1日あたりの注文上限は999件」または「999件を超えた場合の挙動」を明記すべき

### 3-6. セッションIDの有効期限
- **仕様書の場所**: api-spec.md:172-174 (X-Session-Id ヘッダー)
- **曖昧な点**: セッションIDに有効期限はあるのか、永続的に使用できるのか不明
- **実装の解釈**: フロントエンドはlocalStorageに永続保存、バックエンドは有効期限なし
- **推奨**: 「現在はセッションIDに有効期限なし。将来的にセッション管理機能を実装予定」と明記すべき

### 3-7. カート削除 vs 数量0
- **仕様書の場所**: SPEC.md:89-90 (数量を 0 にすると自動削除)
- **曖昧な点**: ゴミ箱アイコンでの削除と、数量を0にする削除の違いが不明（結果は同じだが、UIとして2つの方法がある意味）
- **実装の解釈**: どちらも同じ削除APIを呼び出す
- **推奨**: 「削除方法は2つあるが、結果は同じ」と明記し、UX的な意図を説明すべき

### 3-8. 非公開商品を持つカートの扱い
- **仕様書の場所**: SPEC.md:179 (非公開の商品は表示しない)
- **曖昧な点**: カートに入れた後、その商品が非公開になった場合の挙動が不明
- **実装の解釈**: 現在の実装では、カート内に残り続ける（削除されない）
- **推奨**: 「商品が非公開になってもカート内には残る」または「非公開になったら自動削除」と明記すべき

### 3-9. 注文完了後のカート状態
- **仕様書の場所**: SPEC.md:225 (注文確定時にカートを自動クリア)
- **曖昧な点**: カートがクリアされるのは成功時のみか、失敗時はどうなるか
- **実装の解釈**: 注文作成成功時のみカートをクリア。失敗時はカートに残る
- **推奨**: 「注文作成に失敗した場合、カートは維持される」と明記すべき

### 3-10. 管理画面のアクセス制限
- **仕様書の場所**: SPEC.md:143-162 (管理画面)
- **曖昧な点**: 管理画面へのアクセス制限がないのは仕様なのか、実装漏れなのか不明
- **実装の解釈**: 現在は誰でもアクセス可能（URLを知っていれば）
- **推奨**: 制約事項に「現在は認証・認可なし。Phase 2で実装予定」と明記されているが、管理画面の説明にも注意書きを追加すべき

## 4. API仕様との差異

### 4-1. 商品一覧レスポンスの型の不一致
- **仕様**: api-spec.md:48-68
- **実装**: `backend/src/main/java/com/example/aiec/dto/ProductListResponse.java` (ファイル未読込だが、推測可能)
- **差異**: 仕様書では`total`フィールドは`number`型だが、実装では`long`型（Javaの場合は問題ないが、型の整合性）
- **影響度**: 低 - 実用上は問題ないが、型定義の統一性

### 4-2. フロントエンドの型定義とAPIレスポンスの不整合（軽微）
- **仕様**: api-spec.md の各種レスポンス
- **実装**: `frontend/src/types/api.ts`
- **差異**:
  - `Order`の`updatedAt`がフロントエンドでは`optional`だが、APIレスポンスでは常に返される
  - `AddToCartRequest`の`quantity`がフロントエンドでは`optional`、APIでも`optional`（一致している）
- **影響度**: 低 - TypeScriptの型定義の厳密性の問題

### 4-3. エラーレスポンスの`details`フィールド
- **仕様**: api-spec.md:437-453 (OUT_OF_STOCK エラーの詳細情報)
- **実装**: `backend/src/main/java/com/example/aiec/exception/GlobalExceptionHandler.java`
- **差異**: 仕様書では在庫不足時に`details`配列を返すとあるが、実装では返していない
- **影響度**: 中 - すでに「2-6」で指摘済み

### 4-4. 注文作成APIのリクエストボディ
- **仕様**: api-spec.md:385-395 (`cartId`フィールド)
- **実装**: バックエンドとフロントエンドは仕様通り
- **差異**: なし（一致している）
- **影響度**: なし

### 4-5. カートアイテムIDの仕様
- **仕様**: api-spec.md:296 (「カートアイテムID（商品IDと同じ）」)
- **実装**: `backend/src/main/java/com/example/aiec/dto/CartItemDto.java:25`
- **差異**: なし（一致している。実装のコメントにも明記あり）
- **影響度**: なし

### 4-6. エラーコードの網羅性
- **仕様**: api-spec.md:575-586 (エラーコード一覧)
- **実装**: 実装では仕様に記載のないエラーコードも使用している可能性がある
  - `CART_NOT_FOUND` - 仕様書に記載なし（使用箇所: CartService.java）
  - `NETWORK_ERROR` - フロントエンド独自のエラーコード（api.ts）
- **影響度**: 中 - エラーコード一覧を最新化すべき

## サマリー

- 実装にあるが仕様にないもの: **21件**
  - バックエンド: 12件
  - フロントエンド: 9件
- 仕様にあるが実装されていないもの: **7件**
- 曖昧な仕様: **10件**
- API仕様との差異: **6件**（うち実質的な差異は2件）

### 優先度別の推奨対応

#### 高優先度（セキュリティ・機能的影響大）
1. **商品詳細取得時の公開状態チェック追加** (1-12)
2. **注文詳細取得時のセッションID検証の仕様化** (1-7)
3. **在庫引き当て処理の実装またはスコープ外明記** (2-4)
4. **注文状態遷移機能の実装スコープ明確化** (2-2)

#### 中優先度（UX・データ整合性）
1. **配送料・手数料の仕様明確化** (2-1, 3-3)
2. **在庫不足時の詳細エラーレスポンス実装** (2-6, 4-3)
3. **在庫チェックタイミングの明記** (3-2)
4. **エラーコード一覧の更新** (4-6)
5. **カート内商品の数量上限の明記** (3-1)
6. **非公開商品を持つカートの扱い明記** (3-8)

#### 低優先度（実装詳細・技術的改善）
1. **各種実装詳細の仕様書への追記** (1-1〜1-11, 1-13〜1-21)
2. **ページネーション機能の実装** (2-5)
3. **型定義の整合性確認** (4-1, 4-2)
4. **その他の曖昧な仕様の明確化** (3-4〜3-10)
