# CHG-014: OpenTelemetry 導入（トレース・メトリクス・ログの統合可視化）

作成日: 2026-02-18
---
## 1. 背景
- 現状の調査はログ中心で、1リクエストが各層（React → NestJS(BFF) → Spring(CoreAPI) → PostgreSQL）を跨いだ際の因果関係・遅延箇所の特定に時間がかかる。
- 非同期処理の導入を見据えると、同期/非同期を跨いだ追跡性（トレース伝播）と、障害時の説明可能性が重要になる。
- 監視が「CPUが高い」等のリソース視点に寄りやすく、ユーザー影響（注文成功率・決済NG率・p95/p99遅延等）に基づく観測を強化したい。
- 前提：フロントのFSD実装は未着手（ただし本変更はFSDの有無に依存せず、観測性の土台として位置付ける）。

---
## 2. 要件
- 1リクエストを1本のトレースとして、フロント〜BFF〜CoreAPI〜DBまで一気通貫で追跡できること。
- ボトルネック（遅延箇所）をトレースから即座に特定できること。
- ログとトレースを相互に関連付け（trace_id で相関）し、相互ジャンプができること。
- ユーザー影響ベースのメトリクス（成功率/失敗率/レイテンシ分位など）を可視化できること。
- 将来的に非同期処理を導入しても、追跡性と可視化が維持・強化できること。
- OTelは「計測の標準」とし、保存・表示は別基盤で扱える前提とする。

---
## 3. 受け入れ条件
- checkout など代表的なAPIについて、単一トレースとして全レイヤの処理が可視化され、遅延箇所がトレース上で判別できる。
- 主要ログに trace_id が付与され、以下のどちらも成立する：
  - トレースから該当ログを参照できる
  - ログから該当トレースを参照できる
- 監視ダッシュボードで、少なくとも以下が確認できる：
  - 注文成功率
  - 決済NG率
  - 在庫引当失敗率
  - APIの p95/p99 レイテンシ
  - 非同期キュー滞留（導入後に観測対象として追加可能であること）
- 開発環境で、最小構成でもトレース体験（分散トレーシング）が成立している。

---
## 4. 仕様への反映
- 観測性の基本仕様として、トレース/メトリクス/ログの統合方針（OTel採用）を明記する。
- ログ形式は trace_id を含む相関可能な形に統一する方針を明記する。
- 監視対象はリソース指標だけでなく、ユーザー影響指標（成功率・失敗率・分位レイテンシ等）を中心に定義する。
- 計測（OTel）と保存・表示（可視化基盤）は分離可能な構成として扱う。

---
## 5. 関連資料
- （入力メモ）OpenTelemetry 導入目的・できること・可視化基盤選択肢・推奨ステップ整理
