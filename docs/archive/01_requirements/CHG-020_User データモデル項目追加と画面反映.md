# CHG-020: User データモデル項目追加と画面反映

作成日: 2026-02-19
---
## 1. 背景
- CHG-020 の対象範囲を見直し、拡張対象を User ドメインに限定する。
- 現行の会員情報は最小構成であり、顧客自己管理および BO 運用に必要な情報密度が不足している。
- 後続機能で再分断を起こさないため、`users` を主テーブルとして会員情報を基本集約し、住所は付随テーブルで管理する。

---
## 2. 要件
### 2.1 スコープ
- 本 CHG の対象は `User` のみとする。
- Product / Cart / CartItem / Order / OrderItem の項目追加は本 CHG の対象外とする。

### 2.2 データモデル方針
- 会員情報の主データは `users` テーブルに基本集約する。
- 会員住所は新設テーブル `user_addresses` で管理する。
- `user_addresses` は会員に対する複数住所管理とし、顧客画面・BO画面の双方で整合して扱えること。

### 2.3 users に追加する情報カテゴリ
- 識別/認証連携:
- 連絡/プロフィール:
- 会員運用:

### 2.4 画面反映と更新権限
- 顧客画面（マイページ）で、会員自身がユーザー情報を参照・更新できること。
- 顧客画面で、会員自身が住所情報（`user_addresses`）を管理できること。
- BO 画面では、会員情報を FULL で更新可能とする。
- ただし BO でも、`password_hash`、トークン関連、監査カラム等のシステム管理項目は更新不可とする。

### 2.5 API/型の反映方針
- 顧客向け API は、会員情報カテゴリと住所情報を取得・更新できる契約を提供すること。
- BO 向け API は、会員情報カテゴリと住所情報を運用上必要な粒度で取得・更新できる契約を提供すること。
- 顧客向けと BO 向けで公開範囲を分け、内部専用情報を顧客向けレスポンスに含めないこと。

---
## 3. 受け入れ条件
- `users` に定義した会員情報カテゴリが保持され、顧客画面と BO 画面で一貫して参照できること。
- `user_addresses` で会員住所を複数管理でき、顧客画面・BO画面の双方で整合して扱えること。
- マイページで更新した会員情報が再取得時に反映されること。
- BO で会員情報の FULL 更新ができること（システム管理項目を除く）。
- システム管理項目の更新試行時は、想定どおり拒否されること。
- 追加項目が API 仕様（型）と整合し、顧客画面/BO画面の入出力として一貫していること。

---
## 4. 仕様への反映
- データモデル定義（`docs/data-model.md`）に、`users` のカテゴリ拡張方針と `user_addresses` を追記する。
- API 仕様（`docs/api/customer-bff-openapi.json` / `docs/api/backoffice-bff-openapi.json` / `docs/api/openapi.json`）に、会員情報と住所情報の入出力を反映する。
- 顧客画面仕様（`docs/ui/customer-ui.md`）に、マイページでの会員情報更新・住所管理を反映する。
- BO 画面仕様（`docs/ui/admin-ui.md`）に、会員情報 FULL 更新（システム管理項目除外）を反映する。
- 業務要件（`docs/requirements.md`）に、会員情報管理と住所管理の前提ルールを追記する。

---
## 5. 関連資料
- 技術仕様: `docs/SPEC.md`
- 業務要件: `docs/requirements.md`
- API仕様:
  - `docs/api/customer-bff-openapi.json`
  - `docs/api/backoffice-bff-openapi.json`
  - `docs/api/openapi.json`
- 認証仕様: `docs/specs/authentication.md`
- データモデル: `docs/data-model.md`
