# CHG-004: エラーメッセージ改善

## 背景・課題

現在、バックエンドAPIから返されるエラーメッセージがそのままユーザーに表示されている。

### 具体的な問題

1. **技術的すぎるメッセージ**
   - 例: 「仮引当が存在しません」
   - ユーザーには「仮引当」の概念が理解できない
   - 何をすべきか分からない

2. **内部実装の露呈**
   - システムの内部構造（仮引当システム等）が見える
   - セキュリティ上好ましくない

3. **ユーザビリティの低下**
   - エラーが発生しても、次のアクションが不明確
   - ユーザーが困惑し、離脱につながる可能性

## ビジネス要件

### 主要要件

**REQ-001: ユーザーフレンドリーなエラーメッセージ表示**
- バックエンドの技術的エラーを、ユーザーが理解できる言葉に変換して表示する
- エラーメッセージには、ユーザーが取るべきアクション（リトライ、ページ更新、数量変更等）を含める
- 内部実装の詳細（仮引当、セッション等）を隠蔽する

**REQ-002: エラーメッセージの一元管理**
- フロントエンド側で、エラーコードとユーザー向けメッセージのマッピングを定義する
- 同じエラーコードは、どの画面でも同じメッセージを表示する（一貫性）
- メッセージの変更・追加が容易な設計とする

**REQ-003: エラーの詳細情報の活用**
- バックエンドから返される `details` フィールドがある場合は、適切に活用する
- 例: 在庫不足エラーの場合、不足している商品名や在庫数を表示

## 受け入れ条件

### AC-001: エラーメッセージマッピングの定義
- [ ] フロントエンドに、エラーコード → ユーザーメッセージのマッピング定義が存在する
- [ ] 最低限、以下のエラーコードがカバーされている：
  - `RESERVATION_NOT_FOUND`（仮引当が存在しない）
  - `INSUFFICIENT_STOCK`（在庫不足）
  - `ITEM_NOT_AVAILABLE`（商品非公開）
  - `NETWORK_ERROR`（ネットワークエラー）
  - `INTERNAL_ERROR`（内部エラー）
- [ ] マッピングされていないエラーコードには、汎用的なフォールバックメッセージが表示される

### AC-002: 技術用語の排除
- [ ] ユーザーに表示されるメッセージに「仮引当」「セッション」等の技術用語が含まれない
- [ ] エラーメッセージは平易な日本語で記述されている

### AC-003: アクションガイダンスの提供
- [ ] エラーメッセージには、ユーザーが取るべき次のアクション（例: 「ページを更新してください」「数量を減らしてお試しください」）が含まれる

### AC-004: 既存機能への適用
- [ ] カート操作（追加・更新・削除）のエラーメッセージが改善されている
- [ ] 注文作成のエラーメッセージが改善されている
- [ ] カート取得のエラーメッセージが改善されている

### AC-005: 一貫性の確保
- [ ] 同じエラーコードは、どの画面・コンポーネントでも同じメッセージを表示する
- [ ] メッセージの文体・トーンが統一されている

## 対象外

- バックエンドのエラーメッセージ自体の変更（バックエンドは現状のまま、フロントエンドで吸収する）
- エラーログの改善（本案件はユーザー表示のみを対象）
- バリデーションエラーの改善（別案件で対応）

## 参考情報

### 現在のエラー表示箇所
- `CartPage.tsx`: カート操作エラーの表示
- `CartContext.tsx`: カート関連API呼び出しのエラーハンドリング
- `ProductContext.tsx`: 商品取得エラーのエラーハンドリング（該当する場合）

### エラーコード定義箇所
- バックエンド: `ApiResponse` の `error.code` フィールド
- フロントエンド: `src/types/api.ts` の `ApiError` 型
