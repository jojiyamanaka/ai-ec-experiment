# CHG-017: 非同期処理（監査ログ／メール送信）要件定義（最小版）

作成日: 2026-02-18
---
## 1. 背景
- 注文作成などのメイン処理は、レスポンス性能と可用性を最優先したい。
- 監査ログ記録やメール送信などの「副作用処理」は、失敗や遅延がメイン処理へ波及しない形で安全に実行したい。
- 副作用処理が失敗した場合でも、後から追跡・再実行できる状態を担保したい。

---
## 2. 要件
### 2.1 対象範囲
- 監査ログ（現状: 実装済）
  - 操作成功時にイベントを発行し、メイン処理とは分離して記録する。
  - 将来的にワーカー等の非同期実行方式へ移行できる前提の構造とする。
- メール送信（現状: 未実装）
  - 注文確定時に「注文確認メール」を送信する。
  - メイン処理とは分離して実行する（非同期）。
  - メール送信の失敗は注文処理の結果（確定）に影響させない。
  - メール送信は、外部に送らずSMTPキャッチャ（MailHog/Mailpit）へ流してWeb UIで本文を確認できる形にしたい。


### 2.2 非同期処理（共通）
- メイン処理と別トランザクション／別実行単位で処理されること。
- 失敗時に再試行可能であること。
- 同一イベントが二重処理されないこと（冪等性の担保）。
- 実行結果がログまたはメトリクスで確認可能であること。

### 2.3 成功／失敗の扱い
- 監査ログ
  - 成功操作のみ記録する（失敗操作の記録は今回対象外）。
- メール送信
  - 業務確定後（注文が CONFIRMED となった後）にのみ送信対象となる。
- 非同期処理失敗
  - 失敗したイベントを保持し、将来「DLQ相当」として運用できる余地を残す。

### 2.4 非目標（今回やらない）
- Kafka 等の大規模メッセージ基盤の導入
- 完全なイベントソーシング
- 高度な再試行制御（指数バックオフ等）

---
## 3. 受け入れ条件
- メイン処理（例: 注文作成／確定）の成功・失敗が、副作用処理（監査ログ／メール）に依存しない。
  - 副作用処理が失敗してもメイン処理はロールバックされない（メール要件）。
- 監査ログは「成功操作」に対してのみ記録される。
- メールは注文が CONFIRMED の場合にのみ送信される。
- 非同期処理は再試行可能であり、同一イベントの二重処理が発生しない。
- 副作用処理の成否が、ログまたはメトリクスで確認できる。
- 失敗イベントを将来 DLQ 相当として保持できる前提（要件上の余地）が示されている。

---
## 4. 仕様への反映
- 監査ログ／メール送信を「メイン処理と分離された実行単位」として扱う。
- イベント単位で、冪等性・再試行・可観測性（ログ／メトリクス）を満たす前提を仕様に明記する。
- メール送信は「注文確定（CONFIRMED）後の副作用」であり、注文確定の可用性・応答性を阻害しない前提を仕様へ反映する。
- 失敗イベントの保持（DLQ相当）について、将来対応可能な余地として仕様に記載する。

---
## 5. 関連資料
- 非同期処理 要件定義（最小版）（本要件の元テキスト）
