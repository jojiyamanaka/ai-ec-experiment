# CHG-023_引当区分導入と在庫モデル再編.md（要件定義・確定版）

作成日: 2026-02-20  
CHG番号: CHG-023

---

## 1. サマリー

本CHGでは、商品ごとに **引当区分（実在庫 / 枠在庫）** を導入し、在庫モデルを再編する。

- 商品ごとに引当区分（実在庫 / 枠在庫）を持つ
- `products.stock` を廃止し、在庫管理を `location_stocks` / `sales_limits` に分離
- 商品管理詳細を **商品タブ / 在庫タブ / 販売タブ** に再編
- BO在庫管理メニュー（`/bo/inventory`）を **UI導線から廃止**
- 枠在庫商品の引当は **「仮引当 → 非同期本引当（在庫充足時）」** ルールを導入
- 注文一覧/詳細で **引当進捗（引当済点数/注文点数）** を表示

---

## 2. 背景 / 目的（Why）

### 2.1 背景
- これまで `products.stock` を中心に在庫を扱っていたが、実在庫と販売枠（上限制）を同一概念で扱うことで、運用・画面・引当処理の責務が肥大化している。

### 2.2 目的
- 実在庫と枠在庫を明確に分離し、商品ごとに適切な引当ルールを適用する
- 引当進捗を可視化し、出荷統制（未引当残の出荷禁止）を成立させる
- 管理画面の在庫導線を集約し、更新ポイントを一元化する

---

## 3. 用語

- **引当区分（allocationType）**: 商品単位で持つ在庫判定/引当ルールの区分  
  - `REAL`（実在庫）: 実在庫ベースで引当
  - `FRAME`（枠在庫）: 枠ベースで仮引当し、実在庫が確保できた分を非同期で本引当
- **仮引当**: 注文の成立に必要な数量を「枠」として確保する行為（実在庫の確保ではない）
- **本引当**: 実在庫（ロケーション在庫）を確保する行為
- **未引当**: 注文済のうち、本引当が完了していない数量

---

## 4. スコープ

### 4.1 対象
- 引当区分の導入（商品単位）
- 在庫モデル再編（`products.stock` 廃止、`location_stocks` / `sales_limits` 導入）
- 枠在庫商品の引当フロー（仮引当 → 非同期本引当、在庫増加時の再試行、部分引当）
- 出荷統制（未引当残がある注文は `SHIPPED` 遷移不可）
- 管理画面再編（商品詳細3タブ化、`/bo/inventory` 導線廃止）
- 引当進捗の表示（注文一覧/詳細）

### 4.2 非対象（本CHGではやらない）
- ロケーション多拠点化（単一拠点固定）
- SalesLimit の増減履歴・監査履歴（累計販売限度数のみ）
- 既存在庫データ移行の精緻な移し替え（`products.stock` は 0 初期化）
- 引当アルゴリズムの最適化（性能改善は別CHG）

---

## 5. 前提・デフォルト（明示）

- 引当区分は **2値固定**（未設定なし）
- ロケーションは **単一拠点固定**
- `remaining_qty` は **算出値**
- SalesLimit は **累計販売限度数のみ**（履歴は対象外）
- 非同期再試行の起点は **「注文確定イベント」 + 「在庫増加イベント」**
- 引当進捗表示は **全注文ステータスで表示**

---

## 6. 主要要件（What）

### 6.1 在庫源泉の分離
- 実在庫商品は従来どおり **実在庫ベースで判定・引当** する
- 枠在庫商品は **販売限度数ベースで仮引当** し、注文確定時に即時本引当しない

### 6.2 枠在庫商品の引当フロー
- カート/注文時点では **枠在庫で仮引当** する
- 注文確定時に **実在庫がある分は非同期イベントで本引当**
- 実在庫が不足する分は **未引当として保持**
- **在庫増加イベント** 時に未引当分へ再試行し、可能な分を本引当
- **部分引当を許可**（数量単位で進捗）

### 6.3 出荷統制
- **未引当数量が残る注文は `SHIPPED` へ遷移不可**

### 6.4 管理画面再編
- 商品詳細を **3タブ** 化する
  - **商品タブ**: 基本属性
  - **在庫タブ**: 引当区分、`LocationStock` / `SalesLimit` 更新
  - **販売タブ**: 公開/販売制御
- 在庫管理専用メニュー（`/bo/inventory`）は **廃止** し、在庫更新は商品詳細在庫タブへ集約

### 6.5 引当進捗の可視化
- 注文一覧/詳細に **引当済点数/注文点数（数量合計）** を表示する

---

## 7. ビジネスルール（要件）

### 7.1 在庫判定（顧客向け表示の統一）
- 顧客向けの商品在庫表示は **引当区分に応じた「有効在庫」** を基準とする
  - 実在庫: 実在庫の `remaining` 相当
  - 枠在庫: SalesLimit に基づく販売可能残数（定義は設計で確定）

### 7.2 引当進捗（集計）
- 注文単位の進捗:
  - `orderedQuantity`: 注文点数（数量合計）
  - `allocatedQuantity`: 引当済点数（数量合計）
- 注文明細単位の進捗:
  - `orderedQuantity`: 明細数量
  - `allocatedQuantity`: 本引当済数量（枠在庫は本引当分のみを「引当済」とする）

### 7.3 出荷可能条件
- `allocatedQuantity == orderedQuantity` を満たさない注文は `SHIPPED` へ遷移できない

---

## 8. 非同期要件（イベント起点）

### 8.1 起点イベント
- **注文確定イベント**: 枠在庫商品の本引当を試行する
- **在庫増加イベント**: 未引当を再試行する（可能分を本引当）

### 8.2 処理特性（要件）
- 注文確定の同期処理は、枠在庫について **即時本引当を必須としない**
- 本引当は **非同期で進行** し、部分引当を許可する
- 未引当は保持され、在庫増加で再試行される

---

## 9. 公開API / IF / 型の変更（要件レベル）

### 9.1 Product系IF
- `stock` を廃止
- `allocationType` を追加
- 在庫表示用の新指標（引当区分に応じた有効在庫）を返却対象に含める

### 9.2 注文系IF
- 注文一覧:
  - `allocatedQuantity` / `orderedQuantity`（数量合計）を返却
- 注文詳細:
  - 明細商品ごとに `allocatedQuantity` / `orderedQuantity` を返却

### 9.3 BO商品更新IF
- 在庫タブ操作で `LocationStock` / `SalesLimit` を更新可能にする

---

## 10. データモデル要件（要件書に記載する粒度）

### 10.1 products
- `products.stock` 廃止
- `products.allocation_type` 追加（2値固定）

### 10.2 location_stocks
- 想定カラム（要件粒度）:
  - `product_id`
  - `location_id`
  - `allocated_qty`
  - `allocatable_qty`
- `remaining_qty` は算出値

### 10.3 sales_limits
- 想定カラム（要件粒度）:
  - `product_id`
  - `sales_limit_total`（累計販売限度数のみ）

### 10.4 引当進捗保持（注文/注文明細）
- 引当進捗管理のため、注文/注文明細の引当済数量を保持できる構造を追加  
  - 具体カラムは **設計工程で確定**

### 10.5 データ移行
- 既存 `products.stock` データ移行は **0初期化**

---

## 11. 画面要件（BO）

### 11.1 商品管理詳細（3タブ化）
- **商品タブ**: 基本属性を編集・保存できる
- **在庫タブ**:
  - 引当区分（実在庫/枠在庫）を変更できる
  - `LocationStock` / `SalesLimit` を更新できる
- **販売タブ**: 公開/販売制御を編集・保存できる
- 3タブで保存・再表示が一貫すること

### 11.2 在庫管理メニュー廃止
- ` /bo/inventory ` は **UI導線から非表示** とし、遷移経路が存在しないこと

---

## 12. 画面要件（注文の進捗表示）

### 12.1 注文一覧
- 注文単位で `引当済点数 / 注文点数（数量合計）` が見えること

### 12.2 注文詳細
- 明細商品ごとに `引当済点数 / 注文点数` が見えること

---

## 13. 受け入れ条件

1. 商品単位で引当区分を保持・変更できる  
2. `products.stock` 非依存で在庫判定/引当が成立する  
3. 実在庫商品は従来どおりの引当挙動を維持する  
4. 枠在庫商品は仮引当後、非同期で本引当が進行する  
5. 未引当がある注文は `SHIPPED` へ遷移できない  
6. 商品管理詳細が3タブ構成になっている  
7. BO在庫管理メニューが非表示で導線がない  
8. 注文一覧で注文単位の `引当済点数/注文点数（数量合計）` が見える  
9. 注文詳細で商品単位の `引当済点数/注文点数` が見える  
10. 既存 `Product.stock` 参照箇所が全改修対象として管理される  

---

## 14. テストシナリオ（要件受け入れ観点）

1. 実在庫商品のカート追加/注文確定/キャンセル回帰  
2. 枠在庫商品の仮引当成立、注文確定後の非同期本引当成立  
3. 在庫不足時に未引当が残り、在庫増加イベントで再試行される  
4. 部分引当が数量ベースで進行し、進捗表示に反映される  
5. 未引当残で `SHIPPED` 不可  
6. 商品管理3タブで保存・再表示が一貫  
7. `/bo/inventory` 導線廃止の回帰確認  
8. 顧客在庫表示が引当区分別有効在庫で統一判定される  

---

## 15. 変更影響（棚卸し要件）
- `Product.stock` 参照箇所は **全改修対象として管理** されること  
  - 参照箇所の洗い出し・改修リスト化は設計/タスク工程で実施する

---

## 16. 未決事項（設計工程で確定）
- 「有効在庫」指標の厳密定義（実在庫/枠在庫それぞれの算出式）
- 注文/注文明細の「引当済数量」保持カラムの確定
- 非同期本引当の冪等性/再試行制御（イベント重複時の扱い）
- 在庫増加イベントの発火条件・粒度（どの更新を増加とみなすか）