# CHG-007: 管理画面拡張（注文・在庫・会員）— 実装タスク

要件: `docs/01_requirements/CHG-007_管理画面拡張（注文・在庫・会員）.md`
設計: `docs/02_designs/CHG-007_管理画面拡張（注文・在庫・会員）.md`
作成日: 2026-02-13
ステータス: 実装中

---

## 検証コマンド

```bash
# バックエンド起動
cd backend
./mvnw spring-boot:run

# フロントエンド起動
cd frontend
npm run dev

# アクセスURL
# - 管理画面: http://localhost:5173/bo/item
# - 在庫管理: http://localhost:5173/bo/inventory
# - 会員管理: http://localhost:5173/bo/members

# ADMIN ユーザーでログイン必須
# テストデータ: admin@example.com / password
```

---

## 既存実装状況サマリ

| 項目 | 状態 | 備考 |
|------|------|------|
| User.isActive | ❌ | 実装必須 |
| Role enum | ✅ | 実装済み |
| OperationHistory | ✅ | 実装済み |
| OperationHistoryService.logAdminAction() | ✅ | 実装済み |
| ForbiddenException | ✅ | 実装済み |
| AdminItemPage.tsx | ✅ | 改修必要 |
| AdminOrderPage.tsx | ✅ | 会員情報追加必要 |
| OrderDto | ⚠️ | userId, userEmail, userDisplayName 追加必要 |

---

## フェーズ1: 基盤整備

### タスク1-1: User.isActive フィールド追加

**ファイル**: `backend/src/main/java/com/example/aiec/entity/User.java`

**挿入位置**: `role` フィールドの直後

**コード**:
```java
@Column(nullable = false)
private Boolean isActive = true;
```

**Getter/Setter** (Lombokが自動生成するため追記不要):
```java
// @Data アノテーションで自動生成される
// public Boolean getIsActive() { ... }
// public void setIsActive(Boolean isActive) { ... }
```

**SQLiteデータ移行** (手動実行):
```sql
-- 1. カラム追加（NULL許可で追加）
ALTER TABLE users ADD COLUMN is_active INTEGER;

-- 2. 既存データにDEFAULT値設定
UPDATE users SET is_active = 1 WHERE is_active IS NULL;
```

**注意**: SQLiteは `ALTER COLUMN` で NOT NULL 制約を追加できないため、`nullable = false` + デフォルト値で対応。

---

### タスク1-2: UserDto に isActive フィールド追加

**ファイル**: `backend/src/main/java/com/example/aiec/dto/UserDto.java`

**挿入位置**: `role` フィールドの直後

**コード**:
```java
private Boolean isActive;
```

**fromEntity() メソッド修正**:
```java
// 既存の fromEntity() メソッド内に追加
public static UserDto fromEntity(User user) {
    UserDto dto = new UserDto();
    dto.setId(user.getId());
    dto.setEmail(user.getEmail());
    dto.setDisplayName(user.getDisplayName());
    dto.setRole(user.getRole());
    dto.setIsActive(user.getIsActive()); // ← 追加
    dto.setCreatedAt(user.getCreatedAt());
    return dto;
}
```

---

### タスク1-3: フロントエンド User 型に isActive, updatedAt 追加

**ファイル**: `frontend/src/types/api.ts`

**挿入位置**: `User` インターフェース

**コード**:
```typescript
export interface User {
  id: number
  email: string
  displayName: string
  role: 'CUSTOMER' | 'ADMIN'
  isActive?: boolean      // ← 追加
  createdAt: string
  updatedAt?: string      // ← 追加
}
```

---

### タスク1-4: InventoryAdjustment エンティティ作成

**ファイル**: `backend/src/main/java/com/example/aiec/entity/InventoryAdjustment.java` (新規)

**コード**:
```java
package com.example.aiec.entity;

import jakarta.persistence.*;
import lombok.Data;
import java.time.LocalDateTime;

@Entity
@Table(name = "inventory_adjustments")
@Data
public class InventoryAdjustment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne
    @JoinColumn(name = "product_id", nullable = false)
    private Product product;

    @Column(nullable = false)
    private Integer quantityBefore;

    @Column(nullable = false)
    private Integer quantityAfter;

    @Column(nullable = false)
    private Integer quantityDelta; // 増減量（例: +10, -5）

    @Column(nullable = false, length = 500)
    private String reason;

    @Column(nullable = false, length = 255)
    private String adjustedBy; // メールアドレス

    @Column(nullable = false)
    private LocalDateTime adjustedAt;
}
```

**参考**: `backend/src/main/java/com/example/aiec/entity/Product.java`

---

### タスク1-5: InventoryAdjustmentRepository 作成

**ファイル**: `backend/src/main/java/com/example/aiec/repository/InventoryAdjustmentRepository.java` (新規)

**コード**:
```java
package com.example.aiec.repository;

import com.example.aiec.entity.InventoryAdjustment;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface InventoryAdjustmentRepository extends JpaRepository<InventoryAdjustment, Long> {
    List<InventoryAdjustment> findByProductIdOrderByAdjustedAtDesc(Long productId);
    List<InventoryAdjustment> findAllByOrderByAdjustedAtDesc();
}
```

**参考**: `backend/src/main/java/com/example/aiec/repository/ProductRepository.java`

---

### タスク1-6: AdminSidebar コンポーネント作成

**ファイル**: `frontend/src/components/AdminSidebar.tsx` (新規)

**コード**:
```tsx
import { NavLink } from 'react-router-dom'

const menuItems = [
  { label: '商品', path: '/bo/item' },
  { label: '注文', path: '/bo/order' },
  { label: '在庫', path: '/bo/inventory' },
  { label: '会員', path: '/bo/members' },
]

export default function AdminSidebar() {
  return (
    <aside className="w-64 bg-zinc-900 text-white flex flex-col">
      <div className="p-6 border-b border-zinc-800">
        <h1 className="text-xl font-bold tracking-tight">ETHEREAL Admin</h1>
      </div>
      <nav className="flex-1 p-4">
        <ul className="space-y-2">
          {menuItems.map((item) => (
            <li key={item.path}>
              <NavLink
                to={item.path}
                className={({ isActive }) =>
                  `block px-4 py-3 rounded-lg transition-colors ${
                    isActive
                      ? 'bg-zinc-800 text-white'
                      : 'text-zinc-400 hover:text-white hover:bg-zinc-800'
                  }`
                }
              >
                {item.label}
              </NavLink>
            </li>
          ))}
        </ul>
      </nav>
    </aside>
  )
}
```

**参考**: `frontend/src/components/Layout.tsx`

---

### タスク1-7: AdminLayout コンポーネント作成

**ファイル**: `frontend/src/components/AdminLayout.tsx` (新規)

**コード**:
```tsx
import { Outlet } from 'react-router-dom'
import AdminSidebar from './AdminSidebar'

export default function AdminLayout() {
  return (
    <div className="flex h-screen overflow-hidden">
      <AdminSidebar />
      <main className="flex-1 overflow-y-auto bg-gray-50">
        <Outlet />
      </main>
    </div>
  )
}
```

**参考**: `frontend/src/components/Layout.tsx`

---

### タスク1-8: App.tsx のルーティング変更

**ファイル**: `frontend/src/App.tsx`

**変更内容**:
1. `AdminLayout` をインポート
2. `/bo` パスに `<Route element={<AdminLayout />}>` を追加
3. 既存の `/bo/item`, `/bo/order` を `AdminLayout` の子ルートに移動

**修正前** (現状):
```tsx
<BrowserRouter>
  <Routes>
    <Route element={<Layout />}>
      <Route path="/" element={<HomePage />} />
      <Route path="/item" element={<ItemListPage />} />
      <Route path="/item/:id" element={<ItemDetailPage />} />
      <Route path="/cart" element={<CartPage />} />
      <Route path="/login" element={<LoginPage />} />
      <Route path="/register" element={<RegisterPage />} />
      <Route path="/order" element={<OrderPage />} />
      <Route path="/order/:orderNumber" element={<OrderDetailPage />} />
      <Route path="/bo/item" element={<AdminItemPage />} />
      <Route path="/bo/order" element={<AdminOrderPage />} />
    </Route>
  </Routes>
</BrowserRouter>
```

**修正後**:
```tsx
import AdminLayout from './components/AdminLayout'
import AdminInventoryPage from './pages/AdminInventoryPage'
import AdminMembersPage from './pages/AdminMembersPage'

// ...

<BrowserRouter>
  <Routes>
    {/* 一般ユーザー画面 */}
    <Route element={<Layout />}>
      <Route path="/" element={<HomePage />} />
      <Route path="/item" element={<ItemListPage />} />
      <Route path="/item/:id" element={<ItemDetailPage />} />
      <Route path="/cart" element={<CartPage />} />
      <Route path="/login" element={<LoginPage />} />
      <Route path="/register" element={<RegisterPage />} />
      <Route path="/order" element={<OrderPage />} />
      <Route path="/order/:orderNumber" element={<OrderDetailPage />} />
    </Route>

    {/* 管理画面（別レイアウト） */}
    <Route path="/bo" element={<AdminLayout />}>
      <Route path="item" element={<AdminItemPage />} />
      <Route path="order" element={<AdminOrderPage />} />
      <Route path="inventory" element={<AdminInventoryPage />} />
      <Route path="members" element={<AdminMembersPage />} />
    </Route>
  </Routes>
</BrowserRouter>
```

**参考**: 既存の `<Route element={<Layout />}>` 構造

---

## フェーズ2: 既存管理画面の改修

### タスク2-1: AdminItemPage を4段階レイアウトに改修

**ファイル**: `frontend/src/pages/AdminItemPage.tsx`

**変更内容**:
1. 統計カード削除
2. ヘッダー・検索・フィルタ・テーブルの4段階構成に変更
3. 商品IDをクリッカブルリンクに変更
4. 商品IDクリック → 詳細モーダル表示

**改修ガイドライン**:
- **ヘッダー**: `<h1>商品管理</h1>` + 新規登録ボタン
- **検索エリア**: 商品名で検索する `<input>` + 検索ボタン
- **フィルタエリア**: 公開状態フィルタ（すべて | 公開 | 非公開）
- **テーブル**: 商品ID列を `<button className="font-mono text-blue-600 hover:underline">` でクリッカブルに
- **モーダル**: `selectedProductId` state を追加し、ID クリック時にモーダル表示

**参考実装**:
- `frontend/src/pages/AdminOrderPage.tsx` のフィルタボタン実装

---

### タスク2-2: OrderDto に会員情報フィールドを追加

**ファイル**: `backend/src/main/java/com/example/aiec/dto/OrderDto.java`

**挿入位置**: `orderNumber` フィールドの直後

**コード**:
```java
private Long userId;
private String userEmail;
private String userDisplayName;
```

**fromEntity() メソッド修正**:
```java
public static OrderDto fromEntity(Order order) {
    OrderDto dto = new OrderDto();
    dto.setOrderId(order.getId());
    dto.setOrderNumber(order.getOrderNumber());

    // 会員情報追加
    if (order.getUser() != null) {
        dto.setUserId(order.getUser().getId());
        dto.setUserEmail(order.getUser().getEmail());
        dto.setUserDisplayName(order.getUser().getDisplayName());
    }

    // 既存のフィールド設定
    dto.setItems(order.getItems().stream()
        .map(OrderItemDto::fromEntity)
        .collect(Collectors.toList()));
    dto.setTotalPrice(order.getTotalPrice());
    dto.setStatus(order.getStatus());
    dto.setCreatedAt(order.getCreatedAt());
    dto.setUpdatedAt(order.getUpdatedAt());
    return dto;
}
```

**注意**: `Order` エンティティに `@ManyToOne User user` が存在することを前提（CHG-006で実装済み）

---

### タスク2-3: AdminOrderPage を4段階レイアウトに改修し会員情報を追加

**ファイル**: `frontend/src/pages/AdminOrderPage.tsx`

**変更内容**:
1. 統計カード削除
2. ヘッダー・検索・フィルタ・テーブルの4段階構成に変更
3. テーブルに会員メールアドレスと表示名カラムを追加
4. 注文番号をクリッカブルリンクに変更
5. 注文番号クリック → 詳細モーダル表示（会員情報含む）

**改修ガイドライン**:
- **ヘッダー**: `<h1>注文管理</h1>`
- **検索エリア**: 注文番号で検索する `<input>` + 検索ボタン
- **フィルタエリア**: 既存のステータスフィルタボタンを維持
- **テーブル**: 注文番号列を `<button className="font-mono text-blue-600 hover:underline">` でクリッカブルに
- **テーブルカラム追加**: `<th>会員メール</th>`, `<th>会員表示名</th>`
- **モーダル**: 会員情報セクションを追加（メールアドレス、表示名）

**テーブル構造例**:
```tsx
<table className="w-full">
  <thead>
    <tr className="border-b">
      <th>注文番号</th>
      <th>注文日時</th>
      <th>会員メール</th>
      <th>会員表示名</th>
      <th>ステータス</th>
      <th>合計金額</th>
    </tr>
  </thead>
  <tbody>
    {orders.map(order => (
      <tr key={order.orderId}>
        <td>
          <button
            onClick={() => handleOrderClick(order.orderId)}
            className="font-mono text-blue-600 hover:underline"
          >
            {order.orderNumber}
          </button>
        </td>
        <td>{new Date(order.createdAt).toLocaleString('ja-JP')}</td>
        <td>{order.userEmail || 'ゲスト'}</td>
        <td>{order.userDisplayName || '—'}</td>
        <td>{order.status}</td>
        <td className="tabular-nums">{order.totalPrice.toLocaleString()}円</td>
      </tr>
    ))}
  </tbody>
</table>
```

---

## フェーズ3: 在庫管理機能

### タスク3-1: InventoryService に getAllInventoryStatus() メソッド追加

**ファイル**: `backend/src/main/java/com/example/aiec/service/InventoryService.java`

**挿入位置**: クラスの末尾（既存メソッドの後）

**コード**:
```java
/**
 * 全商品の在庫状況を一括取得（バッチ処理版）
 * JOIN + GROUP BY で効率的に取得
 */
public List<InventoryStatusDto> getAllInventoryStatus() {
    List<Product> products = productRepository.findAll();

    return products.stream().map(product -> {
        // 仮引当数（有効期限内のみ）
        Integer tentative = reservationRepository
            .sumQuantityByProductIdAndType(product.getId(), ReservationType.TENTATIVE)
            .orElse(0);

        // 本引当数
        Integer committed = reservationRepository
            .sumQuantityByProductIdAndType(product.getId(), ReservationType.COMMITTED)
            .orElse(0);

        // 有効在庫計算
        Integer available = product.getStock() - tentative - committed;

        return InventoryStatusDto.builder()
            .productId(product.getId())
            .productName(product.getName())
            .physicalStock(product.getStock())
            .tentativeReserved(tentative)
            .committedReserved(committed)
            .availableStock(available)
            .build();
    }).collect(Collectors.toList());
}
```

**DTO作成**: `backend/src/main/java/com/example/aiec/dto/InventoryStatusDto.java` (新規)
```java
package com.example.aiec.dto;

import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class InventoryStatusDto {
    private Long productId;
    private String productName;
    private Integer physicalStock;
    private Integer tentativeReserved;
    private Integer committedReserved;
    private Integer availableStock;
}
```

**参考**: `backend/src/main/java/com/example/aiec/service/InventoryService.java` の既存メソッド

---

### タスク3-2: InventoryService に adjustStock() メソッド追加

**ファイル**: `backend/src/main/java/com/example/aiec/service/InventoryService.java`

**挿入位置**: `getAllInventoryStatus()` の直後

**コード**:
```java
/**
 * 在庫調整（差分方式）
 * @param productId 商品ID
 * @param quantityDelta 増減量（正: 増加、負: 減少）
 * @param reason 調整理由
 * @param admin 実施管理者
 * @return 調整履歴
 */
@Transactional
public InventoryAdjustment adjustStock(Long productId, Integer quantityDelta, String reason, User admin) {
    Product product = productRepository.findById(productId)
        .orElseThrow(() -> new ResourceNotFoundException("PRODUCT_NOT_FOUND", "商品が見つかりません"));

    Integer quantityBefore = product.getStock();
    Integer quantityAfter = quantityBefore + quantityDelta;

    // 在庫が負にならないようバリデーション
    if (quantityAfter < 0) {
        throw new BusinessException("INVALID_STOCK_ADJUSTMENT",
            "在庫調整後の数量が負になります（現在: " + quantityBefore + ", 調整: " + quantityDelta + "）");
    }

    // 在庫更新
    product.setStock(quantityAfter);
    productRepository.save(product);

    // 調整履歴記録
    InventoryAdjustment adjustment = new InventoryAdjustment();
    adjustment.setProduct(product);
    adjustment.setQuantityBefore(quantityBefore);
    adjustment.setQuantityAfter(quantityAfter);
    adjustment.setQuantityDelta(quantityDelta);
    adjustment.setReason(reason);
    adjustment.setAdjustedBy(admin.getEmail());
    adjustment.setAdjustedAt(LocalDateTime.now());

    return inventoryAdjustmentRepository.save(adjustment);
}
```

**必要な依存**: `InventoryAdjustmentRepository` をフィールドに追加
```java
private final InventoryAdjustmentRepository inventoryAdjustmentRepository;
```

---

### タスク3-3: AdminInventoryController 作成

**ファイル**: `backend/src/main/java/com/example/aiec/controller/AdminInventoryController.java` (新規)

**コード**:
```java
package com.example.aiec.controller;

import com.example.aiec.dto.ApiResponse;
import com.example.aiec.dto.InventoryStatusDto;
import com.example.aiec.entity.InventoryAdjustment;
import com.example.aiec.entity.Role;
import com.example.aiec.entity.User;
import com.example.aiec.exception.ForbiddenException;
import com.example.aiec.service.AuthService;
import com.example.aiec.service.InventoryService;
import com.example.aiec.service.OperationHistoryService;
import com.example.aiec.repository.InventoryAdjustmentRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/admin/inventory")
@RequiredArgsConstructor
public class AdminInventoryController {
    private final InventoryService inventoryService;
    private final InventoryAdjustmentRepository adjustmentRepository;
    private final AuthService authService;
    private final OperationHistoryService operationHistoryService;

    /**
     * 認可チェック（ADMIN必須）
     */
    private void requireAdmin(User user, String requestPath) {
        if (user.getRole() != Role.ADMIN) {
            operationHistoryService.logAuthorizationError(user, requestPath);
            throw new ForbiddenException("FORBIDDEN", "この操作を実行する権限がありません");
        }
    }

    /**
     * Authorization ヘッダーからトークンを抽出
     */
    private String extractToken(String authHeader) {
        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            throw new ForbiddenException("UNAUTHORIZED", "認証が必要です");
        }
        return authHeader.substring(7);
    }

    /**
     * 在庫一覧取得
     */
    @GetMapping
    public ApiResponse<List<InventoryStatusDto>> getAllInventory(
            @RequestHeader("Authorization") String authHeader) {

        String token = extractToken(authHeader);
        User user = authService.verifyToken(token);
        requireAdmin(user, "/api/admin/inventory");

        List<InventoryStatusDto> inventories = inventoryService.getAllInventoryStatus();
        return ApiResponse.success(inventories);
    }

    /**
     * 在庫調整
     */
    @PostMapping("/adjust")
    public ApiResponse<InventoryAdjustment> adjustStock(
            @RequestHeader("Authorization") String authHeader,
            @RequestBody AdjustStockRequest request) {

        String token = extractToken(authHeader);
        User user = authService.verifyToken(token);
        requireAdmin(user, "/api/admin/inventory/adjust");

        InventoryAdjustment adjustment = inventoryService.adjustStock(
            request.getProductId(),
            request.getQuantityDelta(),
            request.getReason(),
            user
        );

        // 監査ログ記録
        String details = String.format("Adjusted inventory: %s (%d → %d, delta: %+d)",
            adjustment.getProduct().getName(),
            adjustment.getQuantityBefore(),
            adjustment.getQuantityAfter(),
            adjustment.getQuantityDelta());
        operationHistoryService.logAdminAction(user, "/api/admin/inventory/adjust", details);

        return ApiResponse.success(adjustment);
    }

    /**
     * 在庫調整履歴取得
     */
    @GetMapping("/adjustments")
    public ApiResponse<List<InventoryAdjustment>> getAdjustments(
            @RequestHeader("Authorization") String authHeader,
            @RequestParam(required = false) Long productId) {

        String token = extractToken(authHeader);
        User user = authService.verifyToken(token);
        requireAdmin(user, "/api/admin/inventory/adjustments");

        List<InventoryAdjustment> adjustments = productId != null
            ? adjustmentRepository.findByProductIdOrderByAdjustedAtDesc(productId)
            : adjustmentRepository.findAllByOrderByAdjustedAtDesc();

        return ApiResponse.success(adjustments);
    }

    /**
     * 在庫調整リクエストDTO
     */
    @lombok.Data
    public static class AdjustStockRequest {
        private Long productId;
        private Integer quantityDelta;
        private String reason;
    }
}
```

**参考**:
- `backend/src/main/java/com/example/aiec/controller/OrderController.java` の認可パターン
- `backend/src/main/java/com/example/aiec/controller/ItemController.java` の監査ログパターン

---

### タスク3-4: AdminInventoryPage 作成

**ファイル**: `frontend/src/pages/AdminInventoryPage.tsx` (新規)

**コード**:
```tsx
import { useState, useEffect } from 'react'
import { api } from '../lib/api'

interface InventoryItem {
  productId: number
  productName: string
  physicalStock: number
  tentativeReserved: number
  committedReserved: number
  availableStock: number
}

interface InventoryAdjustment {
  id: number
  productId: number
  productName?: string
  quantityBefore: number
  quantityAfter: number
  quantityDelta: number
  reason: string
  adjustedBy: string
  adjustedAt: string
}

export default function AdminInventoryPage() {
  const [inventories, setInventories] = useState<InventoryItem[]>([])
  const [adjustments, setAdjustments] = useState<InventoryAdjustment[]>([])
  const [threshold, setThreshold] = useState<number>(10)
  const [showLowStock, setShowLowStock] = useState<boolean>(false)
  const [selectedProductId, setSelectedProductId] = useState<number | null>(null)
  const [showAdjustModal, setShowAdjustModal] = useState<boolean>(false)
  const [adjustForm, setAdjustForm] = useState({ quantityDelta: 0, reason: '' })
  const [searchQuery, setSearchQuery] = useState<string>('')

  useEffect(() => {
    fetchInventories()
    fetchAdjustments()
  }, [])

  const fetchInventories = async () => {
    try {
      const response = await api.get<InventoryItem[]>('/admin/inventory')
      if (response.success && response.data) {
        setInventories(response.data)
      }
    } catch (error) {
      console.error('在庫一覧取得エラー:', error)
    }
  }

  const fetchAdjustments = async () => {
    try {
      const response = await api.get<InventoryAdjustment[]>('/admin/inventory/adjustments')
      if (response.success && response.data) {
        setAdjustments(response.data)
      }
    } catch (error) {
      console.error('調整履歴取得エラー:', error)
    }
  }

  const handleAdjust = async () => {
    if (!selectedProductId) return

    try {
      const response = await api.post('/admin/inventory/adjust', {
        productId: selectedProductId,
        quantityDelta: adjustForm.quantityDelta,
        reason: adjustForm.reason,
      })

      if (response.success) {
        alert('在庫を調整しました')
        setShowAdjustModal(false)
        setAdjustForm({ quantityDelta: 0, reason: '' })
        fetchInventories()
        fetchAdjustments()
      }
    } catch (error) {
      console.error('在庫調整エラー:', error)
      alert('在庫調整に失敗しました')
    }
  }

  const filteredInventories = inventories
    .filter(inv => showLowStock ? inv.availableStock <= threshold : true)
    .filter(inv => inv.productName.toLowerCase().includes(searchQuery.toLowerCase()))

  return (
    <div className="p-8">
      {/* ヘッダー */}
      <div className="mb-6">
        <h1 className="text-3xl font-bold text-zinc-900">在庫管理</h1>
      </div>

      {/* 検索エリア */}
      <div className="mb-4">
        <input
          type="text"
          placeholder="商品名で検索"
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          className="px-4 py-2 border rounded-lg w-full max-w-md"
        />
      </div>

      {/* フィルタエリア */}
      <div className="mb-6 flex items-center gap-4">
        <input
          type="number"
          placeholder="しきい値"
          value={threshold}
          onChange={(e) => setThreshold(Number(e.target.value))}
          className="px-4 py-2 border rounded-lg w-32"
        />
        <button
          onClick={() => setShowLowStock(!showLowStock)}
          className={`px-4 py-2 rounded-lg font-medium ${
            showLowStock
              ? 'bg-rose-600 text-white'
              : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
          }`}
        >
          {showLowStock ? '全商品表示' : '不足商品のみ表示'}
        </button>
      </div>

      {/* 在庫一覧テーブル */}
      <div className="bg-white rounded-lg shadow mb-8 overflow-hidden">
        <table className="w-full">
          <thead className="bg-gray-50 border-b">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">商品ID</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">商品名</th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">現在庫</th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">仮引当</th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">本引当</th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">有効在庫</th>
              <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">操作</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {filteredInventories.map((inv) => (
              <tr key={inv.productId} className="hover:bg-gray-50">
                <td className="px-6 py-4">
                  <button
                    onClick={() => setSelectedProductId(inv.productId)}
                    className="font-mono text-blue-600 hover:underline"
                  >
                    {inv.productId}
                  </button>
                </td>
                <td className="px-6 py-4 text-sm text-gray-900">{inv.productName}</td>
                <td className="px-6 py-4 text-sm text-right tabular-nums">{inv.physicalStock}</td>
                <td className="px-6 py-4 text-sm text-right tabular-nums">{inv.tentativeReserved}</td>
                <td className="px-6 py-4 text-sm text-right tabular-nums">{inv.committedReserved}</td>
                <td className={`px-6 py-4 text-sm text-right tabular-nums font-medium ${
                  inv.availableStock <= threshold ? 'text-rose-600' : 'text-emerald-600'
                }`}>
                  {inv.availableStock}
                </td>
                <td className="px-6 py-4 text-center">
                  <button
                    onClick={() => {
                      setSelectedProductId(inv.productId)
                      setShowAdjustModal(true)
                    }}
                    className="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700"
                  >
                    調整
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* 調整履歴テーブル */}
      <h2 className="text-xl font-bold text-zinc-900 mb-4">調整履歴</h2>
      <div className="bg-white rounded-lg shadow overflow-hidden">
        <table className="w-full">
          <thead className="bg-gray-50 border-b">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">調整日時</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">商品ID</th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">調整前</th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">調整後</th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">増減</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">理由</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">実施者</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {adjustments.slice(0, 20).map((adj) => (
              <tr key={adj.id} className="hover:bg-gray-50">
                <td className="px-6 py-4 text-sm text-gray-900">
                  {new Date(adj.adjustedAt).toLocaleString('ja-JP')}
                </td>
                <td className="px-6 py-4 text-sm font-mono">{adj.productId}</td>
                <td className="px-6 py-4 text-sm text-right tabular-nums">{adj.quantityBefore}</td>
                <td className="px-6 py-4 text-sm text-right tabular-nums">{adj.quantityAfter}</td>
                <td className={`px-6 py-4 text-sm text-right tabular-nums font-medium ${
                  adj.quantityDelta > 0 ? 'text-emerald-600' : 'text-rose-600'
                }`}>
                  {adj.quantityDelta > 0 ? '+' : ''}{adj.quantityDelta}
                </td>
                <td className="px-6 py-4 text-sm text-gray-700">{adj.reason}</td>
                <td className="px-6 py-4 text-sm text-gray-700">{adj.adjustedBy}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* 調整モーダル */}
      {showAdjustModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 max-w-md w-full">
            <h2 className="text-xl font-bold mb-4">在庫調整</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1">増減量</label>
                <input
                  type="number"
                  value={adjustForm.quantityDelta}
                  onChange={(e) => setAdjustForm({ ...adjustForm, quantityDelta: Number(e.target.value) })}
                  className="w-full px-3 py-2 border rounded"
                  placeholder="例: +10 または -5"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">理由</label>
                <input
                  type="text"
                  value={adjustForm.reason}
                  onChange={(e) => setAdjustForm({ ...adjustForm, reason: e.target.value })}
                  className="w-full px-3 py-2 border rounded"
                  placeholder="例: 棚卸調整"
                />
              </div>
              <div className="flex gap-2">
                <button
                  onClick={handleAdjust}
                  className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                >
                  調整実行
                </button>
                <button
                  onClick={() => {
                    setShowAdjustModal(false)
                    setAdjustForm({ quantityDelta: 0, reason: '' })
                  }}
                  className="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                >
                  キャンセル
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
```

**参考**: `frontend/src/pages/AdminOrderPage.tsx` の状態管理パターン

---

## フェーズ4: 会員管理機能

### タスク4-1: UserService に会員管理メソッド追加

**ファイル**: `backend/src/main/java/com/example/aiec/service/UserService.java`

**挿入位置**: クラスの末尾

**コード**:
```java
/**
 * 会員状態変更
 */
@Transactional
public User updateStatus(Long userId, Boolean isActive) {
    User user = userRepository.findById(userId)
        .orElseThrow(() -> new ResourceNotFoundException("USER_NOT_FOUND", "会員が見つかりません"));

    user.setIsActive(isActive);
    return userRepository.save(user);
}

/**
 * 会員ロール変更
 */
@Transactional
public User updateRole(Long userId, Role role) {
    User user = userRepository.findById(userId)
        .orElseThrow(() -> new ResourceNotFoundException("USER_NOT_FOUND", "会員が見つかりません"));

    user.setRole(role);
    return userRepository.save(user);
}
```

---

### タスク4-2: MemberDetailDto 作成

**ファイル**: `backend/src/main/java/com/example/aiec/dto/MemberDetailDto.java` (新規)

**コード**:
```java
package com.example.aiec.dto;

import com.example.aiec.entity.Role;
import lombok.Data;
import java.time.LocalDateTime;

@Data
public class MemberDetailDto {
    private Long id;
    private String email;
    private String displayName;
    private Role role;
    private Boolean isActive;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    private OrderSummary orderSummary;

    @Data
    public static class OrderSummary {
        private Long totalOrders;
        private Long totalAmount;
    }
}
```

---

### タスク4-3: AdminController 作成（会員管理）

**ファイル**: `backend/src/main/java/com/example/aiec/controller/AdminController.java` (新規)

**コード**:
```java
package com.example.aiec.controller;

import com.example.aiec.dto.ApiResponse;
import com.example.aiec.dto.MemberDetailDto;
import com.example.aiec.dto.UserDto;
import com.example.aiec.entity.Role;
import com.example.aiec.entity.User;
import com.example.aiec.exception.ForbiddenException;
import com.example.aiec.repository.OrderRepository;
import com.example.aiec.repository.UserRepository;
import com.example.aiec.service.AuthService;
import com.example.aiec.service.OperationHistoryService;
import com.example.aiec.service.UserService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/admin/members")
@RequiredArgsConstructor
public class AdminController {
    private final UserRepository userRepository;
    private final OrderRepository orderRepository;
    private final UserService userService;
    private final AuthService authService;
    private final OperationHistoryService operationHistoryService;

    private void requireAdmin(User user, String requestPath) {
        if (user.getRole() != Role.ADMIN) {
            operationHistoryService.logAuthorizationError(user, requestPath);
            throw new ForbiddenException("FORBIDDEN", "この操作を実行する権限がありません");
        }
    }

    private String extractToken(String authHeader) {
        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            throw new ForbiddenException("UNAUTHORIZED", "認証が必要です");
        }
        return authHeader.substring(7);
    }

    /**
     * 会員一覧取得
     */
    @GetMapping
    public ApiResponse<List<UserDto>> getMembers(
            @RequestHeader("Authorization") String authHeader) {

        String token = extractToken(authHeader);
        User user = authService.verifyToken(token);
        requireAdmin(user, "/api/admin/members");

        List<UserDto> members = userRepository.findAll().stream()
            .map(UserDto::fromEntity)
            .collect(Collectors.toList());

        return ApiResponse.success(members);
    }

    /**
     * 会員詳細取得
     */
    @GetMapping("/{id}")
    public ApiResponse<MemberDetailDto> getMemberById(
            @RequestHeader("Authorization") String authHeader,
            @PathVariable Long id) {

        String token = extractToken(authHeader);
        User user = authService.verifyToken(token);
        requireAdmin(user, "/api/admin/members/" + id);

        User member = userRepository.findById(id)
            .orElseThrow(() -> new ResourceNotFoundException("USER_NOT_FOUND", "会員が見つかりません"));

        // 注文サマリ取得
        Long totalOrders = orderRepository.countByUserId(id);
        Long totalAmount = orderRepository.sumTotalPriceByUserId(id).orElse(0L);

        MemberDetailDto dto = new MemberDetailDto();
        dto.setId(member.getId());
        dto.setEmail(member.getEmail());
        dto.setDisplayName(member.getDisplayName());
        dto.setRole(member.getRole());
        dto.setIsActive(member.getIsActive());
        dto.setCreatedAt(member.getCreatedAt());
        dto.setUpdatedAt(member.getUpdatedAt());

        MemberDetailDto.OrderSummary orderSummary = new MemberDetailDto.OrderSummary();
        orderSummary.setTotalOrders(totalOrders);
        orderSummary.setTotalAmount(totalAmount);
        dto.setOrderSummary(orderSummary);

        return ApiResponse.success(dto);
    }

    /**
     * 会員状態変更
     */
    @PutMapping("/{id}/status")
    public ApiResponse<UserDto> updateMemberStatus(
            @RequestHeader("Authorization") String authHeader,
            @PathVariable Long id,
            @RequestBody UpdateStatusRequest request) {

        String token = extractToken(authHeader);
        User user = authService.verifyToken(token);
        requireAdmin(user, "/api/admin/members/" + id + "/status");

        User updated = userService.updateStatus(id, request.getIsActive());

        // 監査ログ記録
        String details = String.format("Updated member status: %s (%s → %s)",
            updated.getEmail(),
            !request.getIsActive() ? "active" : "inactive",
            request.getIsActive() ? "active" : "inactive");
        operationHistoryService.logAdminAction(user, "/api/admin/members/" + id + "/status", details);

        return ApiResponse.success(UserDto.fromEntity(updated));
    }

    /**
     * 会員ロール変更
     */
    @PutMapping("/{id}/role")
    public ApiResponse<UserDto> updateMemberRole(
            @RequestHeader("Authorization") String authHeader,
            @PathVariable Long id,
            @RequestBody UpdateRoleRequest request) {

        String token = extractToken(authHeader);
        User user = authService.verifyToken(token);
        requireAdmin(user, "/api/admin/members/" + id + "/role");

        User updated = userService.updateRole(id, request.getRole());

        // 監査ログ記録
        String details = String.format("Updated member role: %s (%s → %s)",
            updated.getEmail(),
            updated.getRole() == Role.ADMIN ? "CUSTOMER" : "ADMIN",
            request.getRole());
        operationHistoryService.logAdminAction(user, "/api/admin/members/" + id + "/role", details);

        return ApiResponse.success(UserDto.fromEntity(updated));
    }

    @lombok.Data
    public static class UpdateStatusRequest {
        private Boolean isActive;
    }

    @lombok.Data
    public static class UpdateRoleRequest {
        private Role role;
    }
}
```

**必要な OrderRepository メソッド追加**:
```java
// OrderRepository.java に追加
Long countByUserId(Long userId);
Optional<Long> sumTotalPriceByUserId(Long userId);
```

**参考**: `backend/src/main/java/com/example/aiec/controller/OrderController.java`

---

### タスク4-4: OrderRepository にメソッド追加

**ファイル**: `backend/src/main/java/com/example/aiec/repository/OrderRepository.java`

**挿入位置**: インターフェース内の末尾

**コード**:
```java
/**
 * 特定ユーザーの注文数をカウント
 */
Long countByUserId(Long userId);

/**
 * 特定ユーザーの総購入額を集計
 */
@Query("SELECT SUM(o.totalPrice) FROM Order o WHERE o.user.id = :userId")
Optional<Long> sumTotalPriceByUserId(@Param("userId") Long userId);
```

**必要なインポート追加**:
```java
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
```

---

### タスク4-5: AdminMembersPage 作成

**ファイル**: `frontend/src/pages/AdminMembersPage.tsx` (新規)

**コード**:
```tsx
import { useState, useEffect } from 'react'
import { api } from '../lib/api'
import type { User } from '../types/api'

interface MemberDetail extends User {
  orderSummary?: {
    totalOrders: number
    totalAmount: number
  }
}

export default function AdminMembersPage() {
  const [members, setMembers] = useState<User[]>([])
  const [selectedMember, setSelectedMember] = useState<MemberDetail | null>(null)
  const [showDetailModal, setShowDetailModal] = useState<boolean>(false)
  const [searchQuery, setSearchQuery] = useState<string>('')
  const [roleFilter, setRoleFilter] = useState<'ALL' | 'CUSTOMER' | 'ADMIN'>('ALL')

  useEffect(() => {
    fetchMembers()
  }, [])

  const fetchMembers = async () => {
    try {
      const response = await api.get<User[]>('/admin/members')
      if (response.success && response.data) {
        setMembers(response.data)
      }
    } catch (error) {
      console.error('会員一覧取得エラー:', error)
    }
  }

  const fetchMemberDetail = async (id: number) => {
    try {
      const response = await api.get<MemberDetail>(`/admin/members/${id}`)
      if (response.success && response.data) {
        setSelectedMember(response.data)
        setShowDetailModal(true)
      }
    } catch (error) {
      console.error('会員詳細取得エラー:', error)
    }
  }

  const updateStatus = async (id: number, isActive: boolean) => {
    try {
      const response = await api.put(`/admin/members/${id}/status`, { isActive })
      if (response.success) {
        alert('会員状態を変更しました')
        fetchMembers()
        if (selectedMember?.id === id) {
          fetchMemberDetail(id)
        }
      }
    } catch (error) {
      console.error('会員状態変更エラー:', error)
      alert('会員状態の変更に失敗しました')
    }
  }

  const updateRole = async (id: number, role: 'CUSTOMER' | 'ADMIN') => {
    try {
      const response = await api.put(`/admin/members/${id}/role`, { role })
      if (response.success) {
        alert('会員ロールを変更しました')
        fetchMembers()
        if (selectedMember?.id === id) {
          fetchMemberDetail(id)
        }
      }
    } catch (error) {
      console.error('会員ロール変更エラー:', error)
      alert('会員ロールの変更に失敗しました')
    }
  }

  const filteredMembers = members
    .filter(member => roleFilter === 'ALL' || member.role === roleFilter)
    .filter(member => member.email.toLowerCase().includes(searchQuery.toLowerCase()))

  return (
    <div className="p-8">
      {/* ヘッダー */}
      <div className="mb-6">
        <h1 className="text-3xl font-bold text-zinc-900">会員管理</h1>
      </div>

      {/* 検索エリア */}
      <div className="mb-4">
        <input
          type="text"
          placeholder="メールアドレスで検索"
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          className="px-4 py-2 border rounded-lg w-full max-w-md"
        />
      </div>

      {/* フィルタエリア */}
      <div className="mb-6 flex gap-2">
        {(['ALL', 'CUSTOMER', 'ADMIN'] as const).map((filter) => (
          <button
            key={filter}
            onClick={() => setRoleFilter(filter)}
            className={`px-4 py-2 rounded-lg font-medium ${
              roleFilter === filter
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
            }`}
          >
            {filter === 'ALL' ? 'すべて' : filter}
          </button>
        ))}
      </div>

      {/* 会員一覧テーブル */}
      <div className="bg-white rounded-lg shadow overflow-hidden">
        <table className="w-full">
          <thead className="bg-gray-50 border-b">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">会員ID</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">メールアドレス</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">表示名</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ロール</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">状態</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">登録日</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {filteredMembers.map((member) => (
              <tr key={member.id} className="hover:bg-gray-50">
                <td className="px-6 py-4">
                  <button
                    onClick={() => fetchMemberDetail(member.id)}
                    className="font-mono text-blue-600 hover:underline"
                  >
                    {member.id}
                  </button>
                </td>
                <td className="px-6 py-4 text-sm text-gray-900">{member.email}</td>
                <td className="px-6 py-4 text-sm text-gray-900">{member.displayName}</td>
                <td className="px-6 py-4">
                  <span className={`inline-flex px-2 py-1 text-xs font-medium rounded ${
                    member.role === 'ADMIN'
                      ? 'bg-purple-100 text-purple-800'
                      : 'bg-blue-100 text-blue-800'
                  }`}>
                    {member.role}
                  </span>
                </td>
                <td className="px-6 py-4">
                  <span className={`inline-flex px-2 py-1 text-xs font-medium rounded ${
                    member.isActive
                      ? 'bg-emerald-100 text-emerald-800'
                      : 'bg-gray-100 text-gray-800'
                  }`}>
                    {member.isActive ? '有効' : '無効'}
                  </span>
                </td>
                <td className="px-6 py-4 text-sm text-gray-700">
                  {new Date(member.createdAt).toLocaleDateString('ja-JP')}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* 会員詳細モーダル */}
      {showDetailModal && selectedMember && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6">会員詳細</h2>

            {/* 基本情報 */}
            <div className="mb-6 space-y-2">
              <div className="flex">
                <span className="w-32 font-medium text-gray-700">会員ID:</span>
                <span className="font-mono">{selectedMember.id}</span>
              </div>
              <div className="flex">
                <span className="w-32 font-medium text-gray-700">メール:</span>
                <span>{selectedMember.email}</span>
              </div>
              <div className="flex">
                <span className="w-32 font-medium text-gray-700">表示名:</span>
                <span>{selectedMember.displayName}</span>
              </div>
              <div className="flex">
                <span className="w-32 font-medium text-gray-700">ロール:</span>
                <span className={`inline-flex px-2 py-1 text-xs font-medium rounded ${
                  selectedMember.role === 'ADMIN'
                    ? 'bg-purple-100 text-purple-800'
                    : 'bg-blue-100 text-blue-800'
                }`}>
                  {selectedMember.role}
                </span>
              </div>
              <div className="flex">
                <span className="w-32 font-medium text-gray-700">状態:</span>
                <span className={`inline-flex px-2 py-1 text-xs font-medium rounded ${
                  selectedMember.isActive
                    ? 'bg-emerald-100 text-emerald-800'
                    : 'bg-gray-100 text-gray-800'
                }`}>
                  {selectedMember.isActive ? '有効' : '無効'}
                </span>
              </div>
              <div className="flex">
                <span className="w-32 font-medium text-gray-700">登録日:</span>
                <span>{new Date(selectedMember.createdAt).toLocaleString('ja-JP')}</span>
              </div>
              {selectedMember.updatedAt && (
                <div className="flex">
                  <span className="w-32 font-medium text-gray-700">更新日:</span>
                  <span>{new Date(selectedMember.updatedAt).toLocaleString('ja-JP')}</span>
                </div>
              )}
            </div>

            {/* 注文サマリ */}
            {selectedMember.orderSummary && (
              <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                <h3 className="font-bold mb-2">注文サマリ</h3>
                <div className="space-y-1">
                  <div className="flex">
                    <span className="w-32 text-gray-700">総注文数:</span>
                    <span className="tabular-nums">{selectedMember.orderSummary.totalOrders}件</span>
                  </div>
                  <div className="flex">
                    <span className="w-32 text-gray-700">総購入額:</span>
                    <span className="tabular-nums">{selectedMember.orderSummary.totalAmount.toLocaleString()}円</span>
                  </div>
                </div>
              </div>
            )}

            {/* アクションボタン */}
            <div className="flex gap-2 mb-4">
              <button
                onClick={() => updateStatus(selectedMember.id, !selectedMember.isActive)}
                className={`flex-1 px-4 py-2 rounded font-medium ${
                  selectedMember.isActive
                    ? 'bg-gray-600 text-white hover:bg-gray-700'
                    : 'bg-emerald-600 text-white hover:bg-emerald-700'
                }`}
              >
                {selectedMember.isActive ? '無効化' : '有効化'}
              </button>
              <button
                onClick={() => updateRole(
                  selectedMember.id,
                  selectedMember.role === 'ADMIN' ? 'CUSTOMER' : 'ADMIN'
                )}
                className="flex-1 px-4 py-2 bg-purple-600 text-white rounded font-medium hover:bg-purple-700"
              >
                ロール変更 → {selectedMember.role === 'ADMIN' ? 'CUSTOMER' : 'ADMIN'}
              </button>
            </div>

            <button
              onClick={() => setShowDetailModal(false)}
              className="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded font-medium hover:bg-gray-300"
            >
              閉じる
            </button>
          </div>
        </div>
      )}
    </div>
  )
}
```

**参考**: `frontend/src/pages/AdminOrderPage.tsx` のモーダル実装

---

## フェーズ5: 統合テスト

### タスク5-1: 手動テスト実施

**テスト観点**:

1. **サイドバーナビゲーション**:
   - [ ] サイドバーの4つのメニューが表示される
   - [ ] 各メニューをクリックして画面遷移できる
   - [ ] アクティブメニューがハイライトされる

2. **商品管理画面**:
   - [ ] 4段階レイアウト（ヘッダー・検索・フィルタ・テーブル）で表示される
   - [ ] 商品IDをクリックして詳細モーダルが表示される
   - [ ] 商品名検索が動作する
   - [ ] 公開状態フィルタが動作する

3. **注文管理画面**:
   - [ ] 4段階レイアウトで表示される
   - [ ] 会員メールアドレスと表示名が表示される
   - [ ] 注文番号をクリックして詳細モーダルが表示される
   - [ ] 注文番号検索が動作する
   - [ ] ステータスフィルタが動作する

4. **在庫管理画面**:
   - [ ] 在庫一覧が表示される
   - [ ] 商品名検索が動作する
   - [ ] しきい値フィルタが動作する
   - [ ] 在庫調整モーダルで調整できる
   - [ ] 調整履歴が表示される

5. **会員管理画面**:
   - [ ] 会員一覧が表示される
   - [ ] メールアドレス検索が動作する
   - [ ] ロールフィルタが動作する
   - [ ] 会員IDをクリックして詳細モーダルが表示される
   - [ ] 会員状態変更が動作する
   - [ ] 会員ロール変更が動作する

6. **認可チェック**:
   - [ ] CUSTOMER ロールで管理画面にアクセスすると403エラーが表示される
   - [ ] 未ログイン状態で管理画面にアクセスするとエラーが表示される

7. **監査ログ**:
   - [ ] データベースの `operation_histories` テーブルに操作履歴が記録される

**テスト手順**:
```bash
# 1. データベース初期化（必要に応じて）
rm backend/data/ec.db

# 2. バックエンド起動
cd backend
./mvnw spring-boot:run

# 3. フロントエンド起動
cd frontend
npm run dev

# 4. ADMIN ユーザーでログイン
# http://localhost:5173/login
# admin@example.com / password

# 5. 管理画面にアクセス
# http://localhost:5173/bo/item

# 6. 各画面をテスト

# 7. 監査ログ確認
sqlite3 backend/data/ec.db "SELECT * FROM operation_histories ORDER BY created_at DESC LIMIT 10;"
```

---

## 実装完了後の次のステップ

1. **ドキュメント更新**:
   - `docs/ui/admin-ui.md` に管理画面UI仕様を追加
   - `docs/ui/api-spec.md` に新規APIエンドポイントを追加
   - `docs/SPEC.md` に在庫調整機能と会員管理機能を追加

2. **アーカイブ**:
   - CHG-007 の要件定義・設計・タスクドキュメントを `docs/archive/` に移動

3. **次の機能検討**:
   - BIダッシュボード（売上分析）
   - CSV一括取込/出力
   - メール配信機能

---

## 参考ドキュメント

- **要件定義**: `docs/01_requirements/CHG-007_管理画面拡張（注文・在庫・会員）.md`
- **技術設計**: `docs/02_designs/CHG-007_管理画面拡張（注文・在庫・会員）.md`
- **既存実装**:
  - `backend/src/main/java/com/example/aiec/controller/OrderController.java` — 認可パターン
  - `backend/src/main/java/com/example/aiec/service/OperationHistoryService.java` — 監査ログパターン
  - `frontend/src/pages/AdminOrderPage.tsx` — 管理画面UIパターン
