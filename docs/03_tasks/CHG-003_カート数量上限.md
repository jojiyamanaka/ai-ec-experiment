# CHG-003: カート内商品の数量上限（タスク）

要件: `docs/01_requirements/CHG-003_カート数量上限.md`
設計: `docs/02_designs/CHG-003_カート数量上限.md`
作成日: 2026-02-12

検証コマンド:
- バックエンド: `docker compose exec backend ./mvnw compile`
- フロントエンド: `docker compose exec frontend npm run build`
- コンテナ未起動の場合: `docker compose up -d` を先に実行

---

## タスク一覧

### バックエンド

- [ ] **T-1**: `AddToCartRequest.java` に `@Max` バリデーションを追加

  パス: `backend/src/main/java/com/example/aiec/dto/AddToCartRequest.java`

  import 追加:

  ```java
  import jakarta.validation.constraints.Max;
  ```

  `quantity` フィールドの `@Min` アノテーションの下に追加:

  ```java
  @Min(value = 1, message = "数量は1以上である必要があります")
  @Max(value = 9, message = "1商品あたりの最大数量は9個です")
  private Integer quantity = 1;
  ```

---

- [ ] **T-2**: `UpdateQuantityRequest.java` に `@Max` バリデーションを追加

  パス: `backend/src/main/java/com/example/aiec/dto/UpdateQuantityRequest.java`

  import 追加:

  ```java
  import jakarta.validation.constraints.Max;
  ```

  `quantity` フィールドの `@Min` アノテーションの下に追加:

  ```java
  @NotNull(message = "数量は必須です")
  @Min(value = 1, message = "数量は1以上である必要があります")
  @Max(value = 9, message = "1商品あたりの最大数量は9個です")
  private Integer quantity;
  ```

---

- [ ] **T-3**: `CartService.addToCart()` にカート内合計数量チェックを追加

  パス: `backend/src/main/java/com/example/aiec/service/CartService.java`

  **3-a**: クラス先頭（フィールド宣言の後、`getOrCreateCart()` メソッドの前）に定数を追加:

  ```java
  private static final int MAX_QUANTITY_PER_ITEM = 9;
  ```

  **3-b**: `addToCart()` メソッド内、`isPublished` チェック（70-72行目）の後、`inventoryService.createReservation()` 呼び出し（75行目）の前に追加:

  ```java
  // カート内の既存数量との合計チェック
  Optional<CartItem> existingItem = cartItemRepository.findByCartAndProduct(cart, product);
  int currentQuantity = existingItem.map(CartItem::getQuantity).orElse(0);
  int totalQuantity = currentQuantity + request.getQuantity();
  if (totalQuantity > MAX_QUANTITY_PER_ITEM) {
      throw new BusinessException("INVALID_QUANTITY",
              "1商品あたりの最大数量は" + MAX_QUANTITY_PER_ITEM + "個です（現在カートに" + currentQuantity + "個あります）");
  }
  ```

  既存の `existingItem` 検索（78行目）は重複するので、上記で宣言した `existingItem` を再利用するように変更:

  ```java
  // 変更前（78行目）:
  // Optional<CartItem> existingItem = cartItemRepository.findByCartAndProduct(cart, product);

  // 変更後（上で宣言済みのため、この行を削除）
  ```

  つまり `addToCart()` メソッドの 74〜94行目は以下のようになる:

  ```java
  // カート内の既存数量との合計チェック
  Optional<CartItem> existingItem = cartItemRepository.findByCartAndProduct(cart, product);
  int currentQuantity = existingItem.map(CartItem::getQuantity).orElse(0);
  int totalQuantity = currentQuantity + request.getQuantity();
  if (totalQuantity > MAX_QUANTITY_PER_ITEM) {
      throw new BusinessException("INVALID_QUANTITY",
              "1商品あたりの最大数量は" + MAX_QUANTITY_PER_ITEM + "個です（現在カートに" + currentQuantity + "個あります）");
  }

  // 仮引当を作成（有効在庫チェック込み）
  inventoryService.createReservation(sessionId, request.getProductId(), request.getQuantity());

  if (existingItem.isPresent()) {
      // 既存のアイテムがある場合は数量を追加
      CartItem item = existingItem.get();
      int newQuantity = item.getQuantity() + request.getQuantity();
      item.setQuantity(newQuantity);
      cartItemRepository.save(item);
  } else {
      // 新しいアイテムを追加
      CartItem newItem = new CartItem();
      newItem.setCart(cart);
      newItem.setProduct(product);
      newItem.setQuantity(request.getQuantity());
      cart.addItem(newItem);
      cartItemRepository.save(newItem);
  }
  ```

---

### フロントエンド

- [ ] **T-4**: `CartPage.tsx` の数量入力に上限制御を追加

  パス: `frontend/src/pages/CartPage.tsx`

  **4-a**: `handleQuantityChange` 関数（46-58行目）の `newQuantity` に上限クランプを追加:

  ```typescript
  const handleQuantityChange = async (itemId: number, newQuantity: number) => {
    setError(null)
    try {
      if (newQuantity <= 0) {
        await removeFromCart(itemId)
      } else {
        const clamped = Math.min(newQuantity, 9)
        await updateQuantity(itemId, clamped)
      }
    } catch (err) {
      console.error('数量変更エラー:', err)
      setError(err instanceof Error ? err.message : '数量の変更に失敗しました')
    }
  }
  ```

  **4-b**: 数量入力欄（155-166行目）の `min` と `max` 属性を修正:

  ```tsx
  <input
    type="number"
    min="1"
    max="9"
    value={item.quantity}
    onChange={(e) =>
      handleQuantityChange(
        item.id,
        parseInt(e.target.value) || 1
      )
    }
    className="w-16 rounded border border-gray-300 px-3 py-1 text-center"
  />
  ```

  **4-c**: 「+」ボタン（167-188行目）に数量上限時の無効化を追加:

  ```tsx
  <button
    onClick={() =>
      handleQuantityChange(item.id, item.quantity + 1)
    }
    disabled={item.quantity >= 9}
    className="flex h-8 w-8 items-center justify-center rounded-full border border-gray-300 hover:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-50"
    aria-label="数量を増やす"
  >
  ```

---

- [ ] **T-5**: `CartContext.tsx` の `updateQuantity()` に上限チェックを追加

  パス: `frontend/src/contexts/CartContext.tsx`

  `updateQuantity()` 関数（105-129行目）の先頭、`quantity <= 0` チェックの後に追加:

  ```typescript
  const updateQuantity = async (itemId: number, quantity: number) => {
    if (quantity <= 0) {
      await removeFromCart(itemId)
      return
    }
    if (quantity > 9) {
      return
    }
    // 以降は既存処理のまま
  ```

---

### ドキュメント更新

- [ ] **T-6**: `docs/spec-implementation-gaps.md` の M-5 ステータスを更新

  M-5 セクション（127-148行目）のタイトルに `✅ 実装完了` を追加。

  サマリーテーブルの中優先度の残件数を `0件` に更新。

---

## 実装順序

```
T-1, T-2（DTO バリデーション — 並行可能）
  → T-3（CartService 合計チェック）
    → T-4, T-5（フロントエンド — 並行可能）
      → T-6（ドキュメント）
```

---

## テスト手順

実装後に以下を手動確認:

1. **DTO バリデーション**: カート追加・数量変更で `quantity=10` → 400エラー
2. **合計チェック**: カート内に5個ある状態で5個追加 → `INVALID_QUANTITY` エラー
3. **合計チェック**: カート内に5個ある状態で4個追加 → 正常（合計9個）
4. **フロントエンド入力制限**: 数量入力欄で10以上が入力できないこと
5. **「+」ボタン無効化**: 数量9の状態で「+」ボタンが無効化されること
6. **在庫不足優先**: 在庫が3個の場合に数量5 → `INSUFFICIENT_STOCK` エラー（在庫チェックが先に検出）
7. **既存機能**: 数量1〜9の範囲での追加・変更・削除が正常に動作すること
