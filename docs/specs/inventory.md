# 在庫管理仕様書

作成日: 2026-02-10
バージョン: 1.0

## 概要

本仕様書は、AI EC Experimentにおける在庫管理の振る舞いを定義する。
フロントエンドおよびバックエンドの実装を基に、Given/When/Then形式で明文化する。

---

## 1. 在庫状態の表示

### 1-1. 在庫が6個以上の場合

**Given**: 商品の `stock` が 6 以上
**When**: 商品一覧または商品詳細を表示する
**Then**:
- 在庫状態は「在庫あり」と表示される
- バッジの色は緑（`bg-green-500`）で表示される

**実装箇所**:
- フロントエンド: `frontend/src/components/ProductCard.tsx:20-24`
- フロントエンド: `frontend/src/pages/ItemDetailPage.tsx:18-23`

---

### 1-2. 在庫が1〜5個の場合

**Given**: 商品の `stock` が 1 以上 5 以下
**When**: 商品一覧または商品詳細を表示する
**Then**:
- 在庫状態は「残りわずか」と表示される
- バッジの色はオレンジ（`bg-orange-500`）で表示される

**実装箇所**:
- フロントエンド: `frontend/src/components/ProductCard.tsx:15-19`
- フロントエンド: `frontend/src/pages/ItemDetailPage.tsx:13-17`

---

### 1-3. 在庫が0個の場合

**Given**: 商品の `stock` が 0
**When**: 商品一覧または商品詳細を表示する
**Then**:
- 在庫状態は「売り切れ」と表示される
- バッジの色はグレー（`bg-gray-400`）で表示される

**実装箇所**:
- フロントエンド: `frontend/src/components/ProductCard.tsx:10-14`
- フロントエンド: `frontend/src/pages/ItemDetailPage.tsx:8-12`

---

## 2. カート追加時の在庫制御

### 2-1. 在庫が0の商品はカートに追加できない

**Given**: 商品の `stock` が 0
**When**: 商品詳細画面で「カートに追加」ボタンを表示する
**Then**:
- ボタンは無効化される（`disabled`）
- ボタンのラベルは「売り切れ」と表示される
- ボタンの背景色はグレー（`bg-gray-400`）になる
- クリックしても何も起きない

**実装箇所**:
- フロントエンド: `frontend/src/pages/ItemDetailPage.tsx:43,84-91`

---

### 2-2. カート追加時の在庫数チェック（新規追加）

**Given**:
- 商品の `stock` が N 個
- カートに同じ商品がまだ追加されていない

**When**: 商品詳細画面で「カートに追加」ボタンをクリックする（数量 Q 個）
**Then**:
- **Q ≤ N の場合**:
  - カートに商品が追加される
  - 成功メッセージが表示される（実装なし）
  - カート画面に遷移する
- **Q > N の場合**:
  - エラー「在庫が不足しています」が返される
  - カートには追加されない

**実装箇所**:
- バックエンド: `backend/src/main/java/com/example/aiec/service/CartService.java:54-56`

---

### 2-3. カート追加時の在庫数チェック（既存アイテムへの追加）

**Given**:
- 商品の `stock` が N 個
- カートに同じ商品が既に M 個追加されている

**When**: 同じ商品を「カートに追加」ボタンで追加する（追加数量 Q 個）
**Then**:
- 新しい数量 = M + Q
- **M + Q ≤ N の場合**:
  - カート内の数量が M から M + Q に更新される
  - カート画面に遷移する
- **M + Q > N の場合**:
  - エラー「在庫が不足しています」が返される
  - カート内の数量は M のまま変更されない

**実装箇所**:
- バックエンド: `backend/src/main/java/com/example/aiec/service/CartService.java:58-81`
- 特に: `CartService.java:62-72`（既存アイテムへの数量加算と在庫チェック）

---

### 2-4. カート内の数量変更時の在庫チェック

**Given**:
- 商品の `stock` が N 個
- カートに同じ商品が M 個追加されている

**When**: カート画面で数量を Q 個に変更する
**Then**:
- **Q ≤ N の場合**:
  - カート内の数量が Q に更新される
- **Q > N の場合**:
  - エラー「在庫が不足しています」が返される
  - カート内の数量は M のまま変更されない

**実装箇所**:
- バックエンド: `backend/src/main/java/com/example/aiec/service/CartService.java:103-106`

---

## 3. 注文時の在庫制御

### 3-1. 注文作成時の在庫チェック

**Given**:
- カートに複数の商品が入っている
- 各商品の `stock` と `quantity` の関係は様々

**When**: 注文確認画面で「注文を確定する」ボタンをクリックする
**Then**:
- すべてのカート内商品について在庫チェックを実行
- **すべての商品で stock ≥ quantity の場合**:
  - 注文が作成される
  - 注文番号（ORD-YYYYMMDD-XXX）が生成される
  - 注文ステータスは `PENDING` になる
  - カートがクリアされる
  - 注文完了画面に遷移する
- **いずれかの商品で stock < quantity の場合**:
  - エラー「在庫が不足している商品があります」が返される
  - 注文は作成されない
  - カートはクリアされない

**実装箇所**:
- バックエンド: `backend/src/main/java/com/example/aiec/service/OrderService.java:48-52`

**注意**:
- 在庫の引当処理（stock を減らす）は実装されていない
- 複数ユーザーが同時に同じ商品を注文した場合、在庫の競合が発生する可能性がある

---

### 3-2. 注文作成後のカートクリア

**Given**: 注文が正常に作成された
**When**: 注文作成処理が完了する
**Then**:
- カートの全アイテムが削除される
- カートは空になる

**実装箇所**:
- バックエンド: `backend/src/main/java/com/example/aiec/service/OrderService.java:72-73`

---

## 4. 在庫引当（現在未実装）

### 4-1. 在庫引当処理は実装されていない

**Given**: 注文が作成される
**When**: 注文作成処理が完了する
**Then**:
- **現在の実装**: 商品の `stock` は減少しない
- **本来あるべき動作**: 注文数量分の `stock` を減少させるべき

**実装状況**:
- ❌ 未実装
- 仕様書（SPEC.md）には「今後の実装予定」として記載あり
- ギャップ分析レポート: `docs/gap-analysis.md` の「2-4」で指摘済み

**影響**:
- 在庫チェックは行われるが、在庫数は減らない
- 理論上、在庫数を超える注文が可能（複数ユーザーが同時に注文した場合）
- 在庫管理が正確に機能しない

---

## 5. 在庫のマイナス値

### 5-1. 在庫数がマイナスになることはない

**Given**: 現在の実装
**When**: いかなる操作を行っても
**Then**:
- 商品の `stock` はマイナスにならない
- 理由: 在庫引当処理が実装されていないため、在庫を減らす処理自体が存在しない

**検証ポイント**:
- カート追加時: 在庫チェックのみ（減らさない）
- 数量変更時: 在庫チェックのみ（減らさない）
- 注文作成時: 在庫チェックのみ（減らさない）

**実装箇所**:
- 在庫を減らす処理は、全ソースコード中に存在しない

---

## 6. 注文キャンセル時の在庫戻し（現在未実装）

### 6-1. 注文キャンセル機能は実装されていない

**Given**: 注文が作成された
**When**: 注文をキャンセルしようとする
**Then**:
- **現在の実装**: キャンセル機能自体が存在しない
- **本来あるべき動作**:
  - 注文ステータスが `CANCELLED` になる
  - 引き当てていた在庫が商品の `stock` に戻される

**実装状況**:
- ❌ 未実装
- 仕様書（SPEC.md）には注文ステータス遷移図で `CANCELLED` 状態が定義されているが、実装なし
- ギャップ分析レポート: `docs/gap-analysis.md` の「2-2, 2-3」で指摘済み

---

## 7. 在庫状態の更新タイミング

### 7-1. 在庫数は管理画面から手動更新のみ

**Given**: 現在の実装
**When**: 在庫数を変更する
**Then**:
- 変更方法: 管理画面（`/bo/item`）から手動で更新
- 自動更新: なし（注文時の引当処理が未実装のため）

**実装箇所**:
- フロントエンド: `frontend/src/pages/AdminItemPage.tsx`
- バックエンド: `backend/src/main/java/com/example/aiec/controller/ItemController.java` (PUT `/api/item/:id`)

---

### 7-2. 在庫数の変更はリアルタイムで反映される

**Given**: 管理画面で商品の在庫数を変更して保存する
**When**: 変更が保存される
**Then**:
- データベースの `stock` が即座に更新される
- 商品一覧・詳細画面で次回表示時に新しい在庫数が反映される
- 既にカートに入っている商品の在庫状態も、次回カート操作時にチェックされる

**実装箇所**:
- バックエンド: 商品更新API（`PUT /api/item/:id`）
- データベース: SQLite（永続化）

---

## 8. エッジケースと制約

### 8-1. 在庫数の上限

**制約**: なし
**説明**: 在庫数に明示的な上限は設定されていない（データ型による制限のみ）

---

### 8-2. カート内商品の数量上限

**制約**: なし
**説明**: カート内の1商品あたりの数量上限は設定されていない
**問題点**: ギャップ分析レポート `docs/gap-analysis.md` の「3-1」で指摘済み

---

### 8-3. 同一商品の重複カート追加

**動作**: 既存のカートアイテムに数量が加算される
**実装箇所**: `CartService.java:62-72`

---

### 8-4. 非公開商品の在庫

**Given**: 商品が非公開（`isPublished = false`）
**When**: その商品の在庫を確認する
**Then**:
- 商品一覧には表示されない
- 商品詳細は ID がわかれば取得可能（セキュリティ問題）
- カートに既に入っている場合は、在庫チェックは通常通り実行される

**問題点**: ギャップ分析レポート `docs/gap-analysis.md` の「1-12, 3-8」で指摘済み

---

## 9. 今後の実装予定

以下の機能は仕様書に記載があるが、現在未実装：

### 9-1. 在庫引当処理
- 注文作成時に `stock` を減少させる
- トランザクション管理（排他制御）
- 複数ユーザー同時注文への対応

### 9-2. 注文キャンセル機能
- 注文ステータスを `CANCELLED` に変更
- 引き当てた在庫を `stock` に戻す
- キャンセル可能な状態の定義（PENDING, CONFIRMED のみ）

### 9-3. 在庫不足時の詳細エラー
- API仕様書に記載された `details` 配列の実装
- どの商品がどれだけ不足しているか明示

---

## 10. 参考情報

### 関連仕様書
- `docs/SPEC.md`: 機能仕様書（在庫状態のルール: 255-280行目）
- `docs/api-spec.md`: API仕様書（在庫エラーレスポンス: 437-453行目）
- `docs/gap-analysis.md`: ギャップ分析レポート（在庫関連の問題点）

### 関連実装
- **フロントエンド**:
  - `frontend/src/components/ProductCard.tsx`: 在庫状態表示ロジック
  - `frontend/src/pages/ItemDetailPage.tsx`: カート追加制御
  - `frontend/src/contexts/CartContext.tsx`: カート状態管理

- **バックエンド**:
  - `backend/src/main/java/com/example/aiec/service/CartService.java`: カート在庫チェック
  - `backend/src/main/java/com/example/aiec/service/OrderService.java`: 注文時在庫チェック
  - `backend/src/main/java/com/example/aiec/entity/Product.java`: 商品エンティティ

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|--------|
| 1.0 | 2026-02-10 | 初版作成 | Claude Sonnet 4.5 |
