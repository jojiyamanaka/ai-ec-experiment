# 商品ドメインの詳細仕様

作成日: 2026-02-10
バージョン: 1.0

**目的**: 商品マスタ、価格管理、公開制御の詳細仕様を定義する
**スコープ**: 商品ドメインのビジネスロジック、価格計算、公開/非公開制御

**関連ドキュメント**:
- [技術仕様](../SPEC.md) - 技術方針・アーキテクチャ
- [業務要件](../requirements.md) - ビジネスルール
- [データモデル](../data-model.md) - Product エンティティ
- [API仕様](../ui/api-spec.md) - 商品関連API

---

## 概要

本仕様書は、AI EC Experimentにおける商品ドメインの詳細仕様を定義する。
特に価格・金額計算の振る舞いに焦点を当て、フロントエンドおよびバックエンドの実装を基に、Given/When/Then形式で明文化する。

---

## 1. 価格のデータ型

### 1-1. 商品価格は整数型（円単位）

**Given**: 商品の価格が設定される
**When**: データベースに保存される
**Then**:
- 価格は `Integer` 型（整数）
- 単位: 円（¥）
- 小数点以下は存在しない
- 例: 8,980円 → `8980`

**実装箇所**:
- バックエンド: `Product.java:26` (`Integer price`)
- データベース: `products.price` カラム（INTEGER型）

---

### 1-2. すべての金額フィールドは整数型

**Given**: 金額を扱うフィールド
**When**: システム内で金額を表現する
**Then**:
- すべて `Integer` 型（または `number` 型）
- 小数点以下は扱わない
- 対象フィールド:
  - 商品価格（`price`）
  - 小計（`subtotal`）
  - 合計金額（`totalPrice`）
  - 配送料、手数料

**実装箇所**:
- バックエンド:
  - `Product.java:26` - `Integer price`
  - `OrderItem.java:34` - `Integer subtotal`
  - `Order.java:36` - `Integer totalPrice`
  - `Cart.java:78-82` - `int getTotalPrice()`

---

## 2. 合計金額の計算方法

### 2-1. カート内の合計金額計算

**Given**: カートに複数の商品が入っている
**When**: カートの合計金額を計算する
**Then**:
- 計算式: `Σ(商品価格 × 数量)`
- 各商品について:
  - 小計 = 商品価格 × 数量
  - 合計 = すべての小計の合算

**実装箇所**:
- バックエンド: `Cart.java:78-82`

**実装コード**:
```java
public int getTotalPrice() {
    return items.stream()
        .mapToInt(item -> item.getProduct().getPrice() * item.getQuantity())
        .sum();
}
```

---

### 2-2. 商品ごとの小計計算

**Given**: カートアイテムまたは注文アイテム
**When**: 1商品の小計を計算する
**Then**:
- 計算式: `小計 = 単価 × 数量`
- 例:
  - 単価 8,980円 × 数量 2個 = 17,960円
  - 単価 3,980円 × 数量 1個 = 3,980円

**実装箇所**:
- バックエンド:
  - `Cart.java:80` - カート内での計算
  - `OrderService.java:66` - 注文作成時の計算
- フロントエンド:
  - `CartPage.tsx:182` - 表示時の計算
  - `OrderConfirmPage.tsx:106` - 注文確認時の計算

---

### 2-3. 複数商品の合計計算例

**Given**:
- 商品A: 8,980円 × 2個 = 17,960円
- 商品B: 3,980円 × 1個 = 3,980円
- 商品C: 24,800円 × 1個 = 24,800円

**When**: カートの合計金額を計算する
**Then**:
- 合計 = 17,960 + 3,980 + 24,800 = 46,740円

---

## 3. 税の扱い

### 3-1. すべて税込み価格

**Given**: 商品価格が設定される
**When**: 価格を表示・計算する
**Then**:
- すべての価格は税込み価格
- 税抜き価格、税額、税率の情報は存在しない
- 税込/税抜の区別なし
- 税計算のロジックは実装されていない

**実装箇所**:
- 税計算のコードは全ソースコード中に存在しない

**補足**:
- 日本の消費税（10%）を含む価格と想定される
- 仕様書（SPEC.md）にも税の記載なし

---

### 3-2. 税額の表示なし

**Given**: カート画面または注文確認画面
**When**: 金額の内訳を表示する
**Then**:
- 「税額」「税抜価格」の表示はない
- 表示される項目:
  - 小計（税込み）
  - 配送料: ¥0
  - 手数料: ¥0
  - 合計金額（税込み）

**実装箇所**:
- フロントエンド: `OrderConfirmPage.tsx:118-143`

---

## 4. 配送料・手数料

### 4-1. 配送料は常に¥0

**Given**: 注文を作成する
**When**: 配送料を計算する
**Then**:
- 配送料: ¥0（固定）
- 配送料の計算ロジックは存在しない
- 注文金額や配送先に関係なく常に無料

**実装箇所**:
- フロントエンド: `OrderConfirmPage.tsx:126-127`（表示のみ）
- バックエンド: 配送料の計算ロジックは存在しない

---

### 4-2. 手数料は常に¥0

**Given**: 注文を作成する
**When**: 手数料を計算する
**Then**:
- 手数料: ¥0（固定）
- 手数料の計算ロジックは存在しない
- 決済手数料などは考慮されない

**実装箇所**:
- フロントエンド: `OrderConfirmPage.tsx:129-131`（表示のみ）
- バックエンド: 手数料の計算ロジックは存在しない

---

### 4-3. 注文の最終合計金額

**Given**: 注文を作成する
**When**: 最終合計金額を計算する
**Then**:
- 計算式: `最終合計 = 商品合計 + 配送料 + 手数料`
- 実質: `最終合計 = 商品合計 + ¥0 + ¥0 = 商品合計`
- 配送料・手数料が常に¥0のため、商品合計がそのまま最終合計になる

**実装箇所**:
- バックエンド: `OrderService.java:58` (`order.setTotalPrice(cart.getTotalPrice())`)

---

## 5. 価格変更時の挙動

### 5-1. カート内の商品価格はリアルタイム反映

**Given**:
- カートに商品A（単価 8,980円）が2個入っている
- カートの小計: 17,960円

**When**:
- 管理画面で商品Aの価格を7,980円に変更する
- カート画面を表示する（またはAPIを呼び出す）

**Then**:
- カートの小計は自動的に更新される
- 新しい小計: 7,980円 × 2個 = 15,960円
- カート内の商品情報は、常に最新の商品マスタから取得される

**実装箇所**:
- バックエンド: `Cart.java:80`
  - `item.getProduct().getPrice()` で毎回最新価格を参照
- バックエンド: `CartItem` は Product への参照を持つのみ（価格をコピーしない）

**実装の詳細**:
```java
// カートの合計計算（毎回 Product から価格を取得）
public int getTotalPrice() {
    return items.stream()
        .mapToInt(item -> item.getProduct().getPrice() * item.getQuantity())
        .sum();
}
```

---

### 5-2. カート内の商品が削除された場合

**Given**:
- カートに商品A（単価 8,980円）が2個入っている
- 商品Aが商品マスタから削除される（または非公開になる）

**When**: カート画面を表示する
**Then**:
- **現在の実装**: カートには残り続ける
- **理由**: CartItem は Product への外部キー参照を持つため、Product が存在する限り参照できる
- **問題点**: 非公開商品がカートに残る問題（ギャップ分析レポート「3-8」で指摘済み）

**実装箇所**:
- バックエンド: `CartItem.java` の `@ManyToOne` 関係

---

### 5-3. 注文済み商品の価格は固定

**Given**:
- 注文を作成した（商品A: 8,980円 × 2個 = 17,960円）
- 注文作成後、商品Aの価格を7,980円に変更

**When**: 注文詳細を取得する
**Then**:
- 注文の小計は変更されない（17,960円のまま）
- 注文時点の価格が `OrderItem.subtotal` に保存されている
- 商品マスタの価格変更は注文に影響しない

**実装箇所**:
- バックエンド: `OrderService.java:66`
  - 注文作成時に小計を計算して保存: `orderItem.setSubtotal(price * quantity)`
- バックエンド: `OrderItem.java:34`
  - 小計は独立したフィールド（`Integer subtotal`）

**実装の詳細**:
```java
// 注文作成時に小計を保存
OrderItem orderItem = new OrderItem();
orderItem.setProduct(cartItem.getProduct());
orderItem.setQuantity(cartItem.getQuantity());
orderItem.setSubtotal(cartItem.getProduct().getPrice() * cartItem.getQuantity());
```

---

## 6. 小数点の扱い・端数処理

### 6-1. 小数点は存在しない

**Given**: すべての金額計算
**When**: 計算結果を取得する
**Then**:
- 小数点以下は存在しない
- すべて整数型（`Integer`）
- 円単位での計算のみ

**理由**:
- 日本円は補助通貨（銭）を使用しない
- 1円未満の金額を扱う必要がない

---

### 6-2. 端数処理は不要

**Given**: 価格を計算する
**When**: 計算結果を保存・表示する
**Then**:
- 端数処理（切り捨て、切り上げ、四捨五入）は不要
- すべての計算結果は整数
- 例: 8,980円 × 2個 = 17,960円（そのまま）

**実装箇所**:
- すべての金額計算コード

---

### 6-3. 割引・クーポンは未実装

**Given**: 現在の実装
**When**: 割引を適用しようとする
**Then**:
- 割引機能は実装されていない
- クーポン機能も実装されていない
- ポイント利用も実装されていない

**補足**:
- 将来的に割引機能を実装する場合、端数処理のルールを定義する必要がある
- 例: 10% OFF → 8,980円 × 0.9 = 8,082円（整数に丸める必要）

---

## 7. 価格の表示形式

### 7-1. 3桁区切りのカンマ表示

**Given**: 金額を画面に表示する
**When**: フロントエンドで金額をフォーマットする
**Then**:
- 3桁ごとにカンマ区切り
- 通貨記号「¥」を前置
- 例: `8980` → `¥8,980`

**実装箇所**:
- フロントエンド: `toLocaleString()` メソッドを使用
  - `CartPage.tsx:182`
  - `OrderConfirmPage.tsx:106, 122, 139`
  - `OrderCompletePage.tsx:99, 103, 117`

**実装例**:
```typescript
¥{item.product.price.toLocaleString()}
// 8980 → "8,980"
```

---

### 7-2. 通貨記号の表示

**Given**: 金額を表示する
**When**: UIに表示する
**Then**:
- 日本円の通貨記号「¥」を使用
- 金額の前に配置
- ドル記号（$）やユーロ（€）は使用しない

**実装箇所**:
- フロントエンド: すべての価格表示箇所

---

## 8. 価格の制約

### 8-1. 価格の最小値

**制約**: なし（0円以上を想定）
**説明**:
- データベースに `CHECK` 制約はない
- 負の価格は想定していない
- 実装上は負の価格も設定可能（バグの可能性）

**推奨**:
- バリデーションで最小値 0円 を設定すべき

---

### 8-2. 価格の最大値

**制約**: Integer型の最大値（2,147,483,647円）
**説明**:
- Javaの `Integer` 型の制限
- 実用上は十分な範囲

---

### 8-3. 価格が0円の商品

**Given**: 商品の価格が 0円
**When**: カートに追加する
**Then**:
- システム上は追加可能
- 小計は 0円 になる
- 在庫チェックは通常通り実行される

**ビジネスルール**:
- 0円商品（無料サンプルなど）の扱いは仕様未定義

---

## 9. オーバーフロー対策

### 9-1. 合計金額のオーバーフロー

**Given**:
- カートに高額商品が大量に入っている
- 例: 100万円 × 2,200個 = 22億円

**When**: 合計金額を計算する
**Then**:
- **現在の実装**: Integer のオーバーフロー発生の可能性
- **リスク**: 計算結果が負の数になる可能性
- **対策**: 未実装

**実装箇所**:
- バックエンド: `Cart.java:78-82` (`int` 型を使用)

**推奨対応**:
- `Long` 型への変更を検討
- または合計金額の上限チェック

---

### 9-2. 小計のオーバーフロー

**Given**: 単価 × 数量 の計算
**When**: 非常に高額な商品または大量の数量
**Then**:
- **現在の実装**: オーバーフロー対策なし
- **例**: 100万円 × 2,200個 = 22億円（Integer最大値を超える）

**推奨対応**:
- カート内の商品数量に上限を設定
- 1商品あたりの最大購入数量を制限（例: 99個まで）

---

## 10. 価格の更新タイミング

### 10-1. 商品マスタの価格更新

**Given**: 管理画面で商品価格を変更
**When**: 保存ボタンをクリックする
**Then**:
- データベースの `products.price` が即座に更新される
- 次回のカート取得時に新しい価格が反映される

**実装箇所**:
- バックエンド: `ItemController.java` (PUT `/api/item/:id`)
- フロントエンド: `AdminItemPage.tsx`

---

### 10-2. カート内の価格更新タイミング

**Given**: 商品価格が変更される
**When**: カート関連のAPIを呼び出す
**Then**:
- 呼び出し時点の最新価格で計算される
- カートの合計金額も自動的に更新される

**タイミング**:
- カート取得時（`GET /api/order/cart`）
- カート追加時（`POST /api/order/cart/items`）
- 数量変更時（`PUT /api/order/cart/items/:id`）
- 商品削除時（`DELETE /api/order/cart/items/:id`）

---

### 10-3. 注文作成時の価格確定

**Given**: カート内の商品価格
**When**: 注文を作成する（`POST /api/order`）
**Then**:
- 注文作成時点の価格で小計を計算
- 計算結果を `OrderItem.subtotal` に保存
- 以降、価格変更の影響を受けない

**実装箇所**:
- バックエンド: `OrderService.java:62-67`

---

## 11. 価格の一貫性

### 11-1. フロントエンドとバックエンドの価格計算

**Given**: 価格計算を行う
**When**: フロントエンドとバックエンドで計算する
**Then**:
- 同じ計算式を使用（単価 × 数量）
- 結果は一致する
- フロントエンドは表示用、バックエンドが正式な計算

**実装箇所**:
- バックエンド: `Cart.java:78-82`
- フロントエンド: `CartPage.tsx:182`, `OrderConfirmPage.tsx:106`

---

### 11-2. API レスポンスの価格情報

**Given**: カートまたは注文のAPIレスポンス
**When**: レスポンスを受け取る
**Then**:
- バックエンドで計算済みの金額が返される
- フロントエンドは受け取った金額を表示するのみ
- フロントエンド側での再計算は不要（ただし一部で行われている）

**実装箇所**:
- バックエンド: `CartDto.java:34` (`cart.getTotalPrice()`)
- フロントエンド: `CartContext.tsx:39` (`setTotalPrice(response.data.totalPrice)`)

---

## 12. 今後の拡張予定

以下の機能は現在未実装：

### 12-1. 消費税の明示
- 税込み/税抜き価格の区別
- 税額の計算と表示
- 軽減税率対応（8% / 10%）

### 12-2. 割引・クーポン機能
- 割引額の計算
- 割引率の適用
- クーポンコードの入力

### 12-3. ポイント機能
- ポイント付与
- ポイント利用
- ポイント相当額の控除

### 12-4. 配送料の動的計算
- 配送先による変動
- 注文金額による送料無料
- 複数配送先対応

### 12-5. 決済手数料
- 決済方法による手数料
- クレジットカード手数料
- 代引き手数料

---

## 13. 参考情報

### 関連仕様書
- `docs/SPEC.md`: 機能仕様書
- `docs/ui/api-spec.md`: API仕様書（データモデル: 518-571行目）
- `docs/spec-implementation-gaps.md`: ギャップ分析レポート（配送料・手数料: 2-1, 3-3）
- `docs/specs/inventory.md`: 在庫管理仕様書
- `docs/specs/order.md`: 注文管理仕様書

### 関連実装
- **フロントエンド**:
  - `frontend/src/contexts/CartContext.tsx`: カート合計管理
  - `frontend/src/pages/CartPage.tsx`: カート金額表示
  - `frontend/src/pages/OrderConfirmPage.tsx`: 注文金額表示

- **バックエンド**:
  - `backend/src/main/java/com/example/aiec/entity/Product.java`: 商品価格
  - `backend/src/main/java/com/example/aiec/entity/Cart.java`: カート合計計算
  - `backend/src/main/java/com/example/aiec/entity/OrderItem.java`: 注文小計
  - `backend/src/main/java/com/example/aiec/service/OrderService.java`: 注文金額計算

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|--------|
| 1.0 | 2026-02-10 | 初版作成 | Claude Sonnet 4.5 |
