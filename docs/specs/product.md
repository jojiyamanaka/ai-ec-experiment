# 商品ドメインの詳細仕様

**目的**: 商品マスタ、価格管理、公開制御の詳細仕様を定義する

**関連ドキュメント**: [データモデル](../data-model.md), [API仕様](../ui/api-spec.md), [在庫管理](./inventory.md)

---

## 1. 価格のデータ型

| フィールド | DB型 | アプリ型 | 説明 |
|-----------|------|---------|------|
| `products.price` | NUMERIC(10,2) | Integer | 商品価格（円、税込） |
| `order_items.product_price` | NUMERIC(10,2) | Integer | 注文時単価スナップショット |
| `order_items.subtotal` | NUMERIC(10,2) | Integer | 小計（単価×数量） |
| `orders.total_price` | NUMERIC(10,2) | Integer | 合計金額 |

DB上は小数2桁格納可能だが、実運用では整数値（円単位）を使用。

---

## 2. 合計金額の計算

- **小計** = 単価 × 数量
- **カート合計** = Σ（各商品の小計）
- **注文合計** = 商品合計 + 配送料(¥0) + 手数料(¥0) = 商品合計

---

## 3. 税・配送料・手数料・割引

| 項目 | 現状 |
|------|------|
| 税 | 全て税込価格。税抜価格・税額・税率の情報は存在しない |
| 配送料 | ¥0 固定。計算ロジックなし |
| 手数料 | ¥0 固定。計算ロジックなし |
| 割引・クーポン | 未実装 |
| ポイント | 未実装 |
| 端数処理 | 不要（全て整数計算、円単位） |

---

## 4. 価格変更時の挙動

| シナリオ | 動作 |
|---------|------|
| カート内商品の価格変更 | 次回API呼び出し時に新価格で計算（CartItemはProductへの参照のみ保持） |
| 注文済み商品の価格変更 | 影響なし（OrderItem.subtotal に注文時点の価格がスナップショット保存済み） |
| 商品マスタの価格更新 | DB即時更新、次回取得時に反映 |

---

## 5. 価格の表示形式

- 3桁ごとにカンマ区切り、通貨記号「¥」を前置
- 例: `8980` → `¥8,980`
- フロントエンド: `toLocaleString()` メソッド使用

---

## 6. 価格の制約

| 制約 | 値 |
|------|-----|
| 最小値 | 0円以上を想定（DB CHECK制約は `price >= 0`） |
| 最大値 | Integer型の最大値（2,147,483,647円） |
| 0円商品 | システム上は追加可能（ビジネスルール未定義） |

---

## 7. オーバーフロー対策

- **現状**: `Cart.java` で `int` 型使用。高額×大量でオーバーフローの可能性
- **実質的回避**: カート数量上限（9個）で回避済み
- **実質的回避済み**: カート数量上限（9個）により通常運用では問題なし

---

## 8. 未実装機能（Phase 2以降）

消費税の明示、割引・クーポン、ポイント、配送料の動的計算、決済手数料

---

## 実装クラス一覧

**バックエンド**: `Product.java`, `Cart.java`（getTotalPrice）, `OrderItem.java`, `OrderService.java`
**フロントエンド**: `CartPage.tsx`, `OrderConfirmPage.tsx`, `OrderCompletePage.tsx`（価格表示）, `CartContext.tsx`（カート合計管理）
