# 管理画面仕様書

管理画面（/bo/item）における商品操作の仕様を定義します。

## 概要

管理画面では以下の操作が可能です：
- 商品価格の変更
- 商品在庫数の変更
- 商品の公開/非公開切り替え

すべての変更は**即時反映**され、バッチ処理は存在しません。

---

## 1. 価格変更の影響範囲

### シナリオ 1-1: カート内商品の価格は動的に計算される

**Given:**
- 商品A（価格: 1000円）がカートに2個入っている
- カートの合計金額は 2000円

**When:**
- 管理者が商品Aの価格を 1500円 に変更

**Then:**
- カート内の商品Aの単価は即座に 1500円 に更新される
- カートの合計金額は 3000円 に更新される
- ユーザーがカート画面を再読み込みすると、新しい価格が表示される

**技術的背景:**
- `CartItem` は `Product` への参照を保持（外部キー）
- カート合計金額は `Product.price * CartItem.quantity` で動的計算
- 価格変更はカート内の商品に即座に反映される

### シナリオ 1-2: 注文確定後の価格変更は影響しない

**Given:**
- 商品A（価格: 1000円）を2個購入し、注文を確定
- 注文の小計は 2000円 で記録されている

**When:**
- 管理者が商品Aの価格を 1500円 に変更

**Then:**
- 既存の注文レコードの小計は 2000円 のまま変わらない
- 注文履歴画面には変更前の価格が表示される

**技術的背景:**
- 注文作成時に `OrderItem.subtotal` に価格が保存される
- 注文後の価格変更は過去の注文には影響しない

---

## 2. 在庫数変更の影響範囲

### シナリオ 2-1: カート内商品の在庫を減らした場合

**Given:**
- 商品B（在庫: 10個）がカートに5個入っている

**When:**
- 管理者が商品Bの在庫を 3個 に変更

**Then:**
- カート内の商品Bは5個のまま残る（削除されない）
- ユーザーがカート内の数量を変更しようとすると在庫不足エラー
- ユーザーが注文を確定しようとすると在庫不足エラー

**技術的背景:**
- カート内商品の数量は在庫変更時に自動調整されない
- 在庫チェックはカート数量変更時と注文作成時に実施
- 在庫不足時は `BusinessException("OUT_OF_STOCK")` をスロー

### シナリオ 2-2: カート内商品の在庫を0にした場合

**Given:**
- 商品C（在庫: 5個）がカートに2個入っている

**When:**
- 管理者が商品Cの在庫を 0個 に変更

**Then:**
- カート内の商品Cは2個のまま残る
- ユーザーが注文を確定しようとすると「在庫が不足している商品があります」エラー
- ユーザーはカートから商品Cを削除する必要がある

**技術的背景:**
- 注文作成時に全カートアイテムの在庫チェックを実施
- `product.getStock() < cartItem.getQuantity()` で判定

### シナリオ 2-3: 在庫増加は即座に購入可能になる

**Given:**
- 商品D（在庫: 0個）

**When:**
- 管理者が商品Dの在庫を 10個 に変更

**Then:**
- 商品一覧画面で商品Dのカート追加ボタンが有効化される
- ユーザーは即座に商品Dを購入可能

---

## 3. 公開/非公開の切り替え

### シナリオ 3-1: 公開中の商品を非公開にする

**Given:**
- 商品E（公開中）が商品一覧に表示されている

**When:**
- 管理者が商品Eを非公開に変更

**Then:**
- 商品一覧画面（GET /api/item）から商品Eが即座に消える
- 商品詳細画面（GET /api/item/:id）では引き続きアクセス可能
- 直接URLを知っているユーザーは商品詳細を閲覧可能

**技術的背景:**
- 商品一覧APIは `findByIsPublishedTrue()` で公開商品のみ取得
- 商品詳細APIは公開状態に関わらず取得可能

### シナリオ 3-2: カート内の商品を非公開にする

**Given:**
- 商品F（公開中）がユーザーのカートに3個入っている

**When:**
- 管理者が商品Fを非公開に変更

**Then:**
- カート内の商品Fは3個のまま残る（削除されない）
- ユーザーはカート画面で商品Fを確認可能
- ユーザーは商品Fを含めて注文を確定可能

**技術的背景:**
- カート内商品の削除処理は実装されていない
- 注文作成時に公開状態のチェックは行われない
- `CartItem` は `Product` への参照を保持しているため、非公開でも情報取得可能

### シナリオ 3-3: 非公開商品を公開に戻す

**Given:**
- 商品G（非公開）

**When:**
- 管理者が商品Gを公開に変更

**Then:**
- 商品一覧画面に商品Gが即座に表示される
- すべてのユーザーが商品Gをカートに追加可能になる

---

## 4. 変更の反映タイミング

### シナリオ 4-1: すべての変更は即時反映される

**Given:**
- 管理画面で商品の価格、在庫、公開状態を変更

**When:**
- 保存ボタンをクリック（PUT /api/item/:id）

**Then:**
- データベースに即座に保存される（トランザクション完了）
- 次のAPIリクエストで新しい値が返される
- バッチ処理や遅延反映は存在しない

**技術的背景:**
- `@Transactional` アノテーションによる即時コミット
- キャッシュ層は存在しない
- すべてのAPI呼び出しでDBから最新データを取得

### シナリオ 4-2: 複数商品の一括変更

**Given:**
- 管理画面で商品A、B、Cの価格を変更

**When:**
- 保存ボタンをクリック

**Then:**
- フロントエンドがすべての更新を並列実行（`Promise.all`）
- 各商品の更新は個別のトランザクションで実行
- 一部の更新が失敗しても、他の商品の更新は成功する可能性がある

**技術的背景:**
- フロントエンド: `Promise.all()` で並列リクエスト送信
- バックエンド: 各 `PUT /api/item/:id` は独立したトランザクション

---

## 5. エッジケースと制限事項

### 制限事項 5-1: 在庫の自動減少は実装されていない

**現状:**
- 注文が確定しても在庫数は減らない
- 複数のユーザーが同じ商品を同時購入可能

**影響:**
- 在庫管理は手動で行う必要がある
- オーバーセリング（過剰販売）のリスクがある

### 制限事項 5-2: 非公開商品の注文可否チェックがない

**現状:**
- カート内の非公開商品でも注文確定可能
- 注文作成時に公開状態のバリデーションが実装されていない

**影響:**
- 非公開にした商品がカートに残っている場合、購入されてしまう可能性がある

### 制限事項 5-3: 価格変更時の通知機能がない

**現状:**
- カート内商品の価格が変更されても、ユーザーに通知されない
- ユーザーは画面を再読み込みするまで気づかない

**影響:**
- ユーザーが想定より高い/低い価格で購入する可能性がある

---

## 参照実装

- **価格計算**: `Cart.java:78-82`
- **在庫チェック**: `CartService.java:54-56, 104-106`, `OrderService.java:48-52`
- **公開状態フィルタ**: `ProductService.java:34`
- **商品更新API**: `ProductService.java:62-80`
- **注文時の価格スナップショット**: `OrderService.java:66`
