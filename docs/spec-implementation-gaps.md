# 仕様と実装のギャップ一覧

作成日: 2026-02-10

## 概要

`docs/SPEC.md`、`docs/api-spec.md`、`docs/specs/*.md` の仕様書と現在の実装を比較し、**仕様通りに動いていない箇所**を優先度別に一覧化しました。

---

## 🔴 優先度: 高（セキュリティ・機能的影響大）

### H-1. 商品詳細取得時の公開状態チェックがない ✅ 実装完了

**仕様**: SPEC.md:179「非公開（isPublished = false）の商品は表示しない」
**実装**: `ProductService.java:52-57` - 商品詳細API (`GET /api/item/:id`) では公開状態をチェックしていない
**問題**: 非公開商品もIDが分かれば誰でも取得できる（セキュリティ問題）
**影響**: 公開前の商品情報が漏洩する可能性
**対応**: 商品詳細取得時に `isPublished` チェックを追加するか、仕様を変更

---

### H-2. 在庫引き当て処理が未実装 ✅ 実装完了

**仕様**: SPEC.md:406-408「今後の実装予定: 注文時の在庫引き当て」
**実装**: 注文作成時に在庫チェックは行うが、在庫数（stock）を減らす処理がない
**問題**:
- 在庫数を超える注文が理論上可能（複数ユーザーが同時注文した場合）
- 在庫管理が正確に機能しない
- オーバーセリング（過剰販売）のリスク

**影響**: 実運用では致命的な問題

**対応方針（確定）**:

仮引当・本引当の2段階方式で在庫引当を実装する。詳細仕様は `inventory.md` セクション4〜13に定義済み。

1. **テーブル追加**: `stock_reservations`（引当管理テーブル）
2. **仮引当（TENTATIVE）**: カート追加時に有効在庫を確保。30分で自動失効（遅延評価 + 定期クリーンアップ方式）
3. **本引当（COMMITTED）**: 注文確定時に仮引当を変換し、`products.stock` を実際に減少
4. **本引当解除**: 注文キャンセル時に `products.stock` を戻す
5. **排他制御**: SQLite の SERIALIZABLE 分離レベル（DB レベルロック）を利用
6. **API**: 5本追加（仮引当CRUD、本引当commit/release、有効在庫確認）
7. **既存API統合**: カート追加・数量変更・削除・注文確定の各APIが内部的に引当APIを呼び出す

**参照**:
- `inventory.md` セクション4〜13（在庫引当の詳細仕様）
- `gap-analysis.md:133-136`

---

### H-3. 注文状態遷移機能 ✅ 実装完了

**仕様**: SPEC.md:284-338「注文の状態遷移」（PENDING → CONFIRMED → SHIPPED → DELIVERED）
**実装**: ✅ 完全実装済み
  - 注文キャンセルAPI（POST /api/order/:id/cancel）
  - 注文確認API（POST /api/order/:id/confirm）
  - 注文発送API（POST /api/order/:id/ship）
  - 注文配達完了API（POST /api/order/:id/deliver）
  - 全注文取得API（GET /api/order）
  - 注文詳細画面（/order/:id）
  - 管理画面 - 注文管理（/bo/order）

**参照**:
- `docs/specs/order.md:294-354`（状態遷移の詳細説明）
- `docs/api-spec.md`（APIエンドポイント仕様）

---

## 🟡 優先度: 中（UX・データ整合性）

### M-1. 配送料・手数料が常に¥0（仕様が曖昧） ✅ 仕様明記済み

**仕様**: SPEC.md:104-105「配送料、手数料」の表示が記載されている
**実装**: 配送料・手数料は常に¥0固定。計算ロジックが存在しない
**対応完了**: 仕様書に「Phase 1 では配送料・手数料ともに¥0固定」と明記済み（requirements.md、SPEC.md）

**参照**:
- `requirements.md:233-237`（価格・料金のルール）
- `SPEC.md:412`（制約事項）

---

### M-2. 在庫不足時の詳細エラーレスポンスが未実装 → 要件化済み（CHG-001）

**仕様**: api-spec.md:437-453「OUT_OF_STOCK エラー時に `details` 配列で商品ごとの在庫状況を返す」
**実装**: 単純なエラーメッセージのみ返す（どの商品が不足しているか不明）
**ステータス**: ✅ 要件化済み → `docs/01_requirements/CHG-001_在庫不足詳細エラー.md`

**参照**:
- 要件定義: `docs/01_requirements/CHG-001_在庫不足詳細エラー.md`
- 設計: `docs/02_designs/CHG-001_在庫不足詳細エラー.md`
- `inventory.md:322-326`
- `gap-analysis.md:143-146, 232-235`

---

### M-3. 非公開商品がカートに残る問題 ✅ 実装完了

**仕様**: SPEC.md:179「非公開の商品は表示しない」
**実装**: カートに入れた後、商品が非公開になってもカート内に残り続ける
**ステータス**: ✅ 実装完了

**参照**:
- 要件定義: `docs/01_requirements/CHG-002_非公開商品カート整合性.md`
- `admin.md:275-306`（シナリオ 3-2）
- `gap-analysis.md:197-201`

---

### M-4. 注文キャンセル機能 ✅ 実装完了

**仕様**: SPEC.md:329-332「PENDING/CONFIRMED → CANCELLED への遷移」
**実装**: ✅ 完全実装済み（H-3 の一部として実装）
  - 顧客向け注文キャンセル（POST /api/order/:id/cancel）
  - 管理者向け注文キャンセル（管理画面から実行可能）
  - 在庫戻し処理（本引当解除）
  - キャンセル不可チェック（SHIPPED/DELIVERED は拒否）

**参照**:
- `inventory.md:222-239`
- `order.md:340-353`
- `docs/api-spec.md`

---

### M-5. カート内商品の数量上限が不明 ✅ 実装完了

**仕様**: SPEC.md:86-89「数量変更機能」の記載のみ
**実装**:
- バックエンド: DTOバリデーション（`@Max(9)`）とサービス層チェックで1商品あたり9個に制限
- フロントエンド: 入力欄に `max="9"` を設定し、更新処理で9個にクランプ

**問題**:
- 1商品あたりの最大購入数量を9個に統一
- 上限超過時は `INVALID_QUANTITY` エラーで明示的に拒否

**影響**: データ整合性のリスク
**対応完了**:
- カート内商品数量を「9個」に制限
- フロントエンドで入力制限を実装（`max="9"` + クランプ）

**参照**:
- `inventory.md:282-286`
- `pricing.md:422-433`
- `gap-analysis.md:155-159`

---

### M-6. エラーコード一覧が不完全 ✅ 実装完了

**仕様**: api-spec.md:783「エラーコード一覧」
**実装**: ✅ 完全実装済み
  - バックエンドエラー（14種類）: ITEM_NOT_FOUND, CART_NOT_FOUND, ORDER_NOT_FOUND, RESERVATION_NOT_FOUND, OUT_OF_STOCK, INSUFFICIENT_STOCK, CART_EMPTY, ORDER_NOT_CANCELLABLE, ALREADY_CANCELLED, INVALID_STATUS_TRANSITION, INVALID_QUANTITY, INVALID_REQUEST, NO_RESERVATIONS, INTERNAL_ERROR
  - フロントエンドエラー（1種類）: NETWORK_ERROR
  - HTTPステータスコードとの対応を明記

**対応完了**: 実際に使用されているすべてのエラーコードをapi-spec.mdに追加し、HTTPステータスコードとの対応を整理

**参照**: `gap-analysis.md:249-254`

---

## 🟢 優先度: 低（実装詳細・将来の拡張）

### L-1. 商品一覧のページネーション機能（フロントエンド未実装）

**仕様**: api-spec.md:42-46「ページングパラメータ（page, limit）」
**実装**:
- バックエンド: ページングをサポート
- フロントエンド: 全件取得のみ（ページング機能なし）

**問題**: 商品数が多い場合にパフォーマンス問題が発生する可能性
**影響**: 現状は商品数が少ないため問題ないが、将来的に必要
**対応**: Phase 2以降で実装

**参照**: `gap-analysis.md:138-141`

---

### L-2. おすすめ商品の選定ロジックが単純 ✅ 仕様明記済み

**仕様**: SPEC.md:17-30「AIがおすすめする商品」
**実装**: 単に最初の3件を表示しているだけ
**対応完了**: 仕様書に「Phase 1: 最初の3件を表示（暫定実装）、Phase 2以降: AIレコメンデーション実装予定」と明記済み

**参照**: `customer-ui.md:61-62`（おすすめ商品の選定ロジック）

---

### L-3. セッションIDの有効期限が不明 ✅ 仕様明記済み

**仕様**: api-spec.md:172-174「X-Session-Id ヘッダー」
**実装**: localStorage に永続保存、有効期限なし
**対応完了**: 仕様書に「Phase 1: 有効期限なし（永続保存）、Phase 2以降: セッション有効期限を実装予定」と明記済み

**参照**:
- `requirements.md:264-265`（セッション管理 > 有効期限）
- `SPEC.md:324-325`（セッション管理 > 制約）

---

### L-4. 注文番号の上限（999件/日）が不明 ✅ 仕様明記済み

**仕様**: SPEC.md:224「ORD-YYYYMMDD-XXX 形式」
**実装**: 1000件目以降も生成されるが、フォーマットが崩れる（4桁になる）
**対応完了**: 仕様書に「上限999件/日、超過時は4桁以上になるがPhase 1では対策不要」と明記済み

**参照**:
- `specs/order.md:113`（注文番号の形式）
- `requirements.md:86`（注文機能 > 連番）

---

### L-5. 商品画像がプレースホルダーのみ ✅ 仕様明記済み

**仕様**: SPEC.md:349「image: string // 商品画像URL」
**実装**: プレースホルダーサービス（placehold.co）を使用
**対応完了**: 仕様書に「プレースホルダー画像を使用（placehold.co）、画像アップロード機能なし」と明記済み

**参照**:
- `requirements.md:337-338`（商品画像の制限）
- `SPEC.md:413`（制約事項）

---

### L-6. 管理画面のアクセス制限なし

**仕様**: SPEC.md:143-162「管理画面」
**実装**: 誰でもアクセス可能（URLを知っていれば）
**問題**: 認証・認可機能がない
**影響**: プロトタイプ段階では許容範囲
**対応**: SPEC.md の制約事項に既に記載あり（「現在は認証・認可なし。Phase 2で実装予定」）

**参照**: `gap-analysis.md:209-213`

---

### L-7. 価格計算のオーバーフロー対策なし

**仕様**: なし
**実装**: `Cart.java:78-82` で `int` 型を使用
**問題**:
- 高額商品 × 大量数量でオーバーフロー発生の可能性
- 例: 100万円 × 2,200個 = 22億円（Integer最大値超過）

**影響**: 通常運用では問題ないが、極端なケースで不具合の可能性
**対応**:
- カート内の商品数量に上限を設定（例: 99個まで）
- または `Long` 型への変更を検討

**参照**: `pricing.md:399-433`

---

## サマリー

| 優先度 | 件数 | 主な分類 |
|--------|------|---------|
| 🔴 高 | 0件 | セキュリティ・機能的影響大（**3件完了** ✅） |
| 🟡 中 | 0件 | UX・データ整合性（**6件完了** ✅） |
| 🟢 低 | 3件 | 実装詳細・将来の拡張（**4件完了** ✅） |
| **合計** | **3件残**（**13件完了** ✅） | |

---

## 推奨対応アクション

### ✅ 完了済み（Phase 1で対応完了）

1. ~~**H-1**: 商品詳細取得時の公開状態チェックを追加（セキュリティ修正）~~ ✅ 完了
2. ~~**H-2**: 在庫引き当て処理の実装（仮引当・本引当の2段階方式）~~ ✅ 完了
3. ~~**H-3**: 注文状態遷移機能の実装（PENDING → CONFIRMED → SHIPPED → DELIVERED）~~ ✅ 完了
4. ~~**M-4**: 注文キャンセル機能の実装（在庫戻し含む）~~ ✅ 完了
5. ~~**M-6**: エラーコード一覧をapi-spec.mdに追記（ドキュメント修正）~~ ✅ 完了

### ✅ 短期対応（Phase 1内で対応完了）

1. ~~仕様書への明記（曖昧な仕様の明確化）~~ ✅ 全件完了:
   - ~~**M-1**: 配送料・手数料は¥0固定~~ ✅
   - ~~**L-2**: おすすめ商品は暫定的に先頭3件~~ ✅
   - ~~**L-3**: セッションIDは有効期限なし~~ ✅
   - ~~**L-4**: 注文番号の1日上限は999件~~ ✅
   - ~~**L-5**: 商品画像はプレースホルダー使用~~ ✅
2. ~~**M-2**: 在庫不足時の詳細エラーレスポンス実装~~ ✅ 完了
3. ~~**M-3**: 非公開商品のカート自動削除機能~~ ✅ 完了

### 残対応（Phase 2以降で検討）

1. **L-1**: フロントエンドのページネーション機能
2. **L-6**: 認証・認可機能（管理画面のアクセス制限）
3. **L-7**: 価格計算のオーバーフロー対策

---

## 関連資料

- **仕様書**:
  - `docs/SPEC.md` - 機能仕様書
  - `docs/ui/api-spec.md` - API仕様書
  - `docs/specs/inventory.md` - 在庫管理仕様書
  - `docs/specs/order.md` - 注文管理仕様書
  - `docs/specs/product.md` - 商品ドメイン仕様書
  - `docs/ui/admin-ui.md` - 管理画面UI仕様書

- **分析レポート**:
  - `docs/gap-analysis.md` - ギャップ分析レポート（元データ）
