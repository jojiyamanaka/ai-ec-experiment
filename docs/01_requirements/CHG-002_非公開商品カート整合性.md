# REQ-002: 非公開商品のカート整合性

作成日: 2026-02-12
ステータス: 起票済み
優先度: 中（M-3）
起源: `docs/spec-implementation-gaps.md` M-3

---

## 1. 背景

現在の実装では、カートに商品を追加した後にその商品が非公開になっても、カート内に残り続ける。また、カート追加時・注文確定時にも商品の公開状態チェックが行われていない。

これにより以下の問題が発生する:

- 非公開商品をカートに入れたまま注文確定できてしまう
- 管理者が商品を非公開にしても、既存カートに残った商品が購入される可能性がある
- 顧客が購入不可能な商品をカート内で見続けることになり、UXが悪化する

**参照**:
- `docs/spec-implementation-gaps.md` M-3
- `docs/gap-analysis.md:197-201`（3-8. 非公開商品を持つカートの扱い）
- `docs/ui/admin-ui.md`（シナリオ 3-2）

---

## 2. 要件

### 2-1. 非公開商品はカートに追加できない

非公開状態の商品をカートに追加しようとした場合、エラーとして拒否する。

### 2-2. 非公開商品を含むカートでは注文確定できない

カート内に非公開商品が含まれている場合、注文確定を拒否する。どの商品が非公開であるかをユーザーに通知する。

### 2-3. カート表示時に非公開商品を自動除外する

カート内容を表示する際、非公開になった商品を自動的に除外する。除外に伴い、該当商品の在庫引当（仮引当）も解放する。

### 2-4. ユーザーへの適切なエラー通知

非公開商品に関連するエラーが発生した場合、ユーザーにわかりやすいメッセージを表示する。注文確定時は、どの商品が購入できないかの一覧を提示し、カートの見直しを促す。

---

## 3. 受け入れ条件

- [ ] 非公開商品をカートに追加しようとするとエラーになる
- [ ] カート内に非公開商品がある状態で注文確定すると、非公開商品の一覧付きエラーが返される
- [ ] カート取得時に非公開商品が自動的に除外される
- [ ] 除外時に対応する仮引当が解放される
- [ ] フロントエンドでエラーメッセージが適切に表示される
- [ ] 既存の公開商品に対するカート操作・注文フローに影響がないこと

---

## 4. 仕様への反映

本要件の実装にあたり、以下の仕様ドキュメントに追記が必要:

- `docs/specs/inventory.md` — 非公開商品の仮引当解放に関するシナリオ追加
- `docs/ui/api-spec.md` — エラーコードの追加
- `docs/SPEC.md` — 非公開商品のカート内での扱いを明記

---

## 5. 関連資料

- `docs/spec-implementation-gaps.md` M-3
- `docs/gap-analysis.md:197-201`
- `docs/ui/admin-ui.md`（シナリオ 3-2）
