# 返品機能 要件定義（Requirements）

## 1. 目的
購入済み商品の返品をユーザーが申請し、運用者が承認・処理できる仕組みを提供する。  
返品は shipment_type = Return のShipmentとして管理し、返品状態を一元管理する。

---

## 2. 用語定義

| 用語 | 説明 |
|-----|-----|
| 返品申請 | ユーザーが購入履歴から返品を開始すること |
| 返品Shipment | shipment_type = Return のShipmentレコード |
| 返品ステータス | 返品Shipmentの処理状態 |
| 返品確定 | システム上返品が正式に成立した状態 |
| 返品キャンセル | 返品が拒否または無効になった状態 |

---

## 3. 対象ユーザー

### 3.1 エンドユーザー
- 購入履歴から返品申請できる
- 自身の返品状態を確認できる

### 3.2 管理者（運用者）
- 返品申請の確認
- 承認 / 拒否
- 返送到着確認

---

## 4. 機能要件

## 4.1 返品申請（ユーザー）

ユーザーは以下条件を満たす注文商品に対して返品申請できる

条件：

- 注文ステータス = 配送完了
- 購入からN日以内（例：30日）
- 返品不可商品でない

操作：

- 購入履歴から返品操作を実行する

結果：

- shipment_type = Return のShipmentが生成される

初期ステータス：

返品待ち

意味：

ユーザーが返品申請を行い、管理者確認待ち状態

---

## 4.2 返品一覧表示（ユーザー）

ユーザーは購入履歴および返品状態を確認できる

表示対象：

- shipment_type = Normal
- shipment_type = Return

表示項目例：

- 注文ID
- 商品
- shipment_type
- 返品ステータス

---

## 4.3 返品管理（管理者）

管理者は返品Shipmentを確認し、以下操作を行える

### 承認

条件：

返品可能と判断した場合

結果：

ステータス：

返品承認済

意味：

返品受付済、ユーザーからの返送待ち

---

### 拒否

条件：

返品不可と判断した場合

入力：

拒否理由（必須）

結果：

ステータス：

返品キャンセル

意味：

返品は成立しない

---

## 4.4 返送到着確認（管理者）

管理者は返品商品到着後、状態を更新できる

結果：

ステータス：

返品確定

意味：

返品処理完了  
（在庫戻し・返金などの後続処理対象）

---

## 5. ステータス定義

| ステータス | actor | 説明 |
|---|---|---|
| 返品待ち | user | ユーザー申請済、管理者確認待ち |
| 返品承認済 | admin | 管理者が承認、返送待ち |
| 返品確定 | admin | 商品到着確認、返品完了 |
| 返品キャンセル | admin | 管理者が拒否 |

---

## 6. ステータス遷移

正常系：

返品待ち  
↓  
返品承認済  
↓  
返品確定  

異常系：

返品待ち  
↓  
返品キャンセル  

---

## 7. 非機能要件

### 7.1 整合性

返品数量 ≤ 購入数量

返品合計数量 ≤ 購入数量

同一Shipmentの重複返品不可

---

### 7.2 操作履歴（監査ログ）

以下操作を保存：

- 返品申請
- 承認
- 拒否
- 返品確定

---

### 7.3 権限制御

ユーザー：

自分の返品のみ参照可能

管理者：

全返品参照・操作可能

---


## 8. 除外範囲（今回対象外）

- 自動返金
- 返品送料計算
- 交換機能