# CHG-018_業務ジョブ基盤（JobRunr）導入 要件定義

作成日: 2026-02-18
---
## 1. 背景
従来の cron ベース運用では、実行履歴管理・失敗時リトライ・手動再実行が標準化されておらず、運用負荷が高い。

また、業務処理と外部連携処理が密結合していることで、障害時の影響範囲が拡大しやすい。

将来的な外部連携（WMS等）拡張や環境増加を見据え、業務ジョブを統一基盤で管理できる構成が必要となった。

---

## 2. 要件

### 2.1 ジョブ基盤導入
- Core（Spring）に JobRunr を導入すること
- core-web（API）と core-worker（ジョブ実行）を分離可能とすること
- 同一バイナリを全環境へ配布可能であること
- 環境設定によりジョブ有効／無効を制御可能であること
- 将来の外部連携拡張に耐えうるジョブ基盤であること

---

### 2.2 共通非機能要件

#### 排他制御
- 同一 JobType は同一環境内で多重起動しないこと

#### 冪等性
- 再実行・リトライ時にデータが破壊されないこと
- 状態遷移は条件付きで制御されること

#### リトライ
- 自動リトライ可能であること
- 回数・間隔を設定可能であること
- 上限到達時は FAILED として記録されること
- 手動再実行可能であること

#### 実行履歴管理
以下を記録すること:
- runId
- jobType
- env
- startedAt / finishedAt
- status（SUCCESS / FAILED / SKIPPED）
- 処理件数
- エラー内容

#### 環境別制御
- enabledJobs により環境ごとに実行可否を制御できること
- 無効ジョブは SKIPPED として履歴に残すこと

---

### 2.3 モデルジョブ① 仮引当解除（release-reservations）

#### 目的
期限切れ仮引当を解除し、在庫整合を回復する。

#### 要件
- 定期実行可能であること
- 期限切れデータのみを対象とすること
- ACTIVE → EXPIRED のみ遷移可能であること
- 再実行しても二重解除が発生しないこと
- 処理件数を履歴に記録すること

---

### 2.4 モデルジョブ② 出荷指示ファイル連携（直列フロー）

a → b → c の段階実行とする。

#### a) 出荷指示処理（shipment-instruction）

- 出荷対象を確定すること
- READY_FOR_SHIP → INSTRUCTED に状態遷移すること
- 冪等であること
- 処理件数を記録すること

---

#### b) 出荷指示ファイル作成（export-shipment-file）

- 出荷指示済みデータを取得しCSV出力できること
- 不完全ファイルが外部公開されないこと
- バックアップ保持可能であること
- ファイル名規約を設定可能であること
- 文字コード（UTF-8 / SJIS）設定可能であること
- 改行コード設定可能であること

---

#### c) SFTP配置（sftp-put）

- 生成ファイルを外部へ送信できること
- 転送戦略を設定で切替可能であること
- 成功／失敗を履歴管理できること
- 同一ファイルの二重送信を防止できること

---

## 3. 受け入れ条件

- core-web と core-worker が分離起動可能であること
- 仮引当解除ジョブが安定稼働すること
- 出荷指示連携（a→b→c）が直列実行可能であること
- 失敗時に再実行可能であること
- 実行履歴が確認可能であること
- 環境差分が設定で吸収可能であること

---

## 4. 仕様への反映

- 業務ジョブは JobRunr に統一する
- ジョブ単位で責務を分離する
- 冪等設計を前提とする
- 外部連携は業務処理と分離する
- 設定駆動で環境差分を吸収する

---

## 5. 関連資料

- CHG-017 非同期処理 要件定義
- CHG-018 出荷指示非同期ジョブ構成
- 外部連携仕様書
