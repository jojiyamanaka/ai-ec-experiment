# CHG-010: BFF構成への移行

## 背景・課題

### 前提

- CHG-008（ドメイン分離とBoUser管理）は完了済み
- CHG-009（PostgreSQL移行）は完了済み
- 顧客向け機能と管理向け機能は現行仕様どおり稼働中

### 現状の問題点

現在の構成では、フロントエンドが単一バックエンド API に直接接続しており、以下の課題があります：

1. **画面要件と API 契約の結合が強い**
   - 画面ごとの最適化（レスポンス集約、不要項目削減）をバックエンド本体で吸収する必要がある
   - 顧客画面と管理画面で異なる要件が同一 API 層に集中し、変更影響が広がりやすい

2. **フロントエンド向け関心事の責務分離不足**
   - 画面固有のデータ整形、複数 API の合成、UI 都合のエラー変換がフロントエンド側に分散する
   - クライアント実装に重複が生じ、保守コストが増加する

3. **セキュリティ境界が不十分**
   - バックエンド API が直接公開されるため、内部向けエンドポイントの露出リスクが高い
   - 顧客向け・管理向けのアクセス経路をネットワーク境界で明確化しづらい

4. **将来拡張時のデプロイ柔軟性不足**
   - 顧客画面の改修と管理画面の改修を独立してリリースしにくい
   - UI 要件変化への追従時にバックエンド本体の改修が増えやすい

### なぜ必要か

- **責務分離**: コア業務 API とフロント最適化層を分離し、変更影響を局所化する
- **開発効率向上**: 画面単位で API 契約を管理し、フロント・バック双方の実装負荷を下げる
- **セキュリティ強化**: コア API の直接公開をやめ、BFF 経由に限定する
- **運用性向上**: 顧客向けと管理向けで独立したスケール・デプロイを可能にする

---

## ビジネス要件

### 1. BFF レイヤーの導入

#### 1.1 顧客向け BFF（Customer BFF）
- 顧客画面専用の公開 API を提供する
- 商品、カート、注文、会員情報の画面要件に合わせてレスポンスを最適化する
- 顧客認証（User トークン）を取り扱う

#### 1.2 管理向け BFF（BackOffice BFF）
- 管理画面専用の公開 API を提供する
- 在庫管理、注文管理、会員管理、BoUser 管理の画面要件に合わせてレスポンスを最適化する
- 管理者認証（BoUser トークン）を取り扱う

#### 1.3 コア API の内部化
- 既存 Spring Boot API はコア API として位置づけ、原則インターネット公開しない
- ブラウザからの直接アクセスは不可とし、BFF 経由のみ許可する

### 2. API 契約と互換方針

#### 2.1 外部契約
- BFF の外部 API は `ApiResponse<T>` 形式を維持する
- エラーコード・メッセージは既存仕様との整合性を保つ

#### 2.2 画面最適化
- BFF は複数コア API の集約、UI 必要項目への整形を担う
- フロントエンドは原則 1 画面 1～数回の API 呼び出しで完結できる契約を提供する

#### 2.3 移行期の互換
- 段階移行中は既存 API 契約との互換期間を設ける
- 切替期限と廃止期限を明示し、期限後は直接公開 API を廃止する

### 3. 認証・認可・アクセス制御

#### 3.1 トークン境界
- 顧客トークン（User）と管理トークン（BoUser）は BFF レイヤーでも厳密に分離する
- 顧客トークンで管理向け BFF へアクセスした場合は必ず 401/403 を返す
- 管理トークンで顧客向け BFF へアクセスした場合の挙動を明文化する

#### 3.2 ネットワーク境界
- 公開エンドポイントは BFF のみ
- コア API は BFF からの通信元のみ許可する

#### 3.3 監査
- 認証失敗、認可失敗、管理操作の監査ログを継続して記録する
- BFF とコア API 間でトレース ID を伝播し、追跡可能にする

### 4. データとトランザクション

#### 4.1 データベース
- データベースは CHG-009 の PostgreSQL 構成を継続利用する
- BFF は原則 DB に直接アクセスせず、コア API 経由で業務処理を行う

#### 4.2 業務整合性
- 在庫引当・注文確定など整合性が重要な処理は、引き続きコア API 側でトランザクション管理する
- BFF はオーケストレーション層として振る舞い、業務ルールを二重実装しない

### 5. 運用・デプロイ

#### 5.1 独立デプロイ
- Customer BFF / BackOffice BFF / Core API を独立してデプロイ可能にする
- サービス単位でスケール設定を分離できること

#### 5.2 設定管理
- 上流 API URL、タイムアウト、リトライ、サーキットブレーカー等は環境変数で切り替え可能にする
- 開発・検証・本番の環境差分をドキュメント化する

---

## 受け入れ条件

### 必須要件

1. **経路分離**
   - [ ] 顧客画面は Customer BFF 経由、管理画面は BackOffice BFF 経由で API を利用すること
   - [ ] ブラウザからコア API への直接アクセスが遮断されること

2. **機能互換**
   - [ ] 顧客向け主要フロー（商品閲覧、カート、注文、注文履歴）が移行前と同等に動作すること
   - [ ] 管理向け主要フロー（在庫管理、注文管理、会員管理、BoUser 認証）が移行前と同等に動作すること

3. **認証・認可**
   - [ ] 顧客トークンで管理向け BFF API にアクセスした場合は必ず 401/403 となること
   - [ ] 管理トークンで顧客向け BFF API にアクセスした場合の仕様どおりの結果となること
   - [ ] 認証なしアクセス時の 401 応答が一貫していること

4. **障害耐性**
   - [ ] コア API 遅延・障害時に BFF がタイムアウトとエラーハンドリングを行い、制御されたエラーを返すこと
   - [ ] 失敗時も監査・トレース情報が残ること

5. **可観測性**
   - [ ] BFF とコア API 間でトレース ID が連携されること
   - [ ] リクエスト数、エラー率、レイテンシのメトリクスを取得できること

6. **段階移行**
   - [ ] 既存クライアントの移行期間と廃止期限が定義されること
   - [ ] ロールバック手順（BFF 経由から旧経路へ戻す手順）が定義されること

### テスト項目

1. **E2E 回帰テスト**
   - [ ] 顧客画面の主要購買フローを BFF 経由で実施し、回帰がないこと
   - [ ] 管理画面の主要業務フローを BFF 経由で実施し、回帰がないこと

2. **誤アクセス防止テスト**
   - [ ] 顧客トークンで管理向け BFF API へアクセスし 401/403 になること
   - [ ] 管理トークンで顧客向け BFF API へアクセスし仕様どおりの結果になること
   - [ ] コア API 直アクセスが拒否されること

3. **障害系テスト**
   - [ ] コア API のタイムアウトを擬似的に発生させ、BFF が規定どおりエラー変換すること
   - [ ] コア API の 4xx/5xx 応答を BFF が契約どおり返すこと

4. **性能テスト**
   - [ ] 主要画面の API 呼び出し回数が移行前より増加しないこと
   - [ ] 同時注文シナリオで在庫整合性が維持されること（整合性責務はコア API）

5. **運用テスト**
   - [ ] デプロイ手順、ヘルスチェック、ロールバック手順を検証環境で 1 回以上実施すること

### 任意要件（将来対応）

- [ ] BFF のレスポンスキャッシュ（商品一覧など読み取り中心 API）
- [ ] API Gateway 導入による認証・レート制限の共通化
- [ ] BFF ごとの A/B テストや機能フラグ運用
- [ ] GraphQL などクエリ最適化層の追加検討

---

## 影響範囲

### フロントエンド
- API 呼び出し先を BFF エンドポイントへ切り替え
- 顧客画面と管理画面で BFF ベース URL 設定を分離
- 既存 UI/UX・文言・導線は原則維持（BFF 化は経路変更が主目的）

### BFF（新規）
- Customer BFF / BackOffice BFF の実装追加
- 認証伝播、レスポンス整形、エラーマッピング、トレース伝播の実装

### コア API（既存バックエンド）
- 公開範囲を内部向けに変更
- BFF 連携向けの内部 API 契約整理（必要最小限）
- 業務ロジック・DB トランザクション責務は維持

### データベース
- PostgreSQL（CHG-009）を継続利用
- 原則として BFF 導入による新規永続化は必須としない

### インフラ・運用
- ルーティング（顧客/管理ドメイン）とネットワーク ACL の更新
- BFF の監視、ログ集約、アラート設定追加
- Runbook（障害対応、切戻し）の更新

### ドキュメント
- 技術仕様書、API 仕様書、運用手順書、テスト手順書の更新

---

## 非機能要件

### セキュリティ
- コア API は非公開ネットワークに配置し、BFF 経由のみ接続可能にする
- 認証トークンは CHG-008 の分離方針（User / BoUser）を維持する
- 機微情報はログに平文出力しない

### 性能
- 主要画面の体感性能を移行前同等以上に維持する
- BFF 追加による遅延増加は許容範囲（例: p95 の増加を限定）に収める

### 可用性
- BFF 障害時の影響範囲をサービス単位で限定できること
- ヘルスチェックと自動復旧を前提とした運用が可能であること

### 保守性
- BFF ごとに責務が明確で、画面要件変更を局所修正で対応できること
- コア API と BFF の契約変更管理（バージョニング/互換期間）を定義すること

---

## 備考

### 段階的な移行戦略

#### Phase 1: Customer BFF 導入
1. 顧客向け主要 API を BFF 経由へ切替
2. 顧客画面 E2E 回帰を完了
3. 問題時の切戻し手順を確認

#### Phase 2: BackOffice BFF 導入
1. 管理向け主要 API を BFF 経由へ切替
2. BoUser 認証・認可の誤アクセス防止テストを完了
3. 監査ログ・トレース連携を確認

#### Phase 3: コア API 直接公開の廃止
1. 旧公開経路の段階廃止
2. 廃止後の監視強化と運用安定化

### 注意事項

- 本 CHG の主目的は「アーキテクチャ変更（BFF 導入）」であり、業務ルール追加は対象外とする
- 既存の API レスポンス形式（`ApiResponse<T>`）は維持を原則とする
- CHG-008 / CHG-009 の確定仕様（認証分離・PostgreSQL）を前提条件として扱う
