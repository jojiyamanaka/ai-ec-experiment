# CHG-003: カート内商品の数量上限の明確化

作成日: 2026-02-12
ステータス: 起票済み
優先度: 中（M-5）
起源: `docs/spec-implementation-gaps.md` M-5

---

## 1. 背景

現在の実装では、カート内の1商品あたりの最大購入数量が仕様上定義されていない。バックエンドでは在庫数までという暗黙のルールがあるが、フロントエンドの数量入力欄には `max` 属性が設定されておらず、任意の数量を入力できてしまう。

これにより以下の問題が発生する:

- 在庫数を超える数量を入力した場合のバリデーションがフロントエンドにない
- `int` 型での価格計算（小計・合計）において、大量数量入力時にオーバーフローが発生する可能性がある（L-7 と関連）
- 1商品あたりの購入数量に関するビジネスルールが不明確

**参照**:
- `docs/spec-implementation-gaps.md` M-5
- `docs/gap-analysis.md:155-159`（3-1. カート内商品の数量上限）

---

## 2. 要件

### 2-1. 1商品あたりのカート内数量上限を9個とする

カート内の1商品あたりの数量は最大9個とする。この上限は在庫数とは独立したビジネスルールとして適用する。

- カート追加時: 追加後の合計数量が9を超える場合はエラーとする
- 数量変更時: 9を超える数量への変更はエラーとする
- 実際に購入可能な数量は `min(9, 有効在庫数)` となる

### 2-2. フロントエンドで数量入力を制限する

カート画面の数量入力欄で、入力可能な数量を制限する。

- 最小値: 1
- 最大値: `min(9, 商品の有効在庫数)`
- 上限を超える数量の入力・送信を防止する

### 2-3. バックエンドでバリデーションを実施する

フロントエンドの制限を回避した場合でも、バックエンドで数量上限を検証する。

- カート追加API・数量変更APIで数量が1〜9の範囲外の場合はエラーを返す
- エラーコード・メッセージで上限超過であることをユーザーに通知する

---

## 3. 受け入れ条件

- [ ] カート追加時に数量が9を超えるとエラーになる
- [ ] カート数量変更時に数量が9を超えるとエラーになる
- [ ] フロントエンドのカート画面で数量入力の最大値が制限される
- [ ] バックエンドで数量バリデーションが実施される
- [ ] 在庫数が9未満の場合は在庫数が上限となる
- [ ] 既存のカート操作・注文フローに影響がないこと

---

## 4. 仕様への反映

本要件の実装にあたり、以下の仕様ドキュメントに追記が必要:

- `docs/SPEC.md` — カート内数量の上限ルールを明記
- `docs/ui/api-spec.md` — カート追加・数量変更APIのバリデーションルール追記、エラーコード追加
- `docs/specs/inventory.md` — 数量上限と在庫引当の関係を明記

---

## 5. 関連資料

- `docs/spec-implementation-gaps.md` M-5
- `docs/spec-implementation-gaps.md` L-7（価格計算オーバーフロー — 数量上限により緩和）
- `docs/gap-analysis.md:155-159`（3-1. カート内商品の数量上限）
