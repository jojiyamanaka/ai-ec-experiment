# CHG-018 impl-notes

## T-1
- JobRunr は `jobrunr-spring-boot-3-starter` を追加し、`org.jobrunr.*` 設定で worker 有効化を `JOBRUNR_WORKER_ENABLED` に委譲した。
- `docker-compose.yml` は backend で `8000:8000` を公開し、同一 backend コンテナで dashboard を確認できる構成にした。
- `app.jobs.*` は設計書の有効化・スケジュール・export・sftp 設定を一式追加し、デフォルト値はローカル検証可能な `/tmp/aiec/shipments/*` を採用した。

## T-2
- V8 で `job_run_history` / `shipments` / `shipment_items` を新規作成し、冪等要件に合わせて `shipments(order_id, shipment_type)` UNIQUE を付与した。
- `orders.status` の CHECK 制約は既存制約名依存を避けるため `pg_constraint` 参照で一旦削除して再作成する方式にした。
- `shipments` / `shipment_items` は既存テーブル群と同じ監査カラム・`update_updated_at_column` トリガーを適用した。

## T-3
- `JobRunnerBase` で enabled 判定、`SKIPPED/SUCCESS/FAILED` の履歴記録、`processedCount`・`errorMessage` 保存を共通化した。
- `JobRunrConfig` は recurring 登録のみを担い、個別ジョブのビジネスロジックは各ジョブクラスに分離した。
- 転送戦略は `TransferStrategyFactory` で `app.jobs.sftp.strategy` から `local`/`sftp` を切替え、`sftp` は設計どおりスタブ実装にした。

## T-4
- `Shipment`/`ShipmentItem` は purchase モジュール内に新設し、`order_items` のスナップショットを `shipment_items` に保持する設計にした。
- `ShipmentRepository` に冪等判定・状態別取得・二重転送防止のためのクエリメソッドを追加した。

## T-5
- `OrderStatus` に `PREPARING_SHIPMENT` を追加し、`OrderRepository.findConfirmedWithoutOutboundShipment` で出荷対象抽出条件（CONFIRMED + COMMITTED + OUTBOUND未作成）を native query で実装した。
- Port/UseCase は `shipOrder` を削除し `markShipped` を追加して、`PREPARING_SHIPMENT -> SHIPPED` のみ許可する契約に変更した。

## T-6
- `OrderController` は `/ship` を削除し `/mark-shipped` を追加、監査イベントの `requestPath` と `operationType` も新エンドポイントに合わせて更新した。
- 認可要件は既存 `requireAdmin` を再利用し、アクセス制御の挙動は変えていない。
