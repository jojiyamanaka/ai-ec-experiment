# CHG-020: データモデル項目追加と画面反映 - 技術設計

要件: `docs/01_requirements/CHG-020_データモデル項目追加と画面反映.md`
作成日: 2026-02-19

**SSOT（唯一の真実）**:
- API契約: このドキュメントの「API契約」セクション
- DBスキーマ: `db/flyway/V9__add_business_fields.sql`（Flywayが正）
- 状態 enum: `purchase/order/entity/Order.OrderStatus` など（Javaコードが正）
- モジュール境界: `backend/AGENTS.md` + ArchUnit テスト

---

## 1. 設計方針

### 基本方針

CHG-020 は既存 Phase 1 データモデルを「業務運用可能レベル」まで引き上げる補強。新機能ではなく情報密度の向上。

- **後方互換維持**: 追加フィールドはすべて `NULLABLE` または `DEFAULT` 値付き。既存 API レスポンスの構造を壊さない
- **DB は ADD COLUMN のみ**: Flyway V9 は ALTER TABLE によるカラム追加のみ（テーブル再作成なし）
- **API は追加のみ**: 既存フィールドの削除・変更なし。フロント側は optional として受け取る
- **公開/販売制御を分離**: `isPublished`（検索表示）と `isOnSale`（購入可否）は独立制御
- **スナップショットは UseCase レイヤで設定**: CartItem 投入時・注文確定時のスナップショットはすべて UseCase / Service レイヤで記録

### フィールド採否一覧

| エンティティ | 追加グループ | 主要フィールド |
|------------|------------|--------------|
| Product | 業務識別・販売・表示・マーケ | `sku`, `brand`, `category`, `compareAtPrice`, `isOnSale`, `isRecommended`, `displayOrder`, `stockDisplayMode` |
| Cart | ライフサイクル・割引 | `status`, `expiresAt`, `couponCode`, `discountAmount` |
| CartItem | 投入時スナップショット | `addedProductName`, `addedUnitPrice`, `addedProductSku`, `addedProductImage` |
| Order | 連絡先・配送先・金額内訳・支払い・状態変化タイムスタンプ・メモ | 下記参照 |
| OrderItem | スナップショット補強・行状態 | `productSku`, `productImage`, `itemStatus` |
| User | 連絡先・住所・プロフィール・会員管理 | `fullName`, `phoneNumber`, `birthDate`, `newsletterOptIn`, `defaultAddress*`, `lastLoginAt`, `loyaltyPoints`, `memberRank`, `deactivationReason`, `termsAgreedAt` |

---

## 2. DBスキーマ変更

Flyway V9 として作成。ADD COLUMN のみ。

```sql
-- V9__add_business_fields.sql

-- ============================================================
-- Product: 商品補強
-- ============================================================
ALTER TABLE products
  ADD COLUMN sku                VARCHAR(100),          -- 業務識別コード
  ADD COLUMN brand              VARCHAR(100),          -- ブランド名
  ADD COLUMN category           VARCHAR(100),          -- カテゴリ（フィルタ用）
  ADD COLUMN compare_at_price   NUMERIC(10, 2),        -- 定価（セール表示用。NULLなら非表示）
  ADD COLUMN is_on_sale         BOOLEAN NOT NULL DEFAULT TRUE,    -- 販売可否（isPublishedとは独立）
  ADD COLUMN is_recommended     BOOLEAN NOT NULL DEFAULT FALSE,   -- おすすめフラグ（TOP画面制御）
  ADD COLUMN display_order      INTEGER NOT NULL DEFAULT 0,       -- 表示優先度（昇順）
  ADD COLUMN stock_display_mode VARCHAR(50) NOT NULL DEFAULT 'STANDARD';  -- 在庫表示方針

ALTER TABLE products
  ADD CONSTRAINT uk_products_sku UNIQUE (sku),
  ADD CONSTRAINT chk_products_stock_display_mode
    CHECK (stock_display_mode IN ('STANDARD', 'HIDDEN', 'ALWAYS_AVAILABLE'));

-- ============================================================
-- Cart: ライフサイクル・割引
-- ============================================================
ALTER TABLE carts
  ADD COLUMN status          VARCHAR(50)    NOT NULL DEFAULT 'ACTIVE',
  ADD COLUMN expires_at      TIMESTAMP WITH TIME ZONE,            -- ABANDONED判定用期限
  ADD COLUMN coupon_code     VARCHAR(100),                        -- 適用クーポン（将来用）
  ADD COLUMN discount_amount NUMERIC(10, 2) NOT NULL DEFAULT 0;   -- 割引額

ALTER TABLE carts
  ADD CONSTRAINT chk_carts_status
    CHECK (status IN ('ACTIVE', 'CHECKED_OUT', 'ABANDONED'));

-- ============================================================
-- CartItem: 投入時スナップショット補強
-- ============================================================
ALTER TABLE cart_items
  ADD COLUMN added_product_name  VARCHAR(255),
  ADD COLUMN added_unit_price    NUMERIC(10, 2),
  ADD COLUMN added_product_sku   VARCHAR(100),
  ADD COLUMN added_product_image VARCHAR(500);

-- ============================================================
-- Order: 連絡先・配送先・金額内訳・支払い・状態タイムスタンプ・メモ
-- ============================================================
ALTER TABLE orders
  -- 注文時点の連絡先スナップショット
  ADD COLUMN contact_name       VARCHAR(255),
  ADD COLUMN contact_email      VARCHAR(255),
  -- 注文時点の配送先スナップショット（Phase 1 は NULL 固定、Phase 2 で入力化）
  ADD COLUMN shipping_postal_code VARCHAR(10),
  ADD COLUMN shipping_prefecture  VARCHAR(50),
  ADD COLUMN shipping_address1    VARCHAR(255),
  ADD COLUMN shipping_address2    VARCHAR(255),
  -- 金額内訳
  ADD COLUMN subtotal_price    NUMERIC(10, 2),
  ADD COLUMN shipping_fee      NUMERIC(10, 2) NOT NULL DEFAULT 0,
  ADD COLUMN handling_fee      NUMERIC(10, 2) NOT NULL DEFAULT 0,
  ADD COLUMN discount_amount   NUMERIC(10, 2) NOT NULL DEFAULT 0,
  -- 支払い
  ADD COLUMN payment_method    VARCHAR(50) NOT NULL DEFAULT 'NONE',
  ADD COLUMN payment_status    VARCHAR(50) NOT NULL DEFAULT 'UNPAID',
  -- 配送追跡
  ADD COLUMN tracking_number           VARCHAR(100),
  ADD COLUMN estimated_delivery_date   DATE,
  -- 状態変化タイムスタンプ
  ADD COLUMN confirmed_at    TIMESTAMP WITH TIME ZONE,
  ADD COLUMN shipped_at      TIMESTAMP WITH TIME ZONE,
  ADD COLUMN delivered_at    TIMESTAMP WITH TIME ZONE,
  ADD COLUMN cancelled_at    TIMESTAMP WITH TIME ZONE,
  -- メモ・理由
  ADD COLUMN customer_note       TEXT,
  ADD COLUMN internal_note       TEXT,
  ADD COLUMN cancellation_reason VARCHAR(500);

ALTER TABLE orders
  ADD CONSTRAINT chk_orders_payment_method
    CHECK (payment_method IN ('NONE', 'CREDIT_CARD', 'COD')),
  ADD CONSTRAINT chk_orders_payment_status
    CHECK (payment_status IN ('UNPAID', 'PAID', 'REFUNDED'));

-- 既存注文の subtotal_price を total_price で初期化
UPDATE orders SET subtotal_price = total_price WHERE subtotal_price IS NULL;
ALTER TABLE orders ALTER COLUMN subtotal_price SET NOT NULL;

-- ============================================================
-- OrderItem: スナップショット補強・行ステータス
-- ============================================================
ALTER TABLE order_items
  ADD COLUMN product_sku   VARCHAR(100),    -- 注文時点の SKU スナップショット
  ADD COLUMN product_image VARCHAR(500),    -- 注文時点の商品画像スナップショット
  ADD COLUMN item_status   VARCHAR(50) NOT NULL DEFAULT 'NORMAL';

ALTER TABLE order_items
  ADD CONSTRAINT chk_order_items_item_status
    CHECK (item_status IN ('NORMAL', 'CANCELLED', 'RETURNED'));

-- ============================================================
-- User: 連絡先・住所・プロフィール・会員管理
-- ============================================================
ALTER TABLE users
  ADD COLUMN full_name          VARCHAR(200),           -- 実名（BO 管理用、displayName と独立）
  ADD COLUMN phone_number       VARCHAR(20),
  ADD COLUMN birth_date         DATE,
  ADD COLUMN newsletter_opt_in  BOOLEAN NOT NULL DEFAULT FALSE,   -- メルマガ同意
  -- デフォルト配送先
  ADD COLUMN default_postal_code VARCHAR(10),
  ADD COLUMN default_prefecture  VARCHAR(50),
  ADD COLUMN default_address1    VARCHAR(255),
  ADD COLUMN default_address2    VARCHAR(255),
  -- 会員管理
  ADD COLUMN last_login_at      TIMESTAMP WITH TIME ZONE,
  ADD COLUMN loyalty_points     INTEGER NOT NULL DEFAULT 0,        -- ポイント残高
  ADD COLUMN member_rank        VARCHAR(50) NOT NULL DEFAULT 'STANDARD',  -- STANDARD/SILVER/GOLD
  ADD COLUMN terms_agreed_at    TIMESTAMP WITH TIME ZONE,
  ADD COLUMN deactivation_reason VARCHAR(500);

ALTER TABLE users
  ADD CONSTRAINT chk_users_member_rank
    CHECK (member_rank IN ('STANDARD', 'SILVER', 'GOLD'));
```

---

## 3. API契約

### 変更後の型定義

#### Product オブジェクト（追加フィールド）

```
sku:              String | null       # BO管理用。顧客画面では非表示
brand:            String | null
category:         String | null
compareAtPrice:   Number | null       # 定価。NULLなら表示なし
isOnSale:         Boolean             # 販売可否（DEFAULT true）
isRecommended:    Boolean             # おすすめフラグ（TOP画面制御）
displayOrder:     Integer             # 表示優先度（昇順）
stockDisplayMode: "STANDARD" | "HIDDEN" | "ALWAYS_AVAILABLE"
```

**BO向け PUT /api/item/:id リクエストの追加フィールド**:
`sku?`, `brand?`, `category?`, `compareAtPrice?`, `isOnSale?`, `isRecommended?`, `displayOrder?`, `stockDisplayMode?`

**商品一覧ソート変更**: `display_order ASC, id ASC`（現在は `id ASC` のみ）

#### Cart オブジェクト（追加フィールド）

```
status:         "ACTIVE" | "CHECKED_OUT" | "ABANDONED"
discountAmount: Number    # 割引額（DEFAULT 0）
couponCode:     String | null
```

#### CartItem オブジェクト（追加フィールド）

```
addedProductName:  String | null   # 投入時商品名
addedUnitPrice:    Number | null   # 投入時単価（現在価格との差分検出に使用）
addedProductSku:   String | null
addedProductImage: String | null
```

#### Order オブジェクト（追加フィールド）

```
# 連絡先・配送先スナップショット
contactName:          String | null
contactEmail:         String | null
shippingPostalCode:   String | null
shippingPrefecture:   String | null
shippingAddress1:     String | null
shippingAddress2:     String | null

# 金額内訳
subtotalPrice:    Number
shippingFee:      Number    # Phase 1 は 0 固定
handlingFee:      Number    # Phase 1 は 0 固定
discountAmount:   Number    # Phase 1 は 0 固定

# 支払い
paymentMethod:  "NONE" | "CREDIT_CARD" | "COD"
paymentStatus:  "UNPAID" | "PAID" | "REFUNDED"

# 配送追跡
trackingNumber:         String | null
estimatedDeliveryDate:  String | null    # YYYY-MM-DD

# 状態変化タイムスタンプ
confirmedAt:  String | null    # ISO 8601
shippedAt:    String | null
deliveredAt:  String | null
cancelledAt:  String | null

# メモ・理由
customerNote:       String | null
cancellationReason: String | null

# internalNote は顧客向け API レスポンスには含めない（BO API のみ）
```

#### OrderItem オブジェクト（追加フィールド）

```
productSku:   String | null   # 注文時点のSKUスナップショット
productImage: String | null   # 注文時点の画像スナップショット
itemStatus:   "NORMAL" | "CANCELLED" | "RETURNED"
```

#### User オブジェクト（追加フィールド）

```
fullName:      String | null    # 実名（BO管理用）
phoneNumber:   String | null
birthDate:     String | null    # YYYY-MM-DD
newsletterOptIn: Boolean
defaultPostalCode: String | null
defaultPrefecture: String | null
defaultAddress1:   String | null
defaultAddress2:   String | null
lastLoginAt:   String | null    # ISO 8601
loyaltyPoints: Number
memberRank:    "STANDARD" | "SILVER" | "GOLD"
termsAgreedAt: String | null

# deactivationReason は顧客向け API レスポンスには含めない（BO API のみ）
```

### 新規エンドポイント

#### PUT /api/auth/me — 会員プロフィール更新

| 項目 | 内容 |
|------|------|
| 認証 | User（Bearer トークン必須） |
| リクエスト body | `{ displayName?, fullName?, phoneNumber?, birthDate?, newsletterOptIn?, defaultPostalCode?, defaultPrefecture?, defaultAddress1?, defaultAddress2? }` |
| レスポンス | `{ data: { user: User } }` |
| エラー | `UNAUTHORIZED`, `INVALID_REQUEST` |

#### GET /api/auth/me/orders — 直近の注文サマリー（マイページ用）

| 項目 | 内容 |
|------|------|
| 認証 | User（Bearer トークン必須） |
| クエリ | `limit` (DEFAULT 3, MAX 10) |
| レスポンス | `{ data: Order[] }` （items は含まない軽量版） |
| 備考 | 既存 `/api/order/history` の軽量版。マイページ用ウィジェット向け |

### 既存エンドポイントの変更

| エンドポイント | 変更内容 |
|--------------|---------|
| GET `/api/item`, `/api/item/:id` | ProductDto に追加フィールドを付与 |
| PUT `/api/item/:id` | UpdateProductRequest に追加フィールドを追加 |
| GET `/api/order/cart` | CartDto・CartItemDto に追加フィールドを付与 |
| POST `/api/order` | 注文確定時スナップショット設定（フロント側変更なし） |
| GET `/api/order/:id`, `/api/order`, `/api/order/history` | OrderDto・OrderItemDto に追加フィールドを付与 |
| POST `/api/order/:id/confirm` | `confirmed_at` を記録 |
| POST `/api/order/:id/mark-shipped` | `shipped_at` を記録、`tracking_number` を受け付ける（BO） |
| POST `/api/order/:id/deliver` | `delivered_at` を記録 |
| POST `/api/order/:id/cancel` | `cancelled_at` を記録、`cancellationReason` を受け付ける |
| GET `/api/auth/me` | UserDto に追加フィールドを付与 |
| POST `/api/auth/login` | 成功時に `last_login_at` を更新 |
| GET `/api/bo/admin/members`, `/:id` | User に追加フィールドを付与、`deactivationReason` は BO 専用 |
| PUT `/api/bo/admin/members/:id/status` | リクエストに `deactivationReason?: string` 追加 |

---

## 4. 会員マイページ（/mypage）の設計

### 画面構成

`/mypage` はタブなしのシングルページ（スクロール式セクション構成）。認証必須（未ログイン時は `/auth/login` へリダイレクト）。

```
/mypage
  ├── [ヘッダー] 会員ランクバッジ + ポイント残高
  ├── [section 1] プロフィール
  │     displayName（表示名）, fullName（実名）, email（変更不可）,
  │     phoneNumber, birthDate
  │     → 「編集」→ インライン編集 or モーダル → PUT /api/auth/me
  ├── [section 2] デフォルト配送先
  │     postalCode, prefecture, address1, address2
  │     → 「編集」→ PUT /api/auth/me
  ├── [section 3] メールマガジン設定
  │     newsletterOptIn（チェックボックス）
  │     → 変更即時送信（PUT /api/auth/me）
  ├── [section 4] 直近の注文
  │     最新 3 件のサマリー（注文番号, 日時, 金額, ステータスバッジ）
  │     → 注文番号クリック → /order/:id
  │     → 「注文履歴をすべて見る」→ /order/history
  └── [section 5] アカウント情報
        会員ランク・ポイント残高の説明
        会員登録日時・最終ログイン日時（参照のみ）
```

### ナビゲーション統合

- **CustomerLayout Header**: ログイン済み時にユーザーアイコン or 表示名をクリック → `/mypage` へ遷移
- 現在の注文履歴リンク（`/order/history`）はそのまま維持

### データ取得フロー

```
/mypage マウント
  → GET /api/auth/me       ... ユーザープロフィール取得
  → GET /api/auth/me/orders?limit=3  ... 直近注文取得（並列）
  → 画面描画
```

---

## 5. モジュール・レイヤ構成

```
product/
  domain/entity/        - Product（フィールド追加）
  application/port/     - ProductDto, UpdateProductRequest（フィールド追加）
  application/usecase/  - ProductUseCase（ソート変更、isOnSale 購入可否チェック追加）

purchase/
  cart/entity/          - Cart（status, expiresAt, couponCode, discountAmount 追加）
  cart/entity/          - CartItem（スナップショット追加）
  cart/service/         - CartService（addItem 時スナップショット設定）
  order/entity/         - Order（多数のフィールド追加 + 状態遷移時タイムスタンプ設定）
  order/entity/         - OrderItem（productSku, productImage, itemStatus 追加）
  adapter/dto/          - CartDto, CartItemDto（フィールド追加）
  application/port/     - OrderDto（フィールド追加。internalNote は BO フラグ制御）
  application/port/     - OrderItemDto（フィールド追加）
  application/usecase/  - OrderUseCase（注文確定時スナップショット設定）

customer/
  domain/entity/        - User（フィールド追加）
  domain/service/       - AuthService（login 時 lastLoginAt 更新）
  adapter/dto/          - UserDto（フィールド追加。deactivationReason は BO のみ）
  adapter/rest/         - AuthController（PUT /api/auth/me、GET /api/auth/me/orders 追加）

backoffice/
  adapter/rest/         - BoAdminController（メンバー詳細拡張、status 変更に reason 追加）
```

---

## 6. 主要クラス/IFの責務

| クラス/IF | 変更概要 |
|-----------|---------|
| `product/domain/entity/Product` | `sku`, `brand`, `category`, `compareAtPrice`, `isOnSale`, `isRecommended`, `displayOrder`, `stockDisplayMode` 追加 |
| `product/application/port/ProductDto` | 追加フィールドを `fromEntity()` でマッピング |
| `product/application/port/UpdateProductRequest` | 追加フィールドを optional で受け付け |
| `product/application/usecase/ProductUseCase` | ソートを `displayOrder ASC, id ASC` に変更。`isOnSale=false` のカート追加チェック追加 |
| `purchase/cart/entity/Cart` | `status`, `expiresAt`, `couponCode`, `discountAmount` 追加 |
| `purchase/cart/entity/CartItem` | 4 スナップショットフィールド追加 |
| `purchase/cart/service/CartService` | `addItem()` 時に `addedProduct*` を設定。`isOnSale=false` 商品を拒否 |
| `purchase/order/entity/Order` | 連絡先・配送先・金額・支払い・追跡・タイムスタンプ・メモフィールド追加。各遷移メソッドでタイムスタンプ設定 |
| `purchase/order/entity/OrderItem` | `productSku`, `productImage`, `itemStatus` 追加 |
| `purchase/application/port/OrderDto` | 追加フィールドをマッピング。`internalNote` は `boView` フラグ（boolean 引数）で出し分け |
| `purchase/application/usecase/OrderUseCase` | `createOrder()` で連絡先・配送先・SKUスナップショット設定。ステータス遷移メソッドでタイムスタンプ設定 |
| `customer/domain/entity/User` | 多数のフィールド追加 |
| `customer/domain/service/AuthService` | `login()` 時に `lastLoginAt` を更新 |
| `customer/adapter/dto/UserDto` | 追加フィールドをマッピング（`deactivationReason` 除く） |
| `customer/adapter/rest/AuthController` | `PUT /api/auth/me`（プロフィール更新）、`GET /api/auth/me/orders`（直近注文）追加 |
| `backoffice/adapter/rest/BoAdminController` | メンバー詳細・status 変更拡張 |

---

## 7. 処理フロー

### 注文確定時のスナップショット設定

```
POST /api/order
  → OrderController
  → OrderUseCase.createOrder(cartId, userId, sessionId)
      ├─ CartItem から OrderItem を生成
      │     OrderItem.productSku   ← cartItem.addedProductSku（or product.sku）
      │     OrderItem.productImage ← cartItem.addedProductImage
      ├─ 認証済みユーザーがいれば:
      │     Order.contactName   ← user.displayName
      │     Order.contactEmail  ← user.email
      │     Order.shippingPostalCode ← user.defaultPostalCode（存在すれば）
      │     Order.shippingPrefecture ← user.defaultPrefecture
      │     Order.shippingAddress1  ← user.defaultAddress1
      │     Order.shippingAddress2  ← user.defaultAddress2
      ├─ 金額内訳設定:
      │     Order.subtotalPrice = Σ(productPrice × quantity)
      │     Order.shippingFee = 0, handlingFee = 0, discountAmount = 0
      │     Order.totalPrice = subtotalPrice（Phase 1 固定）
      └─ Cart.status ← CHECKED_OUT
  → OrderDto にマッピング → Response
```

### ステータス遷移時のタイムスタンプ設定

```
POST /api/order/:id/confirm     → Order.confirmedAt = now()
POST /api/order/:id/mark-shipped → Order.shippedAt = now()
                                   body.trackingNumber → Order.trackingNumber
POST /api/order/:id/deliver     → Order.deliveredAt = now()
POST /api/order/:id/cancel      → Order.cancelledAt = now()
                                   body.reason → Order.cancellationReason
```

### CartItem 投入時スナップショット設定

```
POST /api/order/cart/items
  → CartService.addItem(cartId, productId, quantity)
      → Product を取得
      → CartItem.addedProductName  ← product.name
      → CartItem.addedUnitPrice    ← product.price
      → CartItem.addedProductSku   ← product.sku（NULL 可）
      → CartItem.addedProductImage ← product.image
      → isOnSale=false なら ITEM_NOT_AVAILABLE エラー
  → CartDto → Response
```

### 在庫表示ロジック（フロントエンド）

```
isOnSale = false
  → 「販売停止中」バッジ、カートに追加不可（stock チェック前に判定）

stockDisplayMode = HIDDEN
  → 在庫バッジを非表示

stockDisplayMode = ALWAYS_AVAILABLE
  → 常に「在庫あり」バッジ（実在庫数に関わらず）

stockDisplayMode = STANDARD（DEFAULT）
  → 既存の 3 段階（在庫あり / 残りわずか / 売り切れ）
```

---

## 8. 影響範囲

### Backend

| 区分 | 対象 | 変更概要 |
|------|------|---------|
| 新規作成 | `db/flyway/V9__add_business_fields.sql` | ADD COLUMN マイグレーション |
| 既存変更 | `product/domain/entity/Product` | 8 フィールド追加 |
| 既存変更 | `product/application/port/ProductDto` | フィールド追加、`fromEntity()` 更新 |
| 既存変更 | `product/application/port/UpdateProductRequest` | フィールド追加 |
| 既存変更 | `product/application/usecase/ProductUseCase` | ソート変更、isOnSale チェック追加 |
| 既存変更 | `purchase/cart/entity/Cart` | 4 フィールド追加 |
| 既存変更 | `purchase/cart/entity/CartItem` | 4 スナップショットフィールド追加 |
| 既存変更 | `purchase/cart/service/CartService` | addItem() 時スナップショット・isOnSale チェック |
| 既存変更 | `purchase/adapter/dto/CartDto` | フィールド追加 |
| 既存変更 | `purchase/adapter/dto/CartItemDto` | スナップショットフィールド追加 |
| 既存変更 | `purchase/order/entity/Order` | 多数のフィールド追加 + enum 追加 |
| 既存変更 | `purchase/order/entity/OrderItem` | 3 フィールド追加 |
| 既存変更 | `purchase/application/port/OrderDto` | フィールド追加、internalNote 出し分け |
| 既存変更 | `purchase/application/port/OrderItemDto` | フィールド追加 |
| 既存変更 | `purchase/application/usecase/OrderUseCase` | スナップショット設定、タイムスタンプ設定 |
| 既存変更 | `customer/domain/entity/User` | 12 フィールド追加 |
| 既存変更 | `customer/domain/service/AuthService` | login 時 lastLoginAt 更新 |
| 既存変更 | `customer/adapter/dto/UserDto` | フィールド追加（deactivationReason 除く） |
| 既存変更 | `customer/adapter/rest/AuthController` | PUT /me、GET /me/orders 追加 |
| 既存変更 | `backoffice/adapter/rest/BoAdminController` | メンバー詳細・status 変更拡張 |

### BFF (bff/shared/src/dto/)

| 対象 | 変更概要 |
|------|---------|
| `product.dto.ts` | 追加フィールド |
| `cart.dto.ts` | 追加フィールド（CartDto, CartItemDto） |
| `order.dto.ts` | 追加フィールド（OrderDto, OrderItemDto） |
| `user.dto.ts` | 追加フィールド |

### Frontend

| 区分 | 対象 | 変更概要 |
|------|------|---------|
| 既存変更 | `entities/product/model/types.ts` | `Product`, `UpdateProductRequest` 型に追加フィールド（optional） |
| 既存変更 | `entities/cart/model/types.ts` | `Cart`, `CartItem` 型に追加フィールド（optional） |
| 既存変更 | `entities/order/model/types.ts` | `Order`, `OrderItem` 型に追加フィールド（optional） |
| 既存変更 | `entities/customer/model/types.ts` | `User` 型に追加フィールド、`UpdateProfileRequest` 追加 |
| 既存変更 | `entities/customer/model/api.ts` | `updateProfile()`, `getRecentOrders()` 追加 |
| 既存変更 | `entities/product/ui/ProductCard.tsx` | `isOnSale`, `compareAtPrice`, `stockDisplayMode` 対応 |
| 既存変更 | `pages/customer/ItemDetailPage` | 同上 + `brand`, `category` 表示 |
| 既存変更 | `pages/customer/CartPage` | 価格変更バナー（`addedUnitPrice != product.price`） |
| 既存変更 | `pages/customer/OrderConfirmPage` | 金額内訳（subtotalPrice, shippingFee, handlingFee, discountAmount） |
| 既存変更 | `pages/customer/OrderDetailPage` | 連絡先・配送先・支払い情報・trackingNumber・タイムスタンプ・customerNote 表示 |
| **新規作成** | `pages/customer/MypagePage` | `/mypage` — 5 セクション構成の会員自己管理ページ |
| 既存変更 | `app/router/customer.tsx` | `/mypage` ルート追加 |
| 既存変更 | `widgets/CustomerLayout/CustomerLayout.tsx` | ログイン時にマイページリンク（ユーザー名 or アイコン）追加 |
| 既存変更 | `pages/admin/AdminItemPage` | `sku`, `brand`, `category`, `compareAtPrice`, `isOnSale`, `isRecommended`, `displayOrder`, `stockDisplayMode` 表示・編集 |
| 既存変更 | `pages/admin/AdminOrderPage` | 注文詳細に配送先・追跡番号・タイムスタンプ・internalNote・cancellationReason 追加、mark-shipped に trackingNumber 入力追加 |
| 既存変更 | `pages/admin/AdminMembersPage` | `fullName`, `phoneNumber`, `memberRank`, `loyaltyPoints`, `lastLoginAt`, `termsAgreedAt`, `deactivationReason` 表示・編集 |

### Spec Docs 更新

| ドキュメント | 更新内容 |
|------------|---------|
| `data-model.md` | 各エンティティの DDL を追加フィールド込みに更新 |
| `ui/api-spec.md` | 各オブジェクト型・エンドポイント定義を更新 |
| `ui/customer-ui.md` | MypagePage 追加、各画面の表示項目更新 |
| `ui/admin-ui.md` | 各管理画面の表示・編集項目更新 |
| `requirements.md` | 販売可否・在庫表示方針・金額内訳・支払い状態・会員ランク定義を追記 |

---

## 9. テスト観点

### バックエンド

- **正常系**:
  - CartItem 追加時に 4 スナップショットが設定されること
  - 注文確定時に `contactName`, `contactEmail` がユーザー情報からコピーされること
  - デフォルト住所がある会員の注文確定時に配送先が自動設定されること
  - ゲスト注文で連絡先・配送先が NULL になること
  - ステータス遷移メソッドごとに対応タイムスタンプが設定されること
  - `mark-shipped` で `trackingNumber` が保存されること
  - 顧客向け `OrderDto` に `internalNote` が含まれないこと
  - 顧客向け `UserDto` に `deactivationReason` が含まれないこと
  - `PUT /api/auth/me` でプロフィール・住所・設定が更新されること
  - `GET /api/auth/me/orders?limit=3` で直近 3 件が返ること
  - `login()` 時に `lastLoginAt` が更新されること

- **異常系**:
  - `isOnSale=false` の商品はカート追加拒否（`ITEM_NOT_AVAILABLE`）
  - `PUT /api/auth/me` 未認証時に 401

- **境界値**:
  - `displayOrder` 同値の場合は `id ASC` でソートされること
  - `subtotalPrice + shippingFee + handlingFee - discountAmount = totalPrice` の整合性
  - `GET /api/auth/me/orders?limit=10` が上限として機能すること

### フロントエンド

- `stockDisplayMode` が null/undefined の場合 STANDARD として扱われること
- `addedUnitPrice !== product.price` のとき価格変更バナーが表示されること
- `compareAtPrice` が設定された商品でセール価格表示されること
- `/mypage` は未ログイン時にログイン画面へリダイレクトされること
- マイページのプロフィール編集後、即座に表示が更新されること
