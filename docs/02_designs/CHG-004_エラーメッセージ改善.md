# CHG-004: エラーメッセージ改善 - 技術設計

## 概要

バックエンドAPIから返されるエラーメッセージを、ユーザーフレンドリーなメッセージに変換する仕組みをフロントエンドに実装する。

## 設計方針

### 基本原則

1. **バックエンドは変更しない**
   - 既存のエラーコード・メッセージ体系はそのまま維持
   - フロントエンド側で吸収・変換する

2. **エラーメッセージの一元管理**
   - エラーコード → ユーザーメッセージのマッピングを中央集権的に管理
   - コンポーネント間で一貫性のあるメッセージを表示

3. **詳細情報（details）の活用**
   - `OUT_OF_STOCK`, `ITEM_NOT_AVAILABLE` など、詳細情報が含まれるエラーは適切に活用
   - OrderConfirmPage の既存実装パターンを踏襲

## アーキテクチャ

### 新規モジュール

**`src/lib/errorMessages.ts`**

エラーコードとユーザーメッセージのマッピングを管理するモジュール。

```typescript
// エラーコードとユーザーメッセージのマッピング
interface ErrorMessageConfig {
  message: string
  action?: string  // ユーザーが取るべきアクション
}

// エラーコード → メッセージのマッピング定義
const ERROR_MESSAGES: Record<string, ErrorMessageConfig>

// ユーザーフレンドリーなメッセージを取得
function getUserFriendlyMessage(errorCode: string): string

// エラーコードとアクションガイダンスを取得
function getErrorMessageWithAction(errorCode: string): { message: string; action?: string }
```

### 変更対象ファイル

1. **`src/contexts/CartContext.tsx`**
   - エラーハンドリング部分でマッピング関数を使用
   - `response.error?.message` をそのまま使わず、`getUserFriendlyMessage()` を経由

2. **`src/contexts/ProductContext.tsx`**
   - 商品取得エラーのメッセージを改善（該当する場合）

3. **`src/pages/CartPage.tsx`**
   - エラー表示部分で改善されたメッセージを表示

4. **`src/pages/OrderConfirmPage.tsx`**
   - 基本メッセージは `getUserFriendlyMessage()` を使用
   - 詳細情報表示（`details`）の仕組みはそのまま維持

## エラーメッセージマッピング定義

### 基本エラー

| エラーコード | ユーザーメッセージ | アクションガイダンス |
|------------|-----------------|-------------------|
| `NETWORK_ERROR` | ネットワークエラーが発生しました | 接続を確認してもう一度お試しください |
| `INTERNAL_ERROR` | 一時的なエラーが発生しました | しばらくしてからもう一度お試しください |
| `INVALID_REQUEST` | 無効なリクエストです | 入力内容を確認してください |

### カート関連エラー

| エラーコード | ユーザーメッセージ | アクションガイダンス |
|------------|-----------------|-------------------|
| `CART_NOT_FOUND` | カート情報が見つかりませんでした | ページを更新してください |
| `CART_EMPTY` | カートに商品がありません | 商品を追加してください |
| `RESERVATION_NOT_FOUND` | カート情報が見つかりませんでした | ページを更新してください |
| `NO_RESERVATIONS` | カート情報が見つかりませんでした | ページを更新してください |

### 商品関連エラー

| エラーコード | ユーザーメッセージ | アクションガイダンス |
|------------|-----------------|-------------------|
| `ITEM_NOT_FOUND` | 商品が見つかりませんでした | - |
| `ITEM_NOT_AVAILABLE` | この商品は現在購入できません | カートから削除してください |

### 在庫関連エラー

| エラーコード | ユーザーメッセージ | アクションガイダンス |
|------------|-----------------|-------------------|
| `OUT_OF_STOCK` | 在庫が不足している商品があります | 数量を調整してください |
| `INSUFFICIENT_STOCK` | 在庫が不足しています | 数量を減らしてお試しください |
| `INVALID_QUANTITY` | 数量が無効です | 1〜9の範囲で指定してください |

### 注文関連エラー

| エラーコード | ユーザーメッセージ | アクションガイダンス |
|------------|-----------------|-------------------|
| `ORDER_NOT_FOUND` | 注文が見つかりませんでした | - |
| `ORDER_NOT_CANCELLABLE` | この注文はキャンセルできません | - |
| `ALREADY_CANCELLED` | この注文は既にキャンセルされています | - |
| `INVALID_STATUS_TRANSITION` | 操作を実行できませんでした | - |

### フォールバック

マッピングされていないエラーコードの場合:
- **デフォルトメッセージ**: `操作に失敗しました`
- **アクションガイダンス**: `もう一度お試しください`

## 実装詳細

### 1. エラーメッセージマッピングモジュール（新規作成）

**ファイル**: `src/lib/errorMessages.ts`

```typescript
interface ErrorMessageConfig {
  message: string
  action?: string
}

const ERROR_MESSAGES: Record<string, ErrorMessageConfig> = {
  // ネットワーク・システムエラー
  NETWORK_ERROR: {
    message: 'ネットワークエラーが発生しました',
    action: '接続を確認してもう一度お試しください',
  },
  INTERNAL_ERROR: {
    message: '一時的なエラーが発生しました',
    action: 'しばらくしてからもう一度お試しください',
  },

  // カート関連
  CART_NOT_FOUND: {
    message: 'カート情報が見つかりませんでした',
    action: 'ページを更新してください',
  },
  RESERVATION_NOT_FOUND: {
    message: 'カート情報が見つかりませんでした',
    action: 'ページを更新してください',
  },
  NO_RESERVATIONS: {
    message: 'カート情報が見つかりませんでした',
    action: 'ページを更新してください',
  },

  // 在庫関連
  OUT_OF_STOCK: {
    message: '在庫が不足している商品があります',
    action: '数量を調整してください',
  },
  INSUFFICIENT_STOCK: {
    message: '在庫が不足しています',
    action: '数量を減らしてお試しください',
  },

  // 商品関連
  ITEM_NOT_AVAILABLE: {
    message: 'この商品は現在購入できません',
    action: 'カートから削除してください',
  },

  // ... 他のエラーコード
}

/**
 * エラーコードからユーザーフレンドリーなメッセージを取得
 */
export function getUserFriendlyMessage(errorCode: string): string {
  const config = ERROR_MESSAGES[errorCode]
  if (!config) {
    return '操作に失敗しました'
  }

  // アクションガイダンスがある場合は結合
  if (config.action) {
    return `${config.message}。${config.action}。`
  }

  return config.message
}

/**
 * エラーコードとアクションを個別に取得（UI側で個別表示する場合）
 */
export function getErrorMessageWithAction(errorCode: string): {
  message: string
  action?: string
} {
  const config = ERROR_MESSAGES[errorCode]
  if (!config) {
    return {
      message: '操作に失敗しました',
      action: 'もう一度お試しください',
    }
  }

  return config
}
```

### 2. CartContext の変更

**ファイル**: `src/contexts/CartContext.tsx`

変更箇所: エラーハンドリング部分（`addToCart`, `removeFromCart`, `updateQuantity`, `refreshCart`）

**変更前:**
```typescript
} else {
  throw new Error(response.error?.message || 'カートへの追加に失敗しました')
}
```

**変更後:**
```typescript
} else {
  const message = response.error?.code
    ? getUserFriendlyMessage(response.error.code)
    : 'カートへの追加に失敗しました'
  throw new Error(message)
}
```

同様の変更を `removeFromCart`, `updateQuantity`, `refreshCart` にも適用。

### 3. OrderConfirmPage の変更

**ファイル**: `src/pages/OrderConfirmPage.tsx`

変更箇所: エラー表示部分（176行目）

**変更前:**
```typescript
<h3 className="font-medium text-red-800">{error.message}</h3>
```

**変更後:**
```typescript
<h3 className="font-medium text-red-800">
  {getUserFriendlyMessage(error.code)}
</h3>
```

詳細情報（`details`）の表示ロジックはそのまま維持。

### 4. ProductContext の変更（該当する場合）

**ファイル**: `src/contexts/ProductContext.tsx`

商品取得エラーがある場合、同様にマッピング関数を適用。

## 詳細情報（details）の扱い

### 既存パターンの踏襲

`OrderConfirmPage.tsx` では、`OUT_OF_STOCK` および `ITEM_NOT_AVAILABLE` エラーの場合、`details` フィールドを活用して詳細情報を表示している。この実装パターンは変更せず維持する。

### 表示ルール

1. **基本メッセージ**: `getUserFriendlyMessage()` でユーザーフレンドリーなメッセージを表示
2. **詳細情報**: `error.details` が存在する場合、商品名・在庫数などを追加表示
3. **アクションガイダンス**: 詳細情報の後に具体的なアクション（「カートに戻って数量を調整してください」など）を表示

## エラーハンドリングフロー

```
API呼び出し
  ↓
ApiResponse<T> 取得
  ↓
success = false の場合
  ↓
error.code を getUserFriendlyMessage() に渡す
  ↓
ユーザーフレンドリーなメッセージを取得
  ↓
throw new Error(message) または setError()
  ↓
UIでメッセージ表示
  ↓
details がある場合は追加情報を表示
```

## 既存パターンとの整合性

### API層（`src/lib/api.ts`）

- 変更なし
- `ApiResponse<T>` をそのまま返す仕組みは維持

### Context層（CartContext, ProductContext）

- エラーハンドリング時に `getUserFriendlyMessage()` を使用
- `error.code` が存在しない場合のフォールバックメッセージも定義

### ページ層（CartPage, OrderConfirmPage）

- Context から受け取ったエラーメッセージをそのまま表示
- OrderConfirmPage の詳細情報表示パターンは維持

## テスト観点

1. **マッピング対象エラーコードのテスト**
   - 各エラーコードで正しいメッセージが表示されるか
   - 技術用語（「仮引当」など）が含まれていないか

2. **未定義エラーコードのテスト**
   - マッピングされていないエラーコードの場合、フォールバックメッセージが表示されるか

3. **詳細情報（details）のテスト**
   - `OUT_OF_STOCK`, `ITEM_NOT_AVAILABLE` で詳細情報が正しく表示されるか

4. **一貫性のテスト**
   - 同じエラーコードが、どの画面でも同じメッセージで表示されるか

## 影響範囲

### 変更ファイル

- **新規作成**: `src/lib/errorMessages.ts`
- **変更**: `src/contexts/CartContext.tsx`
- **変更**: `src/pages/OrderConfirmPage.tsx`
- **変更（該当する場合）**: `src/contexts/ProductContext.tsx`, `src/pages/CartPage.tsx`

### 影響なし

- バックエンドコード（変更なし）
- `src/lib/api.ts`（変更なし）
- `src/types/api.ts`（変更なし）

## セキュリティ考慮事項

1. **内部実装の隠蔽**
   - 「仮引当」「セッション」などの技術用語を排除
   - システムの内部構造を推測されにくくする

2. **エラーメッセージの制御**
   - バックエンドのスタックトレースや詳細エラーがユーザーに露呈しないようにする
   - フロントエンドで意図的にフィルタリング

## 拡張性

### 新規エラーコードの追加

`src/lib/errorMessages.ts` の `ERROR_MESSAGES` に新しいエントリを追加するだけで対応可能。

### 多言語化対応（将来）

`ERROR_MESSAGES` を言語ごとに切り替える仕組みに拡張可能。

```typescript
const ERROR_MESSAGES_JA: Record<string, ErrorMessageConfig> = { ... }
const ERROR_MESSAGES_EN: Record<string, ErrorMessageConfig> = { ... }

function getUserFriendlyMessage(errorCode: string, locale = 'ja'): string {
  const messages = locale === 'ja' ? ERROR_MESSAGES_JA : ERROR_MESSAGES_EN
  // ...
}
```
