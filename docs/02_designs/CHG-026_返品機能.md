# CHG-026: 返品機能 - 技術設計（改訂版）

要件: `docs/01_requirements/CHG-026_返品機能.md`
作成日: 2026-02-26

**SSOT（唯一の真実）**:
- API契約: このドキュメントの「2. API契約」セクション
- 状態遷移: `purchase/shipment/entity/Shipment.java` 内の `ShipmentStatus` enum（Javaコードが正）
- DBスキーマ: `backend/src/main/resources/db/flyway/V3__add_return_feature.sql`（Flywayが正）
- モジュール境界: `backend/AGENTS.md` + ArchUnit テスト（`ModularMonolithArchitectureTest`）
- BFF API契約: `docs/api/customer-bff-openapi.json` / `docs/api/backoffice-bff-openapi.json`（更新後が正）

---

## 1. 設計方針

### 1.1 返品の表現モデル

- 返品は `shipment_type = RETURN` の `Shipment` レコードとして管理する（要件準拠）。
- 注文ごとに RETURN Shipment は最大 1 件。既存の `UNIQUE (order_id, shipment_type)` 制約（`uk_shipments_order_type`）で保証される。
- 返品の進捗は `Shipment` 内の `ShipmentStatus` enum に RETURN 専用ステータス 4 値を追加して表現する。OUTBOUND 用ステータス（READY / EXPORTED / TRANSFERRED）と RETURN 用ステータスは `shipment_type` で区別する。
- 既存の `Shipment` / `ShipmentItem` エンティティ・テーブルを再利用し、新規テーブルは作成しない。

### 1.2 返品申請の資格チェック

- 資格チェックはすべて `ReturnUseCase`（実装クラス）が行い、Controller に漏らさない。
- 返品可能期限は `orders.delivered_at + 30日` で計算する。
- `delivered_at` は `OrderUseCase.deliverOrder()` が `SHIPPED → DELIVERED` 遷移を実行する際に `Instant.now()` で設定する（既存メソッドへの追加変更）。
- `is_returnable = false` の商品が申請明細に 1 件でも含まれる場合、申請全体を拒否する（`PRODUCT_NOT_RETURNABLE`）。

### 1.3 監査ログ

- 既存の Transactional Outbox パターン（`OutboxEventPublisher.publish("OPERATION_PERFORMED", ...)`）を踏襲する。
- 返品操作 4 種（申請・承認・拒否・確定）を記録する。

### 1.4 在庫戻し・返金

- 返品確定（`RETURN_CONFIRMED`）時の在庫戻し・返金は今回対象外（要件 §8 除外範囲）。
- `RETURN_CONFIRMED` 遷移時はステータス更新と監査ログのみ実施する。

### 1.5 管理画面

- 専用ページは作成せず、既存 `AdminOrderPage` の注文詳細モーダルに「返品情報」セクションを追加する。

### 1.6 既存データの扱い

- `delivered_at` が NULL の既存注文は V3 マイグレーション適用時点では NULL のまま。
- これらの注文に対する返品申請は `RETURN_PERIOD_EXPIRED` として拒否する。実装者はこの動作を `ReturnUseCase` 内で明示的にハンドルすること。

---

## 2. API契約

### 2.1 Core API（内部、BFF が呼び出す）

| メソッド | パス | 認証 | 用途 |
|---------|------|------|------|
| `POST` | `/api/order/{orderId}/return` | User（Bearer） | 返品申請 |
| `GET` | `/api/order/{orderId}/return` | User or BoUser | 返品情報取得 |
| `POST` | `/api/order/{orderId}/return/approve` | BoUser（ADMIN 以上） | 返品承認 |
| `POST` | `/api/order/{orderId}/return/reject` | BoUser（ADMIN 以上） | 返品拒否 |
| `POST` | `/api/order/{orderId}/return/confirm` | BoUser（ADMIN 以上） | 返品確定 |
| `GET` | `/api/return` | BoUser（ADMIN 以上） | 返品一覧 |

#### `POST /api/order/{orderId}/return` リクエスト

```json
{
  "reason": "商品に傷があった",
  "items": [
    { "orderItemId": 1, "quantity": 2 }
  ]
}
```

バリデーションエラーコード:

| コード | 条件 |
|--------|------|
| `ORDER_NOT_FOUND` | orderId が存在しない / ユーザーの注文でない |
| `ORDER_NOT_DELIVERED` | `order.status != DELIVERED` |
| `RETURN_PERIOD_EXPIRED` | `delivered_at + 30日 < 現在時刻`、または `delivered_at == null` |
| `RETURN_ALREADY_EXISTS` | 同一 orderId に RETURN Shipment が既に存在 |
| `PRODUCT_NOT_RETURNABLE` | 申請明細に `is_returnable = false` の商品が含まれる |
| `INVALID_RETURN_QUANTITY` | `item.quantity > orderItem.quantity` |
| `INVALID_ORDER_ITEM` | `orderItemId` が当該注文の明細でない |

#### `POST /api/order/{orderId}/return/reject` リクエスト

```json
{ "reason": "返品期間対象外のため" }
```

#### `GET /api/return` クエリパラメータ

- `status`: `RETURN_PENDING` | `RETURN_APPROVED` | `RETURN_CONFIRMED` | `RETURN_CANCELLED`（省略時=全件）
- `page`: 1始まり（省略時=1）
- `limit`: 件数（省略時=20）

#### `ReturnShipmentDto`（Core API レスポンス共通）

```json
{
  "shipmentId": 1,
  "orderId": 1,
  "orderNumber": "ORD-0000000001",
  "status": "RETURN_PENDING",
  "statusLabel": "返品待ち",
  "reason": "商品に傷があった",
  "rejectionReason": null,
  "items": [
    {
      "shipmentItemId": 1,
      "orderItemId": 1,
      "productId": 1,
      "productName": "商品名",
      "quantity": 2,
      "unitPrice": 1000,
      "subtotal": 2000
    }
  ],
  "createdAt": "2026-01-01T00:00:00+09:00",
  "updatedAt": "2026-01-01T00:00:00+09:00"
}
```

`statusLabel` は Core API 側で付与する（BFF は透過）。

#### `GET /api/return` レスポンス

```json
{
  "returns": [ /* ReturnShipmentDto[] */ ],
  "pagination": { "page": 1, "limit": 20, "totalCount": 5 }
}
```

#### `OrderDto` 拡張（既存クラスへの追加フィールド）

返品がない注文は `returnShipment: null` とする:

```json
{
  "returnShipment": {
    "shipmentId": 1,
    "status": "RETURN_PENDING",
    "statusLabel": "返品待ち",
    "createdAt": "2026-01-01T00:00:00+09:00"
  }
}
```

### 2.2 Customer BFF（外部公開）

| メソッド | パス | Core API 転送先 |
|---------|------|----------------|
| `POST` | `/api/orders/{orderId}/return` | `POST /api/order/{orderId}/return` |
| `GET` | `/api/orders/{orderId}/return` | `GET /api/order/{orderId}/return` |

`GET /api/orders/history`・`GET /api/orders/{id}` は既存のまま。`OrderDto` に `returnShipment` が含まれるので BFF は透過するだけでよい。

### 2.3 BackOffice BFF（外部公開）

| メソッド | パス | Core API 転送先 |
|---------|------|----------------|
| `GET` | `/api/admin/orders/{orderId}/return` | `GET /api/order/{orderId}/return` |
| `POST` | `/api/admin/orders/{orderId}/return/approve` | `POST /api/order/{orderId}/return/approve` |
| `POST` | `/api/admin/orders/{orderId}/return/reject` | `POST /api/order/{orderId}/return/reject` |
| `POST` | `/api/admin/orders/{orderId}/return/confirm` | `POST /api/order/{orderId}/return/confirm` |
| `GET` | `/api/admin/returns` | `GET /api/return` |

---

## 3. データモデル契約

### 3.1 ShipmentStatus 拡張

`Shipment.java` 内の `ShipmentStatus` enum に以下 4 値を追加する。OUTBOUND 用ステータス（READY / EXPORTED / TRANSFERRED）は変更しない。

| 追加値 | 日本語 | 遷移条件 |
|--------|--------|---------|
| `RETURN_PENDING` | 返品待ち | 申請時の初期値 |
| `RETURN_APPROVED` | 返品承認済 | `RETURN_PENDING` → 管理者承認 |
| `RETURN_CONFIRMED` | 返品確定 | `RETURN_APPROVED` → 管理者・返送到着確認 |
| `RETURN_CANCELLED` | 返品キャンセル | `RETURN_PENDING` → 管理者拒否 |

状態遷移の制約:
- `RETURN_APPROVED` から `RETURN_CANCELLED` への直接遷移は不可（`INVALID_RETURN_STATUS_TRANSITION`）。
- `RETURN_CONFIRMED` / `RETURN_CANCELLED` からの遷移はいずれも不可（終端状態）。

### 3.2 V3 Flyway マイグレーション（`V3__add_return_feature.sql`）

次バージョンは V3（現在の最新は V2）。本スクリプトに以下の変更を一括収録する。

**`orders` テーブル変更**:
- `delivered_at TIMESTAMP WITH TIME ZONE`（nullable。既存レコードは NULL を許容）

**`shipments` テーブル変更**:
- `rejection_reason VARCHAR(500)` 追加（`RETURN_CANCELLED` 時のみ使用、他は NULL）
- `status` の CHECK 制約を再定義し、RETURN 系ステータスを含む形に拡張
  - V2 の実際の制約名は `V2__baseline_current_schema.sql` で確認してから DROP すること

**`products` テーブル変更**:
- `is_returnable BOOLEAN NOT NULL DEFAULT TRUE`（既存商品はすべて返品可能がデフォルト）

### 3.3 既存スキーマとの乖離事項（V3 実装時の注意）

`docs/data-model.md` は V2 の実態と乖離している。V3 作成時は `V2__baseline_current_schema.sql` を正として判断すること。

| 項目 | V2 実際の状態 | data-model.md の記述 |
|------|--------------|---------------------|
| `shipments.status` の型 | `VARCHAR(50) CHECK (status IN ('READY', 'EXPORTED', 'TRANSFERRED'))` | PostgreSQL ENUM 型として記載 |
| `shipments` のカラム名 | `export_file_path` | `instruction_number`, `file_exported_at` 等 |
| `shipment_items` のカラム | `product_price`, `subtotal` あり | 未記載 |

---

## 4. モジュール・レイヤ構成

ArchUnit ルールへの準拠状況を付記する。

```
backend/
  modules/purchase/
    adapter/rest/
      ReturnController.java          ← 新規（ArchUnit: @RestController は adapter.rest）
    application/port/
      ReturnCommandPort.java         ← 新規（public interface）
      ReturnQueryPort.java           ← 新規（public interface）
      ReturnShipmentDto.java         ← 新規（public class, fromEntity 静的メソッド付き）
      ReturnShipmentSummary.java     ← 新規（OrderDto.returnShipment フィールドの型）
      ReturnListResponse.java        ← 新規（public class）
      CreateReturnRequest.java       ← 新規（public class）
      RejectReturnRequest.java       ← 新規（public class）
      OrderDto.java                  ← 既存変更: returnShipment フィールド追加
    application/usecase/
      ReturnUseCase.java             ← 新規（package-private: ArchUnit ルール5）
                                         ReturnCommandPort + ReturnQueryPort を implements
    order/entity/
      Order.java                     ← 既存変更: deliveredAt フィールド追加
    shipment/entity/
      Shipment.java                  ← 既存変更: rejectionReason 追加、ShipmentStatus 拡張
    shipment/repository/
      ShipmentRepository.java        ← 既存変更: findByOrderIdAndShipmentType() 追加
    application/usecase/
      OrderUseCase.java              ← 既存変更: deliverOrder() で deliveredAt 設定
                                                   get 系に returnShipment 付与

  modules/product/
    domain/entity/
      Product.java                   ← 既存変更: isReturnable フィールド追加
                                       （ArchUnit ルール1: product.domain は他モジュールに依存しない）

bff/
  customer-bff/src/returns/
    returns.controller.ts / returns.service.ts / returns.module.ts  ← 新規
  backoffice-bff/src/returns/
    returns.controller.ts / returns.service.ts / returns.module.ts  ← 新規
  shared/src/dto/return.dto.ts       ← 新規
  shared/src/index.ts                ← 既存変更: return.dto.ts をエクスポート

frontend/
  src/entities/return/
    model/types.ts / model/api.ts / index.ts  ← 新規
  src/entities/order/model/types.ts  ← 既存変更: returnShipment? フィールド追加
  src/pages/customer/OrderHistoryPage/index.tsx  ← 既存変更
  src/pages/admin/AdminOrderPage/index.tsx       ← 既存変更
```

---

## 5. 主要クラス/IF の責務

### 5.1 バックエンド（Port 設計）

| クラス/IF | 責務 | レイヤ | 可視性 |
|-----------|------|--------|--------|
| `ReturnCommandPort` | `createReturn` / `approveReturn` / `rejectReturn` / `confirmReturn` のシグネチャ定義 | `application.port` | `public interface` |
| `ReturnQueryPort` | `getReturnByOrderId` / `getAllReturns` のシグネチャ定義 | `application.port` | `public interface` |
| `ReturnUseCase` | `ReturnCommandPort` + `ReturnQueryPort` を実装。資格チェック・Shipment 生成・ステータス遷移・Outbox 発行 | `application.usecase` | `class`（package-private） |
| `ReturnController` | `/api/order/{id}/return*` と `/api/return` のルーティング。`ReturnCommandPort` / `ReturnQueryPort` を DI | `adapter.rest` | `public @RestController` |
| `ReturnShipmentDto` | Core API レスポンス構造。`fromEntity(Shipment, Order)` 静的メソッドで生成 | `application.port` | `public class` |
| `ReturnShipmentSummary` | `OrderDto.returnShipment` フィールドの型（shipmentId, status, statusLabel, createdAt） | `application.port` | `public class` |

#### Port シグネチャ（契約として固定）

```java
public interface ReturnCommandPort {
    ReturnShipmentDto createReturn(Long orderId, Long userId, CreateReturnRequest request);
    ReturnShipmentDto approveReturn(Long orderId);
    ReturnShipmentDto rejectReturn(Long orderId, RejectReturnRequest request);
    ReturnShipmentDto confirmReturn(Long orderId);
}

public interface ReturnQueryPort {
    ReturnShipmentDto getReturnByOrderId(Long orderId, Long userId); // userId=null は管理者呼び出し
    ReturnListResponse getAllReturns(Shipment.ShipmentStatus status, int page, int limit);
}
```

### 5.2 BFF

| クラス | 責務 |
|--------|------|
| `ReturnsController` (Customer BFF) | `/api/orders/{id}/return*` を Core API へ透過転送。`AuthGuard` 適用 |
| `ReturnsController` (BackOffice BFF) | `/api/admin/orders/{id}/return*` と `/api/admin/returns` を Core API へ透過転送。`BoAuthGuard` 適用 |

### 5.3 フロントエンド

| ファイル | 責務 |
|---------|------|
| `entities/return/model/types.ts` | `ReturnShipment`（status, statusLabel, rejectionReason, items, ...）型定義 |
| `entities/return/model/api.ts` | `requestReturn` / `getReturn` / `approveReturn` / `rejectReturn` / `confirmReturn` / `getAllReturns` |

---

## 6. トランザクション・非同期方針

- 各 `ReturnUseCase` メソッドは単一 `@Transactional` で完結する。
- 取得系は `@Transactional(readOnly = true)` を使用する。
- 返品ステータス変更（approve / reject / confirm）は楽観的排他制御を行わない（低頻度操作のため）。
- 監査ログは `outboxEventPublisher.publish("OPERATION_PERFORMED", null, Map.of(...))` で同一トランザクションに書き込む（既存パターン踏襲）。

監査ログの `operationType` 値:

| 操作 | operationType |
|------|---------------|
| 返品申請 | `RETURN_REQUEST` |
| 返品承認 | `RETURN_APPROVE` |
| 返品拒否 | `RETURN_REJECT` |
| 返品確定 | `RETURN_CONFIRM` |

---

## 7. 処理フロー

### 7.1 返品申請

```
Customer → CustomerBFF POST /api/orders/{id}/return
  → CoreAPI POST /api/order/{id}/return
    → ReturnController
        user = authService.verifyToken(extractToken(authHeader))
        → ReturnCommandPort.createReturn(orderId, user.getId(), request)
          → ReturnUseCase（package-private）
              [チェック] Order 取得・オーナー確認
              [チェック] order.status == DELIVERED
              [チェック] order.deliveredAt != null && +30日 >= now()
              [チェック] RETURN Shipment 重複なし
              [チェック] 各 OrderItem の帰属・quantity・isReturnable
              → Shipment(RETURN, RETURN_PENDING) + ShipmentItem 群を生成・保存
              → outbox: RETURN_REQUEST
              → return ReturnShipmentDto.fromEntity(shipment, order)
```

### 7.2 管理者アクション（承認 / 拒否 / 確定）

```
Admin → BackOfficeBFF POST /api/admin/orders/{id}/return/{action}
  → CoreAPI POST /api/order/{id}/return/{action}
    → ReturnController
        boUser = boAuthService.verifyToken(token)
        requireAdmin(boUser, path)
        → ReturnCommandPort.{approve|reject|confirm}Return(orderId, [request])
          → ReturnUseCase
              → RETURN Shipment 取得（なければ ResourceNotFoundException）
              → ステータス遷移チェック（不正なら INVALID_RETURN_STATUS_TRANSITION）
              → status 更新（reject 時は rejectionReason も設定）
              → outbox: RETURN_{APPROVE|REJECT|CONFIRM}
              → return ReturnShipmentDto.fromEntity(shipment, order)
```

### 7.3 OrderDto への返品情報埋め込み

```
GET /api/order/{id} または GET /api/order/history
  → OrderUseCase.get*()
      → Order 取得
      → ShipmentRepository.findByOrderIdAndShipmentType(orderId, RETURN)（Optional）
      → 存在すれば ReturnShipmentSummary を OrderDto に付与
```

### 7.4 `deliverOrder()` での `delivered_at` 設定

```
POST /api/order/{id}/deliver
  → OrderUseCase.deliverOrder(orderId)
      → order.setStatus(DELIVERED)
      → order.setDeliveredAt(Instant.now())  ← 今回追加
      → save
```

---

## 8. 影響範囲

### 新規作成

| 対象 | 説明 |
|------|------|
| `backend/.../db/flyway/V3__add_return_feature.sql` | スキーマ変更一式 |
| `backend/.../purchase/application/port/ReturnCommandPort.java` | 返品コマンド Port IF（public interface） |
| `backend/.../purchase/application/port/ReturnQueryPort.java` | 返品クエリ Port IF（public interface） |
| `backend/.../purchase/application/port/ReturnShipmentDto.java` | レスポンス DTO |
| `backend/.../purchase/application/port/ReturnShipmentSummary.java` | OrderDto 用サマリ型 |
| `backend/.../purchase/application/port/ReturnListResponse.java` | 一覧レスポンス |
| `backend/.../purchase/application/port/CreateReturnRequest.java` | 申請リクエスト |
| `backend/.../purchase/application/port/RejectReturnRequest.java` | 拒否リクエスト |
| `backend/.../purchase/application/usecase/ReturnUseCase.java` | ビジネスロジック実装（package-private） |
| `backend/.../purchase/adapter/rest/ReturnController.java` | Core API エンドポイント |
| `bff/customer-bff/src/returns/returns.{controller,service,module}.ts` | Customer BFF 返品モジュール |
| `bff/backoffice-bff/src/returns/returns.{controller,service,module}.ts` | BackOffice BFF 返品モジュール |
| `bff/shared/src/dto/return.dto.ts` | 共有 ReturnShipmentDto 型 |
| `frontend/src/entities/return/{index,model/types,model/api}.ts` | 返品エンティティ |

### 既存変更

| 対象 | 変更概要 |
|------|---------|
| `backend/.../purchase/shipment/entity/Shipment.java` | `rejectionReason` 追加、`ShipmentStatus` に RETURN 系 4 値追加 |
| `backend/.../purchase/order/entity/Order.java` | `deliveredAt` フィールド追加 |
| `backend/.../product/domain/entity/Product.java` | `isReturnable` フィールド追加 |
| `backend/.../purchase/application/usecase/OrderUseCase.java` | `deliverOrder()` に `deliveredAt` 設定追加、get 系に `returnShipment` 付与追加 |
| `backend/.../purchase/application/port/OrderDto.java` | `returnShipment: ReturnShipmentSummary` フィールド追加 |
| `backend/.../purchase/shipment/repository/ShipmentRepository.java` | `findByOrderIdAndShipmentType()` 追加 |
| `bff/shared/src/index.ts` | `return.dto.ts` の export 追加 |
| `bff/customer-bff/src/app.module.ts` | `ReturnsModule` を imports に追加 |
| `bff/backoffice-bff/src/app.module.ts` | `ReturnsModule` を imports に追加 |
| `frontend/src/entities/order/model/types.ts` | `Order` に `returnShipment?` フィールド追加 |
| `frontend/src/pages/customer/OrderHistoryPage/index.tsx` | 返品申請ボタン・返品ステータスバッジ・申請モーダル追加 |
| `frontend/src/pages/admin/AdminOrderPage/index.tsx` | 注文詳細モーダルに返品情報セクション・操作ボタン追加 |
| `docs/data-model.md` | orders / shipments / products / shipment_items の変更を反映 |
| `docs/specs/order.md` | 返品フロー追記、`delivered_at` フィールド追記 |
| `docs/api/customer-bff-openapi.json` | 返品エンドポイント追加 |
| `docs/api/backoffice-bff-openapi.json` | 返品エンドポイント追加 |

---

## 9. テスト観点

### 正常系

- `DELIVERED` 注文かつ 30 日以内に返品申請できる（`RETURN_PENDING` Shipment が生成される）
- 申請後、管理者が承認すると `RETURN_APPROVED` に遷移する
- 管理者が拒否すると `RETURN_CANCELLED` に遷移し、`rejectionReason` が保存される
- 返送到着確認で `RETURN_CONFIRMED` に遷移する
- 管理者が返品一覧を取得できる（ステータスフィルタ・ページング含む）
- `GET /api/order/{id}` レスポンスに `returnShipment` サマリが含まれる
- `deliverOrder()` 実行後、`orders.delivered_at` が設定される
- OrderHistoryPage で「返品申請」ボタンと返品ステータスバッジが正しく表示される
- AdminOrderPage の注文詳細モーダルに返品情報セクションが表示される

### 異常系

- `DELIVERED` 以外の注文に申請 → `ORDER_NOT_DELIVERED`
- 30 日超過の申請 → `RETURN_PERIOD_EXPIRED`
- `delivered_at = null` の既存注文への申請 → `RETURN_PERIOD_EXPIRED`
- 同一注文への二重申請 → `RETURN_ALREADY_EXISTS`
- `is_returnable = false` の商品を含む申請 → `PRODUCT_NOT_RETURNABLE`
- 注文数量超過の返品数量 → `INVALID_RETURN_QUANTITY`
- 対象注文に属さない `orderItemId` → `INVALID_ORDER_ITEM`
- 他ユーザーの注文への申請 → `ORDER_NOT_FOUND`
- `RETURN_APPROVED` から `RETURN_CANCELLED` への直接遷移 → `INVALID_RETURN_STATUS_TRANSITION`
- 終端状態（`RETURN_CONFIRMED` / `RETURN_CANCELLED`）からの遷移 → `INVALID_RETURN_STATUS_TRANSITION`
- `OPERATOR` 権限の管理者が承認/拒否/確定を実行 → `FORBIDDEN`
- **ArchUnit テスト（`ModularMonolithArchitectureTest`）が全 14 ルール PASS すること**
  - `ReturnUseCase` が package-private（ルール5）
  - `ReturnController` が Port インターフェース経由のみ参照（ルール3）
  - Port IF が `public interface`（ルール6）
  - DTO / Request / Response 類が `application.port` 配下（ルール10）

### 境界値

- 返品期限ちょうど 30 日目は申請可能、31 日目は拒否
- 返品数量 = 注文数量（全量返品）は可能
- 返品数量 = 1（部分返品）は可能
