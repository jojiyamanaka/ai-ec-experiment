# 業務要件・ビジネスルール

**目的**: AIを活用したECサイトの業務要件とビジネスルールを定義する
**スコープ**: 主要機能、ビジネスルール、注文フロー、今後の拡張予定

**関連ドキュメント**:
- [技術仕様](./SPEC.md) - 技術方針・アーキテクチャ
- [データモデル](./data-model.md) - エンティティ定義
- [画面遷移・UI仕様](./ui/customer-ui.md) - 画面設計
- [API仕様](./ui/api-spec.md) - APIエンドポイント

---

## 主要機能

### 1. 商品閲覧機能

**機能概要**:
- 公開されている商品の閲覧
- 商品の詳細情報確認
- 在庫状態の可視化

**対象画面**:
- TOP画面
- 商品一覧画面
- 商品詳細画面

**ビジネスルール**:
- 非公開（`isPublished = false`）の商品は表示しない
- 在庫状態は在庫数に応じて自動判定（後述の「在庫状態のルール」参照）
- 商品画像はプレースホルダーを使用（Phase 1）

**参照**:
- 詳細仕様: [ui/customer-ui.md](./ui/customer-ui.md) - 画面仕様

---

### 2. カート機能

**機能概要**:
- カートへの商品追加
- カート内商品の数量変更
- カート内商品の削除
- 合計金額の計算

**対象画面**:
- 商品詳細画面（追加）
- カート画面（編集）

**ビジネスルール**:
- 売り切れ商品はカートに追加不可
- 数量を 0 にすると自動的に削除
- 合計金額はリアルタイムで再計算
- 配送料・手数料は現在 ¥0 固定（Phase 1）

**カート操作フロー**:
```
商品詳細画面
  ↓ 「カートに追加」ボタンクリック
カート画面に遷移
  ↓ 数量変更（+/- ボタンまたは直接入力）
合計金額が自動再計算
  ↓ 商品削除（ゴミ箱アイコン）
カートから削除
```

**参照**:
- 実装仕様: [SPEC.md](../SPEC.md) - カート状態管理（Context API）

---

### 3. 注文機能

**機能概要**:
- カート内容の確認
- 注文の確定
- 注文番号の生成

**対象画面**:
- 注文確認画面
- 注文完了画面

**ビジネスルール**:
- 注文番号は `ORD-YYYYMMDD-XXX` 形式で自動生成
  - YYYYMMDD: 注文日（例: 20250210）
  - XXX: その日の連番（001〜999、上限999件/日）
- 注文確定時にカートを自動クリア
- 注文時に在庫引当を実施（仮引当 → 本引当）

**注文フロー**:
```
1. カート画面で「レジに進む」
   ↓
2. 注文確認画面で内容を確認
   ↓
3. 「注文を確定する」で注文作成
   ↓ 在庫引当（仮引当 → 本引当）
   ↓ 在庫数（stock）を減少
4. カートがクリアされる
   ↓
5. 注文完了画面に遷移
```

**参照**:
- 詳細仕様: [specs/order.md](./specs/order.md) - 注文管理
- 詳細仕様: [specs/inventory.md](./specs/inventory.md) - 在庫引当

---

### 4. 商品管理機能（管理画面）

**機能概要**:
- 商品情報の一括編集
- 在庫数の管理
- 公開/非公開の切り替え

**対象画面**:
- 管理画面（/bo/item）
- 注文管理画面（/bo/order）

**ビジネスルール**:
- 変更は「保存」ボタンクリック時に反映
- 非公開にした商品は即座に商品一覧から非表示
- 在庫数の変更は即座に反映
- 管理画面へのアクセス制限なし（Phase 1）

**参照**:
- 詳細仕様: [ui/admin-ui.md](./ui/admin-ui.md) - 管理画面

---

## 在庫状態のルール

商品の在庫数（`stock`）に応じて、在庫状態を3段階で表示します。

| 在庫数 | 状態 | 表示 | バッジ色 | 説明 |
|--------|------|------|----------|------|
| 6 以上 | 在庫あり | 「在庫あり」 | 緑（bg-green-500） | 十分な在庫がある状態 |
| 1〜5 | 残りわずか | 「残りわずか」 | オレンジ（bg-orange-500） | 在庫が少なくなっている状態 |
| 0 | 売り切れ | 「売り切れ」 | グレー（bg-gray-400） | 在庫がない状態 |

### 在庫状態の影響

- **在庫あり・残りわずか**: カートに追加可能
- **売り切れ**: カートに追加不可（ボタンを無効化）

### 判定ロジック

```typescript
function getStockStatus(stock: number) {
  if (stock === 0) {
    return { text: '売り切れ', color: 'bg-gray-400 text-white' }
  } else if (stock >= 1 && stock <= 5) {
    return { text: '残りわずか', color: 'bg-orange-500 text-white' }
  } else {
    return { text: '在庫あり', color: 'bg-green-500 text-white' }
  }
}
```

**参照**:
- 詳細仕様: [specs/inventory.md](./specs/inventory.md) - 在庫管理

---

## 注文の状態遷移

注文は作成から完了まで、以下の状態を遷移します。

### 状態一覧

| 状態 | 英語表記 | 説明 |
|------|----------|------|
| 作成済み | PENDING | 注文が作成された初期状態 |
| 確認済み | CONFIRMED | 注文内容が確認され、処理が開始された状態 |
| 発送済み | SHIPPED | 商品が発送された状態 |
| 配達完了 | DELIVERED | 商品が配達完了した状態 |
| キャンセル | CANCELLED | 注文がキャンセルされた状態 |

### 状態遷移図

```
[PENDING]
   ↓ 確認
[CONFIRMED]
   ↓ 発送
[SHIPPED]
   ↓ 配達
[DELIVERED]

[PENDING] → [CANCELLED]（キャンセル可能）
[CONFIRMED] → [CANCELLED]（キャンセル可能）
```

### 遷移ルール

#### 1. PENDING → CONFIRMED（注文確認）
- 管理者が注文内容を確認
- 在庫の引き当てを実施（仮引当が既に存在）
- 決済処理を実行（Phase 2以降）

#### 2. CONFIRMED → SHIPPED（発送）
- 商品の梱包が完了
- 配送業者に引き渡し
- 追跡番号を発行（Phase 2以降）

#### 3. SHIPPED → DELIVERED（配達完了）
- 配送業者が配達完了
- 顧客が商品を受け取り

#### 4. PENDING/CONFIRMED → CANCELLED（キャンセル）
- 顧客または管理者がキャンセル
- 在庫を戻す（本引当を解除）
- 決済をキャンセル（Phase 2以降）

**キャンセル不可の状態**:
- SHIPPED: 発送済み
- DELIVERED: 配達完了

**参照**:
- 詳細仕様: [specs/order.md](./specs/order.md) - 注文管理

---

## 価格・料金のルール

### 商品価格
- 税込価格で表示
- 単位: 円（¥）
- 小数点なし（整数のみ）

### 配送料・手数料
- **Phase 1（現在）**: 配送料・手数料ともに ¥0 固定
- **Phase 2以降**: 配送料の計算ロジックを実装予定
  - 合計金額による送料無料ライン
  - 地域別送料
  - 配送方法別料金

### 注文合計金額の計算
```
小計 = Σ（各商品の単価 × 数量）
配送料 = 0（Phase 1）
手数料 = 0（Phase 1）
合計金額 = 小計 + 配送料 + 手数料
```

**参照**:
- 詳細仕様: [specs/product.md](./specs/product.md) - 価格管理

---

## セッション管理

### セッションID
- フロントエンドが初回アクセス時に自動生成（UUID v4）
- `localStorage` に保存（キー: `sessionId`）
- APIリクエストに `X-Session-Id` ヘッダーで送信

### スコープ
- カート: セッションIDにスコープされる
- 注文: セッションIDにスコープされる

### 有効期限
- **Phase 1（現在）**: 有効期限なし（永続保存）
- **Phase 2以降**: セッション有効期限を実装予定

**参照**:
- 技術仕様: [SPEC.md](../SPEC.md) - セッション管理

---

## 今後の拡張予定

### Phase 2（バックエンドAPI実装後）

1. **検索・フィルタリング機能**
   - 商品名での検索
   - 価格帯でのフィルタリング
   - カテゴリ分類

2. **配送情報管理**
   - 配送先住所の登録
   - 配送状況の追跡
   - 配送方法の選択

3. **決済機能**
   - 決済サービス連携
   - クレジットカード決済
   - 決済履歴管理

### Phase 3（認証・高度な機能）

4. **レビュー・評価機能**
   - 商品レビューの投稿
   - 星評価（1〜5）
   - レビューの表示・ソート

5. **お気に入り機能**
   - 商品のお気に入り登録
   - お気に入り一覧
   - お気に入りからカート追加

6. **注文履歴**
   - 過去の注文一覧
   - 注文詳細の確認
   - 再注文機能

7. **AI レコメンデーション**
   - ユーザーの購買履歴に基づくおすすめ
   - 閲覧履歴に基づくおすすめ
   - 関連商品の表示
   - 協調フィルタリング

**参照**:
- 技術仕様: [SPEC.md](../SPEC.md) - Phase別実装計画

---

## 制約事項

### Phase 1（現在）の制約

1. **データの永続化なし**
   - カート・注文データはバックエンドDBで永続化
   - セッションIDがあれば復元可能

2. **認証・認可なし**
   - ユーザー登録・ログイン機能なし
   - 管理画面へのアクセス制限なし
   - セッション管理は簡易実装

3. **決済機能なし**
   - 決済処理は未実装
   - 注文確定のみ

4. **商品画像の制限**
   - プレースホルダー画像を使用（placehold.co）
   - 画像アップロード機能なし

**参照**:
- ギャップ分析: [spec-implementation-gaps.md](./spec-implementation-gaps.md)

---

## 関連資料

- **技術仕様**: [SPEC.md](../SPEC.md)
- **データモデル**: [data-model.md](./data-model.md)
- **画面遷移・UI仕様**: [ui/customer-ui.md](./ui/customer-ui.md)
- **API仕様**: [ui/api-spec.md](./ui/api-spec.md)
- **詳細仕様**:
  - [在庫管理](./specs/inventory.md)
  - [注文管理](./specs/order.md)
  - [商品ドメイン](./specs/product.md)
  - [管理画面](./ui/admin-ui.md)
