{
  "title": "EC ビジネスメトリクス",
  "uid": "ec-business",
  "version": 1,
  "schemaVersion": 37,
  "refresh": "30s",
  "time": { "from": "now-1h", "to": "now" },
  "panels": [
    {
      "id": 1,
      "title": "注文数（成功/失敗 10m）",
      "type": "timeseries",
      "gridPos": { "x": 0, "y": 0, "w": 6, "h": 4 },
      "targets": [
        {
          "datasource": "Prometheus",
          "expr": "sum(increase(order_created_count_total[10m]))",
          "legendFormat": "注文成功",
          "refId": "A"
        },
        {
          "datasource": "Prometheus",
          "expr": "sum(increase(order_creation_failed_total[10m]))",
          "legendFormat": "注文失敗",
          "refId": "B"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "none" } }
    },
    {
      "id": 2,
      "title": "在庫引当数（成功/失敗 10m）",
      "type": "timeseries",
      "gridPos": { "x": 6, "y": 0, "w": 9, "h": 4 },
      "targets": [
        {
          "datasource": "Prometheus",
          "expr": "sum(increase(http_server_requests_seconds_count{method=\"POST\",uri=\"/api/order/cart/items\",status=\"200\"}[10m]))",
          "legendFormat": "在庫引当成功",
          "refId": "A"
        },
        {
          "datasource": "Prometheus",
          "expr": "sum(increase(http_server_requests_seconds_count{method=\"POST\",uri=\"/api/order/cart/items\",status=~\"4..|5..\"}[10m]))",
          "legendFormat": "在庫引当失敗",
          "refId": "B"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "none" } }
    },
    {
      "id": 3,
      "title": "認証数（成功/失敗 10m）",
      "type": "timeseries",
      "gridPos": { "x": 15, "y": 0, "w": 9, "h": 4 },
      "targets": [
        {
          "datasource": "Prometheus",
          "expr": "sum(increase(http_server_requests_seconds_count{method=\"POST\",uri=\"/api/auth/login\",status=\"200\"}[10m]))",
          "legendFormat": "認証成功",
          "refId": "A"
        },
        {
          "datasource": "Prometheus",
          "expr": "sum(increase(http_server_requests_seconds_count{method=\"POST\",uri=\"/api/auth/login\",status=~\"4..|5..\"}[10m]))",
          "legendFormat": "認証失敗",
          "refId": "B"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "none" } }
    },
    {
      "id": 4,
      "title": "注文処理レイテンシ (p95 / p99)",
      "type": "timeseries",
      "gridPos": { "x": 0, "y": 4, "w": 12, "h": 6 },
      "targets": [
        {
          "datasource": "Prometheus",
            "expr": "histogram_quantile(0.95, rate(order_creation_duration_seconds_bucket[5m]))",
          "legendFormat": "p95",
          "refId": "A"
        },
        {
          "datasource": "Prometheus",
            "expr": "histogram_quantile(0.99, rate(order_creation_duration_seconds_bucket[5m]))",
          "legendFormat": "p99",
          "refId": "B"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "s" } }
    },
    {
      "id": 5,
      "title": "HTTP p95 レイテンシ (BFF)",
      "type": "timeseries",
      "gridPos": { "x": 12, "y": 4, "w": 12, "h": 6 },
      "targets": [
        {
          "datasource": "Prometheus",
          "expr": "histogram_quantile(0.95, sum by (le) (rate(ec_http_server_duration_milliseconds_bucket{exported_job=\"customer-bff\"}[5m])))",
          "legendFormat": "customer-bff p95",
          "refId": "A"
        },
        {
          "datasource": "Prometheus",
          "expr": "histogram_quantile(0.95, sum by (le) (rate(ec_http_server_duration_milliseconds_bucket{exported_job=\"backoffice-bff\"}[5m])))",
          "legendFormat": "backoffice-bff p95",
          "refId": "B"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "ms" } }
    }
  ]
}
